<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>1 核心实践</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/vueblog/assets/css/0.styles.9c4f8d34.css" as="style"><link rel="preload" href="/vueblog/assets/js/app.81e52da8.js" as="script"><link rel="preload" href="/vueblog/assets/js/2.365067af.js" as="script"><link rel="preload" href="/vueblog/assets/js/23.bbf8853f.js" as="script"><link rel="prefetch" href="/vueblog/assets/js/10.a0e23fea.js"><link rel="prefetch" href="/vueblog/assets/js/11.b758150e.js"><link rel="prefetch" href="/vueblog/assets/js/12.d02c1519.js"><link rel="prefetch" href="/vueblog/assets/js/13.0a3e45d8.js"><link rel="prefetch" href="/vueblog/assets/js/14.fd438b0f.js"><link rel="prefetch" href="/vueblog/assets/js/15.8f2f6504.js"><link rel="prefetch" href="/vueblog/assets/js/16.702f6c0f.js"><link rel="prefetch" href="/vueblog/assets/js/17.875cc70b.js"><link rel="prefetch" href="/vueblog/assets/js/18.73ef9897.js"><link rel="prefetch" href="/vueblog/assets/js/19.fcbd610b.js"><link rel="prefetch" href="/vueblog/assets/js/20.b86ab3ce.js"><link rel="prefetch" href="/vueblog/assets/js/21.17f5d888.js"><link rel="prefetch" href="/vueblog/assets/js/22.08acf871.js"><link rel="prefetch" href="/vueblog/assets/js/24.02668152.js"><link rel="prefetch" href="/vueblog/assets/js/25.1bc6f63b.js"><link rel="prefetch" href="/vueblog/assets/js/26.7d6104a9.js"><link rel="prefetch" href="/vueblog/assets/js/3.98cb2320.js"><link rel="prefetch" href="/vueblog/assets/js/4.b835cd21.js"><link rel="prefetch" href="/vueblog/assets/js/5.2d560cb6.js"><link rel="prefetch" href="/vueblog/assets/js/6.d57284aa.js"><link rel="prefetch" href="/vueblog/assets/js/7.51fc855c.js"><link rel="prefetch" href="/vueblog/assets/js/8.f96a8507.js"><link rel="prefetch" href="/vueblog/assets/js/9.4aff9137.js">
    <link rel="stylesheet" href="/vueblog/assets/css/0.styles.9c4f8d34.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vueblog/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vueblog/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/vueblog/zh/java/" class="nav-link">
  java
</a></div><div class="nav-item"><a href="/vueblog/redis/" class="nav-link">
  redis
</a></div><div class="nav-item"><a href="/vueblog/cicd/" class="nav-link">
  CI/CD
</a></div><div class="nav-item"><a href="/vueblog/network/" class="nav-link">
  网络
</a></div><div class="nav-item"><a href="/vueblog/store/" class="nav-link router-link-active">
  存储
</a></div><div class="nav-item"><a href="/vueblog/k8s/" class="nav-link">
  k8s
</a></div><div class="nav-item"><a href="/vueblog/linux/" class="nav-link">
  linux
</a></div><div class="nav-item"><a href="/vueblog/standard/" class="nav-link">
  规范
</a></div><div class="nav-item"><a href="https://www.baidu.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  百度一下
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://www.google.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  google
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/vueblog/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/vueblog/zh/java/" class="nav-link">
  java
</a></div><div class="nav-item"><a href="/vueblog/redis/" class="nav-link">
  redis
</a></div><div class="nav-item"><a href="/vueblog/cicd/" class="nav-link">
  CI/CD
</a></div><div class="nav-item"><a href="/vueblog/network/" class="nav-link">
  网络
</a></div><div class="nav-item"><a href="/vueblog/store/" class="nav-link router-link-active">
  存储
</a></div><div class="nav-item"><a href="/vueblog/k8s/" class="nav-link">
  k8s
</a></div><div class="nav-item"><a href="/vueblog/linux/" class="nav-link">
  linux
</a></div><div class="nav-item"><a href="/vueblog/standard/" class="nav-link">
  规范
</a></div><div class="nav-item"><a href="https://www.baidu.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  百度一下
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://www.google.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  google
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/vueblog/store/" aria-current="page" class="sidebar-link">存储</a></li><li><a href="/vueblog/store/ceph.html" class="sidebar-link">ceph分布式文件系统</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_1-核心实践"><a href="#_1-核心实践" class="header-anchor">#</a> 1 核心实践</h1> <h2 id="_1-1-认证管理"><a href="#_1-1-认证管理" class="header-anchor">#</a> 1.1 认证管理</h2> <h3 id="_1-1-1-认证基础"><a href="#_1-1-1-认证基础" class="header-anchor">#</a> 1.1.1 认证基础</h3> <p>学习目标</p> <p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p> <p><strong>基础知识</strong></p> <p>简介</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	Ceph作为一个分布式存储系统，支持对象存储、块设备和文件系统。为了在网络传输中防止数据被篡改，做到较高程度的安全性，加入了Cephx加密认证协议。其目的是客户端和管理端之间的身份识别，加密、验证传输中的数据。
	注意：所谓的client就是使用ceph命令的客户端
	
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>ceph集群默认开启了cephx协议功能
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ <span class="token function">cat</span> ceph<span class="token punctuation">.</span>conf
<span class="token namespace">[global]</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
auth_cluster_required = cephx
auth_service_required = cephx
auth_client_required = cephx
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

如果我们提供的是公共的信息 <span class="token operator">--</span> 不需要进行认证，所以我们可以禁用CephX功能。将对应的属性值设置为 none即可，比如
auth_cluster_required = none
</code></pre></div><p>认证场景</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>命令行与Ceph集群操作，包括：
    RadosGW 对象网关认证（对象网关认证系统<span class="token operator">+</span>cephx）
    RBD 认证
    CephFS 用户认证（文件路径<span class="token operator">+</span>cephx）
Ceph集群内部组件之间通信
	执行ceph命令时，会使用client<span class="token punctuation">.</span>admin 用户并加载 <span class="token operator">/</span>etc/ceph/ceph<span class="token punctuation">.</span>client<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>keyring文件
</code></pre></div><p>认证和授权</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	在ceph系统中，所有元数据保存在mon节点的ceph-mon的进程中，mon保存了系统中重要的认证相关元数据，例如每个用户的key以及权限。样式结构如下：
	
    名称				key		Caps（权限）
    client<span class="token punctuation">.</span>admin	xxxxxx	  osd allow rw<span class="token punctuation">,</span> mon allow rw
    
    
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>对于ceph的认证和授权来说，主要涉及到三个内容：ceph用户、资源权限、用户授权。
	<span class="token operator">-</span> Ceph用户必须拥有执行权限才能执行Ceph的管理命令
	<span class="token operator">-</span> Ceph用户需要拥有存储池访问权限才能到ceph中读取和写入数据
</code></pre></div><p>基本概念</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>用户 
	<span class="token operator">-</span> ceph创建出来的用户，可以进入到ceph集群里面
	<span class="token operator">-</span> ceph支持多种类型，可管理的用户属于Client类型
	<span class="token operator">-</span> MON、OSD和MDS等系统组件属于系统参与者客户端
授权
	<span class="token operator">-</span> 将某些资源的使用权限交给特定的用户。
	<span class="token operator">-</span> allow
权限
	<span class="token operator">-</span> 描述用户可针对MON、OSD或MDS等资源的使用权限范围或级别
	<span class="token operator">-</span> MON具备的权限包括r、w、x和allow profile cap
	<span class="token operator">-</span> OSD具备的权限包括r、w、x和<span class="token keyword">class</span><span class="token operator">-</span>read、<span class="token keyword">class</span><span class="token operator">-</span><span class="token function">write</span>和profile osd、存储池和名称空间设置
	<span class="token operator">-</span> OSD具备的权限包括allow
</code></pre></div><p>权限解析</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>allow
	需先于守护进程的访问设置指定，标识赋予的xx权限
r：读取权限，访问MON以检索CRUSH时依赖此使能
w：对象写入权限
x：调用类方法（读取和写入）的能力，以及在MON上执行auth操作的能力
<span class="token keyword">class</span><span class="token operator">-</span>read：x能力的子集，授予用户调用类读取方法的能力
<span class="token keyword">class</span><span class="token operator">-</span><span class="token function">write</span>：x的子集，授予用户调用类写入方法的能力
<span class="token operator">*</span>：授予用户对特定守护进程<span class="token operator">/</span>存储池的读取、写入和执行权限，以及执行管理命令的能力
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>profile osd
	授予用户以某个OSD身份连接到其他OSD或监视器的权限
profile mds
	授予用户以某个MDS身份连接到其他MDS或监视器的权限
profile bootstrap-osd
	授予用户引导OSD的权限，在部署时候产生
profile bootstrap-mds
	授予用户引导元数据服务器的权限，在部署时候产生
</code></pre></div><p><strong>简单实践</strong></p> <p>CephX身份验正流程</p> <p><img src="image/image-20211206175437937.png" alt="image-20211206175437937"></p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	client和osd都有一个叫做monclient的模块负责认证和密钥交换。而monitor上有一个AuthMonitor的服务模块负责与monclient对话。
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>Ceph使用cephx协议对客户端进行身份认证
	每个MON都可以对客户端进行身份验正并分发密钥，不存在单点故障和性能瓶颈<span class="token punctuation">,</span>MON会返回用于身份验正的数据结构，其包含获取Ceph服务时用到的session key<span class="token punctuation">.</span>
	<span class="token operator">-</span> session key通过客户端密钥进行加密
	<span class="token operator">-</span> 客户端使用session key向MON请求所需的服务
	<span class="token operator">-</span> MON向客户端提供一个ticket，用于向实际处理数据的OSD等验正客户端身份
	<span class="token operator">-</span> MON和OSD共享同一个secret，因此OSD会信任由MON发放的ticket
	<span class="token operator">-</span> ticket存在有效期限
注意：
	CephX身份验正功能仅限制Ceph的各组件之间，它不能扩展到其它非Ceph组件；
	它并不解决数据传输加密的问题；
</code></pre></div><p>CephX身份验正-MDS和OSD</p> <p><img src="image/image-20211206175909027.png" alt="image-20211206175909027"></p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>1 当client与Monitor实现基本的认证后，monitor与后端的mds和osd会自动进行认证信息的同步
2 当client与Monitor实现基本的通信认证后
	可以独立与后端的MDS服务发送请求。
	可以独立与后端的OSD服务发送请求
</code></pre></div><p><strong>小结</strong></p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div><h3 id="_1-1-2-用户基础"><a href="#_1-1-2-用户基础" class="header-anchor">#</a> 1.1.2 用户基础</h3> <p>学习目标</p> <p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p> <p><strong>基础知识</strong></p> <p>简介</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>Ceph集群管理员能够直接在Ceph集群中创建、更新和删除用户
注意：
	创建用户时，可能需要将密钥分发到客户端，以便将密钥添加到密钥环
</code></pre></div><p>常见命令</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>列出用户
	命令：ceph auth list
	用户标识：<span class="token function">TYPE</span><span class="token punctuation">.</span>ID，因此，osd<span class="token punctuation">.</span>0表示OSD类型的用户，用户ID为0

检索特定用户
	命令：ceph auth get <span class="token function">TYPE</span><span class="token punctuation">.</span>ID或者ceph auth export <span class="token function">TYPE</span><span class="token punctuation">.</span>ID
	
列出用户的密钥
	命令：ceph auth print-key <span class="token function">TYPE</span><span class="token punctuation">.</span>ID
</code></pre></div><p><strong>简单实践</strong></p> <p>信息查看</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>查看用户账号
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph auth list
osd<span class="token punctuation">.</span>0
        key: AQCv3i9j34BWKhAAII3+THENuLJTv5Yr2NwDxA==
        caps: <span class="token namespace">[mgr]</span> allow profile osd
        caps: <span class="token namespace">[mon]</span> allow profile osd
        caps: <span class="token namespace">[osd]</span> allow <span class="token operator">*</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
结果显示：
	每个osd都有类似的caps权限信息
	client<span class="token punctuation">.</span>admin具备的权限是非常多的
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看制定的认证信息
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph auth get osd<span class="token punctuation">.</span>0
<span class="token namespace">[osd.0]</span>
        key = AQCv3i9j34BWKhAAII3+THENuLJTv5Yr2NwDxA==
        caps mgr = <span class="token string">&quot;allow profile osd&quot;</span>
        caps mon = <span class="token string">&quot;allow profile osd&quot;</span>
        caps osd = <span class="token string">&quot;allow *&quot;</span>
exported keyring <span class="token keyword">for</span> osd<span class="token punctuation">.</span>0
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看秘钥文件信息
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ <span class="token function">ls</span> <span class="token operator">/</span>etc/ceph/
ceph<span class="token punctuation">.</span>client<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>keyring  ceph<span class="token punctuation">.</span>conf  rbdmap  tmpr0oj5H
	
查看秘钥环相关的信息
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ <span class="token function">cat</span> <span class="token operator">/</span>etc/ceph/ceph<span class="token punctuation">.</span>client<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>keyring
<span class="token namespace">[client.admin]</span>
        key = AQAr0S9jK8RNLxAAD/xpDZgnAx1kQEV3+<span class="token operator">/</span>utWw==
        caps mds = <span class="token string">&quot;allow *&quot;</span>
        caps mgr = <span class="token string">&quot;allow *&quot;</span>
        caps mon = <span class="token string">&quot;allow *&quot;</span>
        caps osd = <span class="token string">&quot;allow *&quot;</span>
注意：
	一个秘钥环里面可以存放很多秘钥信息的
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>列出用户秘钥信息
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph auth print-key mgr<span class="token punctuation">.</span>mon01
AQC12C9j/hAgKhAA6lOZiUpz5kqA55PFv3eHng==
</code></pre></div><p><strong>小结</strong></p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div><h3 id="_1-1-3-用户实践"><a href="#_1-1-3-用户实践" class="header-anchor">#</a> 1.1.3 用户实践</h3> <p>学习目标</p> <p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p> <p><strong>基础知识</strong></p> <p>简介</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	在ceph中，针对用户主要有两种场景：增删和导出导入
</code></pre></div><p>命令解析</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>添加用户
	ceph auth add：创建用户、生成密钥并添加指定的caps
	ceph auth <span class="token function">get-or</span><span class="token operator">-</span>create：创建用户并返回密钥文件格式的密钥信息，用户存在时返回密钥信息
	ceph auth <span class="token function">get-or</span><span class="token operator">-</span>create-key：创建用户并返回密钥信息，用户存在时返回密钥信息

注意：
	典型的用户至少对 Ceph monitor 具有读取功能，并对 Ceph OSD 具有读取和写入功能；
	另外，用户的 OSD 权限通常应该限制为只能访问特定的存储池，
	否则，他将具有访问集群中所有存储池的权限
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>导入用户
	命令：ceph auth import

修改用户caps
	命令：ceph auth caps
		会覆盖用户现有的caps，因此建立事先使用ceph auth get <span class="token function">TYPE</span><span class="token punctuation">.</span>ID命令查看用户的caps
	若是为添加caps，则需要先指定现有的caps<span class="token punctuation">,</span>命令格式如下：
		ceph auth caps <span class="token function">TYPE</span><span class="token punctuation">.</span>ID daemon <span class="token string">'allow [r|w|x|*|...] [pool=pool-name]'</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

删除用户
	命令：ceph auth <span class="token function">del</span> <span class="token function">TYPE</span><span class="token punctuation">.</span>ID
</code></pre></div><p><strong>简单实践</strong></p> <p>添加用户</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>查看帮助信息
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph auth <span class="token operator">--</span>help

 General usage:
 ==============
usage: ceph <span class="token punctuation">[</span><span class="token operator">-</span>h<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span>c CEPHCONF<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span>i INPUT_FILE<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span>o OUTPUT_FILE<span class="token punctuation">]</span>
            <span class="token punctuation">[</span><span class="token operator">--</span>setuser SETUSER<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span>setgroup SETGROUP<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span>id CLIENT_ID<span class="token punctuation">]</span>
            <span class="token punctuation">[</span><span class="token operator">--</span>name CLIENT_NAME<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span>cluster CLUSTER<span class="token punctuation">]</span>
            <span class="token punctuation">[</span><span class="token operator">--</span>admin-daemon ADMIN_SOCKET<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span>s<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span>w<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span><span class="token function">watch-debug</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span><span class="token operator">--</span><span class="token function">watch-info</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span><span class="token function">watch-sec</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span><span class="token function">watch-warn</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span><span class="token function">watch-error</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span><span class="token operator">--</span><span class="token function">watch-channel</span> <span class="token punctuation">{</span>cluster<span class="token punctuation">,</span>audit<span class="token punctuation">,</span><span class="token operator">*</span><span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span>version<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span>verbose<span class="token punctuation">]</span>
            <span class="token punctuation">[</span><span class="token operator">--</span>concise<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span>f <span class="token punctuation">{</span>json<span class="token punctuation">,</span>json-pretty<span class="token punctuation">,</span>xml<span class="token punctuation">,</span>xml-pretty<span class="token punctuation">,</span>plain<span class="token punctuation">}</span><span class="token punctuation">]</span>
            <span class="token punctuation">[</span><span class="token operator">--</span><span class="token function">connect-timeout</span> CLUSTER_TIMEOUT<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span>block<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span>period PERIOD<span class="token punctuation">]</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>创建普通用户
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph auth add client<span class="token punctuation">.</span>testuser mon <span class="token string">'allow r'</span> osd <span class="token string">'allow rw pool=rdbpool'</span>
added key <span class="token keyword">for</span> client<span class="token punctuation">.</span>testuser

获取创建的用户信息
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph auth get client<span class="token punctuation">.</span>testuser
<span class="token namespace">[client.testuser]</span>
        key = AQDfOTBjsmRaEhAATcpXwDluXBpshy4420/zgg==
        caps mon = <span class="token string">&quot;allow r&quot;</span>
        caps osd = <span class="token string">&quot;allow rw pool=rdbpool&quot;</span>
exported keyring <span class="token keyword">for</span> client<span class="token punctuation">.</span>testuser

列出用户的秘钥信息
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph auth print-key client<span class="token punctuation">.</span>testuser
AQDfOTBjsmRaEhAATcpXwDluXBpshy4420/zgg==
</code></pre></div><p>用户授权</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>修改用户的授权
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph auth caps client<span class="token punctuation">.</span>testuser mon <span class="token string">'allow rw'</span> osd <span class="token string">'allow rw pool=rdbpool1'</span>
updated caps <span class="token keyword">for</span> client<span class="token punctuation">.</span>testuser

查看修改后的授权信息
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph auth get client<span class="token punctuation">.</span>testuser
<span class="token namespace">[client.testuser]</span>
        key = AQDfOTBjsmRaEhAATcpXwDluXBpshy4420/zgg==
        caps mon = <span class="token string">&quot;allow rw&quot;</span>
        caps osd = <span class="token string">&quot;allow rw pool=rdbpool1&quot;</span>
exported keyring <span class="token keyword">for</span> client<span class="token punctuation">.</span>testuser
</code></pre></div><p>导出用户</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>查看导出信息
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph auth export client<span class="token punctuation">.</span>testuser
<span class="token namespace">[client.testuser]</span>
        key = AQDfOTBjsmRaEhAATcpXwDluXBpshy4420/zgg==
        caps mon = <span class="token string">&quot;allow rw&quot;</span>
        caps osd = <span class="token string">&quot;allow rw pool=rdbpool1&quot;</span>
export auth<span class="token punctuation">(</span>key=AQDfOTBjsmRaEhAATcpXwDluXBpshy4420/zgg==<span class="token punctuation">)</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>导出信息到一个备份文件
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph auth export client<span class="token punctuation">.</span>testuser &gt; testuser<span class="token punctuation">.</span>file
export auth<span class="token punctuation">(</span>key=AQDfOTBjsmRaEhAATcpXwDluXBpshy4420/zgg==<span class="token punctuation">)</span>

<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ <span class="token function">cat</span> testuser<span class="token punctuation">.</span>file
<span class="token namespace">[client.testuser]</span>
        key = AQDfOTBjsmRaEhAATcpXwDluXBpshy4420/zgg==
        caps mon = <span class="token string">&quot;allow rw&quot;</span>
        caps osd = <span class="token string">&quot;allow rw pool=rdbpool1&quot;</span>
</code></pre></div><p>删除用户</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>删除用户信息
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph auth <span class="token function">del</span> client<span class="token punctuation">.</span>testuser
updated

查看效果
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph auth get client<span class="token punctuation">.</span>testuser
Error ENOENT: failed to find client<span class="token punctuation">.</span>testuser in keyring
</code></pre></div><p>导入用户</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>导入用户文件
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph auth  import <span class="token operator">-</span>i testuser<span class="token punctuation">.</span>file
imported keyring

查看文件效果
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph auth get client<span class="token punctuation">.</span>testuser
<span class="token namespace">[client.testuser]</span>
        key = AQDfOTBjsmRaEhAATcpXwDluXBpshy4420/zgg==
        caps mon = <span class="token string">&quot;allow rw&quot;</span>
        caps osd = <span class="token string">&quot;allow rw pool=rdbpool1&quot;</span>
exported keyring <span class="token keyword">for</span> client<span class="token punctuation">.</span>testuser
</code></pre></div><p>尝试创建一个未知的用户</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>创建一个已知的用户
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph auth <span class="token function">get-or</span><span class="token operator">-</span>create client<span class="token punctuation">.</span>testuser
<span class="token namespace">[client.testuser]</span>
        key = AQDfOTBjsmRaEhAATcpXwDluXBpshy4420/zgg==
结果显示：
	如果是一个已存在的用户名，则会返回具体的信息，而且不会覆盖现有的用户信息
	
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph auth get client<span class="token punctuation">.</span>testuser
<span class="token namespace">[client.testuser]</span>
        key = AQDfOTBjsmRaEhAATcpXwDluXBpshy4420/zgg==
        caps mon = <span class="token string">&quot;allow rw&quot;</span>
        caps osd = <span class="token string">&quot;allow rw pool=rdbpool1&quot;</span>
exported keyring <span class="token keyword">for</span> client<span class="token punctuation">.</span>testuser
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>创建一个未知的用户
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph auth <span class="token function">get-or</span><span class="token operator">-</span>create client<span class="token punctuation">.</span>testuser2 mon <span class="token string">'allow r'</span> osd <span class="token string">'allow rw pool=rdbpool'</span>
<span class="token namespace">[client.testuser2]</span>
        key = AQAwPDBjHPByABAA+nMEvAXztrzE8FSCZkNGgg==
        
如果从未出现过的用户，则直接创建新的用户
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph auth get client<span class="token punctuation">.</span>testuser2
<span class="token namespace">[client.testuser2]</span>
        key = AQAwPDBjHPByABAA+nMEvAXztrzE8FSCZkNGgg==
        caps mon = <span class="token string">&quot;allow r&quot;</span>
        caps osd = <span class="token string">&quot;allow rw pool=rdbpool&quot;</span>
exported keyring <span class="token keyword">for</span> client<span class="token punctuation">.</span>testuser2
</code></pre></div><p><strong>小结</strong></p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div><h3 id="_1-1-4-秘钥管理"><a href="#_1-1-4-秘钥管理" class="header-anchor">#</a> 1.1.4 秘钥管理</h3> <p>学习目标</p> <p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p> <p><strong>基础知识</strong></p> <p>keyring</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	密钥环文件是“存储机密、密码、密钥、证书并使它们可用于应用程序的组件的集合”。密钥环文件存储一个或多个 Ceph 身份验证密钥以及可能的相关功能规范。

注意：
	每个键都与一个实体名称相关联，形式为 <span class="token punctuation">{</span>client<span class="token punctuation">,</span>mon<span class="token punctuation">,</span>mds<span class="token punctuation">,</span>osd<span class="token punctuation">}</span><span class="token punctuation">.</span>name。
	ceph-authtool 是一个用于创建、查看和修改 Ceph 密钥环文件的实用程序。
</code></pre></div><p>秘钥环文件信息</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>访问Ceph集群时，客户端会于本地查找密钥环，只有，认证成功的对象，才可以正常使用。

默认情况下，Ceph会使用以下四个密钥环名称预设密钥环
	<span class="token operator">/</span>etc/ceph/cluster-name<span class="token punctuation">.</span>user-name<span class="token punctuation">.</span>keyring：保存单个用户的keyring
	<span class="token operator">/</span>etc/ceph/cluster<span class="token punctuation">.</span>keyring：保存多个用户的keyring
	<span class="token operator">/</span>etc/ceph/keyring
	<span class="token operator">/</span>etc/ceph/keyring<span class="token punctuation">.</span>bin
	注意：
		cluster-name是为集群名称，user-name是为用户标识（<span class="token function">TYPE</span><span class="token punctuation">.</span>ID）
		client<span class="token punctuation">.</span>admin用户的在名为ceph的集群上的密钥环文件名为ceph<span class="token punctuation">.</span>client<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>keyring
</code></pre></div><p>keyring的管理</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>创建keyring
	ceph auth add等命令添加的用户还需要额外使用ceph-authtool命令为其创建用户密钥环文件<span class="token punctuation">,</span>ceph客户端通过keyring文件查找用户名并检索密钥
	命令：ceph-authtool <span class="token operator">--</span>create-keyring <span class="token operator">/</span>path/to/kerying
注意
	keyring文件一般应该保存于<span class="token operator">/</span>etc/ceph目录中，以便客户端能自动查找
	创建包含多个用户的keyring文件时，应该使用cluster-name<span class="token punctuation">.</span>keyring作为文件名
	创建仅包含单个用户的kerying文件时，应该使用cluster-name<span class="token punctuation">.</span>user-name<span class="token punctuation">.</span>keyring作为文件名
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>将用户添加至keyring
	可将某个用户从包含多个用户的keyring中导出，并保存于一个专用的keyring文件
	命令：ceph auth get <span class="token function">TYPE</span><span class="token punctuation">.</span>ID <span class="token operator">-</span>o <span class="token operator">/</span>etc/ceph/cluster-name<span class="token punctuation">.</span>user-name<span class="token punctuation">.</span>keyring

	也可将用户的keyring合并至一个统一的keyring文件中
	命令：ceph-authtool <span class="token operator">/</span>etc/ceph/cluster-name<span class="token punctuation">.</span>keyring <span class="token operator">--</span><span class="token function">import-key</span> <span class="token operator">/</span>etc/ceph/clustername<span class="token punctuation">.</span>
user-name<span class="token punctuation">.</span>keyring
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>ceph-authtool命令可直接创建用户、授予caps并创建keyring
	ceph-authtool keyringfile <span class="token punctuation">[</span><span class="token operator">-</span>C <span class="token punctuation">|</span> <span class="token operator">--</span>create-keyring<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span>n <span class="token punctuation">|</span> <span class="token operator">--</span>name entityname<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span>genkey<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token operator">-</span>a <span class="token punctuation">|</span> <span class="token operator">--</span><span class="token function">add-key</span> base64_key<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span>cap <span class="token punctuation">|</span> <span class="token operator">--</span>caps capfile<span class="token punctuation">]</span>
	
注意：
	此种方式添加的用户仅存在于keyring文件中，管理员还需要额外将其添加至Ceph集群上；
	命令： ceph auth add <span class="token function">TYPE</span><span class="token punctuation">.</span>ID <span class="token operator">-</span>i <span class="token operator">/</span>PATH/TO/keyring
</code></pre></div><p><strong>简单实践</strong></p> <p>创建携带秘钥环的账号</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>创建普通格式的用户
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph auth <span class="token function">get-or</span><span class="token operator">-</span>create client<span class="token punctuation">.</span>kube mon <span class="token string">'allow r'</span> osd <span class="token string">'allow * pool=kube'</span>
<span class="token namespace">[client.kube]</span>
        key = AQA11TBjzq6NEhAAF2tyvEY0L+XYMP7IOykkcQ==
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看用户信息
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph auth get client<span class="token punctuation">.</span>kube
<span class="token namespace">[client.kube]</span>
        key = AQA11TBjzq6NEhAAF2tyvEY0L+XYMP7IOykkcQ==
        caps mon = <span class="token string">&quot;allow r&quot;</span>
        caps osd = <span class="token string">&quot;allow * pool=kube&quot;</span>
exported keyring <span class="token keyword">for</span> client<span class="token punctuation">.</span>kube

查看文件
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ <span class="token function">ls</span>
ceph<span class="token punctuation">.</span>bootstrap-mds<span class="token punctuation">.</span>keyring  ceph<span class="token punctuation">.</span>bootstrap-rgw<span class="token punctuation">.</span>keyring  ceph-deploy-ceph<span class="token punctuation">.</span>log
ceph<span class="token punctuation">.</span>bootstrap-mgr<span class="token punctuation">.</span>keyring  ceph<span class="token punctuation">.</span>client<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>keyring   ceph<span class="token punctuation">.</span>mon<span class="token punctuation">.</span>keyring
ceph<span class="token punctuation">.</span>bootstrap-osd<span class="token punctuation">.</span>keyring  ceph<span class="token punctuation">.</span>conf                   testuser<span class="token punctuation">.</span>file                  
结果显示：
	没有生成对应的用户秘钥环文件
</code></pre></div><p>导出秘钥环文件</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>将普通的用户导出为keyring
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph auth get client<span class="token punctuation">.</span>kube <span class="token operator">-</span>o ceph<span class="token punctuation">.</span>client<span class="token punctuation">.</span>kube<span class="token punctuation">.</span>keyring
exported keyring <span class="token keyword">for</span> client<span class="token punctuation">.</span>kube
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看效果
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ll <span class="token operator">*</span>kube*
<span class="token operator">-</span>rw-rw-r-<span class="token operator">-</span> 1 cephadm cephadm 117 9月  26 06:26 ceph<span class="token punctuation">.</span>client<span class="token punctuation">.</span>kube<span class="token punctuation">.</span>keyring
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ <span class="token function">cat</span> ceph<span class="token punctuation">.</span>client<span class="token punctuation">.</span>kube<span class="token punctuation">.</span>keyring
<span class="token namespace">[client.kube]</span>
        key = AQA11TBjzq6NEhAAF2tyvEY0L+XYMP7IOykkcQ==
        caps mon = <span class="token string">&quot;allow r&quot;</span>
        caps osd = <span class="token string">&quot;allow * pool=kube&quot;</span>
</code></pre></div><p>合并秘钥环文件</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>创建要合并的文件
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph-authtool <span class="token operator">--</span>create-keyring cluster<span class="token punctuation">.</span>keyring
creating cluster<span class="token punctuation">.</span>keyring
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ll cluster<span class="token punctuation">.</span>keyring
<span class="token operator">-</span>rw-<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> 1 cephadm cephadm 0 9月  26 06:28 cluster<span class="token punctuation">.</span>keyring

合并要导入的keyring文件
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph-authtool cluster<span class="token punctuation">.</span>keyring <span class="token operator">--</span><span class="token function">import-keyring</span> ceph<span class="token punctuation">.</span>client<span class="token punctuation">.</span>kube<span class="token punctuation">.</span>keyring
importing contents of ceph<span class="token punctuation">.</span>client<span class="token punctuation">.</span>kube<span class="token punctuation">.</span>keyring into cluster<span class="token punctuation">.</span>keyring
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ <span class="token function">cat</span> cluster<span class="token punctuation">.</span>keyring
<span class="token namespace">[client.kube]</span>
        key = AQA11TBjzq6NEhAAF2tyvEY0L+XYMP7IOykkcQ==
        caps mon = <span class="token string">&quot;allow r&quot;</span>
        caps osd = <span class="token string">&quot;allow * pool=kube&quot;</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>再来合并一个用户
c<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph-authtool cluster<span class="token punctuation">.</span>keyring <span class="token operator">--</span><span class="token function">import-keyring</span> ceph<span class="token punctuation">.</span>client<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>keyring
importing contents of ceph<span class="token punctuation">.</span>client<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>keyring into cluster<span class="token punctuation">.</span>keyring

查看合并后效果
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ <span class="token function">cat</span> cluster<span class="token punctuation">.</span>keyring
<span class="token namespace">[client.admin]</span>
        key = AQAr0S9jK8RNLxAAD/xpDZgnAx1kQEV3+<span class="token operator">/</span>utWw==
        caps mds = <span class="token string">&quot;allow *&quot;</span>
        caps mgr = <span class="token string">&quot;allow *&quot;</span>
        caps mon = <span class="token string">&quot;allow *&quot;</span>
        caps osd = <span class="token string">&quot;allow *&quot;</span>
<span class="token namespace">[client.kube]</span>
        key = AQA11TBjzq6NEhAAF2tyvEY0L+XYMP7IOykkcQ==
        caps mon = <span class="token string">&quot;allow r&quot;</span>
        caps osd = <span class="token string">&quot;allow * pool=kube&quot;</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>专用查看keyring的内容
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph-authtool <span class="token operator">-</span>l cluster<span class="token punctuation">.</span>keyring
<span class="token namespace">[client.admin]</span>
        key = AQAr0S9jK8RNLxAAD/xpDZgnAx1kQEV3+<span class="token operator">/</span>utWw==
        caps mds = <span class="token string">&quot;allow *&quot;</span>
        caps mgr = <span class="token string">&quot;allow *&quot;</span>
        caps mon = <span class="token string">&quot;allow *&quot;</span>
        caps osd = <span class="token string">&quot;allow *&quot;</span>
<span class="token namespace">[client.kube]</span>
        key = AQA11TBjzq6NEhAAF2tyvEY0L+XYMP7IOykkcQ==
        caps mon = <span class="token string">&quot;allow r&quot;</span>
        caps osd = <span class="token string">&quot;allow * pool=kube&quot;</span>
</code></pre></div><p><strong>小结</strong></p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div><h2 id="_1-2-rbd接口"><a href="#_1-2-rbd接口" class="header-anchor">#</a> 1.2 RBD接口</h2> <h3 id="_1-2-1-基础知识"><a href="#_1-2-1-基础知识" class="header-anchor">#</a> 1.2.1 基础知识</h3> <p>学习目标</p> <p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p> <p><strong>基础知识</strong></p> <p>简介</p> <p><img src="image/1636089258096.png" alt="1636089258096"></p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	Ceph块设备，也称为RADOS块设备（简称RBD），是一种基于RADOS存储系统支持超配（thin-provisioned）、可伸缩的条带化数据存储系统，它通过librbd库与OSD进行交互。RBD为KVM等虚拟化技术和云OS（如OpenStack和CloudStack）提供高性能和无限可扩展性的存储后端，这些系统依赖于libvirt和QEMU实用程序与RBD进行集成。
</code></pre></div><p>RBD</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>RBD，全称RADOS Block Devices，是一种建构在RADOS存储集群之上为客户端提供块设备接口的存储服务中间层<span class="token punctuation">.</span>
	<span class="token operator">-</span> 这类的客户端包括虚拟化程序KVM（结合qemu）和云的计算操作系统OpenStack和CloudStack等

RBD基于RADOS存储集群中的多个OSD进行条带化，支持存储空间的简配（thinprovisioning）和动态扩容等特性，并能够借助于RADOS集群实现快照、副本和一致性。同时，RBD自身也是RADOS存储集群的客户端，它通过将存储池提供的存储服务抽象为一到多个image（表现为块设备）向客户端提供块级别的存储接口
	<span class="token operator">-</span> RBD支持两种格式的image，不过v1格式因特性较少等原因已经处于废弃状态
	<span class="token operator">-</span> 当前默认使用的为v2格式
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>客户端访问RBD设备的方式有两种
	<span class="token operator">-</span> 通过内核模块rbd<span class="token punctuation">.</span>ko将image映射为节点本地的块设备，相关的设备文件一般为<span class="token operator">/</span>dev/rdb<span class="token comment">#（#为设备编号，例如rdb0等）</span>
	<span class="token operator">-</span> 通过librbd提供的API接口，它支持C/C+<span class="token operator">+</span>和Python等编程语言，qemu即是此类接口的客户端
</code></pre></div><p>操作逻辑</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	RBD接口在ceph环境创建完毕后，就在服务端自动提供了<span class="token punctuation">;</span> 客户端基于librbd库即可将RADOS存储集群用作块设备。不过，RADOS集群体用块设备需要经过一系列的<span class="token string">&quot;额外操作&quot;</span>才能够为客户端提供正常的存储功能。
	这个过程步骤，主要有以下几步：
		<span class="token operator">-</span> 1 创建一个专用的存储池
			ceph osd pool create <span class="token punctuation">{</span>pool-name<span class="token punctuation">}</span> <span class="token punctuation">{</span>pg-num<span class="token punctuation">}</span> <span class="token punctuation">{</span>pgp-num<span class="token punctuation">}</span>
		<span class="token operator">-</span> 2 对存储池启用rbd功能
			ceph osd pool application enable <span class="token punctuation">{</span>pool-name<span class="token punctuation">}</span> rbd
		<span class="token operator">-</span> 3 对存储池进行环境初始化
			rbd pool init <span class="token operator">-</span>p <span class="token punctuation">{</span>pool-name<span class="token punctuation">}</span>
		<span class="token operator">-</span> 4 基于存储池创建专用的磁盘镜像
			rbd create <span class="token operator">--</span>size &lt;megabytes&gt; <span class="token operator">--</span>pool &lt;pool-name&gt; &lt;image-name&gt;
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>其他命令
	存储池中的各image名称需要惟一，“rbd <span class="token function">ls</span>”命令能够列出指定存储池中的image
	rbd <span class="token function">ls</span> <span class="token punctuation">[</span><span class="token operator">-</span>p &lt;pool-name&gt;<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span>format json<span class="token punctuation">|</span>xml<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span>pretty-format<span class="token punctuation">]</span> &lt;pool-name&gt;

	要获取指定image的详细信息，则通常使用“rbd info”命令
	rbd info <span class="token punctuation">[</span><span class="token operator">--</span>pool &lt;pool&gt;<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span>image &lt;image&gt;<span class="token punctuation">]</span>  <span class="token punctuation">[</span><span class="token operator">--</span>format &lt;format&gt;<span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p><strong>简单实践</strong></p> <p>创建专用存储池</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code><span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd pool create rbddata 64
pool <span class="token string">'rbddata'</span> created

注意：
	这里面的pg数量，我们定制为64个
</code></pre></div><p>对存储池启用rbd功能</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>启用存储池的rbd功能
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd pool application enable rbddata rbd
enabled application <span class="token string">'rbd'</span> on pool <span class="token string">'rbddata'</span>
注意：
	如果关闭应用的话，使用disable
	
查看rbc的效果
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd pool application get rbddata
<span class="token punctuation">{</span>
    <span class="token string">&quot;rbd&quot;</span>: <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对存储池进行环境初始化</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>环境初始化
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd pool init <span class="token operator">-</span>p rbddata

查看效果
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd pool stats rbddata
Total Images: 0
Total Snapshots: 0
Provisioned Size: 0 B
</code></pre></div><p>基于存储池创建专用的磁盘镜像</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>创建镜像
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd create img1 <span class="token operator">--</span>size 1024 <span class="token operator">--</span>pool rbddata
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd <span class="token function">ls</span> <span class="token operator">-</span>p rbddata
img1

查看状态
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd pool stats rbddata
Total Images: 1
Total Snapshots: 0
Provisioned Size: 1 GiB
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>注意：
	这个时候，我们创建出来的磁盘影响文件，就可以在客户端上，通过内核机制，直接导入到内核中，在内核中被当成一个磁盘设备来进行使用，样式就是 <span class="token operator">/</span>dev/xxx，然后就可以针对这个rdb磁盘设备，进行各种后续分区、格式化等操作。
</code></pre></div><p>查看磁盘信息</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>查看方法1：
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd info rbddata/img1
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd <span class="token operator">--</span>image img1 <span class="token operator">--</span>pool rbddata info
rbd image <span class="token string">'img1'</span>:
        size 1 GiB in 256 objects
        order 22 <span class="token punctuation">(</span>4 MiB objects<span class="token punctuation">)</span>
        snapshot_count: 0
        id: 3817a3738fac
        block_name_prefix: rbd_data<span class="token punctuation">.</span>3817a3738fac
        format: 2
        features: layering<span class="token punctuation">,</span> exclusive-lock<span class="token punctuation">,</span> object-map<span class="token punctuation">,</span> fast-<span class="token function">diff</span><span class="token punctuation">,</span> deep-flatten
        op_features:
        flags:
        create_timestamp: Mon Sep 26 10:46:25 2062
        access_timestamp: Mon Sep 26 10:46:25 2062
        modify_timestamp: Mon Sep 26 10:46:25 2062
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>size : 就是这个块的大小，即1024MB=1G，1024MB/256 = 4M<span class="token punctuation">,</span>共分成了256个对象<span class="token punctuation">(</span>object<span class="token punctuation">)</span>，每个对象4M。
order 22： 有效范围为12-25。22是个幂编号，4M是22， 8M是23，也就是2^22 bytes = 4MB<span class="token punctuation">,</span> 2^23 bytes = 8MB
block_name_prefix : 这个是块的最重要的属性了，这是每个块在ceph中的唯一前缀编号，有了这个前缀，把主机上的OSD都拔下来带回家，就能复活所有的VM了
format : 格式有两种，1和2
features：当前image启用的功能特性，其值是一个以逗号分隔的字符串列表，例如
        	layering<span class="token punctuation">,</span> exclusive-lock<span class="token punctuation">,</span> object-map
op_features：可选的功能特性；
</code></pre></div><p>磁盘设备的删除</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>删除设备
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd <span class="token function">rm</span> rbddata/img1
Removing image: 100% complete<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>done<span class="token punctuation">.</span>

查看效果
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd <span class="token function">ls</span> <span class="token operator">-</span>p rbddata
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd pool stats rbddata
Total Images: 0
Total Snapshots: 0
Provisioned Size: 0 B

删除存储池
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd pool <span class="token function">rm</span> rbddata rbddata <span class="token operator">--</span>yes-i-really-really-mean-it
pool <span class="token string">'rbddata'</span> removed
</code></pre></div><p><strong>小结</strong></p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div><h3 id="_1-2-2-镜像管理"><a href="#_1-2-2-镜像管理" class="header-anchor">#</a> 1.2.2 镜像管理</h3> <p>学习目标</p> <p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p> <p><strong>基础知识</strong></p> <p>镜像属性</p> <table><thead><tr><th>属性</th> <th>解析</th></tr></thead> <tbody><tr><td>layering</td> <td>分层克隆机制，磁盘的数据分层获取克隆机制</td></tr> <tr><td>striping</td> <td>是否支持数据对象间的数据条带化</td></tr> <tr><td>exclusive-lock</td> <td>排它锁的机制，磁盘应用于多路读写机制场景。限制同时仅能有一个客户端访问当前image</td></tr> <tr><td>object-map</td> <td>对象位图机制，主要用于加速导入、导出及已用容量统计等操作，依赖于exclusive-lock特性</td></tr> <tr><td>fast-diff</td> <td>快照定制机制，快速对比数据差异，便于做快照管理，依赖于object-map特性</td></tr> <tr><td>deep-flatten</td> <td>数据处理机制，解除父子image及快照的依赖关系</td></tr> <tr><td>journaling</td> <td>磁盘日志机制，将image的所有修改操作进行日志化，便于异地备份，依赖于exclusive-lock特性</td></tr> <tr><td>data-pool</td> <td>是否支持将image的数据对象存储于纠删码存储池，主要用于将image的元数据与数据放置于不同的存储池；</td></tr></tbody></table> <p>属性操作</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>镜像功能命令
cephadm@admin:~<span class="token operator">/</span>ceph-cluster$ rbd <span class="token operator">--</span>help <span class="token punctuation">|</span> grep feature
    feature disable                   Disable the specified image feature<span class="token punctuation">.</span>
    feature enable                    Enable the specified image feature<span class="token punctuation">.</span>
</code></pre></div><p><strong>简单实践</strong></p> <p>准备工作</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>创建存储池
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd pool create kube 64 64
pool <span class="token string">'kube'</span> created
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd pool <span class="token function">ls</span>
kube


启动rbd功能
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd pool application enable kube rbd
enabled application <span class="token string">'rbd'</span> on pool <span class="token string">'kube'</span>


rbd环境初始化
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd pool init kube
</code></pre></div><p>创建镜像</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>方法2：通过参数属性方式，创建一个2G的镜像文件
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd create <span class="token operator">--</span>pool super <span class="token operator">--</span>size 2G <span class="token operator">--</span>image vol01

查看镜像
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd <span class="token function">ls</span> <span class="token operator">--</span>pool kube
vol01
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>方法2：通过&lt;image-spec&gt;方式，创建一个2G的镜像文件
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd create <span class="token operator">--</span>size 2G kube/vol02

查看镜像
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd <span class="token function">ls</span> <span class="token operator">--</span>pool kube
vol01
vol02
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看详情信息 <span class="token operator">-</span>l
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd <span class="token function">ls</span> <span class="token operator">--</span>pool kube <span class="token operator">-</span>l
NAME   SIZE   PARENT  FMT  PROT  LOCK
vol01  2 GiB            2
vol02  2 GiB            2

以json格式查看详情 <span class="token operator">--</span>format json <span class="token operator">--</span>pretty-format
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd <span class="token function">ls</span> <span class="token operator">--</span>pool kube <span class="token operator">-</span>l <span class="token operator">--</span>format json <span class="token operator">--</span>pretty-format
<span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        <span class="token string">&quot;image&quot;</span>: <span class="token string">&quot;vol01&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;size&quot;</span>: 2147483648<span class="token punctuation">,</span>
        <span class="token string">&quot;format&quot;</span>: 2
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token string">&quot;image&quot;</span>: <span class="token string">&quot;vol02&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;size&quot;</span>: 2147483648<span class="token punctuation">,</span>
        <span class="token string">&quot;format&quot;</span>: 2
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看镜像属性
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd info kube/vol01
rbd image <span class="token string">'vol01'</span>:
        size 2 GiB in 512 objects
        order 22 <span class="token punctuation">(</span>4 MiB objects<span class="token punctuation">)</span>
        snapshot_count: 0
        id: 386ed735e96b
        block_name_prefix: rbd_data<span class="token punctuation">.</span>386ed735e96b
        format: 2
        features: layering<span class="token punctuation">,</span> exclusive-lock<span class="token punctuation">,</span> object-map<span class="token punctuation">,</span> fast-<span class="token function">diff</span><span class="token punctuation">,</span> deep-flatten
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p>镜像属性</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>禁用磁盘镜像功能
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd feature disable kube/vol01 object-map fast-<span class="token function">diff</span> deep-flatten
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd info <span class="token operator">--</span>pool kube <span class="token operator">--</span>image vol01
rbd image <span class="token string">'vol01'</span>:
        size 2 GiB in 512 objects
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        features: layering<span class="token punctuation">,</span> exclusive-lock
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>启用磁盘镜像功能
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd feature enable kube/vol01 object-map fast-<span class="token function">diff</span>
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd info <span class="token operator">--</span>pool kube <span class="token operator">--</span>image vol01
rbd image <span class="token string">'vol01'</span>:
        size 2 GiB in 512 objects
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        flags: object map invalid<span class="token punctuation">,</span> fast <span class="token function">diff</span> invalid
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p><strong>小结</strong></p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div><h3 id="_1-2-3-镜像实践"><a href="#_1-2-3-镜像实践" class="header-anchor">#</a> 1.2.3 镜像实践</h3> <p>学习目标</p> <p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p> <p><strong>基础知识</strong></p> <p>磁盘使用</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>使用方法1：通过内核级别的ceph模块，将rdb设备提供给相关主机使用
	初始化存储池后，创建image
	最好禁用 object-map，fast-<span class="token function">diff</span>，deep-flatten功能
	需要直接与monitor角色进行通信
		<span class="token operator">-</span> 若存储集群端启用了CephX认证，还需要指定用户名和keyring文件
	使用rdb命令的map子命令，进行磁盘文件的映射
	
注意：
	在客户端上可以通过 rbd showmapped 查看已经映射的image
	在客户端上可以通过 rbd unmap 命令断开已经映射的image
</code></pre></div><p>admin主机管理image镜像文件的权限</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>禁用无效的属性
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd feature disable kube/vol01 object-map fast-<span class="token function">diff</span>
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd info <span class="token operator">--</span>pool kube <span class="token operator">--</span>image vol01
rbd image <span class="token string">'vol01'</span>:
        size 2 GiB in 512 objects
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        features: layering<span class="token punctuation">,</span> exclusive-lock
</code></pre></div><p>映射命令的帮助</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code><span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd help map
usage: rbd map <span class="token punctuation">[</span><span class="token operator">--</span>device-<span class="token function">type</span> &lt;device-<span class="token function">type</span>&gt;<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span>pool &lt;pool&gt;<span class="token punctuation">]</span>
               <span class="token punctuation">[</span><span class="token operator">--</span>namespace &lt;namespace&gt;<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span>image &lt;image&gt;<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span>snap &lt;snap&gt;<span class="token punctuation">]</span>
               <span class="token punctuation">[</span><span class="token operator">--</span><span class="token function">read-only</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span>exclusive<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span>options &lt;options&gt;<span class="token punctuation">]</span>
               &lt;image-or-snap-spec&gt;
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p><strong>简单实践</strong></p> <p>客户端主机安装基本环境</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>客户端主机安装环境
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># yum install ceph ceph-common -y</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看模块效果
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># modinfo ceph</span>
filename:       <span class="token operator">/</span>lib/modules/3<span class="token punctuation">.</span>10<span class="token punctuation">.</span>0-1160<span class="token punctuation">.</span>el7<span class="token punctuation">.</span>x86_64/kernel/fs/ceph/ceph<span class="token punctuation">.</span>ko<span class="token punctuation">.</span>xz
license:        GPL
description:    Ceph filesystem <span class="token keyword">for</span> Linux
author:         Patience Warnick &lt;patience@newdream<span class="token punctuation">.</span>net&gt;
author:         Yehuda Sadeh &lt;yehuda@hq<span class="token punctuation">.</span>newdream<span class="token punctuation">.</span>net&gt;
author:         Sage Weil &lt;sage@newdream<span class="token punctuation">.</span>net&gt;
alias:          fs-ceph
retpoline:      Y
rhelversion:    7<span class="token punctuation">.</span>9
srcversion:     EB765DDC1F7F8219F09D34C
depends:        libceph
intree:         Y
vermagic:       3<span class="token punctuation">.</span>10<span class="token punctuation">.</span>0-1160<span class="token punctuation">.</span>el7<span class="token punctuation">.</span>x86_64 SMP mod_unload modversions
signer:         CentOS Linux kernel signing key
sig_key:        E1:FD:B0:E2:A7:E8:61:A1:D1:CA:80:A2:3D:CF:0D:BA:3A:A4:AD:F5
sig_hashalgo:   sha256
</code></pre></div><p>管理端主机传递相关文件</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>查看认证信息
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph auth get client<span class="token punctuation">.</span>kube
<span class="token namespace">[client.kube]</span>
        key = AQA11TBjzq6NEhAAF2tyvEY0L+XYMP7IOykkcQ==
        caps mon = <span class="token string">&quot;allow r&quot;</span>
        caps osd = <span class="token string">&quot;allow * pool=super&quot;</span>
exported keyring <span class="token keyword">for</span> client<span class="token punctuation">.</span>kube
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ <span class="token function">ls</span> <span class="token operator">*</span>kube*
ceph<span class="token punctuation">.</span>client<span class="token punctuation">.</span>kube<span class="token punctuation">.</span>keyring

传递认证文件
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ sudo scp ceph<span class="token punctuation">.</span>client<span class="token punctuation">.</span>kube<span class="token punctuation">.</span>keyring root@stor06:<span class="token operator">/</span>etc/ceph/
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>传递正常的ceph集群的配置文件
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ sudo scp ceph<span class="token punctuation">.</span>conf root@stor06:<span class="token operator">/</span>etc/ceph/
</code></pre></div><p>客户端简单使用</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>默认情况下，是无法正常连接ceph集群的
root@stor06:~<span class="token comment"># ceph -s</span>
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># ceph -s</span>
2062-09-26 11:05:04<span class="token punctuation">.</span>530 7f7cca27f700 <span class="token operator">-</span>1 auth: unable to find a keyring on <span class="token operator">/</span>etc/ceph/ceph<span class="token punctuation">.</span>client<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>keyring<span class="token punctuation">,</span><span class="token operator">/</span>etc/ceph/ceph<span class="token punctuation">.</span>keyring<span class="token punctuation">,</span><span class="token operator">/</span>etc/ceph/keyring<span class="token punctuation">,</span><span class="token operator">/</span>etc/ceph/keyring<span class="token punctuation">.</span>bin<span class="token punctuation">,</span>: <span class="token punctuation">(</span>2<span class="token punctuation">)</span> No such file or directory
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token namespace">[errno 2]</span> error connecting to the cluster
结果显示：
	默认采用的认证用户是 client<span class="token punctuation">.</span>admin账号，而我们没有。
	
通过<span class="token operator">--</span>user参数，使用指定的用户来访问ceph
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># ceph --user kube -s</span>
  cluster:
    id:     1d4e5773-619a-479d-861a-66ba451ce945
    health: HEALTH_OK
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p>rdb文件的使用</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>查看当前的系统磁盘效果
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># fdisk -l | grep '磁盘 '</span>
磁盘 <span class="token operator">/</span>dev/sda：21<span class="token punctuation">.</span>5 GB<span class="token punctuation">,</span> 21474836480 字节，41943040 个扇区
磁盘 <span class="token operator">/</span>dev/sdb：21<span class="token punctuation">.</span>5 GB<span class="token punctuation">,</span> 21474836480 字节，41943040 个扇区
磁盘 <span class="token operator">/</span>dev/sdc：21<span class="token punctuation">.</span>5 GB<span class="token punctuation">,</span> 21474836480 字节，41943040 个扇区
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>映射远程ceph的磁盘文件到本地
root@stor06:~<span class="token comment"># rbd --user kube map kube/vol01</span>
<span class="token operator">/</span>dev/rbd0

查看效果
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># fdisk -l | grep '磁盘 '</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
磁盘 <span class="token operator">/</span>dev/rbd0：2147 MB<span class="token punctuation">,</span> 2147483648 字节，4194304 个扇区
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>格式化磁盘
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># mkfs.ext4 /dev/rbd0</span>
mke2fs 1<span class="token punctuation">.</span>45<span class="token punctuation">.</span>5 <span class="token punctuation">(</span>07-Jan-2020<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
写入超级块和文件系统账户统计信息： 已完成
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>挂载操作
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># mount /dev/rbd0 /mnt</span>
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># mount | grep rbd</span>
<span class="token operator">/</span>dev/rbd0 on <span class="token operator">/</span>mnt <span class="token function">type</span> ext4 <span class="token punctuation">(</span>rw<span class="token punctuation">,</span>relatime<span class="token punctuation">,</span>stripe=1024<span class="token punctuation">,</span><span class="token keyword">data</span>=ordered<span class="token punctuation">)</span>

尝试使用磁盘文件
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># cp /etc/issue /mnt/</span>
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># cat /mnt/issue</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>卸载操作
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># umount /mnt</span>
</code></pre></div><p>我们还可以在客户端上，使用 rbd命令对rbd设备进行管理</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>客户端挂载操作
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># mount /dev/rbd0 /mnt</span>

确认效果
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># rbd showmapped</span>
id pool namespace image snap device
0  kube           vol01 <span class="token operator">-</span>    <span class="token operator">/</span>dev/rbd0
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>主服务器上，查看挂载效果
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd <span class="token function">ls</span> <span class="token operator">--</span>pool kube <span class="token operator">-</span>l
NAME  SIZE  PARENT FMT PROT LOCK
vol01 2 GiB          2      excl
vol02 2 GiB          2
</code></pre></div><p>磁盘卸载操作</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>卸载操作
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># rbd unmap /dev/rbd0</span>
rbd: sysfs <span class="token function">write</span> failed
rbd: unmap failed: <span class="token punctuation">(</span>16<span class="token punctuation">)</span> Device or resource busy

卸载磁盘
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># umount /mnt</span>
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># rbd unmap /dev/rbd0</span>

查看挂载效果
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># rbd showmapped</span>

主节点查看挂载效果
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd <span class="token function">ls</span> <span class="token operator">--</span>pool kube <span class="token operator">-</span>l
NAME   SIZE   PARENT  FMT  PROT  LOCK
vol01  2 GiB            2
vol02  2 GiB            2
</code></pre></div><p><strong>小结</strong></p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div><h3 id="_1-2-4-容量管理"><a href="#_1-2-4-容量管理" class="header-anchor">#</a> 1.2.4 容量管理</h3> <p>学习目标</p> <p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p> <p><strong>基础知识</strong></p> <p>容量</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>如果有必要的话，我们可以针对镜像文件的大小进行容量的调整。
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd help resize
usage: rbd resize <span class="token punctuation">[</span><span class="token operator">--</span>pool &lt;pool&gt;<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span>namespace &lt;namespace&gt;<span class="token punctuation">]</span>
                  <span class="token punctuation">[</span><span class="token operator">--</span>image &lt;image&gt;<span class="token punctuation">]</span> <span class="token operator">--</span>size &lt;size&gt; <span class="token punctuation">[</span><span class="token operator">--</span>allow-shrink<span class="token punctuation">]</span>
                  <span class="token punctuation">[</span><span class="token operator">--</span>no-progress<span class="token punctuation">]</span>
                  &lt;image-spec&gt;
</code></pre></div><p>调整image的大小</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>增大：
	rbd resize <span class="token punctuation">[</span><span class="token operator">--</span>pool &lt;pool&gt;<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span>image &lt;image&gt;<span class="token punctuation">]</span> <span class="token operator">--</span>size &lt;size&gt;
减少：
	rbd resize <span class="token punctuation">[</span><span class="token operator">--</span>pool &lt;pool&gt;<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span>image &lt;image&gt;<span class="token punctuation">]</span> <span class="token operator">--</span>size &lt;size&gt; <span class="token punctuation">[</span><span class="token operator">--</span>allow-shrink<span class="token punctuation">]</span>
</code></pre></div><p>删除image</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>命令格式
	rbd remove <span class="token punctuation">[</span><span class="token operator">--</span>pool &lt;pool&gt;<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span>image &lt;image&gt;<span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
	注意：
		删除image会导致数据丢失，且不可恢复；
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>	如果删除一些敏感的image，为了保险，推荐使用回收站功能trash，确定不再需要时再从trash中删除；
命令格式：
	rbd trash <span class="token punctuation">{</span>list<span class="token punctuation">|</span><span class="token function">move</span><span class="token punctuation">|</span>purge<span class="token punctuation">|</span>remove<span class="token punctuation">|</span>restore<span class="token punctuation">}</span>
</code></pre></div><p><strong>简单实践</strong></p> <p>image的容量扩展</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>查看当前的image容量
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd <span class="token function">ls</span> <span class="token operator">-</span>p kube <span class="token operator">-</span>l
NAME   SIZE   PARENT  FMT  PROT  LOCK
vol01  2 GiB            2
vol02  2 GiB            2

调整image容量
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd resize <span class="token operator">-</span>s 5G kube/vol01
Resizing image: 100% complete<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>done<span class="token punctuation">.</span>

再次确认image容量大小
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd <span class="token function">ls</span> <span class="token operator">-</span>p kube <span class="token operator">-</span>l
NAME   SIZE   PARENT  FMT  PROT  LOCK
vol01  5 GiB            2
vol02  2 GiB            2
</code></pre></div><p>image容量的缩小</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>调整image容量
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd resize <span class="token operator">-</span>s 3G kube/vol01 <span class="token operator">--</span>allow-shrink
Resizing image: 100% complete<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>done<span class="token punctuation">.</span>

再次确认image容量大小
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd <span class="token function">ls</span> <span class="token operator">-</span>p kube <span class="token operator">-</span>l
NAME   SIZE   PARENT  FMT  PROT  LOCK
vol01  3 GiB            2
vol02  2 GiB            2
</code></pre></div><p>删除image文件</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>删除image文件
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd <span class="token function">rm</span> kube/vol02
Removing image: 100% complete<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>done<span class="token punctuation">.</span>

查看image文件效果
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd <span class="token function">ls</span> <span class="token operator">-</span>p kube <span class="token operator">-</span>l
NAME   SIZE   PARENT  FMT  PROT  LOCK
vol01  3 GiB            2
注意：
	image文件的删除是不可修复的
</code></pre></div><p>image文件恢复</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>查看trash命令帮助
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd trash <span class="token operator">--</span>help <span class="token punctuation">|</span> grep trash
    trash list <span class="token punctuation">(</span>trash <span class="token function">ls</span><span class="token punctuation">)</span>             List trash images<span class="token punctuation">.</span>
    trash <span class="token function">move</span> <span class="token punctuation">(</span>trash <span class="token function">mv</span><span class="token punctuation">)</span>             <span class="token function">Move</span> an image to the trash<span class="token punctuation">.</span>
    trash purge                       Remove all expired images <span class="token keyword">from</span> trash<span class="token punctuation">.</span>
    trash remove <span class="token punctuation">(</span>trash <span class="token function">rm</span><span class="token punctuation">)</span>           Remove an image <span class="token keyword">from</span> trash<span class="token punctuation">.</span>
    trash restore                     Restore an image <span class="token keyword">from</span> trash<span class="token punctuation">.</span>
</code></pre></div><p>简介</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>查看回收站
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd trash <span class="token function">ls</span> <span class="token operator">-</span>p kube

移动文件到回收站
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd trash <span class="token function">move</span> kube/vol01

查看回收站
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd trash <span class="token function">ls</span> <span class="token operator">-</span>p kube
386ed735e96b vol01

查看文件
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd <span class="token function">ls</span> <span class="token operator">-</span>p kube <span class="token operator">-</span>l
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>恢复image文件
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd trash restore <span class="token operator">-</span>p kube <span class="token operator">--</span>image vol01 <span class="token operator">--</span>image-id 386ed735e96b

查看回收站
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd trash <span class="token function">ls</span> <span class="token operator">-</span>p kube

查看image文件
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd <span class="token function">ls</span> <span class="token operator">-</span>p kube <span class="token operator">-</span>l
NAME  SIZE  PARENT FMT PROT LOCK
vol01 3 GiB          2
</code></pre></div><p><strong>小结</strong></p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div><h3 id="_1-2-5-快照管理"><a href="#_1-2-5-快照管理" class="header-anchor">#</a> 1.2.5 快照管理</h3> <p>学习目标</p> <p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p> <p><strong>基础知识</strong></p> <p>快照</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	RBD支持image快照技术，借助于快照可以保留image的状态历史。Ceph还支持快照“分层”机制，从而可实现快速克隆VM映像。
</code></pre></div><p>常见命令</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>创建快照
	rbd snap create <span class="token punctuation">[</span><span class="token operator">--</span>pool &lt;pool&gt;<span class="token punctuation">]</span> <span class="token operator">--</span>image &lt;image&gt; <span class="token operator">--</span>snap &lt;snap&gt;
	或者 rbd snap create <span class="token punctuation">[</span>&lt;pool-name&gt;<span class="token operator">/</span><span class="token punctuation">]</span>&lt;image-name&gt;@&lt;snapshot-name&gt;
注意：
	在创建映像快照之前应停止image上的IO操作，且image上存在文件系统时，还要确保其处于一致状态；
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>列出快照
	rbd snap <span class="token function">ls</span> <span class="token punctuation">[</span><span class="token operator">--</span>pool &lt;pool&gt;<span class="token punctuation">]</span> <span class="token operator">--</span>image &lt;image&gt; <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>回滚快照
	rbd snap rollback <span class="token punctuation">[</span><span class="token operator">--</span>pool &lt;pool&gt;<span class="token punctuation">]</span> <span class="token operator">--</span>image &lt;image&gt; <span class="token operator">--</span>snap &lt;snap&gt; <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
注意：
	意味着会使用快照中的数据重写当前版本的image，回滚所需的时间将随映像大小的增加而延长
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>限制快照数量
	快照数量过多，必然会导致image上的原有数据第一次修改时的IO压力恶化
	rbd snap limit <span class="token function">set</span> <span class="token punctuation">[</span><span class="token operator">--</span>pool &lt;pool&gt;<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span>image &lt;image&gt;<span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

解除限制
	rbd snap limit clear <span class="token punctuation">[</span><span class="token operator">--</span>pool &lt;pool&gt;<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span>image &lt;image&gt;<span class="token punctuation">]</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>删除快照
	rbd snap <span class="token function">rm</span> <span class="token punctuation">[</span><span class="token operator">--</span>pool &lt;pool&gt;<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span>image &lt;image&gt;<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span>snap &lt;snap&gt;<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span>no-progress<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token operator">--</span>force<span class="token punctuation">]</span>
提示：
	Ceph OSD会以异步方式删除数据，因此删除快照并不能立即释放磁盘空间<span class="token punctuation">;</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>清理快照
	删除一个image的所有快照，可以使用rbd snap purge命令
	rbd snap purge <span class="token punctuation">[</span><span class="token operator">--</span>pool &lt;pool&gt;<span class="token punctuation">]</span> <span class="token operator">--</span>image &lt;image&gt; <span class="token punctuation">[</span><span class="token operator">--</span>no-progress<span class="token punctuation">]</span>
</code></pre></div><p><strong>简单实践</strong></p> <p>查看快照命令</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code><span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd <span class="token operator">--</span>help <span class="token punctuation">|</span> grep <span class="token string">'  snap '</span>
    snap create <span class="token punctuation">(</span>snap add<span class="token punctuation">)</span>            Create a snapshot<span class="token punctuation">.</span>
    snap limit clear                  Remove snapshot limit<span class="token punctuation">.</span>
    snap limit <span class="token function">set</span>                    Limit the number of snapshots<span class="token punctuation">.</span>
    snap list <span class="token punctuation">(</span>snap <span class="token function">ls</span><span class="token punctuation">)</span>               Dump list of image snapshots<span class="token punctuation">.</span>
    snap protect                      Prevent a snapshot <span class="token keyword">from</span> being deleted<span class="token punctuation">.</span>
    snap purge                        Delete all unprotected snapshots<span class="token punctuation">.</span>
    snap remove <span class="token punctuation">(</span>snap <span class="token function">rm</span><span class="token punctuation">)</span>             Delete a snapshot<span class="token punctuation">.</span>
    snap rename                       Rename a snapshot<span class="token punctuation">.</span>
    snap rollback <span class="token punctuation">(</span>snap revert<span class="token punctuation">)</span>       Rollback image to snapshot<span class="token punctuation">.</span>
    snap unprotect                    Allow a snapshot to be deleted<span class="token punctuation">.</span>
</code></pre></div><p>客户端准备rbd文件</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>客户端挂载rbd文件
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># rbd --user kube map kube/vol01</span>
<span class="token operator">/</span>dev/rbd0

查看效果
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># rbd showmapped</span>
id  pool  namespace  image  snap  device
0   kube             vol01  <span class="token operator">-</span>     <span class="token operator">/</span>dev/rbd0

挂载操作
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># mount /dev/rbd0 /mnt</span>
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># ls /mnt/</span>
issue  lost+found
结果显示：
	虽然容量调整过了，但是就有的文件仍然存在
</code></pre></div><p>管理端创建快照</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>查看快照
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd snap list kube/vol01

创建快照
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd snap create kube/vol01@snap01

查看快照
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd snap list kube/vol01
SNAPID NAME   SIZE  PROTECTED TIMESTAMP
     4 snap01 3 GiB           Mon Sep 26 11:34:20 2062
</code></pre></div><p>恢复快照动作</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>客户端将文件删除
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># ls /mnt/</span>
issue  lost+found
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># rm -f /mnt/issue</span>
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># ls /mnt/</span>
lost+found

客户端解除磁盘的占用
root@stor06:~<span class="token comment"># umount /mnt</span>
root@stor06:~<span class="token comment"># rbd unmap /dev/rbd0</span>
root@stor06:~<span class="token comment"># rbd showmapped</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>服务端恢复快照
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd snap rollback kube/vol01@snap01
Rolling back to snapshot: 100% complete<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>done<span class="token punctuation">.</span>

客户端重新加载磁盘文件
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># rbd --user kube map kube/vol01</span>
<span class="token operator">/</span>dev/rbd0
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># mount /dev/rbd0 /mnt</span>
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># ls /mnt/</span>
issue  lost+found
结果显示：
	快照数据恢复过来了
</code></pre></div><p>删除快照</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>删除之前查看效果
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd snap list kube/vol01
SNAPID NAME   SIZE  PROTECTED TIMESTAMP
     4 snap01 3 GiB           Mon Sep 26 11:34:20 2062
     
删除快照
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd snap <span class="token function">rm</span> kube/vol01@snap01
Removing snap: 100% complete<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>done<span class="token punctuation">.</span>

确认删除效果
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd snap list kube/vol01
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ 
</code></pre></div><p>快照数量的限制</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>设定快照数量的限制
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd snap limit <span class="token function">set</span> <span class="token operator">--</span>pool kube <span class="token operator">--</span>image vol01 <span class="token operator">--</span>limit 5

确认效果
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd snap create kube/vol01@snap01
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd snap create kube/vol01@snap06
rbd: failed to create snapshot: <span class="token punctuation">(</span>122<span class="token punctuation">)</span> Disk quota exceeded

解除快照限制
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd snap limit clear <span class="token operator">--</span>pool kube <span class="token operator">--</span>image vol01

确认效果
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd snap create kube/vol01@snap06
Creating snap: 100% complete<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>done<span class="token punctuation">.</span>
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd snap list kube/vol01
SNAPID NAME   SIZE  PROTECTED TIMESTAMP
     6 snap01 3 GiB           Mon Sep 26 11:38:25 2022
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    13 snap06 3 GiB           Mon Sep 26 11:39:07 2022
</code></pre></div><p>清理所有快照</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>清理所有快照
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd snap purge <span class="token operator">--</span>pool kube <span class="token operator">--</span>image vol01

确认效果
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd snap list kube/vol01
</code></pre></div><p><strong>小结</strong></p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div><h3 id="_1-2-6-快照分层"><a href="#_1-2-6-快照分层" class="header-anchor">#</a> 1.2.6 快照分层</h3> <p>学习目标</p> <p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p> <p><strong>基础知识</strong></p> <p>简介</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	Ceph支持在一个块设备快照的基础上创建一到多个COW或COR（<span class="token function">Copy-On</span><span class="token operator">-</span>Read）类型的克隆，这种中间快照层机制提了一种极速创建image的方式<span class="token punctuation">.</span>用户可以创建一个基础image并为其创建一个只读快照层，而后可以在此快照层上创建任意个克隆进行读写操作，甚至能够进行多级克隆
	
例如:
	实践中可以为Qemu虚拟机创建一个image并安装好基础操作系统环境作为模板，对其创建创建快照层后，便可按需创建任意多个克隆作为image提供给多个不同的VM（虚拟机）使用，或者每创建一个克隆后进行按需修改，而后对其再次创建下游的克隆<span class="token punctuation">.</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>	通过克隆生成的image在其功能上与直接创建的image几乎完全相同，它同样支持读、写、克隆、空间扩缩容等功能，惟一的不同之处是克隆引用了一个只读的上游快照，而且此快照必须要置于“保护”模式之下
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>Ceph的快照支持COW和COR两种类型
	COW是为默认的类型，仅在数据首次写入时才需要将它复制到克隆的image中
	COR则是在数据首次被读取时复制到当前克隆中，随后的读写操作都将直接基于此克隆中的对象进行
</code></pre></div><p>分层快照使用</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>在RBD上使用分层克隆的方法非常简单：
	创建一个image，对image创建一个快照并将其置入保护模式，而克隆此快照即可
	
创建克隆的image时，
	需要指定引用的存储池、镜像和镜像快照，以及克隆的目标image的存储池和镜像名称，
	因此，克隆镜像支持跨存储池进行
</code></pre></div><p><img src="image/image-20211210111915782.png" alt="image-20211210111915782"></p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>简单来说，这里的快照分层，主要说的就是：
	基础的模板快照和特有应用快照
</code></pre></div><p>命令实践</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>保护上游的原始快照
	下游image需要引用上游快照中的数据，快照的意外删除必将导致数据服务的中止，因此在克隆操作之外，必须将上游的快照置于保护模式
	rbd snap protect <span class="token punctuation">[</span><span class="token operator">--</span>pool &lt;pool&gt;<span class="token punctuation">]</span> <span class="token operator">--</span>image &lt;image&gt; <span class="token operator">--</span>snap &lt;snap&gt;
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>克隆快照
	rbd clone <span class="token punctuation">[</span><span class="token operator">--</span>pool &lt;pool&gt;<span class="token punctuation">]</span> <span class="token operator">--</span>image &lt;image&gt; <span class="token operator">--</span>snap &lt;snap&gt; <span class="token operator">--</span>dest-pool &lt;dest-pool&gt; <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	rbd clone <span class="token punctuation">[</span>&lt;pool-name&gt;<span class="token operator">/</span><span class="token punctuation">]</span>&lt;image-name&gt;@&lt;snapshot-name&gt; <span class="token punctuation">[</span>&lt;pool-name&gt;<span class="token operator">/</span><span class="token punctuation">]</span>&lt;image-name&gt;
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>列出快照的子项
	rbd children <span class="token punctuation">[</span><span class="token operator">--</span>pool &lt;pool&gt;<span class="token punctuation">]</span> <span class="token operator">--</span>image &lt;image&gt; <span class="token operator">--</span>snap &lt;snap&gt;
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>展平克隆的image
	克隆的映像会保留对父快照的引用，删除子克隆对父快照的引用时，可通过将信息从快照复制到克隆，进行image的“展平”操作
	展平克隆所需的时间随着映像大小的增加而延长
	要删除某拥有克隆子项的快照，必须先平展其子image
	命令： rbd flatten <span class="token punctuation">[</span><span class="token operator">--</span>pool &lt;pool&gt;<span class="token punctuation">]</span> <span class="token operator">--</span>image &lt;image&gt; <span class="token operator">--</span>no-progress
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>取消快照保护
	必须先取消保护快照，然后才能删除它
	用户无法删除克隆所引用的快照，需要先平展其每个克隆，然后才能删除快照
	命令：rbd snap unprotect <span class="token punctuation">[</span><span class="token operator">--</span>pool &lt;pool&gt;<span class="token punctuation">]</span> <span class="token operator">--</span>image &lt;image&gt; <span class="token operator">--</span>snap &lt;snap&gt;
</code></pre></div><p><strong>简单实践</strong></p> <p>清理环境</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>在客户端将磁盘取消应用
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># umount /mnt</span>
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># rbd unmap /dev/rbd0</span>
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># rbd showmapped</span>
</code></pre></div><p>服务端定制基础快照</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>定制基础快照
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd snap create kube/vol01@clonetpl01
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd snap <span class="token function">ls</span> kube/vol01
SNAPID NAME       SIZE  PROTECTED TIMESTAMP
    20 clonetpl01 3 GiB           Mon Sep 26 11:42:51 2062
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>将快照置于保护模式
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd snap protect kube/vol01@clonetpl01
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd snap <span class="token function">ls</span> kube/vol01
SNAPID NAME       SIZE  PROTECTED TIMESTAMP
    20 clonetpl01 3 GiB yes       Mon Sep 26 11:42:51 2062
结果显示：
	该快照已经被处于保护模式了
</code></pre></div><p>基于快照来进行克隆操作</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>基于基础模板克隆一个镜像
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd clone kube/vol01@clonetpl01 kube/myimg01
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd clone kube/vol01@clonetpl01 kube/myimg02

查看效果
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd <span class="token function">ls</span> <span class="token operator">-</span>p kube
myimg01
myimg02
vol01

查看模板镜像的所有子镜像文件
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd children kube/vol01@clonetpl01
kube/myimg01
kube/myimg02
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>客户端尝试应用一下clone文件
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># rbd --user kube map kube/myimg01</span>
<span class="token operator">/</span>dev/rbd0

查看效果
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># rbd showmapped</span>
id pool namespace image   snap device
0  kube           myimg01 <span class="token operator">-</span>    <span class="token operator">/</span>dev/rbd0

挂载操作
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># mount /dev/rbd0 /mnt</span>
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># ls /mnt</span>
issue  lost+found
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># echo myimg1 &gt;&gt; /mnt/issue</span>
结果显示：
	该clone镜像文件可以正常的使用
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>客户端再次应用clone文件
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># rbd --user kube map kube/myimg02</span>
<span class="token operator">/</span>dev/rbd1

查看效果
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># rbd showmapped</span>
id pool namespace image   snap device
0  kube           myimg01 <span class="token operator">-</span>    <span class="token operator">/</span>dev/rbd0
1  kube           myimg02 <span class="token operator">-</span>    <span class="token operator">/</span>dev/rbd1

挂载操作
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># mkdir /mnt1</span>
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># mount /dev/rbd1 /mnt1</span>
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># cat /mnt1/issue</span>
\S
Kernel \r on an \m
结果显示：
	多个clone镜像文件可以独立的正常使用
</code></pre></div><p>卸载操作</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>客户端卸载myimg02
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># umount /mnt1</span>
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># rbd unmap kube/myimg02</span>

管理端删除image镜像
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd <span class="token function">rm</span> kube/myimg02
Removing image: 100% complete<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>done<span class="token punctuation">.</span>
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd children kube/vol01@clonetpl01
kube/myimg01
</code></pre></div><p>展平快照文件</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	如果我们要删除底层的模板快照文件，为了避免对上层镜像的文件产生不好的影响，我们可以将底层快照的文件转移到上层clone文件中一份，这个动作叫展平快照文件
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>展平数据
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd flatten kube/myimg01
Image flatten: 100% complete<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>done<span class="token punctuation">.</span>

取消保护基础快照模板文件
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd snap unprotect kube/vol01@clonetpl01

移除底层的模板文件
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd snap <span class="token function">rm</span> kube/vol01@clonetpl01
Removing snap: 100% complete<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>done<span class="token punctuation">.</span>

查看效果
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd snap <span class="token function">ls</span> kube/vol01
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ 
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>在客户端上不影响子clone文件的操作
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># ls /mnt</span>
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># cat /mnt/issue</span>
</code></pre></div><p><strong>小结</strong></p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div><h3 id="_1-2-7-rbd实践"><a href="#_1-2-7-rbd实践" class="header-anchor">#</a> 1.2.7 RBD实践</h3> <p>学习目标</p> <p>这一节，我们从 案例需求、简单实践、小结 三个方面来学习。</p> <p><strong>基础知识</strong></p> <p>简介</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	ceph提供的块存储能够可以为其他虚拟机提供磁盘设备来进行使用，所以接下来我们准备将ceph的磁盘文件提供给kvm进行使用。
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>	我们需要按照如下的步骤来进行相关的实践：
		1 kvm环境和ceph环境准备
		2 ceph和kvm认证集成
		3 kvm到ceph中创建镜像文件
		4 启动kvm虚拟机测试ceph磁盘使用效果
</code></pre></div><p>准备系统文件</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>获取镜像文件
mkdir <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>images/ &amp;&amp; cd <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>images/
wget http:<span class="token operator">/</span><span class="token operator">/</span>download<span class="token punctuation">.</span>cirros-cloud<span class="token punctuation">.</span>net/0<span class="token punctuation">.</span>5<span class="token punctuation">.</span>2/cirros-0<span class="token punctuation">.</span>5<span class="token punctuation">.</span>2-x86_64-disk<span class="token punctuation">.</span>img
</code></pre></div><p>部署kvm环境</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>判断CPU是否支持硬件虚拟化
<span class="token namespace">[root@stor05 ~]</span><span class="token comment"># egrep '(vmx|svm)' --color=always /proc/cpuinfo | wc -l</span>
2

检查kvm模块是否加载
<span class="token namespace">[root@stor05 ~]</span><span class="token comment"># lsmod | grep kvm</span>
kvm_intel             188740  0
kvm                   637289  1 kvm_intel
irqbypass              13503  1 kvm
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>安装软件
<span class="token namespace">[root@stor05 ~]</span><span class="token comment"># yum install -y virt-manager libvirt qemu-kvm kvm</span>
注意：
	libvirt 虚拟机管理
	virt 虚拟机安装克隆
	qemu-kvm 管理虚拟机磁盘
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>启动服务
systemctl <span class="token function">start</span> libvirtd<span class="token punctuation">.</span>service

确认效果
systemctl status libvirtd<span class="token punctuation">.</span>service
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看虚拟网络
<span class="token namespace">[root@stor05 ~]</span><span class="token comment"># virsh net-list</span>
 名称               状态     自动开始  持久
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
 default              活动     是           是

查看虚拟主机
<span class="token namespace">[root@stor05 ~]</span><span class="token comment"># virsh list</span>
 Id    名称                         状态
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
</code></pre></div><p>部署ceph环境</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>安装ceph软件
<span class="token namespace">[root@stor05 ~]</span><span class="token comment"># yum install ceph ceph-common -y</span>
</code></pre></div><p><strong>简单实践</strong></p> <p>确认kvm环境支持rdb磁盘</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>内置的qemu-kvm包已经支持RBD块设备
<span class="token namespace">[root@stor05 ~]</span><span class="token comment"># qemu-img --help | grep rbd</span>
Supported formats: vvfat vpc vmdk vhdx vdi ssh sheepdog rbd <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token namespace">[root@stor05 ~]</span><span class="token comment"># ldd /usr/libexec/qemu-kvm | grep rbd</span>
        librbd<span class="token punctuation">.</span>so<span class="token punctuation">.</span>1 =&gt; <span class="token operator">/</span>lib64/librbd<span class="token punctuation">.</span>so<span class="token punctuation">.</span>1 <span class="token punctuation">(</span>0x00007f9badca9000<span class="token punctuation">)</span>
        
结果显示：
	qemu-kvm具备访问RBD的能力。
</code></pre></div><p>ceph创建专属的pool和秘钥</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>Ceph建立一个Pool，
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd pool create superopsmsb 16 16
pool <span class="token string">'superopsmsb'</span> created

启动rbd功能
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd pool application enable superopsmsb rbd
enabled application <span class="token string">'rbd'</span> on pool <span class="token string">'superopsmsb'</span>

rbd环境初始化
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rbd pool init superopsmsb
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>创建superopsmsb的pool专属认证权限
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph auth <span class="token function">get-or</span><span class="token operator">-</span>create client<span class="token punctuation">.</span>superopsmsb mon <span class="token string">'allow r'</span> osd <span class="token string">'allow class-read object_prefix rbd_children, allow rwx pool=superopsmsb'</span>
<span class="token namespace">[client.superopsmsb]</span>
        key = AQD5JzFjymapKxAASoWCRgp/yQt4dFGRmZDI8w==
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>创建专属用户的秘钥文件
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph auth get client<span class="token punctuation">.</span>superopsmsb <span class="token operator">-</span>o ceph<span class="token punctuation">.</span>client<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>keyring
exported keyring <span class="token keyword">for</span> client<span class="token punctuation">.</span>superopsmsb
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>传递认证文件
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ sudo scp ceph<span class="token punctuation">.</span>client<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>keyring root@stor05:<span class="token operator">/</span>etc/ceph/
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ sudo scp ceph<span class="token punctuation">.</span>client<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>keyring root@stor05:<span class="token operator">/</span>etc/ceph/

传递正常的ceph集群的配置文件
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ sudo scp ceph<span class="token punctuation">.</span>conf root@stor05:<span class="token operator">/</span>etc/ceph/
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>确认效果
<span class="token namespace">[root@stor05 ~]</span><span class="token comment"># ceph --user superopsmsb -s</span>
  cluster:
    id:     1d4e5773-619a-479d-861a-66ba451ce945
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p>kvm 集成ceph</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>创建认证文件 ceph-client-superopsmsb-secret<span class="token punctuation">.</span>xml
&lt;secret ephemeral=<span class="token string">'no'</span> private=<span class="token string">'no'</span>&gt;
	&lt;usage <span class="token function">type</span>=<span class="token string">'ceph'</span>&gt; 
		&lt;name&gt;client<span class="token punctuation">.</span>superopsmsb secret&lt;<span class="token operator">/</span>name&gt;
	&lt;<span class="token operator">/</span>usage&gt;
&lt;<span class="token operator">/</span>secret&gt;
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>使用virsh创建secret
<span class="token namespace">[root@stor05 /data/conf]</span><span class="token comment"># virsh secret-define --file ceph-client-superopsmsb-secret.xml</span>
生成 secret caf4336b-d2de-4699-8aee-94569531559b
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>将ceph的client<span class="token punctuation">.</span>superopsmsb的密钥导⼊secret中
<span class="token namespace">[root@stor05 /data/conf]</span><span class="token comment"># virsh secret-set-value --secret caf4336b-d2de-4699-8aee-94569531559b --base64 $(ceph auth get-key client.superopsmsb)</span>
secret 值设定

确认效果
<span class="token namespace">[root@stor05 /data/conf]</span><span class="token comment"># virsh secret-list</span>
 UUID                                  用量
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
 caf4336b-d2de-4699-8aee-94569531559b  ceph client<span class="token punctuation">.</span>superopsmsb secret
</code></pre></div><p>镜像创建</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>创建空的image，或者导⼊已经的磁盘镜像内容
方法1：导入镜像
qemu-img convert <span class="token operator">-</span>f qcow2 <span class="token operator">-</span>O raw <span class="token operator">/</span>path/to/image<span class="token punctuation">.</span>img rbd:&lt;pool-name&gt;<span class="token operator">/</span>&lt;image-name&gt;
方法2：创建镜像
qemu-img xxx create <span class="token operator">-</span>f rbd rbd:&lt;pool-name&gt;<span class="token operator">/</span>&lt;image-name&gt; size
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>创建镜像
<span class="token namespace">[root@stor05 /data/conf]</span><span class="token comment"># qemu-img create -f rbd rbd:superopsmsb/superopsmsb-image 1G</span>
Formatting <span class="token string">'rbd:superopsmsb/superopsmsb-image'</span><span class="token punctuation">,</span> fmt=rbd size=10737418240 cluster_size=0
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>确认镜像文件
<span class="token namespace">[root@stor05 /data/conf]</span><span class="token comment"># qemu-img info /data/images/cirros-0.5.2-x86_64-disk.img</span>
image: cirros-0<span class="token punctuation">.</span>5<span class="token punctuation">.</span>2-x86_64-disk<span class="token punctuation">.</span>img
file format: qcow2
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

导入镜像文件到rdb
<span class="token namespace">[root@stor05 /data/conf]</span><span class="token comment"># qemu-img convert -f qcow2 -O raw /data/images/cirros-0.5.2-x86_64-disk.img rbd:superopsmsb/cirros-0.5.2</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>确认效果
<span class="token namespace">[root@stor05 ~]</span><span class="token comment"># rbd --user superopsmsb ls superopsmsb -l</span>
NAME              SIZE    PARENT FMT PROT LOCK
cirros-0<span class="token punctuation">.</span>5<span class="token punctuation">.</span>2      112 MiB          2
superopsmsb-image  10 GiB          2
注意：
	因为是远程查看，所以信息展示有可能缓慢，我们可以直接在admin主机上进行快速查看
</code></pre></div><p>虚拟机创建</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>定制虚拟机配置文件 <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>conf/node1<span class="token punctuation">.</span>xml
&lt;domain <span class="token function">type</span>=<span class="token string">'kvm'</span>&gt;
  &lt;name&gt;node1&lt;<span class="token operator">/</span>name&gt;
  &lt;memory unit=<span class="token string">'KiB'</span>&gt;512000&lt;<span class="token operator">/</span>memory&gt;
  &lt;currentMemory unit=<span class="token string">'KiB'</span>&gt;512000&lt;<span class="token operator">/</span>currentMemory&gt;
  &lt;vcpu placement=<span class="token string">'static'</span>&gt;1&lt;<span class="token operator">/</span>vcpu&gt;
  &lt;os&gt;
    &lt;<span class="token function">type</span> arch=<span class="token string">'x86_64'</span>&gt;hvm&lt;<span class="token operator">/</span><span class="token function">type</span>&gt;
  &lt;<span class="token operator">/</span>os&gt;
  &lt;devices&gt;
    &lt;emulator&gt;<span class="token operator">/</span>usr/libexec/qemu-kvm&lt;<span class="token operator">/</span>emulator&gt;
    &lt;disk <span class="token function">type</span>=<span class="token string">'network'</span> device=<span class="token string">'disk'</span>&gt;
      &lt;source protocol=<span class="token string">'rbd'</span> name=<span class="token string">'superopsmsb/cirros-0.5.2'</span>&gt;
        &lt;host name=<span class="token string">'mon01'</span> port=<span class="token string">'6789'</span> <span class="token operator">/</span>&gt;
      &lt;<span class="token operator">/</span>source&gt;
      &lt;auth username=<span class="token string">'superopsmsb'</span>&gt;
        &lt;secret <span class="token function">type</span>=<span class="token string">'ceph'</span> uuid=<span class="token string">'caf4336b-d2de-4699-8aee-94569531559b'</span><span class="token operator">/</span>&gt;
      &lt;<span class="token operator">/</span>auth&gt;
      &lt;target dev=<span class="token string">'vda'</span> bus=<span class="token string">'virtio'</span><span class="token operator">/</span>&gt;
    &lt;<span class="token operator">/</span>disk&gt;
    &lt;interface <span class="token function">type</span>=<span class="token string">'network'</span>&gt;
      &lt;mac address=<span class="token string">'52:54:01:74:1c:9e'</span><span class="token operator">/</span>&gt;
      &lt;source network=<span class="token string">'default'</span><span class="token operator">/</span>&gt;
      &lt;model <span class="token function">type</span>=<span class="token string">'virtio'</span><span class="token operator">/</span>&gt;
    &lt;<span class="token operator">/</span>interface&gt;
    &lt;serial <span class="token function">type</span>=<span class="token string">'pty'</span>&gt;
      &lt;target <span class="token function">type</span>=<span class="token string">'isa-serial'</span> port=<span class="token string">'0'</span>&gt;
        &lt;model name=<span class="token string">'isa-serial'</span><span class="token operator">/</span>&gt;
      &lt;<span class="token operator">/</span>target&gt;
    &lt;<span class="token operator">/</span>serial&gt;
    &lt;console <span class="token function">type</span>=<span class="token string">'pty'</span>&gt;
      &lt;target <span class="token function">type</span>=<span class="token string">'serial'</span> port=<span class="token string">'0'</span><span class="token operator">/</span>&gt;
    &lt;<span class="token operator">/</span>console&gt;
    &lt;graphics <span class="token function">type</span>=<span class="token string">'vnc'</span> port=<span class="token string">'-1'</span> autoport=<span class="token string">'yes'</span>&gt;
      &lt;listen <span class="token function">type</span>=<span class="token string">'address'</span> address=<span class="token string">'0.0.0.0'</span><span class="token operator">/</span>&gt;
    &lt;<span class="token operator">/</span>graphics&gt;
  &lt;<span class="token operator">/</span>devices&gt;
&lt;<span class="token operator">/</span>domain&gt;
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>创建虚拟机
<span class="token namespace">[root@stor05 /data/conf]</span><span class="token comment"># virsh define node1.xml</span>
定义域 node1（从 node1<span class="token punctuation">.</span>xml）
<span class="token namespace">[root@stor05 /data/conf]</span><span class="token comment"># virsh start node1</span>
域 node1 已开始
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看主机状态
<span class="token namespace">[root@stor05 /data/conf]</span><span class="token comment"># virsh list --all</span>
 Id    名称                         状态
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
 2     node1                          running

查看设备信息
<span class="token namespace">[root@stor05 /data/conf]</span><span class="token comment"># virsh domblklist node1</span>
目标     源
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
vda        superopsmsb/cirros-0<span class="token punctuation">.</span>5<span class="token punctuation">.</span>2

可以借助于vnc viewer 连接到虚拟机查看效果
注意：
	启动很慢，但是运行需要等待3分钟左右
</code></pre></div><p>磁盘挂载</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>关闭虚拟机
<span class="token namespace">[root@stor05 /data/conf]</span><span class="token comment"># virsh destroy node1</span>
域 node1 被删除
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>编写专有设备文件 device<span class="token punctuation">.</span>xml 
&lt;disk <span class="token function">type</span>=<span class="token string">'network'</span> device=<span class="token string">'disk'</span>&gt;
  &lt;driver name=<span class="token string">'qemu'</span> <span class="token function">type</span>=<span class="token string">'raw'</span><span class="token operator">/</span>&gt;
  &lt;auth username=<span class="token string">'superopsmsb'</span>&gt;
    &lt;secret <span class="token function">type</span>=<span class="token string">'ceph'</span> uuid=<span class="token string">'caf4336b-d2de-4699-8aee-94569531559b'</span><span class="token operator">/</span>&gt;
  &lt;<span class="token operator">/</span>auth&gt;
  &lt;source protocol=<span class="token string">'rbd'</span> name=<span class="token string">'superopsmsb/superopsmsb-image'</span>&gt;
    &lt;host name=<span class="token string">'mon01'</span> port=<span class="token string">'6789'</span><span class="token operator">/</span>&gt;
  &lt;<span class="token operator">/</span>source&gt;
  &lt;target dev=<span class="token string">'vdc'</span> bus=<span class="token string">'virtio'</span><span class="token operator">/</span>&gt;
&lt;<span class="token operator">/</span>disk&gt;
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>将设备追加到虚拟机中
<span class="token namespace">[root@stor05 /data/conf]</span><span class="token comment"># virsh attach-device node1 device.xml --persistent</span>
成功附加设备

确认磁盘挂载效果
<span class="token namespace">[root@stor05 /data/conf]</span><span class="token comment"># virsh domblklist node1</span>
目标     源
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
vda        superopsmsb/cirros-0<span class="token punctuation">.</span>5<span class="token punctuation">.</span>2
vdc        superopsmsb/superopsmsb-image
</code></pre></div><p>环境还原</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>删除虚拟机
<span class="token namespace">[root@stor05 /data/conf]</span><span class="token comment"># virsh undefine node1</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>删除pool
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd pool <span class="token function">rm</span> superopsmsb superopsmsb <span class="token operator">--</span>yes-i-really-really-mean-it
pool <span class="token string">'superopsmsb'</span> removed
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd pool <span class="token function">rm</span> kube kube  <span class="token operator">--</span>yes-i-really-really-mean-it
pool <span class="token string">'kube'</span> removed
</code></pre></div><p><strong>小结</strong></p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div><h2 id="_1-3-rgw接口"><a href="#_1-3-rgw接口" class="header-anchor">#</a> 1.3 RGW接口</h2> <h3 id="_1-3-1-基础知识"><a href="#_1-3-1-基础知识" class="header-anchor">#</a> 1.3.1 基础知识</h3> <p>学习目标</p> <p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p> <p><strong>基础知识</strong></p> <p>OSS简介</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>对象存储<span class="token punctuation">(</span>Object Storage<span class="token punctuation">)</span> 是无层次结构的数据存储方法，通常用于云计算环境中。不同于其他数据存储方法，基于对象的存储不使用目录树
	数据作为单独的对象进行存储
	数据并不放置在目录层次结构中，而是存在于平面地址空间内的同一级别
	应用通过唯一地址来识别每个单独的数据对象
	每个对象可包含有助于检索的元数据
	专为使用API在应用级别（而非用户级别）进行访问而设计
</code></pre></div><p>对象</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>对象是对象存储系统中数据存储的基本单位，每个Object是数据和数据属性集的综合体，数据属性可以根据应用的需求进行设置，包括数据分布、服务质量等
	每个对象自我维护其属性，从而简化了存储系统的管理任务
	对象的大小可以不同，甚至可以包含整个数据结构，如文件、数据库表项等
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>对象存储系统一般是一类智能设备，它具有自己的存储介质、处理器、内存以及网络系统等，负责管理本地的对象，是对象存储系统的核心<span class="token punctuation">.</span>
</code></pre></div><p><img src="image/image-20220926182809531.png" alt="image-20220926182809531"></p> <p>术语解析</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>一般说来，一个对象存储系统的核心资源类型应该包括用户（User）、存储桶（ bucket）和对象（object）
它们之间的关系是：
	<span class="token operator">-</span> User将Object存储到存储系统上的Bucket
	<span class="token operator">-</span> 存储桶属于某个用户并可以容纳对象，一个存储桶用于存储多个对象
	<span class="token operator">-</span> 同一个用户可以拥有多个存储桶，不同用户允许使用相同名称的bucket
</code></pre></div><p><img src="image/image-20211210163113908.png" alt="image-20211210163113908"></p> <p>常见方案</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>各种存储方案，虽然在设计与实现上有所区别，但大多数对象存储系统对外呈现的核心资源类型大同小异
</code></pre></div><table><thead><tr><th>方案</th> <th>描述</th></tr></thead> <tbody><tr><td>Amazon S3</td> <td>提供了user、bucket和object分别表示用户、存储桶和对象，其中bucket隶属于user，因此user名称即可做为bucket的名称空间，不同用户允许使用相同名称的bucket</td></tr> <tr><td>OpenStack Swift</td> <td>提供了user、container和object分别对应于用户、存储桶和对象，不过它还额外为user提供了父级组件account，用于表示一个项目或租户，因此一个account中可包含一到多个user，它们可共享使用同一组container，并为container提供名称空间</td></tr> <tr><td>RadosGW</td> <td>提供了user、subuser、bucket和object，其中的user对应于S3的user，而subuser则对应于Swift的user，不过user和subuser都不支持为bucket提供名称空间，因此 ，不同用户的存储桶也不允许同名；不过，自Jewel版本起，RadosGW引入了tenant（租户）用于为user和bucket提供名称空间，但它是个可选组件<br>Jewel版本之前，radosgw的所有user位于同一名称空间，它要求所有user的ID必须惟一，并且即便是不同user的bucket也不允许使用相同的bucket ID</td></tr></tbody></table> <p><strong>简单实践</strong></p> <p>简介</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	Ceph对象存储使用Ceph对象网关守护进程（radosgw），它是用于与Ceph存储群集进行交互的HTTP服务器。由于它提供与OpenStack Swift和Amazon S3兼容的接口，因此Ceph对象网关具有自己的用户管理。Ceph对象网关可以将数据存储在用于存储来自Ceph文件系统客户端或Ceph块设备客户端的数据的同一Ceph存储群集中。S3和Swift API共享一个公共的名称空间，因此可以使用一个API编写数据，而使用另一个API检索数据。
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>Ceph RGW基于librados，是为应用提供RESTful类型的对象存储接口。RGW提供两种类型的接口：
　　1<span class="token punctuation">)</span> S3：兼容Amazon S3RESTful API；
　　2<span class="token punctuation">)</span> Swift：兼容OpenStack Swift API。
　　
同时，RGW为了实现RESTful接口的功能，默认使用Civetweb作为其Web Sevice，而Civetweb默认使用端口7480提供服务，如果想修改端口（如80端口），就需要修改Ceph的配置文件。
</code></pre></div><p>要点</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>RGW在创建的时候，自动会初始化自己的存储池，而且RGW还需要自己独有的守护进程服务才可以正常的使用

RGW并非必须的接口，仅在需要用到与S3和Swift兼容的RESTful接口时才需要部署RGW实例
</code></pre></div><p><img src="image/image-20220926220715586.png" alt="image-20220926220715586"></p> <p>RGW内部逻辑处理层级结构图</p> <p><img src="image/image-20220928111659491.png" alt="image-20220928111659491"></p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>HTTP 前端: 
	接收数据操作请求。
REST API接口：
	从http请求中解析出 S3 或 Swift 数据并进行一系列检查。
API操作逻辑:
	经Restful 接口检查通过后，根据内部业务逻辑交由不同业务模块进行数据处理。
RADOS接口：
	如果需要写入或者操作ceph集群数据，则经由RADOS <span class="token operator">+</span> librados 调用将数据发送给集群的后端主机
</code></pre></div><p>常见属性</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	自0<span class="token punctuation">.</span>80版本起，Ceph放弃了基于apache和fastcgi提供radosgw服务的传统而代之以默认嵌入在ceph-radosgw进程中的Citeweb，这种新的实现方式更加轻便和简洁，但直到Ceph 11<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1版本，Citeweb才开始支持SSL协议<span class="token punctuation">.</span>
	
	Citeweb默认监听于TCP协议的7480端口提供http服务，修改配置需要编辑ceph<span class="token punctuation">.</span>conf配置文件，以如下格式进行定义
	<span class="token namespace">[client.rgw.&lt;gateway-node&gt;]</span>
	rgw_host = &lt;hostname OR ipaddr&gt;
	rgw_frontends = <span class="token string">&quot;civetweb port=80&quot;</span>
	
	配置完成后需要重启ceph-radosgw进程以生效新配置
	ceph-radosgw@rgw<span class="token punctuation">.</span>&lt;gateway-node&gt;
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>其他相关的配置 
配置https
	额外添加参数ssl_certificate=<span class="token operator">/</span>PATH/TO/PEM_FILE
	定义port=443s，或者port=80+443s

其它配置参数
	num_threads：Citeweb以线程模型处理客户端请求，它为每个连接请求分配一个专用线
程，因而此参数定义了其支持的最大并发连接数，默认值为50
	request_timeout_ms：网络发送与接收操作的超时时长，以ms为单位，默认值为30000
；可以在必要时通过增大此值实现长连接的效果
	access_log_file：访问日志的文件路径，默认为空
	error_log_file：错误日志的文件路径，默认为空
	rgw_dns_name： 定制专属的dns服务解析域名
</code></pre></div><p><strong>小结</strong></p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div><h3 id="_1-3-2-基础操作"><a href="#_1-3-2-基础操作" class="header-anchor">#</a> 1.3.2 基础操作</h3> <p>学习目标</p> <p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p> <p><strong>基础知识</strong></p> <p>部署RGW主机</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>到stor04主机上的部署ceph环境
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># yum install -y ceph-radosgw</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>admin节点上，创建rgw的主机环境
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph-deploy rgw create stor04
<span class="token namespace">[ceph_deploy.conf]</span><span class="token namespace">[DEBUG ]</span> found configuration file at: <span class="token operator">/</span>home/cephadm/<span class="token punctuation">.</span>cephdeploy<span class="token punctuation">.</span>conf
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token namespace">[ceph_deploy.rgw]</span><span class="token namespace">[INFO  ]</span> The Ceph Object Gateway <span class="token punctuation">(</span>RGW<span class="token punctuation">)</span> is now running on host stor04 and default port 7480
</code></pre></div><p>查看效果</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>查看集群的状态
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph <span class="token operator">-</span>s
  cluster:
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  services:
    mon: 3 daemons<span class="token punctuation">,</span> quorum mon01<span class="token punctuation">,</span>mon02<span class="token punctuation">,</span>mon03 <span class="token punctuation">(</span>age 3h<span class="token punctuation">)</span>
    mgr: mon01<span class="token punctuation">(</span>active<span class="token punctuation">,</span> since 30h<span class="token punctuation">)</span><span class="token punctuation">,</span> standbys: mon02
    osd: 6 osds: 6 up <span class="token punctuation">(</span>since 26h<span class="token punctuation">)</span><span class="token punctuation">,</span> 6 in <span class="token punctuation">(</span>since 26h<span class="token punctuation">)</span>
    rgw: 1 daemon active <span class="token punctuation">(</span>stor04<span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看服务状况
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># netstat -tnulp | grep radosgw</span>
tcp        0      0 0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0:7480   0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0:<span class="token operator">*</span>  LISTEN      4295/radosgw
tcp6       0      0 :::7480        :::<span class="token operator">*</span>       LISTEN      4295/radosgw

查看服务进程
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># ps aux | grep -v grep | grep radosgw</span>
ceph       4295  0<span class="token punctuation">.</span>5  2<span class="token punctuation">.</span>1 5145976 39612 ?       Ssl  18:37   0:00 <span class="token operator">/</span>usr/bin/radosgw <span class="token operator">-</span>f <span class="token operator">--</span>cluster ceph <span class="token operator">--</span>name client<span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>stor04 <span class="token operator">--</span>setuser ceph <span class="token operator">--</span>setgroup ceph
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>RGW会在rados集群上生成包括如下存储池的一系列存储池
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd pool <span class="token function">ls</span>
<span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>root
default<span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>control
default<span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>meta
default<span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>log
结果显示：
	默认情况下，rgw自动创建4个存储池
</code></pre></div><p>RGW提供了一个简单的web接口，用于数据的交流</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>web访问接口
	RGW提供的是REST接口，客户端通过http与其进行交互，完成数据的增删改查等管理操作。浏览器查看 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>16:7480 的web简单应用效果
</code></pre></div><p><img src="image/image-20211206115942508.png" alt="image-20211206115942508"></p> <p><strong>简单实践</strong></p> <p>更改端口实践</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>默认情况下，RGW实例监听于TCP协议的7480端口7480，需要定制的话，可以通过在运行RGW的节点上编辑其主配置文件ceph<span class="token punctuation">.</span>conf进行修改，相关参数如下所示：
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># cat /etc/ceph/ceph.conf</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token namespace">[client.rgw.stor04]</span>
rgw_frontends = <span class="token string">&quot;civetweb port=8080&quot;</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>重启服务
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># systemctl restart ceph-radosgw@rgw.stor04</span>
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># systemctl status ceph-radosgw@rgw.stor04</span>
	
查看效果
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># netstat -tnulp | grep 8080</span>
tcp     0   0 0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0:8080    0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0:<span class="token operator">*</span>    LISTEN  152636/radosgw
</code></pre></div><p><img src="image/image-20211210173544875.png" alt="image-20211210173544875"></p> <p>ssl通信</p> <div class="language- extra-class"><pre class="language-text"><code>需要提供pem证书文件，需要将 证书和私钥文件放在同一个文件里面
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>生成秘钥
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># mkdir /etc/ceph/ssl &amp;&amp; cd /etc/ceph/ssl</span>
<span class="token namespace">[root@stor04 /etc/ceph/ssl]</span><span class="token comment"># openssl genrsa -out civetweb.key 2048</span>

生成证书
<span class="token namespace">[root@stor04 /etc/ceph/ssl]</span><span class="token comment"># openssl req -new -x509 -key civetweb.key -out civetweb.crt -days 3650 -subj &quot;/CN=stor04.superopsmsb.com&quot;</span>
<span class="token namespace">[root@stor04 /etc/ceph/ssl]</span><span class="token comment"># ls</span>
civetweb<span class="token punctuation">.</span>crt  civetweb<span class="token punctuation">.</span>key

合并证书信息
root@stor04:<span class="token operator">/</span>etc/ceph/ssl<span class="token comment"># cat civetweb.key civetweb.crt &gt; civetweb.pem</span>
</code></pre></div><p>修改认证信息</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>在运行RGW的节点上编辑其主配置文件ceph<span class="token punctuation">.</span>conf进行修改，相关参数如下所示：
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># cat /etc/ceph/ceph.conf</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token namespace">[client.rgw.stor04]</span>
rgw_frontends = <span class="token string">&quot;civetweb port=8443s ssl_certificate=/etc/ceph/ssl/civetweb.pem&quot;</span>
注意：
	这里的8443s，最后的s代表必须使用ssl通信方式
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>重启服务
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># systemctl restart ceph-radosgw@rgw.stor04</span>
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># systemctl status ceph-radosgw@rgw.stor04</span>
	
查看效果
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># netstat -tnulp | grep 8443</span>
tcp        0      0 0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0:8443   0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0:<span class="token operator">*</span>     LISTEN      153319/radosgw
</code></pre></div><p><img src="image/image-20211210174100106.png" alt="image-20211210174100106"></p> <p>同时开启 https和http方式来进行访问</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>在运行RGW的节点上编辑其主配置文件ceph<span class="token punctuation">.</span>conf进行修改，相关参数如下所示：
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># cat ceph.conf</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token namespace">[client.rgw.stor04]</span>
rgw_frontends = <span class="token string">&quot;civetweb port=7480+8443s ssl_certificate=/etc/ceph/ssl/civetweb.pem&quot;</span>
注意：
	通过 port+port 的方式实现多端口开启服务
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>重启服务
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># systemctl restart ceph-radosgw@rgw.stor04</span>
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># systemctl status ceph-radosgw@rgw.stor04</span>
	
查看效果
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># netstat -tnulp | grep radosgw</span>
tcp        0      0 0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0:7480   0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0:<span class="token operator">*</span>     LISTEN      153941/radosgw
tcp        0      0 0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0:8443   0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0:<span class="token operator">*</span>     LISTEN      153941/radosgw
</code></pre></div><p><img src="image/image-20211210174340551.png" alt="image-20211210174340551"></p> <p>高并发配置</p> <div class="language- extra-class"><pre class="language-text"><code>对于ceph来说，它内部的高并发主要是通过线程方式定义的，而且默认值是50，如果我们要调整并发数量的话，可以调整num_threads的属性值

配置示例：
	[client.rgw.stor04]
    rgw_frontends = &quot;civetweb port=7480+8443s ssl_certificate=/etc/ceph/ssl/civetweb.pem num_threads=2000&quot;
</code></pre></div><p><strong>小结</strong></p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div><h3 id="_1-3-3-泛域名实践"><a href="#_1-3-3-泛域名实践" class="header-anchor">#</a> 1.3.3 泛域名实践</h3> <p>学习目标</p> <p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p> <p><strong>基础知识</strong></p> <p>简介</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>S3的存储桶是用于存储对象的容器，每个对象都必须储存在一个特定的存储桶中，且每个对象都要直接通过RESTful API基于URL进行访问，URL格式为
	“http<span class="token punctuation">(</span>s<span class="token punctuation">)</span>:<span class="token operator">/</span><span class="token operator">/</span>bucket-name<span class="token punctuation">.</span>radowgw-host<span class="token punctuation">[</span>:port<span class="token punctuation">]</span><span class="token operator">/</span>key”
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>	例如，对于存储在rgw01<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>io上的S3 API对象存储系统上eshop存储桶中的名为images/1<span class="token punctuation">.</span>jpg 的对象，可通过 http:<span class="token operator">/</span><span class="token operator">/</span>eshop<span class="token punctuation">.</span>rgw01<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>io/images/1<span class="token punctuation">.</span>jpg对其进行寻址
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>	因此，radosgw的S3 API接口的功能强依赖于DNS的泛域名解析服务，它必须能够正常解析任何“&lt;bucket-name&gt;<span class="token punctuation">.</span>&lt;radowgw-host&gt;”格式的名称至radosgw主机。
	除此之外，我们还需要配置每个radowgw守护进程的rgw_dns_name为其DNS名称
</code></pre></div><p>dns环境配置</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>安装软件
<span class="token namespace">[root@admin ~]</span><span class="token comment"># yum -y install bind bind-chroot bind-utils bind-libs</span>
备注：
  bind           提供了域名服务的主要程序及相关文件  
  bind-utils     提供了对DNS服务器的测试工具程序（如nslookup、dig等）
  bind-chroot    为bind提供一个伪装的根目录以增强安全性
  
启动服务
<span class="token namespace">[root@admin ~]</span><span class="token comment"># systemctl  start named</span>
<span class="token namespace">[root@admin ~]</span><span class="token comment"># systemctl  status named</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看版本信息
<span class="token namespace">[root@admin ~]</span><span class="token comment"># named -v</span>
BIND 9<span class="token punctuation">.</span>11<span class="token punctuation">.</span>4-P2-RedHat-9<span class="token punctuation">.</span>11<span class="token punctuation">.</span>4-26<span class="token punctuation">.</span>P2<span class="token punctuation">.</span>el7_9<span class="token punctuation">.</span>9 <span class="token punctuation">(</span>Extended Support Version<span class="token punctuation">)</span> &lt;id:7107deb&gt;

查看配置文件
<span class="token namespace">[root@admin ~]</span><span class="token comment"># rpm -ql bind | grep named.conf</span>
<span class="token operator">/</span>etc/named<span class="token punctuation">.</span>conf
<span class="token operator">/</span>usr/lib/tmpfiles<span class="token punctuation">.</span>d/named<span class="token punctuation">.</span>conf
<span class="token operator">/</span>usr/share/doc/bind-9<span class="token punctuation">.</span>11<span class="token punctuation">.</span>4/man<span class="token punctuation">.</span>named<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>html
<span class="token operator">/</span>usr/share/doc/bind-9<span class="token punctuation">.</span>11<span class="token punctuation">.</span>4/named<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>default
<span class="token operator">/</span>usr/share/doc/bind-9<span class="token punctuation">.</span>11<span class="token punctuation">.</span>4/sample/etc/named<span class="token punctuation">.</span>conf
<span class="token operator">/</span>usr/share/man/man5/named<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>5<span class="token punctuation">.</span>gz

查看暴露端口
<span class="token namespace">[root@admin ~]</span><span class="token comment"># netstat -tnulp | grep 53</span>
tcp        0      0 127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:53    0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0:<span class="token operator">*</span>    LISTEN    17563/named
tcp        0      0 127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:953   0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0:<span class="token operator">*</span>    LISTEN    17563/named
tcp6       0      0 ::1:53          :::<span class="token operator">*</span>         LISTEN    17563/named
tcp6       0      0 ::1:953         :::<span class="token operator">*</span>         LISTEN    17563/named
udp        0      0 127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:53    0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0:<span class="token operator">*</span>              17563/named
udp6       0      0 ::1:53          :::<span class="token operator">*</span>                   17563/named
</code></pre></div><p><strong>简单实践</strong></p> <p>定制zone的配置</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>定制正向解析zone的配置
<span class="token namespace">[root@admin ~]</span><span class="token comment"># tail /etc/named.conf -n 9</span>
options <span class="token punctuation">{</span>
        listen-on port 53 <span class="token punctuation">{</span> any<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token operator">/</span><span class="token operator">/</span> 监听任何ip对53端口的请求
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        allow-query     <span class="token punctuation">{</span> any<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token operator">/</span><span class="token operator">/</span> 接收任何来源查询dns记录
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">/</span><span class="token operator">/</span> 定制网站主域名的zone配置
zone <span class="token string">&quot;superopsmsb.com&quot;</span> IN <span class="token punctuation">{</span>
        <span class="token function">type</span> master<span class="token punctuation">;</span>
        file <span class="token string">&quot;superopsmsb.com.zone&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token operator">/</span><span class="token operator">/</span> 定制泛域名网站的zone配置
zone <span class="token string">&quot;stor04.superopsmsb.com&quot;</span> IN <span class="token punctuation">{</span>
        <span class="token function">type</span> master<span class="token punctuation">;</span>
        file <span class="token string">&quot;stor04.superopsmsb.com.zone&quot;</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
include <span class="token string">&quot;/etc/named.rfc1912.zones&quot;</span><span class="token punctuation">;</span>
include <span class="token string">&quot;/etc/named.root.key&quot;</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>定制主域名的zone文件
<span class="token namespace">[root@admin ~]</span><span class="token comment"># cat /var/named/superopsmsb.com.zone</span>
<span class="token punctuation">;</span>
<span class="token punctuation">;</span> BIND reverse <span class="token keyword">data</span> file <span class="token keyword">for</span> local loopback interface
<span class="token punctuation">;</span>
<span class="token variable">$TTL</span>    604800
@       IN      SOA     ns<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com<span class="token punctuation">.</span> admin<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com<span class="token punctuation">.</span> <span class="token punctuation">(</span>
                              1         <span class="token punctuation">;</span> Serial
                         604800         <span class="token punctuation">;</span> Refresh
                          86400         <span class="token punctuation">;</span> Retry
                        2419200         <span class="token punctuation">;</span> Expire
                         604800 <span class="token punctuation">)</span>       <span class="token punctuation">;</span> Negative Cache TTL
<span class="token punctuation">;</span>
        IN      NS      ns
ns      IN      A       10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12
stor02  IN      A       10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>14
stor03  IN      A       10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>15
stor04  IN     NS    ns
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>定制泛域名的zone文件
<span class="token namespace">[root@admin ~]</span><span class="token comment"># cat /var/named/stor04.superopsmsb.com.zone</span>
<span class="token punctuation">;</span>
<span class="token punctuation">;</span> BIND reverse <span class="token keyword">data</span> file <span class="token keyword">for</span> local loopback interface
<span class="token punctuation">;</span>
<span class="token variable">$TTL</span>    604800
@       IN      SOA     ns<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com<span class="token punctuation">.</span> admin<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com<span class="token punctuation">.</span> <span class="token punctuation">(</span>
                              1         <span class="token punctuation">;</span> Serial
                         604800         <span class="token punctuation">;</span> Refresh
                          86400         <span class="token punctuation">;</span> Retry
                        2419200         <span class="token punctuation">;</span> Expire
                         604800 <span class="token punctuation">)</span>       <span class="token punctuation">;</span> Negative Cache TTL
<span class="token punctuation">;</span>
        IN      NS      ns
ns      IN      A       10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12
<span class="token operator">*</span>        IN     A       10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>16
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>检查配置文件
<span class="token namespace">[root@admin ~]</span><span class="token comment"># named-checkconf</span>

重启dns服务
<span class="token namespace">[root@admin ~]</span><span class="token comment"># systemctl restart named</span>
<span class="token namespace">[root@admin ~]</span><span class="token comment"># systemctl status named</span>

定制本地主机专属的dns域名服务器
<span class="token namespace">[root@admin ~]</span><span class="token comment"># cat /etc/resolv.conf</span>
<span class="token comment"># Generated by NetworkManager</span>
search localhost
nameserver 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>确认dns解析效果
[root@admin ~]# host -a stor02.superopsmsb.com
[root@admin ~]# host -a stor02.superopsmsb.com 10.0.0.12
[root@admin ~]# host -a stor02.superopsmsb.com 10.0.0.12
Trying &quot;stor02.superopsmsb.com&quot;
Using domain server:
Name: 10.0.0.12
Address: 10.0.0.12#53
Aliases:
...
;; QUESTION SECTION:
;stor02.superopsmsb.com.                IN      ANY

;; ANSWER SECTION:
stor02.superopsmsb.com. 604800  IN      A       10.0.0.14

;; AUTHORITY SECTION:
superopsmsb.com.        604800  IN      NS      ns.superopsmsb.com.

;; ADDITIONAL SECTION:
ns.superopsmsb.com.     604800  IN      A       10.0.0.12

Received 89 bytes from 10.0.0.12#53 in 0 ms
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code><span class="token namespace">[root@admin ~]</span><span class="token comment"># nslookup stor02.superopsmsb.com </span>
<span class="token namespace">[root@admin ~]</span><span class="token comment"># nslookup stor02.superopsmsb.com 10.0.0.12</span>
Server:         10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12
Address:        10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12<span class="token comment">#53</span>

Name:   stor02<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com
Address: 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>14
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>确认dns解析效果
<span class="token namespace">[root@admin ~]</span><span class="token comment"># dig file.stor04.superopsmsb.com</span>
<span class="token namespace">[root@admin ~]</span><span class="token comment"># dig img.stor04.superopsmsb.com @10.0.0.12</span>

<span class="token punctuation">;</span> &lt;&lt;&gt;&gt; DiG 9<span class="token punctuation">.</span>11<span class="token punctuation">.</span>4-P2-RedHat-9<span class="token punctuation">.</span>11<span class="token punctuation">.</span>4-26<span class="token punctuation">.</span>P2<span class="token punctuation">.</span>el7_9<span class="token punctuation">.</span>9 &lt;&lt;&gt;&gt; img<span class="token punctuation">.</span>stor04<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com @10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> ANSWER SECTION:
img<span class="token punctuation">.</span>stor04<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com<span class="token punctuation">.</span> 604800 IN   A       10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>16

<span class="token punctuation">;</span><span class="token punctuation">;</span> AUTHORITY SECTION:
stor04<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com<span class="token punctuation">.</span> 604800  IN      NS      ns<span class="token punctuation">.</span>stor04<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com<span class="token punctuation">.</span>

<span class="token punctuation">;</span><span class="token punctuation">;</span> ADDITIONAL SECTION:
ns<span class="token punctuation">.</span>stor04<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com<span class="token punctuation">.</span> 604800 IN    A       10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12

<span class="token punctuation">;</span><span class="token punctuation">;</span> Query time: 0 msec
<span class="token punctuation">;</span><span class="token punctuation">;</span> SERVER: 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12<span class="token comment">#53(10.0.0.12)</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> WHEN: 一 9月 26 19:46:57 CST 2022
<span class="token punctuation">;</span><span class="token punctuation">;</span> MSG SIZE  rcvd: 104
</code></pre></div><p>配置rgw存储节点的dns相关配置</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>定制stor04的dns域名配置
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># tail -n4 /etc/ceph/ceph.conf</span>
<span class="token namespace">[client.rgw.stor04]</span>
rgw_host = stor04
rgw_frontends = <span class="token string">&quot;civetweb port=7480+8443s ssl_certificate=/etc/ceph/ssl/civetweb.pem&quot;</span>
rgw_dns_name = stor04<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com
属性解析：
	通过 rgw_dns_name 属性制定当前节点的域名
	
重启当前节点的服务效果
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># systemctl restart ceph-radosgw@rgw.stor04</span>
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># systemctl status ceph-radosgw@rgw.stor04</span>
</code></pre></div><p><strong>小结</strong></p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div><h3 id="_1-3-4-s3测试"><a href="#_1-3-4-s3测试" class="header-anchor">#</a> 1.3.4 S3测试</h3> <p>学习目标</p> <p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p> <p><strong>基础知识</strong></p> <p>S3 API接口简介</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	S3服务的REST API使用用户账号（user）、存储桶（bucket）和对象（object）三个组件来组织存储的数据对象，对象保存于存储桶中，而存储桶则支持授权给特定账号进行读写及创建<span class="token operator">/</span>删除等操作
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>	radosgw-admin是用于管理radowgw服务的命令行接口，它有着众多的分别用于不同管理功能的命令，例如user、subuser、key、bucket和object等
	命令格式：
		radosgw-admin user create <span class="token operator">--</span>uid=<span class="token string">&quot;s3user&quot;</span> <span class="token operator">--</span>display-name=<span class="token string">&quot;S3 Testing User&quot;</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>而后即可通过其API接口进行访问测试，或者使用s3cmd命令进行
<span class="token operator">-</span> 使用s3cmd命令之前需要事先配置其工作环境，包括指定Access Key和Secret Key，以及S3服务的访问端点和默认的Region（Ceph的新版本中称作zonegroup）等
	命令格式：
		s3cmd <span class="token operator">--</span>configure

<span class="token operator">-</span> 配置的结果将保存于~<span class="token operator">/</span><span class="token punctuation">.</span>s3cmd<span class="token punctuation">.</span>cfg配置文件中，用户随后可通过编辑此文件修改配置参数，或者再次运行此配置命令为其指定新的配置信息
	s3cmd有众多的子命令
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>参考资料：
	https:<span class="token operator">/</span><span class="token operator">/</span>docs<span class="token punctuation">.</span>ceph<span class="token punctuation">.</span>com/en/latest/radosgw/s3/python/<span class="token comment">#using-s3-api-extensions</span>
</code></pre></div><p><strong>简单实践</strong></p> <p>S3 API接口专用账号</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>创建专属账号
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ radosgw-admin user create <span class="token operator">--</span>uid=<span class="token string">'s3user'</span> <span class="token operator">--</span>display-name=<span class="token string">'S3 Testing user'</span>
<span class="token punctuation">{</span>
    <span class="token string">&quot;user_id&quot;</span>: <span class="token string">&quot;s3user&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;display_name&quot;</span>: <span class="token string">&quot;S3 Testing user&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;email&quot;</span>: <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;suspended&quot;</span>: 0<span class="token punctuation">,</span>
    <span class="token string">&quot;max_buckets&quot;</span>: 1000<span class="token punctuation">,</span>
    <span class="token string">&quot;subusers&quot;</span>: <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">&quot;keys&quot;</span>: <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token string">&quot;user&quot;</span>: <span class="token string">&quot;s3user&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;access_key&quot;</span>: <span class="token string">&quot;BX2IDCO5ADZ8IWZ4AVX7&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;secret_key&quot;</span>: <span class="token string">&quot;wKXAiBBspTx9kl1NpcAi4eOCHxvQD7ORHnrmvBlf&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看认证用户
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ radosgw-admin user list
<span class="token punctuation">[</span>
    <span class="token string">&quot;s3user&quot;</span>
<span class="token punctuation">]</span>

查看详情
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ radosgw-admin user info <span class="token operator">--</span>uid s3user
<span class="token punctuation">{</span>
    <span class="token string">&quot;user_id&quot;</span>: <span class="token string">&quot;s3user&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token string">&quot;keys&quot;</span>: <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token string">&quot;user&quot;</span>: <span class="token string">&quot;s3user&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;access_key&quot;</span>: <span class="token string">&quot;BX2IDCO5ADZ8IWZ4AVX7&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;secret_key&quot;</span>: <span class="token string">&quot;wKXAiBBspTx9kl1NpcAi4eOCHxvQD7ORHnrmvBlf&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>客户端配置</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>在客户端上安装测试命令 s3cmd
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># yum install s3cmd -y</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>使用s3之前，需要做一些预设的配置
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># s3cmd --configure</span>

Enter new values or accept defaults in brackets with Enter<span class="token punctuation">.</span>
Refer to user manual <span class="token keyword">for</span> detailed description of all options<span class="token punctuation">.</span>

Access key and Secret key are your identifiers <span class="token keyword">for</span> Amazon S3<span class="token punctuation">.</span> Leave them empty <span class="token keyword">for</span> <span class="token keyword">using</span> the env variables<span class="token punctuation">.</span>
<span class="token comment"># 下面的两个属性是来自于之前的账号信息</span>
Access Key: BX2IDCO5ADZ8IWZ4AVX7		
Secret Key: wKXAiBBspTx9kl1NpcAi4eOCHxvQD7ORHnrmvBlf
Default Region <span class="token namespace">[US]</span>:		<span class="token comment"># 此处可以使用默认的</span>

Use <span class="token string">&quot;s3.amazonaws.com&quot;</span> <span class="token keyword">for</span> S3 Endpoint and not modify it to the target Amazon S3<span class="token punctuation">.</span>
<span class="token comment"># 此处的域名是否用，我们自己定义的内容</span>
S3 Endpoint <span class="token namespace">[s3.amazonaws.com]</span>: stor04<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com:7480

Use <span class="token string">&quot;%(bucket)s.s3.amazonaws.com&quot;</span> to the target Amazon S3<span class="token punctuation">.</span> <span class="token string">&quot;%(bucket)s&quot;</span> and <span class="token string">&quot;%(location)s&quot;</span> vars can be used
<span class="token keyword">if</span> the target S3 system supports dns based buckets<span class="token punctuation">.</span>
<span class="token comment"># 关于存储桶的定制，需要使用自己的域名，但是格式一样</span>
DNS-style bucket+hostname:port template <span class="token keyword">for</span> accessing a bucket <span class="token punctuation">[</span><span class="token operator">%</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>s<span class="token punctuation">.</span>s3<span class="token punctuation">.</span>amazonaws<span class="token punctuation">.</span>com<span class="token punctuation">]</span>: <span class="token operator">%</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>s<span class="token punctuation">.</span>stor04<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com:7480

Encryption password is used to protect your files <span class="token keyword">from</span> reading
by unauthorized persons <span class="token keyword">while</span> in transfer to S3
Encryption password:						<span class="token comment"># 这里不需要密码</span>
Path to GPG program <span class="token punctuation">[</span><span class="token operator">/</span>usr/bin/gpg<span class="token punctuation">]</span>:			<span class="token comment"># 使用默认的gpg命令路径</span>

When <span class="token keyword">using</span> secure HTTPS protocol all communication with Amazon S3
servers is protected <span class="token keyword">from</span> 3rd party eavesdropping<span class="token punctuation">.</span> This method is
slower than plain HTTP<span class="token punctuation">,</span> and can only be proxied with Python 2<span class="token punctuation">.</span>7 or newer
Use HTTPS protocol <span class="token namespace">[Yes]</span>: No				<span class="token comment"># 不使用HTTPs协议</span>

On some networks all internet access must go through a HTTP proxy<span class="token punctuation">.</span>
<span class="token keyword">Try</span> setting it here <span class="token keyword">if</span> you can<span class="token string">'t connect to S3 directly
HTTP Proxy server name:						# 不使用代理，因为是本地访问

New settings:
  Access Key: NOF182FGP8Q38CWLZ8WQ
  Secret Key: zP2ZWJPXTsZWQXg2hKY4Wv4OpoolKZEOwfheJlx3
  Default Region: US
  S3 Endpoint: stor04.superopsmsb.com:7480
  DNS-style bucket+hostname:port template for accessing a bucket: %(bucket)s.stor04.superopsmsb.com:7480
  Encryption password:
  Path to GPG program: /usr/bin/gpg
  Use HTTPS protocol: False
  HTTP Proxy server name:
  HTTP Proxy server port: 0

Test access with supplied credentials? [Y/n] Y		# 确认最后的信息
Please wait, attempting to list all buckets...
Success. Your access key and secret key worked fine :-)

Now verifying that encryption works...
Not configured. Never mind.

Save settings? [y/N] y								# 保存信息
Configuration saved to '</span><span class="token operator">/</span>root/<span class="token punctuation">.</span>s3cfg'
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看常见的帮助信息
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># s3cmd</span>
Usage: s3cmd <span class="token namespace">[options]</span> COMMAND <span class="token namespace">[parameters]</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
Commands:
  Make bucket
      s3cmd mb s3:<span class="token operator">/</span><span class="token operator">/</span>BUCKET
  Remove bucket
      s3cmd rb s3:<span class="token operator">/</span><span class="token operator">/</span>BUCKET
  List objects or buckets
      s3cmd <span class="token function">ls</span> <span class="token namespace">[s3://BUCKET[/PREFIX]]</span>
  List all object in all buckets
      s3cmd la
  Put file into bucket
      s3cmd put FILE <span class="token namespace">[FILE...]</span> s3:<span class="token operator">/</span><span class="token operator">/</span>BUCKET<span class="token punctuation">[</span><span class="token operator">/</span>PREFIX<span class="token punctuation">]</span>
  Get file <span class="token keyword">from</span> bucket
      s3cmd get s3:<span class="token operator">/</span><span class="token operator">/</span>BUCKET/OBJECT LOCAL_FILE
  Delete file <span class="token keyword">from</span> bucket
      s3cmd <span class="token function">del</span> s3:<span class="token operator">/</span><span class="token operator">/</span>BUCKET/OBJECT
  Delete file <span class="token keyword">from</span> bucket <span class="token punctuation">(</span>alias <span class="token keyword">for</span> <span class="token function">del</span><span class="token punctuation">)</span>
      s3cmd <span class="token function">rm</span> s3:<span class="token operator">/</span><span class="token operator">/</span>BUCKET/OBJECT
  Restore file <span class="token keyword">from</span> Glacier storage
      s3cmd restore s3:<span class="token operator">/</span><span class="token operator">/</span>BUCKET/OBJECT
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p>域名解析</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>定制专属的dns域名，让客户端找到 stor04<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com 主机名。
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># cat /etc/resolv.conf</span>
<span class="token comment"># Generated by NetworkManager</span>
nameserver 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># nslookup file.stor04.superopsmsb.com 10.0.0.12</span>
Server:         10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12
Address:        10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12<span class="token comment">#53</span>

Name:   file<span class="token punctuation">.</span>stor04<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com
Address: 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>16
</code></pre></div><p>存储桶创建实践</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>创建存储桶
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># s3cmd mb s3://images</span>
Bucket <span class="token string">'s3://images/'</span> created
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># s3cmd mb s3://dir</span>
Bucket <span class="token string">'s3://dir/'</span> created

查看存储桶
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># s3cmd ls</span>
2062-09-26 14:21  s3:<span class="token operator">/</span><span class="token operator">/</span><span class="token function">dir</span>
2062-09-26 13:57  s3:<span class="token operator">/</span><span class="token operator">/</span>images
</code></pre></div><p>文件上传下载实践</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>上传文件到存储桶中，存储同目录可以随意玩耍
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># s3cmd put /etc/issue s3://images/linux/issue</span>
upload: <span class="token string">'/etc/issue'</span> <span class="token operator">-</span>&gt; <span class="token string">'s3://images/linux/issue'</span>  <span class="token punctuation">[</span>1 of 1<span class="token punctuation">]</span>
 23 of 23   100% in    1s    12<span class="token punctuation">.</span>79 B/s  done
 
查看文件对象效果
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># s3cmd ls s3://images/linux</span>
                          <span class="token function">DIR</span>  s3:<span class="token operator">/</span><span class="token operator">/</span>images/linux/
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># s3cmd ls s3://images/linux/issue</span>
2062-09-26 13:58           23  s3:<span class="token operator">/</span><span class="token operator">/</span>images/linux/issue
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>下载文件对象
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># s3cmd get s3://images/linux/issue</span>
download: <span class="token string">'s3://images/linux/issue'</span> <span class="token operator">-</span>&gt; <span class="token string">'./issue'</span>  <span class="token punctuation">[</span>1 of 1<span class="token punctuation">]</span>
 23 of 23   100% in    0s     3<span class="token punctuation">.</span>42 KB/s  done
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># s3cmd get s3://images/linux/issue /tmp/issue-bak</span>
download: <span class="token string">'s3://images/linux/issue'</span> <span class="token operator">-</span>&gt; <span class="token string">'/tmp/issue-bak'</span>  <span class="token punctuation">[</span>1 of 1<span class="token punctuation">]</span>
 23 of 23   100% in    0s     3<span class="token punctuation">.</span>38 KB/s  done
 
查看效果
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># ls</span>
anaconda-ks<span class="token punctuation">.</span>cfg  issue
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># ls /tmp/issue-bak</span>
<span class="token operator">/</span>tmp/issue-bak
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>对于一个大的RGW Object，会被切割成多个独立的RGW Object上传，称为multipart。multipar的优势是断点续传。s3接口默认切割大小为15MB。
<span class="token namespace">[root@stor04 /data/scripts]</span><span class="token comment"># dd if=/dev/zero of=a.txt bs=1M count=60</span>
记录了60+0 的读入
记录了60+0 的写出
62914560字节<span class="token punctuation">(</span>63 MB<span class="token punctuation">)</span>已复制，0<span class="token punctuation">.</span>0495739 秒，1<span class="token punctuation">.</span>3 GB/秒

<span class="token namespace">[root@stor04 /data/scripts]</span><span class="token comment"># ll a.txt</span>
<span class="token operator">-</span>rw-r-<span class="token operator">-</span>r-<span class="token operator">-</span> 1 root root 62914560 9月  27 11:06 a<span class="token punctuation">.</span>txt
<span class="token namespace">[root@stor04 /data/scripts]</span><span class="token comment">#  s3cmd put a.txt s3://images/linux/</span>
upload: <span class="token string">'a.txt'</span> <span class="token operator">-</span>&gt; <span class="token string">'s3://images/linux/a.txt'</span>  <span class="token namespace">[part 1 of 4, 15MB]</span> <span class="token punctuation">[</span>1 of 1<span class="token punctuation">]</span>
 15728640 of 15728640   100% in    0s    25<span class="token punctuation">.</span>99 MB/s  done
upload: <span class="token string">'a.txt'</span> <span class="token operator">-</span>&gt; <span class="token string">'s3://images/linux/a.txt'</span>  <span class="token namespace">[part 2 of 4, 15MB]</span> <span class="token punctuation">[</span>1 of 1<span class="token punctuation">]</span>
 15728640 of 15728640   100% in    0s    27<span class="token punctuation">.</span>90 MB/s  done
upload: <span class="token string">'a.txt'</span> <span class="token operator">-</span>&gt; <span class="token string">'s3://images/linux/a.txt'</span>  <span class="token namespace">[part 3 of 4, 15MB]</span> <span class="token punctuation">[</span>1 of 1<span class="token punctuation">]</span>
 15728640 of 15728640   100% in    0s    28<span class="token punctuation">.</span>93 MB/s  done
upload: <span class="token string">'a.txt'</span> <span class="token operator">-</span>&gt; <span class="token string">'s3://images/linux/a.txt'</span>  <span class="token namespace">[part 4 of 4, 15MB]</span> <span class="token punctuation">[</span>1 of 1<span class="token punctuation">]</span>
 15728640 of 15728640   100% in    0s    31<span class="token punctuation">.</span>85 MB/s  done
</code></pre></div><p>目录上传下载实践</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>准备目录结构
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># mkdir /data/test/{scripts,conf,file} -p</span>
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># touch /data/test/{scripts/{1..4}.sh,conf/{1..3}.conf,file/{1..5}.txt}</span>
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># echo scripts-1 &gt; /data/test/scripts/1.sh</span>
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># echo conf-2 &gt; /data/test/conf/2.conf</span>
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># echo file-5 &gt; /data/test/file/5.txt</span>

上传目录 
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># s3cmd put /data/test/ s3://dir/etc/ --recursive</span>
upload: <span class="token string">'/data/test/conf/1.conf'</span> <span class="token operator">-</span>&gt; <span class="token string">'s3://dir/etc/conf/1.conf'</span>  <span class="token punctuation">[</span>1 of 12<span class="token punctuation">]</span>
 0 of 0     0% in    0s     0<span class="token punctuation">.</span>00 B/s  done
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
upload: <span class="token string">'/data/test/scripts/4.sh'</span> <span class="token operator">-</span>&gt; <span class="token string">'s3://dir/etc/scripts/4.sh'</span>  <span class="token punctuation">[</span>12 of 12<span class="token punctuation">]</span>
 0 of 0     0% in    0s     0<span class="token punctuation">.</span>00 B/s  done
 
查看效果
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># s3cmd ls s3://dir</span>
                          <span class="token function">DIR</span>  s3:<span class="token operator">/</span><span class="token operator">/</span><span class="token function">dir</span><span class="token operator">/</span>etc/
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># s3cmd ls s3://dir/etc				# 查看目录的时候，必须在最后添加/</span>
                          <span class="token function">DIR</span>  s3:<span class="token operator">/</span><span class="token operator">/</span><span class="token function">dir</span><span class="token operator">/</span>etc/
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># s3cmd ls s3://dir/etc/</span>
                          <span class="token function">DIR</span>  s3:<span class="token operator">/</span><span class="token operator">/</span><span class="token function">dir</span><span class="token operator">/</span>etc/conf/
                          <span class="token function">DIR</span>  s3:<span class="token operator">/</span><span class="token operator">/</span><span class="token function">dir</span><span class="token operator">/</span>etc/file/
                          <span class="token function">DIR</span>  s3:<span class="token operator">/</span><span class="token operator">/</span><span class="token function">dir</span><span class="token operator">/</span>etc/scripts/
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># s3cmd ls s3://dir/etc/conf/</span>
2062-09-26 14:23            0  s3:<span class="token operator">/</span><span class="token operator">/</span><span class="token function">dir</span><span class="token operator">/</span>etc/conf/1<span class="token punctuation">.</span>conf
2062-09-26 14:23            7  s3:<span class="token operator">/</span><span class="token operator">/</span><span class="token function">dir</span><span class="token operator">/</span>etc/conf/2<span class="token punctuation">.</span>conf
2062-09-26 14:23            0  s3:<span class="token operator">/</span><span class="token operator">/</span><span class="token function">dir</span><span class="token operator">/</span>etc/conf/3<span class="token punctuation">.</span>conf
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>下载目录对象
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># s3cmd get s3://dir/  --recursive</span>
download: <span class="token string">'s3://dir/etc/conf/1.conf'</span> <span class="token operator">-</span>&gt; <span class="token string">'./etc/conf/1.conf'</span>  <span class="token punctuation">[</span>1 of 12<span class="token punctuation">]</span>
 0 of 0     0% in    0s     0<span class="token punctuation">.</span>00 B/s  done
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
注意：
	如果按照上传目录结构方式下载文件的时候，不要加子目录，
	
下载子目录
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># s3cmd get s3://dir/etc/  --recursive</span>
download: <span class="token string">'s3://dir/etc/conf/1.conf'</span> <span class="token operator">-</span>&gt; <span class="token string">'./conf/1.conf'</span>  <span class="token punctuation">[</span>1 of 12<span class="token punctuation">]</span>
 0 of 0     0% in    0s     0<span class="token punctuation">.</span>00 B/s  done
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
结果显示：
	它是将子目录下载到当前目录了
</code></pre></div><p>文件删除</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>删除文件文件对象
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># s3cmd del s3://images/linux/issue</span>
delete: <span class="token string">'s3://images/linux/issue'</span>
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># s3cmd ls s3://images/linux/issue</span>
<span class="token namespace">[root@stor04 ~]</span><span class="token comment">#</span>

删除目录对象
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># s3cmd del s3://images/linux/issue</span>
delete: <span class="token string">'s3://images/linux/issue'</span>
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># s3cmd del s3://dir/etc/  --recursive</span>
delete: <span class="token string">'s3://dir/etc/conf/1.conf'</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
delete: <span class="token string">'s3://dir/etc/scripts/4.sh'</span>

删除存储桶
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># s3cmd rb  s3://images</span>
Bucket <span class="token string">'s3://images/'</span> removed
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># s3cmd rb  s3://dir</span>
Bucket <span class="token string">'s3://dir/'</span> removed
</code></pre></div><p>python测试</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>安装测试模块
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># yum -y install python-boto</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>定制测试脚本
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># cat /data/scripts/tests3.py</span>
import boto<span class="token punctuation">.</span>s3<span class="token punctuation">.</span>connection

access_key = <span class="token string">'BX2IDCO5ADZ8IWZ4AVX7'</span>
secret_key = <span class="token string">'wKXAiBBspTx9kl1NpcAi4eOCHxvQD7ORHnrmvBlf'</span>
conn = boto<span class="token punctuation">.</span>connect_s3<span class="token punctuation">(</span>
        aws_access_key_id=access_key<span class="token punctuation">,</span>
        aws_secret_access_key=secret_key<span class="token punctuation">,</span>
        host=<span class="token string">'10.0.0.16'</span><span class="token punctuation">,</span> port=7480<span class="token punctuation">,</span>
        is_secure=False<span class="token punctuation">,</span> calling_format=boto<span class="token punctuation">.</span>s3<span class="token punctuation">.</span>connection<span class="token punctuation">.</span>OrdinaryCallingFormat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">)</span>

bucket = conn<span class="token punctuation">.</span>create_bucket<span class="token punctuation">(</span><span class="token string">'ceph-s3-bucket'</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> bucket in conn<span class="token punctuation">.</span>get_all_buckets<span class="token punctuation">(</span><span class="token punctuation">)</span>:
    print <span class="token string">&quot;{name} {created}&quot;</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>
        name=bucket<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
        created=bucket<span class="token punctuation">.</span>creation_date<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>测试效果
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># python /data/scripts/tests3.py</span>
ceph-s3-bucket 2062-09-26T14:41:42<span class="token punctuation">.</span>505Z
</code></pre></div><p><strong>小结</strong></p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div><h3 id="_1-3-5-swift测试"><a href="#_1-3-5-swift测试" class="header-anchor">#</a> 1.3.5 Swift测试</h3> <p>学习目标</p> <p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p> <p><strong>基础知识</strong></p> <p>Swift API接口简介</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>Swift的用户账号对应于radosgw中的subuser（子用户），它隶属于某个事先存在的user（用户账号）
	radosgw-admin user create <span class="token operator">--</span>uid=<span class="token string">&quot;swiftuser&quot;</span> <span class="token operator">--</span>display-name=<span class="token string">&quot;Swift Testing User&quot;</span>
	radosgw-admin subuser create <span class="token operator">--</span>uid=swiftuser <span class="token operator">--</span>subuser=swiftuser:swift <span class="token operator">--</span>access=full
	
Swift API的上下文中，存储桶以container表示，而非S3中的bucket，但二者在功用上类同，都是对象数据的容器
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>Python Swiftclient是一个用于与Swift API交互的Python客户端程序，它包含了Python API（swift 模块）和一个命令行工具swift<span class="token punctuation">.</span>
	环境安装如下
	pip instal <span class="token operator">--</span>upgrade python-swiftclient

swift命令可以通过Swift API完成容器和对象数据的管理操作，其基础语法格式为“
	swift <span class="token punctuation">[</span><span class="token operator">-</span>A Auth URL<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span>U username<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span>K password<span class="token punctuation">]</span> subcommand
</code></pre></div><p><strong>简单实践</strong></p> <p>用户创建</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>swift的实践用户，我们直接使用上面s3创建的用户来创建
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ radosgw-admin user list
<span class="token punctuation">[</span>
    <span class="token string">&quot;s3user&quot;</span>
<span class="token punctuation">]</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>基于s3user用户创建swift拥有所有权限的用户
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ radosgw-admin subuser create <span class="token operator">--</span>uid s3user <span class="token operator">--</span>subuser=s3user:swift <span class="token operator">--</span>access=full
<span class="token punctuation">{</span>
    <span class="token string">&quot;user_id&quot;</span>: <span class="token string">&quot;s3user&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token string">&quot;subusers&quot;</span>: <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token string">&quot;id&quot;</span>: <span class="token string">&quot;s3user:swift&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;permissions&quot;</span>: <span class="token string">&quot;full-control&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">&quot;keys&quot;</span>: <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token string">&quot;user&quot;</span>: <span class="token string">&quot;s3user&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;access_key&quot;</span>: <span class="token string">&quot;BX2IDCO5ADZ8IWZ4AVX7&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;secret_key&quot;</span>: <span class="token string">&quot;wKXAiBBspTx9kl1NpcAi4eOCHxvQD7ORHnrmvBlf&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">&quot;swift_keys&quot;</span>: <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token string">&quot;user&quot;</span>: <span class="token string">&quot;s3user:swift&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;secret_key&quot;</span>: <span class="token string">&quot;pZ5DGT3YDBqdAtb10aFiNGeO2AtJKJN4rLKuI4wU&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>生成 s3user:swift 对应的secret_key
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ radosgw-admin key create <span class="token operator">--</span>subuser=s3user:swift <span class="token operator">--</span>key-<span class="token function">type</span>=swift <span class="token operator">--</span>gen-secret
<span class="token punctuation">{</span>
    <span class="token string">&quot;user_id&quot;</span>: <span class="token string">&quot;s3user&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;display_name&quot;</span>: <span class="token string">&quot;S3 Testing user&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;email&quot;</span>: <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;suspended&quot;</span>: 0<span class="token punctuation">,</span>
    <span class="token string">&quot;max_buckets&quot;</span>: 1000<span class="token punctuation">,</span>
    <span class="token string">&quot;subusers&quot;</span>: <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token string">&quot;id&quot;</span>: <span class="token string">&quot;s3user:swift&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;permissions&quot;</span>: <span class="token string">&quot;full-control&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">&quot;keys&quot;</span>: <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token string">&quot;user&quot;</span>: <span class="token string">&quot;s3user&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;access_key&quot;</span>: <span class="token string">&quot;BX2IDCO5ADZ8IWZ4AVX7&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;secret_key&quot;</span>: <span class="token string">&quot;wKXAiBBspTx9kl1NpcAi4eOCHxvQD7ORHnrmvBlf&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">&quot;swift_keys&quot;</span>: <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token string">&quot;user&quot;</span>: <span class="token string">&quot;s3user:swift&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;secret_key&quot;</span>: <span class="token string">&quot;O7On31ApRWE6aZkSPby9bTp4y19srGTfDKl7IA04&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>客户端环境</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>安装swift命令
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># yum -y install python-setuptools python-pip</span>
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># pip install python-swiftclient==3.4.0</span>
注意：
	如果需要安装最新版本的话，需要提前将Python版本提升到3<span class="token punctuation">.</span>6+
	https:<span class="token operator">/</span><span class="token operator">/</span>pypi<span class="token punctuation">.</span>org/project/python-swiftclient/
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>命令解析：
	swift <span class="token operator">-</span>A 认证URL/auth <span class="token operator">-</span>U 用户名称:swift <span class="token operator">-</span>K secret_key 命令

命令测试效果
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># swift -A http://10.0.0.16:7480/auth -U s3user:swift -K O7On31ApRWE6aZkSPby9bTp4y19srGTfDKl7IA04 list</span>
ceph-s3-bucket
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>配置环境变量
<span class="token function">cat</span> &gt; ~<span class="token operator">/</span><span class="token punctuation">.</span>swift &lt;&lt; EOF
export ST_AUTH=http:<span class="token operator">/</span><span class="token operator">/</span>10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>16:7480/auth
export ST_USER=s3user:swift
export ST_KEY=O7On31ApRWE6aZkSPby9bTp4y19srGTfDKl7IA04
EOF
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>加载环境变量
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># source ~/.swift</span>

确认效果
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># swift list</span>
ceph-s3-bucket
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看状态信息
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># swift stat</span>
                                    Account: v1
                                 Containers: 2
                                    Objects: 1
                                      Bytes: 23
Objects in policy <span class="token string">&quot;default-placement-bytes&quot;</span>: 0
  Bytes in policy <span class="token string">&quot;default-placement-bytes&quot;</span>: 0
   Containers in policy <span class="token string">&quot;default-placement&quot;</span>: 2
      Objects in policy <span class="token string">&quot;default-placement&quot;</span>: 1
        Bytes in policy <span class="token string">&quot;default-placement&quot;</span>: 23
                     X-Openstack-<span class="token function">Request-Id</span>: tx00000000000000000012c-0063324b45-63ad-default
                X-Account-Bytes-Used-Actual: 4096
                                 X-Trans-Id: tx00000000000000000012c-0063324b45-63ad-default
                                X-Timestamp: 1664240453<span class="token punctuation">.</span>17581
                               Content-<span class="token function">Type</span>: text/plain<span class="token punctuation">;</span> charset=utf-8
                              Accept-Ranges: bytes
</code></pre></div><p>存储桶增删测试</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>创建存储桶
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># swift post swift-super</span>

删除存储桶
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># swift delete ceph-s3-bucket</span>
ceph-s3-bucket

查看存储桶
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># swift list</span>
swift-super
</code></pre></div><p>文件上传操作</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>上传文件
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># swift upload swift-super /etc/passwd</span>
etc/passwd

查看效果
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># swift list swift-super</span>
etc/passwd
</code></pre></div><p>目录上传操作</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>上传目录操作
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># swift upload swift-super /data/test</span>
<span class="token keyword">data</span><span class="token operator">/</span>test/scripts/4<span class="token punctuation">.</span>sh
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">data</span><span class="token operator">/</span>test/file/3<span class="token punctuation">.</span>txt

查看效果
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># swift list swift-super</span>
<span class="token keyword">data</span><span class="token operator">/</span>test/conf/1<span class="token punctuation">.</span>conf
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
etc/passwd
</code></pre></div><p>文件下载操作</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>下载文件
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># swift download swift-super etc/passwd</span>
etc/passwd <span class="token namespace">[auth 0.014s, headers 0.023s, total 0.024s, 0.120 MB/s]</span>
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># ls etc/passwd</span>
etc/passwd

下载所有
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># swift download --all</span>
swift-super/<span class="token keyword">data</span><span class="token operator">/</span>test/file/4<span class="token punctuation">.</span>txt <span class="token namespace">[auth 0.008s, headers 0.019s, total 0.019s, 0.000 MB/s]</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
注意：
	它对于目录的递归下载不是太友好
</code></pre></div><p>文件删除操作</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>删除文件
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># swift delete swift-super etc/passwd</span>
etc/passwd
注意：
	它不支持目录删除，但是可以通过批量删除来实现

批量删除
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># swift delete swift-super --prefix=data</span>
<span class="token keyword">data</span><span class="token operator">/</span>test/file/4<span class="token punctuation">.</span>txt
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">data</span><span class="token operator">/</span>test/scripts/1<span class="token punctuation">.</span>sh

批量删除
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># swift delete swift-super --all</span>
</code></pre></div><p><strong>小结</strong></p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div><h3 id="_1-3-6-对象访问"><a href="#_1-3-6-对象访问" class="header-anchor">#</a> 1.3.6 对象访问</h3> <p>学习目标</p> <p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p> <p><strong>基础知识</strong></p> <p>简介</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>作为OSS对象存储，我们可以在互联网上以http<span class="token punctuation">(</span>s<span class="token punctuation">)</span>:<span class="token operator">/</span><span class="token operator">/</span> 的方式来访问对象文件，基本格式如下：
	对于存储在rgw01<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com上的S3 API对象存储系统上bucket存储桶中的名为images/1<span class="token punctuation">.</span>jpg 的对象，可通过 http:<span class="token operator">/</span><span class="token operator">/</span>bucket<span class="token punctuation">.</span>rgw01<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/images/1<span class="token punctuation">.</span>jpg对其进行访问。
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>默认情况下，这种情况是拒绝的
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># s3cmd ls s3://images/linux/issue</span>
2062-09-27 00:49           23  s3:<span class="token operator">/</span><span class="token operator">/</span>images/linux/issue
<span class="token namespace">[root@stor04 ~]</span><span class="token comment"># curl http://images.stor04.superopsmsb.com:7480/linux/issue</span>
&lt;?xml version=<span class="token string">&quot;1.0&quot;</span> encoding=<span class="token string">&quot;UTF-8&quot;</span>?&gt;&lt;Error&gt;&lt;Code&gt;AccessDenied&lt;<span class="token operator">/</span>Code&gt;&lt;BucketName&gt;images&lt;<span class="token operator">/</span>BucketName&gt;&lt;RequestId&gt;tx00000000000000000012f-0063324d15-63ad-default&lt;<span class="token operator">/</span>RequestId&gt;&lt;HostId&gt;63ad-default-default&lt;<span class="token operator">/</span>HostId&gt;&lt;<span class="token operator">/</span>Error&gt;
结果显示：
	这里拒绝的原因就是 AccessDenied，是需要我们通过专用的访问策略方式来进行功能实现。
</code></pre></div><p>解析</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>在使用http方式访问对象存储的时候，我们需要注意的是：
	1 资源对象的访问方式
		http 还是 https，依赖于rgw的基本配置
	2 资源对象的访问控制
		通过定制策略的方式来实现
	3 资源对象的跨域问题
		通过定制cors的方式来实现
	4 资源对象在浏览器端的缓存机制
		rgw的基本配置定制
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>参考资料：
	https:<span class="token operator">/</span><span class="token operator">/</span>docs<span class="token punctuation">.</span>ceph<span class="token punctuation">.</span>com/en/latest/radosgw/bucketpolicy/
	https:<span class="token operator">/</span><span class="token operator">/</span>docs<span class="token punctuation">.</span>ceph<span class="token punctuation">.</span>com/en/latest/radosgw/s3/python/
</code></pre></div><p>命令解析</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code><span class="token namespace">[root@stor04 /data/conf]</span><span class="token comment"># s3cmd --help</span>
Usage: s3cmd <span class="token namespace">[options]</span> COMMAND <span class="token namespace">[parameters]</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  Modify Bucket Policy
      s3cmd setpolicy FILE s3:<span class="token operator">/</span><span class="token operator">/</span>BUCKET
  Delete Bucket Policy
      s3cmd delpolicy s3:<span class="token operator">/</span><span class="token operator">/</span>BUCKET
  Modify Bucket CORS
      s3cmd setcors FILE s3:<span class="token operator">/</span><span class="token operator">/</span>BUCKET
  Delete Bucket CORS
      s3cmd delcors s3:<span class="token operator">/</span><span class="token operator">/</span>BUCKET
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  Upload a lifecycle policy <span class="token keyword">for</span> the bucket
      s3cmd setlifecycle FILE s3:<span class="token operator">/</span><span class="token operator">/</span>BUCKET
  Get a lifecycle policy <span class="token keyword">for</span> the bucket
      s3cmd getlifecycle s3:<span class="token operator">/</span><span class="token operator">/</span>BUCKET
  Remove a lifecycle policy <span class="token keyword">for</span> the bucket
      s3cmd dellifecycle s3:<span class="token operator">/</span><span class="token operator">/</span>BUCKET
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p>查看默认策略</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code><span class="token namespace">[root@stor04 /data/conf]</span><span class="token comment"># s3cmd info s3://swift-super</span>
s3:<span class="token operator">/</span><span class="token operator">/</span>swift-super/ <span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>:
   Location:  default
   Payer:     BucketOwner
   Expiration Rule: none
   Policy:    none
   CORS:      none
   ACL:       S3 Testing user: FULL_CONTROL
</code></pre></div><p><strong>简单实践</strong></p> <p>定制策略</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>定制访问策略文件 <span class="token function">cat</span> <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>conf/policy<span class="token punctuation">.</span>json
<span class="token punctuation">{</span>
        <span class="token string">&quot;Statement&quot;</span>: <span class="token punctuation">[</span><span class="token punctuation">{</span>
                <span class="token string">&quot;Effect&quot;</span>: <span class="token string">&quot;Allow&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;Principal&quot;</span>: <span class="token string">&quot;*&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;Action&quot;</span>: <span class="token punctuation">[</span><span class="token string">&quot;s3:GetObject&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">&quot;Resource&quot;</span>: <span class="token string">&quot;*&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
属性解析：
	Resource参数匹配某一种文件：Resource:<span class="token punctuation">[</span><span class="token string">&quot;*.jpg&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;*.png&quot;</span><span class="token punctuation">]</span>
	Action可以设置较多参数，
参考资料：
	https:<span class="token operator">/</span><span class="token operator">/</span>docs<span class="token punctuation">.</span>ceph<span class="token punctuation">.</span>com/docs/master/radosgw/bucketpolicy/
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>应用访问策略
<span class="token namespace">[root@stor04 /data/conf]</span><span class="token comment"># s3cmd setpolicy policy.json s3://images --acl-public</span>
s3:<span class="token operator">/</span><span class="token operator">/</span>images/: Policy updated

确认效果
<span class="token namespace">[root@stor04 /data/conf]</span><span class="token comment"># s3cmd info s3://images</span>
s3:<span class="token operator">/</span><span class="token operator">/</span>images/ <span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>:
   Location:  default
   Payer:     BucketOwner
   Expiration Rule: none
   Policy:    <span class="token punctuation">{</span>
        <span class="token string">&quot;Statement&quot;</span>: <span class="token punctuation">[</span><span class="token punctuation">{</span>
                <span class="token string">&quot;Effect&quot;</span>: <span class="token string">&quot;Allow&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;Principal&quot;</span>: <span class="token string">&quot;*&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;Action&quot;</span>: <span class="token punctuation">[</span><span class="token string">&quot;s3:GetObject&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">&quot;Resource&quot;</span>: <span class="token string">&quot;*&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

   CORS:      none
   ACL:       S3 Testing user: FULL_CONTROL
</code></pre></div><p>设置访问限制</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>定制cors的策略文件 <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>conf/rules<span class="token punctuation">.</span>xml 
&lt;CORSConfiguration&gt;
  &lt;CORSRule&gt; 
    &lt;ID&gt;Allow everything&lt;<span class="token operator">/</span>ID&gt;  
    &lt;AllowedOrigin&gt;<span class="token operator">*</span>&lt;<span class="token operator">/</span>AllowedOrigin&gt;  
    &lt;AllowedMethod&gt;GET&lt;<span class="token operator">/</span>AllowedMethod&gt;  
    &lt;AllowedMethod&gt;HEAD&lt;<span class="token operator">/</span>AllowedMethod&gt;  
    &lt;AllowedMethod&gt;PUT&lt;<span class="token operator">/</span>AllowedMethod&gt;  
    &lt;AllowedMethod&gt;POST&lt;<span class="token operator">/</span>AllowedMethod&gt;  
    &lt;AllowedMethod&gt;DELETE&lt;<span class="token operator">/</span>AllowedMethod&gt;  
    &lt;AllowedHeader&gt;<span class="token operator">*</span>&lt;<span class="token operator">/</span>AllowedHeader&gt;  
    &lt;MaxAgeSeconds&gt;30&lt;<span class="token operator">/</span>MaxAgeSeconds&gt;
  &lt;<span class="token operator">/</span>CORSRule&gt;
&lt;<span class="token operator">/</span>CORSConfiguration&gt;
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>应用浏览器跨域设置文件
<span class="token namespace">[root@stor04 /data/conf]</span><span class="token comment"># s3cmd setcors rules.xml s3://images</span>
查看效果
<span class="token namespace">[root@stor04 /data/conf]</span><span class="token comment"># s3cmd info s3://images</span>
s3:<span class="token operator">/</span><span class="token operator">/</span>images/ <span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>:
   Location:  default
   Payer:     BucketOwner
   Expiration Rule: none
   Policy:    <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

   CORS:      &lt;CORSConfiguration xmlns=<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>&lt;<span class="token operator">/</span>CORSConfiguration&gt;
   ACL:       S3 Testing user: FULL_CONTROL
</code></pre></div><p>访问效果</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code><span class="token namespace">[root@stor04 /data/conf]</span><span class="token comment"># curl http://images.stor04.superopsmsb.com:7480/linux/issue</span>
\S
Kernel \r on an \m
</code></pre></div><p>脚本测试</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>定制访问测试脚本 <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>scripts/tests4<span class="token punctuation">.</span>py
import boto<span class="token punctuation">.</span>s3<span class="token punctuation">.</span>connection

access_key = <span class="token string">'BX2IDCO5ADZ8IWZ4AVX7'</span>
secret_key = <span class="token string">'wKXAiBBspTx9kl1NpcAi4eOCHxvQD7ORHnrmvBlf'</span>
conn = boto<span class="token punctuation">.</span>connect_s3<span class="token punctuation">(</span>
        aws_access_key_id=access_key<span class="token punctuation">,</span>
        aws_secret_access_key=secret_key<span class="token punctuation">,</span>
        host=<span class="token string">'10.0.0.16'</span><span class="token punctuation">,</span> port=7480<span class="token punctuation">,</span>
        is_secure=False<span class="token punctuation">,</span> calling_format=boto<span class="token punctuation">.</span>s3<span class="token punctuation">.</span>connection<span class="token punctuation">.</span>OrdinaryCallingFormat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token punctuation">)</span>
def get_object_url<span class="token punctuation">(</span>bucket_name<span class="token punctuation">,</span> object_name<span class="token punctuation">)</span>:
    <span class="token keyword">try</span>:
        bucket = conn<span class="token punctuation">.</span>get_bucket<span class="token punctuation">(</span>bucket_name<span class="token punctuation">)</span>
        plans_key = bucket<span class="token punctuation">.</span>get_key<span class="token punctuation">(</span>object_name<span class="token punctuation">)</span>
        plans_url = plans_key<span class="token punctuation">.</span>generate_url<span class="token punctuation">(</span>0<span class="token punctuation">,</span> query_auth=False<span class="token punctuation">,</span>
                                           force_http=False<span class="token punctuation">)</span>
        <span class="token keyword">return</span> plans_url
    except Exception as e:
        print<span class="token punctuation">(</span><span class="token string">&quot;get {} error:{}&quot;</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>object_name<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> False
print<span class="token punctuation">(</span>get_object_url<span class="token punctuation">(</span><span class="token string">&quot;images&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;linux/issue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>获取资源对象的url效果
<span class="token namespace">[root@stor04 /data/scripts]</span><span class="token comment"># python tests4.py</span>
http:<span class="token operator">/</span><span class="token operator">/</span>10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>16:7480/images/linux/issue?x-amz-meta-s3cmd-attrs=atime%3A1664200700/ctime%3A1654585109/gid%3A0/gname%3Aroot/md5%3Af078fe086dfc22f64b5dca2e1b95de2c/mode%3A33188/mtime%3A1603464839/uid%3A0/uname%3Aroot
访问url的效果
<span class="token namespace">[root@stor04 /data/scripts]</span><span class="token comment"># curl http://10.0.0.16:7480/images/linux/issue?x-amz-meta-s3cmd-attrs=atime%3A1664200700/ctime%3A1654585109/gid%3A0/gname%3Aroot/md5%3Af078fe086dfc22f64b5dca2e1b95de2c/mode%3A33188/mtime%3A1603464839/uid%3A0/uname%3Aroot</span>
\S
Kernel \r on an \m
</code></pre></div><p><strong>小结</strong></p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div><h3 id="_1-3-7-底层数据"><a href="#_1-3-7-底层数据" class="header-anchor">#</a> 1.3.7 底层数据</h3> <p>学习目标</p> <p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p> <p><strong>基础知识</strong></p> <p>简介</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	RGW是一个对象处理网关。数据实际存储在ceph集群中。利用librados的接口，与ceph集群通信。RGW主要存储三类数据：元数据<span class="token punctuation">(</span>metadata<span class="token punctuation">)</span>、索引数据<span class="token punctuation">(</span>bucket index<span class="token punctuation">)</span>、数据<span class="token punctuation">(</span><span class="token keyword">data</span><span class="token punctuation">)</span>。
	<span class="token operator">-</span> 元数据信息：包括user<span class="token punctuation">(</span>用户信息<span class="token punctuation">)</span>，bucket<span class="token punctuation">(</span>存储桶关系<span class="token punctuation">)</span>，bucket<span class="token punctuation">.</span>instance<span class="token punctuation">(</span>存储桶实例<span class="token punctuation">)</span>。
    <span class="token operator">-</span> 索引数据信息: 主要k/v的结构来维护bucket中rgw对象的索引信息，val是关于rgw对象的元数据信息
    <span class="token operator">-</span> 数据信息: 其实就是rgw object内容，它存放在一个或多个rados object中
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>这三类数据一般存储在不同的pool中，元数据也分多种元数据，存在不同的ceph pool中。
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>默认情况下，RGW安装完毕后，会在rados集群上生成包括如下存储池的一系列存储池
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd pool <span class="token function">ls</span>
<span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>root
default<span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>control
default<span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>meta
default<span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>log

当我们开始基于对象存储的方式实现数据访问后，它就会生成另外一些存储池
<span class="token namespace">[cephadm@admin ~]</span>$ ceph osd pool <span class="token function">ls</span>
<span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>root						<span class="token comment"># 包含的都是zone,zonegroup,realm等信息</span>
default<span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>control				<span class="token comment"># pool中对象的控制信息</span>
default<span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>meta				<span class="token comment"># 包含的是元数据信息</span>
default<span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>log					<span class="token comment"># 包含的是日志处理信息，包括垃圾回收机制</span>
default<span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>buckets<span class="token punctuation">.</span>index		<span class="token comment"># 包含的是存储桶和对象的映射信息</span>
default<span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>buckets<span class="token punctuation">.</span><span class="token keyword">data</span>		<span class="token comment"># 包含的是存储桶的对象数据信息</span>
注意：
	这里的default指的是 ceph的zone区域。
	control利用librados提供的对象<span class="token function">watch-notify</span>功能，当有数据更新时，通知其他RGW刷新cache。
</code></pre></div><p>元数据</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>查看元数据
<span class="token namespace">[cephadm@admin ~]</span>$ radosgw-admin metadata list
<span class="token punctuation">[</span>
    <span class="token string">&quot;bucket&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;bucket.instance&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;otp&quot;</span><span class="token punctuation">,</span>		<span class="token comment"># One-time password 一次性密码机制</span>
    <span class="token string">&quot;user&quot;</span>
<span class="token punctuation">]</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看用户
<span class="token namespace">[cephadm@admin ~]</span>$ radosgw-admin metadata list user
<span class="token punctuation">[</span>
    <span class="token string">&quot;s3user&quot;</span>
<span class="token punctuation">]</span>

获取用户细节信息
<span class="token namespace">[cephadm@admin ~]</span>$ radosgw-admin metadata list user:s3user
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看存储桶
<span class="token namespace">[cephadm@admin ~]</span>$ radosgw-admin metadata list bucket
<span class="token punctuation">[</span>
    <span class="token string">&quot;images&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;swift-super&quot;</span>
<span class="token punctuation">]</span>

获取存储桶信息
<span class="token namespace">[cephadm@admin ~]</span>$ radosgw-admin metadata get bucket:images:
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>获取存储桶实例
<span class="token namespace">[cephadm@admin ~]</span>$ radosgw-admin metadata list bucket<span class="token punctuation">.</span>instance
<span class="token punctuation">[</span>
    <span class="token string">&quot;images:09d0b6f1-fc49-4838-bda1-08cc60553e29.15577.7&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;swift-super:09d0b6f1-fc49-4838-bda1-08cc60553e29.15577.4&quot;</span>
<span class="token punctuation">]</span>

获取存储桶实例信息
<span class="token namespace">[cephadm@admin ~]</span>$ radosgw-admin metadata get bucket<span class="token punctuation">.</span>instance:images:09d0b6f1-fc49-4838-bda1-08cc60553e29<span class="token punctuation">.</span>15577<span class="token punctuation">.</span>7
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p><strong>简单实践</strong></p> <p>元数据存储池</p> <div class="language-pow extra-class"><pre class="language-text"><code>{zone}.rgw.meta 存放的是元数据
	root: bucket及bucket-instance
    users.keys: 用户key
    users.email:用户Email,object的key值=email
    users.swift: swift账号
    users.uid: s3用户及用户的Bucket信息
    roles：
    heap：
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看用户的uid信息
<span class="token namespace">[cephadm@admin ~]</span>$ rados <span class="token operator">-</span>p default<span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>meta <span class="token operator">-</span>N users<span class="token punctuation">.</span>uid <span class="token function">ls</span>
s3user
s3user<span class="token punctuation">.</span>buckets
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>获取用户管理的buckets
<span class="token namespace">[cephadm@admin ~]</span>$ rados <span class="token operator">-</span>p default<span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>meta  <span class="token operator">-</span>N users<span class="token punctuation">.</span>uid listomapkeys s3user<span class="token punctuation">.</span>buckets
images
swift-super

默认查看bucket信息是二进制，所以我们需要将其保存到一个文件中，通过专用命令进行查看
<span class="token namespace">[cephadm@admin ~]</span>$ rados <span class="token operator">-</span>p default<span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>meta  <span class="token operator">-</span>N users<span class="token punctuation">.</span>uid getomapval s3user<span class="token punctuation">.</span>buckets images images_bucket
Writing to images_bucket

查看加密文件信息
<span class="token namespace">[cephadm@admin ~]</span>$ ceph-dencoder import images_bucket <span class="token function">type</span> cls_user_bucket_entry decode dump_json
<span class="token punctuation">{</span>
    <span class="token string">&quot;bucket&quot;</span>: <span class="token punctuation">{</span>
        <span class="token string">&quot;name&quot;</span>: <span class="token string">&quot;images&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;marker&quot;</span>: <span class="token string">&quot;09d0b6f1-fc49-4838-bda1-08cc60553e29.15577.7&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;bucket_id&quot;</span>: <span class="token string">&quot;09d0b6f1-fc49-4838-bda1-08cc60553e29.15577.7&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;size&quot;</span>: 23<span class="token punctuation">,</span>
    <span class="token string">&quot;size_rounded&quot;</span>: 4096<span class="token punctuation">,</span>
    <span class="token string">&quot;creation_time&quot;</span>: <span class="token string">&quot;2022-09-27 00:49:53.839482Z&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;count&quot;</span>: 1<span class="token punctuation">,</span>
    <span class="token string">&quot;user_stats_sync&quot;</span>: <span class="token string">&quot;true&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>其他信息获取
	bucket信息： rados <span class="token operator">-</span>p default<span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>meta <span class="token operator">-</span>N root <span class="token function">ls</span>
	bucket元数据：rados <span class="token operator">-</span>p default<span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>meta <span class="token operator">-</span>N root get <span class="token punctuation">{</span>bucket_id<span class="token punctuation">}</span> meta_file

</code></pre></div><p>索引数据存储池</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>获取buckets的索引信息
<span class="token namespace">[cephadm@admin ~]</span>$ rados <span class="token operator">-</span>p default<span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>buckets<span class="token punctuation">.</span>index <span class="token function">ls</span>
<span class="token punctuation">.</span><span class="token function">dir</span><span class="token punctuation">.</span>09d0b6f1-fc49-4838-bda1-08cc60553e29<span class="token punctuation">.</span>15577<span class="token punctuation">.</span>4
<span class="token punctuation">.</span><span class="token function">dir</span><span class="token punctuation">.</span>09d0b6f1-fc49-4838-bda1-08cc60553e29<span class="token punctuation">.</span>15577<span class="token punctuation">.</span>7
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看存储桶的对象信息
<span class="token namespace">[cephadm@admin ~]</span>$ rados <span class="token operator">-</span>p default<span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>buckets<span class="token punctuation">.</span>index listomapkeys <span class="token punctuation">.</span><span class="token function">dir</span><span class="token punctuation">.</span>09d0b6f1-fc49-4838-bda1-08cc60553e29<span class="token punctuation">.</span>15577<span class="token punctuation">.</span>7
linux/issue
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看对象元数据信息
<span class="token namespace">[cephadm@admin ~]</span>$ rados <span class="token operator">-</span>p default<span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>buckets<span class="token punctuation">.</span>index getomapval <span class="token punctuation">.</span><span class="token function">dir</span><span class="token punctuation">.</span>09d0b6f1-fc49-4838-bda1-08cc60553e29<span class="token punctuation">.</span>15577<span class="token punctuation">.</span>7 linux/issue object_key
Writing to object_key

查看文件内容信息
<span class="token namespace">[cephadm@admin ~]</span>$ ceph-dencoder <span class="token function">type</span> rgw_bucket_dir_entry import object_key decode dump_json         <span class="token punctuation">{</span>
    <span class="token string">&quot;name&quot;</span>: <span class="token string">&quot;linux/issue&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;instance&quot;</span>: <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;ver&quot;</span>: <span class="token punctuation">{</span>
        <span class="token string">&quot;pool&quot;</span>: 11<span class="token punctuation">,</span>
        <span class="token string">&quot;epoch&quot;</span>: 1
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;locator&quot;</span>: <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;exists&quot;</span>: <span class="token string">&quot;true&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>文件对象的header中记录了一些统计信息
<span class="token namespace">[cephadm@admin ~]</span>$ rados <span class="token operator">-</span>p default<span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>buckets<span class="token punctuation">.</span>index getomapheader <span class="token punctuation">.</span><span class="token function">dir</span><span class="token punctuation">.</span>09d0b6f1-fc49-4838-bda1-08cc60553e29<span class="token punctuation">.</span>15577<span class="token punctuation">.</span>7 index_object_header
Writing to index_object_header

查看统计信息
<span class="token namespace">[cephadm@admin ~]</span>$ ceph-dencoder <span class="token function">type</span> rgw_bucket_dir_header import index_object_header decode dump_json
<span class="token punctuation">{</span>
    <span class="token string">&quot;ver&quot;</span>: 2<span class="token punctuation">,</span>
    <span class="token string">&quot;master_ver&quot;</span>: 0<span class="token punctuation">,</span>
    <span class="token string">&quot;stats&quot;</span>: <span class="token punctuation">[</span>
        1<span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token string">&quot;total_size&quot;</span>: 23<span class="token punctuation">,</span>
            <span class="token string">&quot;total_size_rounded&quot;</span>: 4096<span class="token punctuation">,</span>
            <span class="token string">&quot;num_entries&quot;</span>: 1<span class="token punctuation">,</span>
            <span class="token string">&quot;actual_size&quot;</span>: 23
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">&quot;new_instance&quot;</span>: <span class="token punctuation">{</span>
        <span class="token string">&quot;reshard_status&quot;</span>: <span class="token string">&quot;not-resharding&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;new_bucket_instance_id&quot;</span>: <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;num_shards&quot;</span>: <span class="token operator">-</span>1
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>数据信息存储池</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>查看数据对象
<span class="token namespace">[cephadm@admin ~]</span>$ rados <span class="token operator">-</span>p default<span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>buckets<span class="token punctuation">.</span><span class="token keyword">data</span> <span class="token function">ls</span>
09d0b6f1-fc49-4838-bda1-08cc60553e29<span class="token punctuation">.</span>15577<span class="token punctuation">.</span>7_linux/issue

查看对象数据的属性信息
<span class="token namespace">[cephadm@admin ~]</span>$ rados <span class="token operator">-</span>p default<span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>buckets<span class="token punctuation">.</span><span class="token keyword">data</span> listxattr 09d0b6f1-fc49-4838-bda1-08cc60553e29<span class="token punctuation">.</span>15577<span class="token punctuation">.</span>7_linux/issue
user<span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>acl
user<span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>content_type
user<span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>etag
user<span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>idtag
user<span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>manifest
user<span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>pg_ver
user<span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>source_zone
user<span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>storage_class
user<span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>tail_tag
user<span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>x-amz-content-sha256
user<span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>x-amz-date
user<span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>x-amz-meta-s3cmd-attrs
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>获取对象的manifest的信息
<span class="token namespace">[cephadm@admin ~]</span>$ rados <span class="token operator">-</span>p default<span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>buckets<span class="token punctuation">.</span><span class="token keyword">data</span> getxattr 09d0b6f1-fc49-4838-bda1-08cc60553e29<span class="token punctuation">.</span>15577<span class="token punctuation">.</span>7_linux/issue user<span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>manifest &gt; manifest
查看信息详情
<span class="token namespace">[cephadm@admin ~]</span>$ ceph-dencoder <span class="token function">type</span> RGWObjManifest import manifest decode dump_json
<span class="token punctuation">{</span>
    <span class="token string">&quot;objs&quot;</span>: <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p><strong>小结</strong></p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div><h3 id="_1-3-8-进阶方案"><a href="#_1-3-8-进阶方案" class="header-anchor">#</a> 1.3.8 进阶方案</h3> <p>学习目标</p> <p>这一节，我们从 基础知识、案例解读、小结 三个方面来学习。</p> <p><strong>基础知识</strong></p> <p>简介</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	ceph分布式存储机制，随着大量应用的普及，在生产中的存储地位越来越高了，但是自我搭建存储云的成本太高了，所以我们在实际应用的过程中，往往是混合云<span class="token punctuation">(</span>公有云<span class="token operator">+</span>私有云<span class="token punctuation">)</span>的方式来实现<span class="token punctuation">,</span>借助于公有云的可扩展、低成本实现大量普通数据的存储，借助于私有云的高度可控实现敏感数据的安全控制。
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>混合云存储的特点：
	高性能：敏感活动数据存储在私有云存储中，普通数据存储到公有云存储中。利用公有云的特性，实现负载的分散，从而提供一个较高的综合访问性能；
	安全可控：混合云存储中的私有云部分的软硬件资源都是高度控制的，所以可以实现敏感数据的可控制性和安全性；
	高度扩展：借助于公有云存储的扩展特性，混合云存储也具备了高度扩展容量的特性；
	相对低成本：普通数据存储到公有云存储中，节省了私有云存储的成本，还拥有公有云存储的成本优势，混合云存储具有低成本的优势。
</code></pre></div><p>ceph解决方案</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	混合云存储相较于公有云存储和私有云存储会更加全面，更加完善。Ceph 的对象存储针对混合云的场景，也相应的提供了解决方案，即云同步Cloud Sync功能。Ceph RGW 的Cloud Sync 功能是基于RGW Multisite 机制实现的，先看下RGW Multisite 机制。
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>	Ceph RGW 的 Multisite 机制用于实现多个Ceph 对象存储集群间数据同步，其涉及到的核心概念包括：
        zone：对应于一个独立的集群，由一组 RGW 对外提供服务。
        zonegroup：每个 zonegroup 可以对应多个zone，zone 之间同步数据和元数据。
        realm：每个realm都是独立的命名空间，可以包含多个 zonegroup，zonegroup 之间同步元数据。
</code></pre></div><p><img src="image/image-20220927100024375.png" alt="image-20220927100024375"></p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	Multisite 是一个zone 层面的功能处理机制，所以默认情况下，是 zone 级的数据同步，所以说操作粒度过于粗糙。而基于RGW multisite 实现了 Cloud Sync，支持将Ceph 中的对象数据同步到支持 S3 接口的公有云存储中，作为slave zone不再是一个具体的对象存储集群，而是一个抽象程度更高的概念，可以代表任何一个对象存储集群，从而实现了混合云的基本能力。
	Cloud Sync 功能正是将支持 S3 接口的存储集群，抽象为 slave zone 的概念，然后通过Multisite 机制，实现将 Ceph 中的对象数据同步到外部对象存储中。
</code></pre></div><p>局限性</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	在使用 Ceph 对象存储时， RGW 的 Cloud Sync 功能实际上是基本可以满足混合云存储的应用场景的，当然劣势是不可避免的：
	1 支持的同步粒度最细为存储桶级，在某些应用场景下，存储桶级的同步粒度是不太合适的；
	2 RGW Multisite 的数据同步因为涉及到多云环境，所以时间控制要求高，一些时间敏感的场景并不适用。
</code></pre></div><p><strong>案例解读</strong></p> <p>存储分级管理</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>存储介质：
	出于对访问性能、成本等因素的考虑，同时引入多种存储介质的分级管理，实现高效数据存储。
存储策略：
	主要针对的是数据级别的副本设定<span class="token punctuation">(</span>默认3副本<span class="token punctuation">)</span>和存储厂商的指定。
存放规则：
	针对应用场景的不同，对不同的数据实现各自的数据存放规则。但是因为是zone级别的，所以有些场景不合适。
</code></pre></div><p>对象周期管理</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	作为对象存储，它的最大特点就是基于web形式来进行访问，不可避免的涉及到缓存的管理，所以对象生命周期管理是非常重要的事项。
	目前来说，对象存储的周期管理主要有两种方式：迁移处理和过期删除处理
</code></pre></div><p>自动迁移管理</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	根据存储桶日志中的操作记录等属性参数，我们可以实现对存储桶中的对象数据的热度进行分析，并按照分析结果自动生成迁移策略，从而实现对象数据的自动化管理。
	从 target bucket 中读取存储桶日志；
    对日记记录进行过滤、分析，得到用户配置的规则中所标定的对象数据的访问热度；
    生成相应的生命周期管理规则；
    将生成的生命周期管理规则配置到相应的存储桶上。
</code></pre></div><p><strong>小结</strong></p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div><h2 id="_1-4-cephfs接口"><a href="#_1-4-cephfs接口" class="header-anchor">#</a> 1.4 CephFS接口</h2> <h3 id="_1-4-1-基础知识"><a href="#_1-4-1-基础知识" class="header-anchor">#</a> 1.4.1 基础知识</h3> <p>学习目标</p> <p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p> <p><strong>基础知识</strong></p> <p>场景</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	有了 RBD，远程磁盘挂载的问题就解决了，但 RBD 的问题是不能多个主机共享一个磁盘，如果有一份数据很多客户端都要读写该怎么办呢？这时 CephFS 作为文件系统存储解决方案就派上用场了。
</code></pre></div><p>简介</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	Ceph 文件系统（Ceph FS）是个 POSIX 兼容的文件系统，它直接使用 Ceph 存储集群来存储数据。 Ceph 文件系统与 Ceph 块设备、同时提供 S3 和 Swift API 的 Ceph 对象存储、或者原生库（ librados ）的实现机制稍显不同。
</code></pre></div><p>要点</p> <p><img src="image/image-20211117114047214.png" alt="image-20211117114047214"></p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	CephFS需要至少运行一个元数据服务器（MDS）守护进程（ceph-mds），此进程管理与CephFS上存储的文件相关的元数据，并协调对Ceph存储集群的访问。
	因此，若要使用CephFS接口，需要在存储集群中至少部署一个MDS实例。
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>注意：
	MDS虽然称为元数据服务，但是它却不存储任何元数据信息，它存在的目的仅仅是 让我们rados集群提供的存储接口能够兼容POSIX 的文件系统接口 <span class="token operator">--</span> 简单来说，它是真正元数据信息的索引服务。
	客户端在访问文件接口的时候，首先连接到 MDS上，在MDS的内存里面维持元数据的索引信息，这些信息真正的保存在RADOS集群的metadata pool上面，而对应的数据，保存在对应的 <span class="token keyword">data</span> pool上面。
	而且以将元数据服务作为一个非状态的效果，便于扩展。
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>相较于NFS来说，它主要有以下特点优势：
	1 底层数据冗余的功能，底层的roados 提供了基本的数据冗余功能，因此不存在nfs的单点故障因素。
	2 底层的roados系统有n个存储节点组成，所以数据的存储可以分散IO，吞吐量较高。
	3 底层的roados系统有n个存储节点组成，所以ceph提供的扩展性要想当的高
</code></pre></div><p><strong>简单实践</strong></p> <p>部署mds主机</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>在admin主机上为stor05上部署mds服务
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph-deploy mds create stor05

在stor05上，并确认是否开启了守护进程
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ssh stor05 <span class="token string">&quot;ps aux | grep ceph-mds | grep -v grep&quot;</span>
ceph       14471  0<span class="token punctuation">.</span>1  1<span class="token punctuation">.</span>2 384316 22504 ?        Ssl  11:48   0:00 <span class="token operator">/</span>usr/bin/ceph-mds <span class="token operator">-</span>f <span class="token operator">--</span>cluster ceph <span class="token operator">--</span>id stor05 <span class="token operator">--</span>setuser ceph <span class="token operator">--</span>setgroup ceph
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>在admin主机上通过 ceph <span class="token operator">-</span>s 中查看mds的状态
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$  ceph <span class="token operator">-</span>s
  cluster:
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  services:
    mon: 3 daemons<span class="token punctuation">,</span> quorum mon01<span class="token punctuation">,</span>mon02<span class="token punctuation">,</span>mon03 <span class="token punctuation">(</span>age 6m<span class="token punctuation">)</span>
    mgr: mon01<span class="token punctuation">(</span>active<span class="token punctuation">,</span> since 47h<span class="token punctuation">)</span><span class="token punctuation">,</span> standbys: mon02
    mds:  1 up:standby		<span class="token comment"># 一个mds部署成功</span>
    osd: 6 osds: 6 up <span class="token punctuation">(</span>since 6m<span class="token punctuation">)</span><span class="token punctuation">,</span> 6 in <span class="token punctuation">(</span>since 43h<span class="token punctuation">)</span>
    rgw: 1 daemon active <span class="token punctuation">(</span>stor04<span class="token punctuation">)</span>
注意：
	在没有为fs准备存储池的前提下，是看不到效果的
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>需要专用的命令来进行查看mds的状态效果
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph mds stat
 1 up:standby
结果显示：
	查看MDS的相关状态可以发现，刚添加的MDS处于Standby模式
</code></pre></div><p>创建专属存储池</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>创建元数据存储池
ceph osd pool create cephfs-metadata 32 32
ceph osd pool create cephfs-<span class="token keyword">data</span> 64 64
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>将刚才创建的存储池组合为fs专属存储池
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph fs new cephfs cephfs-metadata cephfs-<span class="token keyword">data</span>
new fs with metadata pool 14 and <span class="token keyword">data</span> pool 15
</code></pre></div><p>确认效果</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>确认效果
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph <span class="token operator">-</span>s
  cluster:
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  services:
    mon: 3 daemons<span class="token punctuation">,</span> quorum mon01<span class="token punctuation">,</span>mon02<span class="token punctuation">,</span>mon03 <span class="token punctuation">(</span>age 11m<span class="token punctuation">)</span>
    mgr: mon01<span class="token punctuation">(</span>active<span class="token punctuation">,</span> since 47h<span class="token punctuation">)</span><span class="token punctuation">,</span> standbys: mon02
    mds: cephfs:1 <span class="token punctuation">{</span>0=stor05=up:active<span class="token punctuation">}</span>
    osd: 6 osds: 6 up <span class="token punctuation">(</span>since 11m<span class="token punctuation">)</span><span class="token punctuation">,</span> 6 in <span class="token punctuation">(</span>since 43h<span class="token punctuation">)</span>
    rgw: 1 daemon active <span class="token punctuation">(</span>stor04<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看状态
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph fs status cephfs
cephfs <span class="token operator">-</span> 0 clients
======
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token punctuation">|</span> Rank <span class="token punctuation">|</span> State  <span class="token punctuation">|</span>  MDS   <span class="token punctuation">|</span>    Activity   <span class="token punctuation">|</span>  dns  <span class="token punctuation">|</span>  inos <span class="token punctuation">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token punctuation">|</span>  0   <span class="token punctuation">|</span> active <span class="token punctuation">|</span> stor05 <span class="token punctuation">|</span> Reqs:    0 <span class="token operator">/</span>s <span class="token punctuation">|</span>   10  <span class="token punctuation">|</span>   13  <span class="token punctuation">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token punctuation">|</span>       Pool      <span class="token punctuation">|</span>   <span class="token function">type</span>   <span class="token punctuation">|</span>  used <span class="token punctuation">|</span> avail <span class="token punctuation">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token punctuation">|</span> cephfs-metadata <span class="token punctuation">|</span> metadata <span class="token punctuation">|</span> 1536k <span class="token punctuation">|</span> 35<span class="token punctuation">.</span>8G <span class="token punctuation">|</span>
<span class="token punctuation">|</span>   cephfs-<span class="token keyword">data</span>   <span class="token punctuation">|</span>   <span class="token keyword">data</span>   <span class="token punctuation">|</span>    0  <span class="token punctuation">|</span> 35<span class="token punctuation">.</span>8G <span class="token punctuation">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token punctuation">|</span> Standby MDS <span class="token punctuation">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
MDS version: ceph version 14<span class="token punctuation">.</span>2<span class="token punctuation">.</span>22 <span class="token punctuation">(</span>ca74598065096e6fcbd8433c8779a2be0c889351<span class="token punctuation">)</span> nautilus <span class="token punctuation">(</span>stable<span class="token punctuation">)</span>
</code></pre></div><p><strong>小结</strong></p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div><h3 id="_1-4-2-接口使用"><a href="#_1-4-2-接口使用" class="header-anchor">#</a> 1.4.2 接口使用</h3> <p>学习目标</p> <p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p> <p><strong>基础知识</strong></p> <p>客户端使用cephFS方式</p> <p><img src="image/image-20211210121816739.png" alt="image-20211210121816739"></p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>客户端使用cephFS，主要有两种方式：
	内核文件系统 <span class="token operator">-</span> Ceph、libcephfs
	用户空间文件系统 <span class="token operator">-</span> FUSE<span class="token punctuation">(</span>Filesystem in USErspace<span class="token punctuation">)</span>
前提：
	1 至少一个节点运行ceph-mds守护进程
	2 创建存储池 ceph-metadata、ceph-<span class="token keyword">data</span>
	3 激活文件系统
	4 无论那种客户端使用cephFS的方式，都需要有专门的认证机制。
</code></pre></div><p>准备认证文件</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>在admin节点上，准备认证账号
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph auth <span class="token function">get-or</span><span class="token operator">-</span>create client<span class="token punctuation">.</span>fsclient mon <span class="token string">'allow r'</span> mds <span class="token string">'allow rw'</span> osd <span class="token string">'allow rwx pool=cephfs-data'</span> <span class="token operator">-</span>o ceph<span class="token punctuation">.</span>client<span class="token punctuation">.</span>fsclient<span class="token punctuation">.</span>keyring
	注意：我们只需要对<span class="token keyword">data</span>的存储池进行操作即可，不需要对metadata存储池进行授权。  
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看账号信息
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph auth get client<span class="token punctuation">.</span>fsclient

查看认证文件信息
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ <span class="token function">ls</span> <span class="token operator">*</span>fsclient*
ceph<span class="token punctuation">.</span>client<span class="token punctuation">.</span>fsclient<span class="token punctuation">.</span>keyring
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ <span class="token function">cat</span> ceph<span class="token punctuation">.</span>client<span class="token punctuation">.</span>fsclient<span class="token punctuation">.</span>keyring
<span class="token namespace">[client.fsclient]</span>
        key = AQBgdTJj+LVdFBAAZOjGIsw4t+o1swZlW4CvKQ== 
</code></pre></div><p>秘钥管理</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	客户端挂载cephFS的时候，需要指定用户名和key，而这两项是有不同的两个选项来指定的，所以我们应该将这两个内容分开存储

获取相关的秘钥信息
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph-authtool <span class="token operator">-</span>p <span class="token operator">-</span>n client<span class="token punctuation">.</span>fsclient ceph<span class="token punctuation">.</span>client<span class="token punctuation">.</span>fsclient<span class="token punctuation">.</span>keyring
AQBgdTJj+LVdFBAAZOjGIsw4t+o1swZlW4CvKQ==
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph auth print-key client<span class="token punctuation">.</span>fsclient
AQBgdTJj+LVdFBAAZOjGIsw4t+o1swZlW4CvKQ==
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>保存用户账号的密钥信息于secret文件，用于客户端挂载操作认证之用
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph auth print-key client<span class="token punctuation">.</span>fsclient &gt; fsclient<span class="token punctuation">.</span>key
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ <span class="token function">cat</span> fsclient<span class="token punctuation">.</span>key
AQBgdTJj+LVdFBAAZOjGIsw4t+o1swZlW4CvKQ==
</code></pre></div><p><strong>简单实践</strong></p> <p>ceph客户端的需求</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>客户端主机环境准备
	内核模块ceph<span class="token punctuation">.</span>ko
		yum install ceph
	安装ceph-common程序包
		yum install ceph-common
	提供ceph<span class="token punctuation">.</span>conf配置文件
		ceph-deploy <span class="token operator">--</span>overwrite-conf config push stor06
	获取到用于认证的密钥文件
		sudo scp fsclient<span class="token punctuation">.</span>key stor06:<span class="token operator">/</span>etc/ceph/
</code></pre></div><p>cephFS客户端准备</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>我们准备将 stor06 作为cephFS的客户端主机，检查stor06的ceph模块加载情况
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># modinfo ceph</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

保证 stor06上有ceph相关的配置文件
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># ls /etc/ceph/</span>
ceph<span class="token punctuation">.</span>client<span class="token punctuation">.</span>kube<span class="token punctuation">.</span>keyring <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  ceph<span class="token punctuation">.</span>conf  fsclient<span class="token punctuation">.</span>key  rbdmap
</code></pre></div><p>挂载cephFS</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>创建专属的数据目录
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># mkdir /cephfs-data/</span>

挂载cephFS对象
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># mount -t ceph mon01:6789,mon02:6789,mon03:6789:/ /cephfs-data/ -o name=fsclient,secretfile=/etc/ceph/fsclient.key</span>
注意：
	内核空间挂载ceph文件系统，要求必须指定ceph文件系统的挂载路径
	
确认挂载效果
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># mount | grep cephfs</span>
10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>13:6789<span class="token punctuation">,</span>10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>14:6789<span class="token punctuation">,</span>10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>15:6789:<span class="token operator">/</span> on <span class="token operator">/</span>cephfs-<span class="token keyword">data</span> <span class="token function">type</span> ceph <span class="token punctuation">(</span>rw<span class="token punctuation">,</span>relatime<span class="token punctuation">,</span>name=fsclient<span class="token punctuation">,</span>secret=&lt;hidden&gt;<span class="token punctuation">,</span>acl<span class="token punctuation">,</span>wsize=16777216<span class="token punctuation">)</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看挂载点的效果
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># stat -f /cephfs-data/</span>
  文件：<span class="token string">&quot;/cephfs-data/&quot;</span>
    ID：c931549bd8ae8624 文件名长度：255     类型：ceph
块大小：4194304    基本块大小：4194304
    块：总计：9182       空闲：9182       可用：9182
Inodes: 总计：0          空闲：<span class="token operator">-</span>1
结果显示：
	挂载点的类型是 ceph。
	
确认文件系统使用效果
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># echo nihao cephfs &gt; /cephfs-data/cephfs.txt</span>
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># cat /cephfs-data/cephfs.txt</span>
nihao cephfs
</code></pre></div><p>开机自启动挂载cephFS</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>卸载刚才挂载的cephFS
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># umount /cephfs-data</span>
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># mount | grep ceph</span>

设置开机自启动
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># echo 'mon01:6789,mon02:6789,mon03:6789:/  /cephfs-data  ceph name=fsclient,secretfile=/etc/ceph/fsclient.key,_netdev,noatime 0 0' &gt;&gt; /etc/fstab</span>
属性解析：
	_netdev <span class="token operator">-</span> 告诉挂载程序，一旦超时，自动跳过去。
	noatime <span class="token operator">-</span> 在读文件时不去更改文件的access time属性，提高性能
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>挂载磁盘
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># mount -a</span>
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># mount | grep ceph</span>
10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>13:6789<span class="token punctuation">,</span>10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>14:6789<span class="token punctuation">,</span>10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>15:6789:<span class="token operator">/</span> on <span class="token operator">/</span>cephfs-<span class="token keyword">data</span> <span class="token function">type</span> ceph <span class="token punctuation">(</span>rw<span class="token punctuation">,</span>noatime<span class="token punctuation">,</span>name=fsclient<span class="token punctuation">,</span>secret=&lt;hidden&gt;<span class="token punctuation">,</span>acl<span class="token punctuation">)</span>

查看效果
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># cat /cephfs-data/cephfs.txt</span>
nihao cephfs
</code></pre></div><p><strong>小结</strong></p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div><h3 id="_1-4-3-fuse实践"><a href="#_1-4-3-fuse实践" class="header-anchor">#</a> 1.4.3 FUSE实践</h3> <p>学习目标</p> <p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p> <p><strong>基础知识</strong></p> <p>简介</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	对于某些操作系统来说，它没有提供对应的ceph内核模块，我们还需要使用cephFS的话，可以通过 FUSE方式来实现，FUSE全称Filesystem in Userspace，用于非特权用户能够无需操作内核而创建文件系统。
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>如果我们在非内核的环境下使用cephFS的话，需要对客户端主机的环境做一些准备工作：
	安装ceph-fuse程序包
		yum install <span class="token operator">-</span>y ceph-fuse ceph-common
	获取到客户端账号的keyring文件和ceph<span class="token punctuation">.</span>conf配置文件
		ceph-deploy <span class="token operator">--</span>overwrite-conf config push stor06
		sudo scp ceph<span class="token punctuation">.</span>client<span class="token punctuation">.</span>fsclient<span class="token punctuation">.</span>keyring root@stor06:<span class="token operator">/</span>etc/ceph/
</code></pre></div><p><strong>简单实践</strong></p> <p>客户端环境准备</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>我们准备将 stor06 作为cephFS的客户端主机，安装对应的软件
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># yum install ceph-fuse ceph-common -y</span>

保证 stor06上有ceph相关的配置文件
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># ls /etc/ceph/</span>
ceph<span class="token punctuation">.</span>client<span class="token punctuation">.</span>kube<span class="token punctuation">.</span>keyring <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  ceph<span class="token punctuation">.</span>conf  fsclient<span class="token punctuation">.</span>key  rbdmap
</code></pre></div><p>挂载cephFS</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>创建专属的数据目录
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># mkdir /cephfs-data-user/</span>

挂载cephFS对象
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># ceph-fuse -n client.fsclient -m mon01:6789,mon02:6789,mon03:6789 /cephfs-data-user/</span>
ceph-fuse<span class="token punctuation">[</span>7963<span class="token punctuation">]</span>: starting ceph client2062-09-27 12:23:47<span class="token punctuation">.</span>905 7f6e97de4f80 <span class="token operator">-</span>1 init<span class="token punctuation">,</span> newargv = 0x5637c9545540 newargc=9
ceph-fuse<span class="token punctuation">[</span>7963<span class="token punctuation">]</span>: starting fuse

确认挂载效果
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># mount | grep cephfs</span>
ceph-fuse on <span class="token operator">/</span>cephfs-<span class="token keyword">data</span><span class="token operator">-</span>user <span class="token function">type</span> fuse<span class="token punctuation">.</span>ceph-fuse <span class="token punctuation">(</span>rw<span class="token punctuation">,</span>nosuid<span class="token punctuation">,</span>nodev<span class="token punctuation">,</span>relatime<span class="token punctuation">,</span>user_id=0<span class="token punctuation">,</span>group_id=0<span class="token punctuation">,</span>allow_other<span class="token punctuation">)</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看挂载点的效果
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># stat -f /cephfs-data-user/</span>
  文件：<span class="token string">&quot;/cephfs-data-user/&quot;</span>
    ID：0        文件名长度：255     类型：fuseblk
块大小：4194304    基本块大小：4194304
    块：总计：9182       空闲：9182       可用：9182
Inodes: 总计：1          空闲：0
	
确认文件系统使用效果
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># echo nihao cephfs user &gt; /cephfs-data-user/cephfs.txt</span>
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># cat /cephfs-data-user/cephfs.txt</span>
nihao cephfs <span class="token operator">-</span>user
</code></pre></div><p>开机自启动挂载cephFS</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>卸载刚才挂载的cephFS
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># umount /cephfs-data-user</span>
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># mount | grep ceph</span>

设置开机自启动
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># echo 'none  /cephfs-data-user   fuse.ceph   ceph.id=fsclient,ceph.conf=/etc/ceph/ceph.conf,_netdev,noatime 0 0' &gt;&gt; /etc/fstab</span>
属性解析：
	_netdev <span class="token operator">-</span> 告诉挂载程序，一旦超时，自动跳过去。
	noatime <span class="token operator">-</span> 在读文件时不去更改文件的access time属性，提高性能
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>挂载磁盘
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># mount -a</span>
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># mount | grep ceph</span>
ceph-fuse on <span class="token operator">/</span>cephfs-<span class="token keyword">data</span><span class="token operator">-</span>user <span class="token function">type</span> fuse<span class="token punctuation">.</span>ceph-fuse <span class="token punctuation">(</span>rw<span class="token punctuation">,</span>nosuid<span class="token punctuation">,</span>nodev<span class="token punctuation">,</span>noatime<span class="token punctuation">,</span>user_id=0<span class="token punctuation">,</span>group_id=0<span class="token punctuation">,</span>allow_other<span class="token punctuation">)</span>

查看效果
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># cat /cephfs-data-user/cephfs.txt</span>
nihao cephfs user

专用的卸载命令
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># fusermount -u /cephfs-data-user</span>
<span class="token namespace">[root@stor06 ~]</span><span class="token comment"># mount | grep cephfs</span>
</code></pre></div><p><strong>小结</strong></p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div><h2 id="_1-5-集群管理"><a href="#_1-5-集群管理" class="header-anchor">#</a> 1.5 集群管理</h2> <h3 id="_1-5-1-集群状态"><a href="#_1-5-1-集群状态" class="header-anchor">#</a> 1.5.1 集群状态</h3> <p>学习目标</p> <p>这一节，我们从 基础知识、集群管理、小结 三个方面来学习。</p> <p><strong>基础知识</strong></p> <p>检查集群状态</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code><span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph <span class="token operator">-</span>s
  cluster: 查看集群ID 和 集群运行状况
    id:     1d4e5773-619a-479d-861a-66ba451ce945
    health: HEALTH_OK

  services: 各种服务的状态监控
    mon: 3 daemons<span class="token punctuation">,</span> quorum mon01<span class="token punctuation">,</span>mon02<span class="token punctuation">,</span>mon03 <span class="token punctuation">(</span>age 48m<span class="token punctuation">)</span>
    mgr: mon01<span class="token punctuation">(</span>active<span class="token punctuation">,</span> since 2d<span class="token punctuation">)</span><span class="token punctuation">,</span> standbys: mon02
    mds: cephfs:1 <span class="token punctuation">{</span>0=stor05=up:active<span class="token punctuation">}</span>
    osd: 6 osds: 6 up <span class="token punctuation">(</span>since 48m<span class="token punctuation">)</span><span class="token punctuation">,</span> 6 in <span class="token punctuation">(</span>since 44h<span class="token punctuation">)</span>
    rgw: 1 daemon active <span class="token punctuation">(</span>stor04<span class="token punctuation">)</span>

  task status:  任务状态

  <span class="token keyword">data</span>: 存储数据相关的监控，包括存储池、存储对象、存储统计数量等
    pools:   10 pools<span class="token punctuation">,</span> 352 pgs
    objects: 270 objects<span class="token punctuation">,</span> 60 MiB
    usage:   6<span class="token punctuation">.</span>3 GiB used<span class="token punctuation">,</span> 114 GiB <span class="token operator">/</span> 120 GiB avail
    pgs:     352 active+clean  
</code></pre></div><p>检查集群即时状态</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>查看pg的状态
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph pg stat
352 pgs: 352 active+clean<span class="token punctuation">;</span> 60 MiB <span class="token keyword">data</span><span class="token punctuation">,</span> 314 MiB used<span class="token punctuation">,</span> 114 GiB <span class="token operator">/</span> 120 GiB avail<span class="token punctuation">;</span> 4<span class="token punctuation">.</span>0 KiB/s <span class="token function">rd</span><span class="token punctuation">,</span> 0 B/s wr<span class="token punctuation">,</span> 6 op/s

查看pool的状态
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd pool stats
pool <span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>root id 6
  nothing is going on
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看ceph的存储空间状态
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph df <span class="token namespace">[detail]</span>
RAW STORAGE:
    <span class="token keyword">CLASS</span>     SIZE        AVAIL       USED        RAW USED     <span class="token operator">%</span>RAW USED
    hdd       120 GiB     114 GiB     314 MiB      6<span class="token punctuation">.</span>3 GiB          5<span class="token punctuation">.</span>26
    TOTAL     120 GiB     114 GiB     314 MiB      6<span class="token punctuation">.</span>3 GiB          5<span class="token punctuation">.</span>26

POOLS:
    POOL         ID  PGS  STORED    OBJECTS  USED      <span class="token operator">%</span>USED    MAX AVAIL
    <span class="token punctuation">.</span>rgw<span class="token punctuation">.</span>root    6   32   1<span class="token punctuation">.</span>2 KiB   4        768 KiB   0        36 GiB
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p>查看osd状态</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>查看osd的基本状态
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd stat
6 osds: 6 up <span class="token punctuation">(</span>since 52m<span class="token punctuation">)</span><span class="token punctuation">,</span> 6 in <span class="token punctuation">(</span>since 44h<span class="token punctuation">)</span><span class="token punctuation">;</span> epoch: e150

查看osd的属性详情
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd dump
epoch 150
fsid 1d4e5773-619a-479d-861a-66ba451ce945
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

查看osd的归属结构Ceph将列显CRUSH树及主机、它的OSD、OSD是否已启动及其权重
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd tree
ID <span class="token keyword">CLASS</span> WEIGHT  <span class="token function">TYPE</span> NAME      STATUS REWEIGHT PRI-AFF
<span class="token operator">-</span>1       0<span class="token punctuation">.</span>11691 root default
<span class="token operator">-</span>3       0<span class="token punctuation">.</span>03897     host mon01
 0   hdd 0<span class="token punctuation">.</span>01949         osd<span class="token punctuation">.</span>0      up  1<span class="token punctuation">.</span>00000 1<span class="token punctuation">.</span>00000
 1   hdd 0<span class="token punctuation">.</span>01949         osd<span class="token punctuation">.</span>1      up  1<span class="token punctuation">.</span>00000 1<span class="token punctuation">.</span>00000
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p>查看mon状态</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	集群中存在多个Mon主机时，应该在启动集群之后读取或写入数据之前检查Mon的仲裁状态；事实上，管理员也应该定期检查这种仲裁结果
	
显示监视器映射
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph mon stat
e3: 3 mons at <span class="token punctuation">{</span>mon01=<span class="token namespace">[v2:10.0.0.13:3300/0,v1:10.0.0.13:6789/0]</span><span class="token punctuation">,</span>mon02=<span class="token namespace">[v2:10.0.0.14:3300/0,v1:10.0.0.14:6789/0]</span><span class="token punctuation">,</span>mon03=<span class="token namespace">[v2:10.0.0.15:3300/0,v1:10.0.0.15:6789/0]</span><span class="token punctuation">}</span><span class="token punctuation">,</span> election epoch 36<span class="token punctuation">,</span> leader 0 mon01<span class="token punctuation">,</span> quorum 0<span class="token punctuation">,</span>1<span class="token punctuation">,</span>2 mon01<span class="token punctuation">,</span>mon02<span class="token punctuation">,</span>mon03

<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph mon dump
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
0: <span class="token namespace">[v2:10.0.0.13:3300/0,v1:10.0.0.13:6789/0]</span> mon<span class="token punctuation">.</span>mon01
1: <span class="token namespace">[v2:10.0.0.14:3300/0,v1:10.0.0.14:6789/0]</span> mon<span class="token punctuation">.</span>mon02
2: <span class="token namespace">[v2:10.0.0.15:3300/0,v1:10.0.0.15:6789/0]</span> mon<span class="token punctuation">.</span>mon03
dumped monmap epoch 3
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>普通方式查看多个mon节点的选举状态
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph quorum_status

以格式化方式查看选举状态
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph quorum_status <span class="token operator">-</span>f json-pretty
</code></pre></div><p><strong>集群管理</strong></p> <p>集群管理套接字</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>Ceph的管理套接字接口常用于查询守护进程
	资源对象文件保存的目录 <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib/ceph目录
	套接字默认保存 于<span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>run/ceph目录
	此接口的使用不能以远程方式进程
</code></pre></div><p>借助于socket文件实现ceph属性的动态管理</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>命令的使用格式：
	ceph <span class="token operator">--</span>admin-daemon <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>run/ceph/socket-name
	获取使用帮助：
	ceph <span class="token operator">--</span>admin-daemon <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>run/ceph/socket-name help
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>简单示例
	ceph <span class="token operator">--</span>admin-daemon <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>run/ceph/ceph-mgr<span class="token punctuation">.</span>mon01<span class="token punctuation">.</span>asok help
	ceph <span class="token operator">--</span>admin-daemon <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>run/ceph/ceph-mon<span class="token punctuation">.</span>mon01<span class="token punctuation">.</span>asok help
	ceph <span class="token operator">--</span>admin-daemon <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>run/ceph/ceph-osd<span class="token punctuation">.</span>0<span class="token punctuation">.</span>asok help
	ceph <span class="token operator">--</span>admin-daemon <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>run/ceph/ceph-osd<span class="token punctuation">.</span>1<span class="token punctuation">.</span>asok help
</code></pre></div><p><strong>小结</strong></p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div><h3 id="_1-5-2-配置文件"><a href="#_1-5-2-配置文件" class="header-anchor">#</a> 1.5.2 配置文件</h3> <p>学习目标</p> <p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p> <p><strong>基础知识</strong></p> <p>文件目录</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>ceph软件安装完成后，就会生成专用的家目录

root@mon01:~<span class="token comment"># ls /etc/ceph/</span>
ceph<span class="token punctuation">.</span>client<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>keyring  ceph<span class="token punctuation">.</span>conf  rbdmap  tmpzvyyulv9
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>ceph配置文件就是 ceph<span class="token punctuation">.</span>conf，该文件遵循 ini文件的语法格式。

root@mon01:~<span class="token comment"># cat /etc/ceph/ceph.conf</span>
<span class="token namespace">[global]</span>
fsid = 22fc9b8e-6d30-463d-b312-89dc91ee0969
public_network = 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0/24
cluster_network = 192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>8<span class="token punctuation">.</span>0/24
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token namespace">[mon]</span>
mon allow pool delete = true
</code></pre></div><p>配置结构</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>对于ceph<span class="token punctuation">.</span>conf文件来说，它主要有四部分组成：
	<span class="token namespace">[global]</span> 	ceph存储的全局性配置
	<span class="token namespace">[osd]</span>		所有影响 Ceph 存储集群中 ceph-osd 守护进程的相关配置，会覆盖global的相同属性
	<span class="token namespace">[mon]</span>		所有影响 Ceph 存储集群中 ceph-mon 守护进程的相关配置，会覆盖global的相同属性
	<span class="token namespace">[client]</span>	所有影响 Ceph 客户端管理的相关配置，比如 块设备客户端、fs客户端、oss客户端等
	
注意：ceph<span class="token punctuation">.</span>conf主要是针对整体来进行设置的，如果我们需要针对某一个对象来进行修改的话，可以使用
	<span class="token string">&quot;对象.主机名|id&quot;</span> 的方式来进行针对性定制。
	比如：<span class="token namespace">[mon.mon01]</span>、<span class="token namespace">[osd.1]</span>
</code></pre></div><p>配置文件的加载</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>对于ceph来说，它的配置文件，不仅仅有 <span class="token operator">/</span>etc/ceph/ceph<span class="token punctuation">.</span>conf 一种样式，他还有更多的样式 <span class="token operator">--</span> 主要是作用的范围不一样

全局范围：
	<span class="token operator">/</span>etc/ceph/ceph<span class="token punctuation">.</span>conf
	<span class="token variable">$CEPH_CONF</span>
	<span class="token operator">-</span>c path/to/ceph<span class="token punctuation">.</span>conf
局部范围
	~<span class="token operator">/</span><span class="token punctuation">.</span>ceph/config
	<span class="token punctuation">.</span><span class="token operator">/</span>ceph/conf
</code></pre></div><p><strong>简单实践</strong></p> <p>元参数</p> <div class="language- extra-class"><pre class="language-text"><code>	在ceph环境中，它提供了很多可以直接拿过来使用的元数据变量。这些变量可以直接从环境中获取到指定的信息，方便我们进行后续处理。
	这些信息，不仅仅可以在运行时使用，还可以在配置文件中进行定制。
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>常见的变量信息有：
<span class="token operator">-</span> <span class="token variable">$cluster</span>：当前Ceph集群的名称
<span class="token operator">-</span> <span class="token variable">$type</span>：当前服务的类型名称，可能会展开为osd或mon；
<span class="token operator">-</span> <span class="token variable">$id</span>：进程的标识符，例如对osd<span class="token punctuation">.</span>0来说，其标识符为0；
<span class="token operator">-</span> <span class="token variable">$host</span>：守护进程所在主机的主机名；
<span class="token operator">-</span> <span class="token variable">$name</span>：其值为<span class="token variable">$type</span><span class="token punctuation">.</span><span class="token variable">$id</span>
</code></pre></div><p>运行时使用</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>我们在ceph运行过程中，可以通过 以下方式来获取不同的属性信息内容
	查看配置信息
	ceph daemon <span class="token punctuation">{</span>daemon-<span class="token function">type</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token punctuation">{</span>id<span class="token punctuation">}</span> config show
	查看帮助信息
	ceph daemon <span class="token punctuation">{</span>daemon-<span class="token function">type</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token punctuation">{</span>id<span class="token punctuation">}</span> help
	查看指定参数信息
	ceph daemon <span class="token punctuation">{</span>daemon-<span class="token function">type</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token punctuation">{</span>id<span class="token punctuation">}</span> config get <span class="token punctuation">{</span>parameter<span class="token punctuation">}</span>
	修改特定的信息
	ceph tell <span class="token punctuation">{</span>daemon-<span class="token function">type</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token punctuation">{</span>daemon id or <span class="token operator">*</span><span class="token punctuation">}</span> injectargs <span class="token operator">--</span><span class="token punctuation">{</span>name<span class="token punctuation">}</span> <span class="token punctuation">{</span>value<span class="token punctuation">}</span> <span class="token punctuation">[</span><span class="token operator">--</span><span class="token punctuation">{</span>name<span class="token punctuation">}</span> <span class="token punctuation">{</span>value<span class="token punctuation">}</span><span class="token punctuation">]</span>
	设定特定的属性
	ceph daemon <span class="token punctuation">{</span>daemon-<span class="token function">type</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token punctuation">{</span>id<span class="token punctuation">}</span> <span class="token function">set</span> <span class="token punctuation">{</span>name<span class="token punctuation">}</span> <span class="token punctuation">{</span>value<span class="token punctuation">}</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>获取所有配置属性
<span class="token namespace">[root@mon01 ~]</span><span class="token comment"># ceph daemon osd.0 config show</span>
<span class="token punctuation">{</span>
    <span class="token string">&quot;name&quot;</span>: <span class="token string">&quot;osd.0&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;cluster&quot;</span>: <span class="token string">&quot;ceph&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;admin_socket&quot;</span>: <span class="token string">&quot;/var/run/ceph/ceph-osd.0.asok&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;admin_socket_mode&quot;</span>: <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token string">&quot;threadpool_empty_queue_max_wait&quot;</span>: <span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;throttler_perf_counter&quot;</span>: <span class="token string">&quot;true&quot;</span>
<span class="token punctuation">}</span>
<span class="token namespace">[root@mon01 ~]</span><span class="token comment"># ceph daemon osd.0 config show | wc -l</span>
1644
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>获取帮助信息
<span class="token namespace">[root@mon01 ~]</span><span class="token comment"># ceph daemon mon.mon01 help</span>
<span class="token punctuation">{</span>
    <span class="token string">&quot;add_bootstrap_peer_hint&quot;</span>: <span class="token string">&quot;add peer address as potential bootstrap peer for cluster bringup&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token string">&quot;sessions&quot;</span>: <span class="token string">&quot;list existing sessions&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;smart&quot;</span>: <span class="token string">&quot;Query health metrics for underlying device&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;sync_force&quot;</span>: <span class="token string">&quot;force sync of and clear monitor store&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;version&quot;</span>: <span class="token string">&quot;get ceph version&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>获取制定信息
<span class="token namespace">[root@mon01 ~]</span><span class="token comment"># ceph daemon mon.mon01 config get admin_socket</span>
<span class="token punctuation">{</span>
    <span class="token string">&quot;admin_socket&quot;</span>: <span class="token string">&quot;/var/run/ceph/ceph-mon.mon01.asok&quot;</span>
<span class="token punctuation">}</span>

<span class="token namespace">[root@mon01 ~]</span><span class="token comment"># ceph daemon osd.0 config get admin_socket</span>
<span class="token punctuation">{</span>
    <span class="token string">&quot;admin_socket&quot;</span>: <span class="token string">&quot;/var/run/ceph/ceph-osd.0.asok&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>更改属性</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>查看当前的属性信息
<span class="token namespace">[root@mon01 ~]</span><span class="token comment"># ceph daemon osd.0 config get debug_osd</span>
<span class="token punctuation">{</span>
    <span class="token string">&quot;debug_osd&quot;</span>: <span class="token string">&quot;1/5&quot;</span>
<span class="token punctuation">}</span>

修改制定的属性
<span class="token namespace">[root@mon01 ~]</span><span class="token comment"># ceph tell osd.0 injectargs '--debug-osd 0/5'</span>

查看修改后的属性信息
<span class="token namespace">[root@mon01 ~]</span><span class="token comment"># ceph daemon osd.0 config get debug_osd</span>
<span class="token punctuation">{</span>
    <span class="token string">&quot;debug_osd&quot;</span>: <span class="token string">&quot;0/5&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>修改制定的属性
ceph daemon osd<span class="token punctuation">.</span>0 config <span class="token function">set</span> debug_osd 1/5
ceph daemon osd<span class="token punctuation">.</span>0 config get debug_osd
</code></pre></div><p><strong>小结</strong></p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div><h3 id="_1-5-3-磁盘管理"><a href="#_1-5-3-磁盘管理" class="header-anchor">#</a> 1.5.3 磁盘管理</h3> <p>学习目标</p> <p>这一节，我们从 场景需求、简单实践、小结 三个方面来学习。</p> <p><strong>场景需求</strong></p> <p>简介</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	在ceph分布式存储集群里，数以千计万计的磁盘数量规模下，磁盘出现故障是不可避免，所以服务器更换故障磁盘就成为大规模机房的日常运维工作之一，而ceph存储集群中就需要在物理磁盘更换的前提下，需要不断重复的完成OSD磁盘的更换的操作。
</code></pre></div><p>操作步骤</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	在ceph集群环境中，主要有三套方法来实现磁盘的更换操作，但是这些操作各有优劣，甚至对于某些场景来说，不能够使用xx方式的磁盘更换操作，所以我们需要了解一下这些常见的磁盘管理操作。
	注意：
		这里主要介绍多种磁盘更换的思路和区别，里面的一些数据，仅供参考。
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>更换方式1：
	1 到指定节点上，停止指定的osd进程
    2 将移除OSD节点状态标记为out
    3 从crush中移除OSD节点，该节点不作为数据的载体
    4 删除OSD节点和对应的认证信息
    5 增加一个新的 OSD
   	注意：
   		1、2、3、4、5 这几步都会发生数据迁移的动作
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>更换方式2：
	1 修改osd的数据操作权重值，让数据不分布在这个节点上
	2 到指定节点上，停止指定的osd进程
	3 将移除OSD节点状态标记为out
	4 从crush中移除OSD节点，该节点不作为数据的载体
	5 删除OSD节点和对应的认证信息
	6 增加一个新的 OSD
	注意：
		1、5、6 这几步会发生数据迁移动作
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>更换方式3：
	1 对ceph集群的osd设置禁止数据迁移的标记
	2 修改osd的数据操作权重值，让数据不分布在这个节点上
	3 到指定节点上，停止指定的osd进程
	4 从crush中移除OSD节点，该节点不作为数据的载体
	5 删除OSD节点和对应的认证信息
	6 增加一个新的 OSD
	7 移除ceph集群的osd禁止数据迁移标记
	注意：
		因为添加了标记，所以1-6这几步的数据迁移都不会执行，只有7这一步会发生数据迁移动作。
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>注意：
	如果想要查看每次数据迁移的状态，可以查看当前pg的状态效果
	ceph pg dump pgs<span class="token punctuation">|</span>awk <span class="token string">'{print $1,$15}'</span><span class="token punctuation">|</span>grep <span class="token operator">-</span>v pg &gt; pg_base<span class="token punctuation">.</span>txt
	每次执行数据迁移动作后，可以再次保存，然后对比此次数据迁移的效果
	<span class="token function">diff</span> <span class="token operator">-</span>y <span class="token operator">-</span>W 100 pg_end<span class="token punctuation">.</span>txt pg_base<span class="token punctuation">.</span>txt <span class="token operator">--</span>suppress-common-lines <span class="token punctuation">|</span> wc <span class="token operator">-</span>l
</code></pre></div><p><strong>简单实践</strong></p> <p>磁盘更换方式1实践</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>1 到指定节点上，停止指定的osd进程
<span class="token namespace">[root@mon01 ~]</span><span class="token comment"># systemctl  stop  ceph-osd@1</span>
<span class="token namespace">[root@mon01 ~]</span><span class="token comment"># ceph osd tree</span>
ID <span class="token keyword">CLASS</span> WEIGHT  <span class="token function">TYPE</span> NAME      STATUS REWEIGHT PRI-AFF
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 1   hdd 0<span class="token punctuation">.</span>01949         osd<span class="token punctuation">.</span>1    down  1<span class="token punctuation">.</span>00000 1<span class="token punctuation">.</span>00000
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>2 将移除OSD节点状态标记为out
<span class="token namespace">[root@mon01 ~]</span><span class="token comment"># ceph osd out 1</span>
marked out osd<span class="token punctuation">.</span>1<span class="token punctuation">.</span>
<span class="token namespace">[root@mon01 ~]</span><span class="token comment"># ceph osd tree</span>
ID <span class="token keyword">CLASS</span> WEIGHT  <span class="token function">TYPE</span> NAME      STATUS REWEIGHT PRI-AFF
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 1   hdd 0<span class="token punctuation">.</span>01949         osd<span class="token punctuation">.</span>1    down        0 1<span class="token punctuation">.</span>00000
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>标记状态的改变，会导致pg的迁移，查看pgs的状态
<span class="token namespace">[root@mon01 ~]</span><span class="token comment"># ceph pg dump pgs</span>
10<span class="token punctuation">.</span>1d         0     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   0 active+clean <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
注意：
	pg迁移过程中，会有一些异常状态 active+recovering+undersized+remapped 
	
我们还有另外一种方式来进行检查数据迁移效果
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph <span class="token operator">-</span>s
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  services:
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    osd: 7 osds: 6 up <span class="token punctuation">(</span>since 20s<span class="token punctuation">)</span><span class="token punctuation">,</span> 6 in <span class="token punctuation">(</span>since 20s<span class="token punctuation">)</span><span class="token punctuation">;</span> 17 remapped pgs
    rgw: 1 daemon active <span class="token punctuation">(</span>stor04<span class="token punctuation">)</span>

  task status:

  <span class="token keyword">data</span>:
    pools:   10 pools<span class="token punctuation">,</span> 352 pgs
    objects: 270 objects<span class="token punctuation">,</span> 60 MiB
    usage:   6<span class="token punctuation">.</span>4 GiB used<span class="token punctuation">,</span> 114 GiB <span class="token operator">/</span> 120 GiB avail
    pgs:     0<span class="token punctuation">.</span>284% pgs not active
             158/810 objects degraded <span class="token punctuation">(</span>19<span class="token punctuation">.</span>506%<span class="token punctuation">)</span>
             14/810 objects misplaced <span class="token punctuation">(</span>1<span class="token punctuation">.</span>728%<span class="token punctuation">)</span>
             327 active+clean
             17  active+recovery_wait+undersized+degraded+remapped
             3   active+recovery_wait+degraded
             1   active+recovery_wait
             1   active+recovery_wait+remapped
             1   active+recovering+degraded
             1   activating
             1   active+recovering+undersized+remapped

  io:
    recovery: 3<span class="token punctuation">.</span>1 MiB/s<span class="token punctuation">,</span> 4 objects/s
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>3 从crush中移除OSD节点，该节点不作为数据的载体
<span class="token namespace">[root@mon01 ~]</span><span class="token comment"># ceph osd crush remove osd.1</span>
removed item id 1 name <span class="token string">'osd.1'</span> <span class="token keyword">from</span> crush map
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>4 移除无效的osd节点<span class="token punctuation">,</span>并移除认证信息
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd <span class="token function">rm</span> osd<span class="token punctuation">.</span>1
removed osd<span class="token punctuation">.</span>1
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph auth <span class="token function">del</span> osd<span class="token punctuation">.</span>1
updated
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>5-1 清理磁盘
dmsetup status
<span class="token function">cat</span> <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib/ceph/osd/ceph-1/fsid
dmsetup remove ceph-1的id
mkfs<span class="token punctuation">.</span>ext4 <span class="token operator">/</span>dev/sdc

5-2 擦除磁盘上的数据
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph-deploy disk zap mon01 <span class="token operator">/</span>dev/sdc

5-3 添加磁盘数据
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph-deploy <span class="token operator">--</span>overwrite-conf osd create mon01 <span class="token operator">--</span><span class="token keyword">data</span> <span class="token operator">/</span>dev/sdc
</code></pre></div><p>磁盘更换方式2实践</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>这次以mon02 主机为例
<span class="token namespace">[root@mon02 ~]</span><span class="token comment"># ceph osd tree</span>
ID <span class="token keyword">CLASS</span> WEIGHT  <span class="token function">TYPE</span> NAME      STATUS REWEIGHT PRI-AFF
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">-</span>5       0<span class="token punctuation">.</span>03897     host mon02
 2   hdd 0<span class="token punctuation">.</span>01949         osd<span class="token punctuation">.</span>2      up  1<span class="token punctuation">.</span>00000 1<span class="token punctuation">.</span>00000
 3   hdd 0<span class="token punctuation">.</span>01949         osd<span class="token punctuation">.</span>3      up  1<span class="token punctuation">.</span>00000 1<span class="token punctuation">.</span>00000
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>1 修改osd的数据操作权重值，让数据不分布在这个节点上
<span class="token namespace">[root@mon02 ~]</span><span class="token comment"># ceph osd crush reweight osd.3 0</span>
reweighted item id 3 name <span class="token string">'osd.3'</span> to 0 in crush map
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>2 到指定节点上，停止指定的osd进程
<span class="token namespace">[root@mon02 ~]</span><span class="token comment"># sudo systemctl stop ceph-osd@3</span>

3 将移除OSD节点状态标记为out
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd out osd<span class="token punctuation">.</span>3
marked out osd<span class="token punctuation">.</span>3<span class="token punctuation">.</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>4 从crush中移除OSD节点，该节点不作为数据的载体
<span class="token namespace">[root@mon02 ~]</span><span class="token comment"># ceph osd crush remove osd.3</span>
removed item id 3 name <span class="token string">'osd.3'</span> <span class="token keyword">from</span> crush map
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>5 移除无效的osd节点后删除认证信息
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd <span class="token function">rm</span> osd<span class="token punctuation">.</span>3
removed osd<span class="token punctuation">.</span>3
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph auth <span class="token function">del</span> osd<span class="token punctuation">.</span>3
updated
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>6-1 清理磁盘
dmsetup status
<span class="token function">cat</span> <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib/ceph/osd/ceph-2/fsid
dmsetup remove ceph-3的id
mkfs<span class="token punctuation">.</span>ext4 <span class="token operator">/</span>dev/sdc

6-2 擦除磁盘上的数据后添加磁盘
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph-deploy disk zap mon02 <span class="token operator">/</span>dev/sdc
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph-deploy <span class="token operator">--</span>overwrite-conf osd create mon02 <span class="token operator">--</span><span class="token keyword">data</span> <span class="token operator">/</span>dev/sdc
</code></pre></div><p>磁盘更换方式3实践</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>1 对ceph集群的osd设置禁止数据迁移的标记
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd <span class="token function">set</span> norebalance
norebalance is <span class="token function">set</span>
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd <span class="token function">set</span> nobackfill
nobackfill is <span class="token function">set</span>
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd <span class="token function">set</span> norecover
norecover is <span class="token function">set</span>

查看状态后，osd会有相应标签
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph <span class="token operator">-</span>s
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  services:
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    osd: 6 osds: 6 up <span class="token punctuation">(</span>since 16m<span class="token punctuation">)</span><span class="token punctuation">,</span> 6 in <span class="token punctuation">(</span>since 16m<span class="token punctuation">)</span>
         flags nobackfill<span class="token punctuation">,</span>norebalance<span class="token punctuation">,</span>norecover
    rgw: 1 daemon active <span class="token punctuation">(</span>stor04<span class="token punctuation">)</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>2 修改osd的数据操作权重值，让数据不分布在这个节点上
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd crush reweight osd<span class="token punctuation">.</span>5 0
reweighted item id 5 name <span class="token string">'osd.5'</span> to 0 in crush map

因为集群已经禁止数据迁移了，所以这个时候，并不会发生数据迁移动作
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph <span class="token operator">-</span>s
  cluster:
    id:     1d4e5773-619a-479d-861a-66ba451ce945
    health: HEALTH_WARN
            nobackfill<span class="token punctuation">,</span>norebalance<span class="token punctuation">,</span>norecover flag<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token function">set</span>
            Reduced <span class="token keyword">data</span> availability: 16 pgs inactive<span class="token punctuation">,</span> 20 pgs peering
            Degraded <span class="token keyword">data</span> redundancy: 104/810 objects degraded <span class="token punctuation">(</span>12<span class="token punctuation">.</span>840%<span class="token punctuation">)</span><span class="token punctuation">,</span> 30 pgs degraded<span class="token punctuation">,</span> 1 pg undersized
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">data</span>:
    pools:   10 pools<span class="token punctuation">,</span> 352 pgs
    objects: 270 objects<span class="token punctuation">,</span> 60 MiB
    usage:   6<span class="token punctuation">.</span>5 GiB used<span class="token punctuation">,</span> 114 GiB <span class="token operator">/</span> 120 GiB avail
    pgs:     27<span class="token punctuation">.</span>273% pgs not active
             104/810 objects degraded <span class="token punctuation">(</span>12<span class="token punctuation">.</span>840%<span class="token punctuation">)</span>
             6/810 objects misplaced <span class="token punctuation">(</span>0<span class="token punctuation">.</span>741%<span class="token punctuation">)</span>
             226 active+clean
             95  peering
             16  active+recovery_wait+degraded
             14  active+recovery_wait+undersized+degraded+remapped
             1   remapped+peering
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>3 到指定节点上，停止指定的osd进程
<span class="token namespace">[root@mon03 ~]</span><span class="token comment"># sudo systemctl stop ceph-osd@5</span>

4 从crush中移除OSD节点，该节点不作为数据的载体
<span class="token namespace">[root@mon02 ~]</span><span class="token comment"># ceph osd crush remove osd.5</span>
removed item id 5 name <span class="token string">'osd.5'</span> <span class="token keyword">from</span> crush map

5 移除无效的osd节点后删除认证信息
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd <span class="token function">rm</span> osd<span class="token punctuation">.</span>5
removed osd<span class="token punctuation">.</span>5
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph auth <span class="token function">del</span> osd<span class="token punctuation">.</span>5
updated
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>6-1 清理磁盘
dmsetup status
<span class="token function">cat</span> <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib/ceph/osd/ceph-5/fsid
dmsetup remove ceph-5的id
mkfs<span class="token punctuation">.</span>ext4 <span class="token operator">/</span>dev/sdc

6-2 擦除磁盘上的数据后添加磁盘
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph-deploy disk zap mon03 <span class="token operator">/</span>dev/sdc
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph-deploy <span class="token operator">--</span>overwrite-conf osd create mon03 <span class="token operator">--</span><span class="token keyword">data</span> <span class="token operator">/</span>dev/sdc
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>7 移除ceph集群的osd禁止数据迁移标记
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd unset norebalance
norebalance is unset
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd unset nobackfill
nobackfill is unset
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd unset norecover
norecover is unset
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>稍等一会查看ceph的状态
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph <span class="token operator">-</span>s
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">data</span>:
    pools:   10 pools<span class="token punctuation">,</span> 352 pgs
    objects: 270 objects<span class="token punctuation">,</span> 60 MiB
    usage:   6<span class="token punctuation">.</span>5 GiB used<span class="token punctuation">,</span> 113 GiB <span class="token operator">/</span> 120 GiB avail
    pgs:     352 active+clean
结果显示：
	这个时候，才会发生数据迁移的动作
</code></pre></div><p>生产技巧</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	当我们遇到ceph宿主机重启的场景，如果不想发生频繁的数据迁移动作，可以手工临时禁用ceph自带数据恢复平衡功能即可

禁用ceph集群数据迁移：
    ceph osd <span class="token function">set</span> noout
    ceph osd <span class="token function">set</span> nobackfill
    ceph osd <span class="token function">set</span> norecover
启用ceph集群数据迁移：
    ceph osd unset noout
    ceph osd unset nobackfill
    ceph osd unset norecover
</code></pre></div><p><strong>小结</strong></p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div><h3 id="_1-5-4-性能调优"><a href="#_1-5-4-性能调优" class="header-anchor">#</a> 1.5.4 性能调优</h3> <p>学习目标</p> <p>这一节，我们从 基础知识、常见策略、小结 三个方面来学习。</p> <p><strong>基础知识</strong></p> <p>简介</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	性能优化没有一个标准的定义，如果用大白话来说的话，他就是在现有主机资源的前提下，发挥业务最大的处理能力。也理解为：通过空间<span class="token punctuation">(</span>资源消耗<span class="token punctuation">)</span>优化换取时间<span class="token punctuation">(</span>业务处理<span class="token punctuation">)</span>效益
	它主要体现在几个方面：改善业务逻辑处理的速度、提升业务数据吞吐量、优化主机资源的消耗量。
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>	性能优化没有一个基准值，我们只能通过自我或者普遍的场景工作经验，设定一个阶段性的目标，然后通过物理手段、配置手段、代码手段等方式提高主机资源的业务处理能力。
</code></pre></div><p>通用处理措施</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>基础设施
	合适设备 <span class="token operator">-</span> 多云环境、新旧服务器结合、合适网络等
	研发环境 <span class="token operator">-</span> 应用架构、研发平台、代码规范等
应用软件
	多级缓存 <span class="token operator">-</span> 浏览器缓存、缓存服务器、服务器缓存、应用缓存、代码缓存、数据缓存等。
	数据压缩 <span class="token operator">-</span> 数据构建压缩、数据传输压缩、缓存数据压缩、数据对象压缩、清理无效数据等。
	数据预热 <span class="token operator">-</span> 缓冲数据、预取数据、预置主机、数据同步等。
业务处理
	削峰填谷 <span class="token operator">-</span> 延时加载、分批发布、限流控制、异步处理、超时降级等
	任务批处理 <span class="token operator">-</span> 数据打包传输、数据批量传输、延迟数据处理等
</code></pre></div><p>ceph环境</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	Ceph分布式存储环境是以集群服务器来进行承载存储服务的，所以对于Ceph的性能优化主要体现在基础设施层的合适设备、应用项目的多级缓存和数据压缩、业务处理的任务批处理。
</code></pre></div><p><strong>常见策略</strong></p> <p>基础设施</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	Ceph集群的各个服务守护进程在 Linux 服务器上运行，所以适当调优操作系统能够对ceph存储集群的性能产生积极的影响。它主要涉及到以下几个方面：
	<span class="token operator">-</span> 选择合适的CPU和内存。
		不同角色具有不同的 CPU 需求，MDS<span class="token punctuation">(</span>4<span class="token punctuation">)</span>&gt;OSD<span class="token punctuation">(</span>2<span class="token punctuation">)</span>&gt;MON<span class="token punctuation">(</span>1<span class="token punctuation">)</span>，纠删代码功能需要更多 CPU。
		不同角色具有不同的 内存 需求，MON&gt;OSD
	<span class="token operator">-</span> 选择合适的磁盘容量	
    	合理评估阶段性业务量，计算节点数量及各个节点的磁盘容量需求。
    	选择合适的 SAS、SATA、SSD，实现分级存储的能力。
    	OS系统、数据、日志使用独立的SSD硬盘，使整体吞吐量最大化
    <span class="token operator">-</span> 选择合适的网络设备
    	Ceph集群对于网络数据传输能力要求高，需要支持巨型帧<span class="token punctuation">(</span>9000字节，默认1500字节<span class="token punctuation">)</span>功能
    	Ceph集群数据传输量很大，需要所有设备的 MTU 设置必须一致
    	如果可以的话，网络带宽一定要大，最好以3倍需求量的方式采购
    <span class="token operator">-</span> 配置合适的文件系统
    	推荐使用vfs文件系统，ceph借助于xfs扩展属性在创建和挂载文件系统场景中提高索引数据缓存
    	osd_mkfs_options_xfs、osd_mount_options_xfs
    <span class="token operator">-</span> 搭建内部时间服务器
    	ceph集群对于时间要求比较高，为了保证数据的通信一致性，最好采用内部时间服务器
    <span class="token operator">-</span> 合理采用多云环境
    	将合适的业务负载转移到公有云环境。
</code></pre></div><p>应用软件</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	Ceph集群的很多功能都是以各种服务配置的方式来进行实现的，所以我们有必要结合不同的配置属性，实现ceph集群环境级别的性能优化：
	<span class="token operator">-</span> 数据访问
		采用public网络和cluster网络机制，实现数据操作网络的可靠性，避免外部网络攻击的安全性。
		配置属性：public_network、cluster_network、max_open_file等
	<span class="token operator">-</span> 数据存储
		设定合理的存储池的PG 数量，集群PGs总数 = <span class="token punctuation">(</span>OSD总数 <span class="token operator">*</span> 100 <span class="token operator">/</span> 最大副本数<span class="token punctuation">)</span>
		更多数据存储规划：https:<span class="token operator">/</span><span class="token operator">/</span>docs<span class="token punctuation">.</span>ceph<span class="token punctuation">.</span>com/en/latest/rados/operations/placement-groups/<span class="token comment">#choosing-the-number-of-placement-groups</span>
	<span class="token operator">-</span> 多级缓存
		根据实际情况开启RDBCache<span class="token punctuation">(</span>rbd_cache_xxx<span class="token punctuation">)</span>、RGWCache<span class="token punctuation">(</span>rgw_cache_xxx<span class="token punctuation">)</span>、OSDCache、MDSCache
		建立合理的SSD缓存pool，设定合理的cache age、target size 等参数
		理清业务场景，根据缓存模式<span class="token punctuation">(</span><span class="token function">write-back</span>、readproxy、readonly等<span class="token punctuation">)</span>，启用cache-tiering机制。
</code></pre></div><p>业务处理</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	ceph集群在大规模数据处理的时候，可以通过数据批处理能力来实现数据的高效传输。
	<span class="token operator">-</span> 数据批处理
		filestore_max<span class="token punctuation">|</span>min_sync_interval 从日志到数据盘最大<span class="token punctuation">|</span>小同步间隔<span class="token punctuation">(</span>seconds<span class="token punctuation">)</span>
		filestore_queue_max_ops<span class="token punctuation">|</span>bytes 数据盘单次最大接受的操作数<span class="token punctuation">|</span>字节数
		filestore_queue_committing_max_ops<span class="token punctuation">|</span>bytes 数据盘单次最大处理的操作数<span class="token punctuation">|</span>字节数
		journal_max_write_ops<span class="token punctuation">|</span>bytes 日志一次性写入的最大操作数<span class="token punctuation">|</span>字节数<span class="token punctuation">(</span>bytes<span class="token punctuation">)</span>
		journal_queue_max_ops<span class="token punctuation">|</span>bytes 日志一次性查询的最大操作数<span class="token punctuation">|</span>字节数<span class="token punctuation">(</span>bytes<span class="token punctuation">)</span>
		osd_max_write_size	OSD一次可写入的最大值<span class="token punctuation">(</span>MB<span class="token punctuation">)</span>
		osd_recovery_max_active	同一时间内活跃的恢复请求数
</code></pre></div><p><strong>小结</strong></p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div><h3 id="_1-5-5-性能测试"><a href="#_1-5-5-性能测试" class="header-anchor">#</a> 1.5.5 性能测试</h3> <p>学习目标</p> <p>这一节，我们从 基准测试、rados测试、小结 三个方面来学习。</p> <p><strong>基准测试</strong></p> <p>磁盘测试</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>准备工作<span class="token operator">-</span>清理缓存
<span class="token namespace">[root@mon03 ~]</span><span class="token comment"># echo 3 &gt; /proc/sys/vm/drop_caches^C</span>
<span class="token namespace">[root@mon03 ~]</span><span class="token comment"># cat /proc/sys/vm/drop_caches</span>
0
<span class="token namespace">[root@mon03 ~]</span><span class="token comment"># echo 3 &gt; /proc/sys/vm/drop_caches</span>

查看磁盘
<span class="token namespace">[root@mon03 ~]</span><span class="token comment"># ls /var/lib/ceph/osd/</span>
ceph-4  ceph-5
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>OSD 磁盘写性能
<span class="token namespace">[root@mon03 ~]</span><span class="token comment"># dd if=/dev/zero of=/var/lib/ceph/osd/ceph-4/write_test bs=1M count=100</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
104857600字节<span class="token punctuation">(</span>105 MB<span class="token punctuation">)</span>已复制，0<span class="token punctuation">.</span>4009 秒，262 MB/秒

OSD 磁盘读性能
<span class="token namespace">[root@mon03 ~]</span><span class="token comment"># dd if=/var/lib/ceph/osd/ceph-4/write_test of=/dev/null bs=1M count=100</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
104857600字节<span class="token punctuation">(</span>105 MB<span class="token punctuation">)</span>已复制，0<span class="token punctuation">.</span>0233439 秒，4<span class="token punctuation">.</span>5 GB/秒

清理环境
<span class="token namespace">[root@mon03 ~]</span><span class="token comment"># rm -f /var/lib/ceph/osd/ceph-4/write_test</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>参考资料：
	https:<span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>thomas-krenn<span class="token punctuation">.</span>com/en/wiki/Linux_I/O_Performance_Tests_using_dd
</code></pre></div><p>网络测试</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>在多台主机上准备网络基准测试工具
yum install iperf <span class="token operator">-</span>y
服务端命令参数
	<span class="token operator">-</span>s 以server模式启动
	<span class="token operator">-</span>p 指定服务器端使用的端口或客户端所连接的端口
客户端命令参数
	<span class="token operator">-</span>d 同时进行双向传输测试
	<span class="token operator">-</span>n 指定传输的字节数
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>节点1执行命令
<span class="token namespace">[root@admin ~]</span><span class="token comment"># iperf -s -p 6900</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>客户端执行命令
<span class="token namespace">[root@mon03 ~]</span><span class="token comment"># iperf -c admin -p 6900</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
Client connecting to admin<span class="token punctuation">,</span> TCP port 6900
TCP window size:  552 KByte <span class="token punctuation">(</span>default<span class="token punctuation">)</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token punctuation">[</span>  3<span class="token punctuation">]</span> local 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>15 port 48376 connected with 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12 port 6900
<span class="token punctuation">[</span> ID<span class="token punctuation">]</span> Interval       Transfer     Bandwidth
<span class="token punctuation">[</span>  3<span class="token punctuation">]</span>  0<span class="token punctuation">.</span>0-10<span class="token punctuation">.</span>0 sec  2<span class="token punctuation">.</span>58 GBytes  2<span class="token punctuation">.</span>21 Gbits/sec
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>注意：
	无论是磁盘测试还是网络测试，都需要多次测试后，获取平均值效果
</code></pre></div><p><strong>rados测试</strong></p> <p>bench性能测试工具</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>它是Ceph 自带的 rados bench 测试工具，命令格式如下：
	rados bench <span class="token operator">-</span>p &lt;存储池&gt; &lt;秒数&gt; &lt;操作模式&gt; <span class="token operator">-</span>b &lt;块大小&gt; <span class="token operator">-</span>t 并行数 <span class="token operator">--</span>no-cleanup
参数解读：
	操作模式：包括三种，分别是<span class="token function">write</span>：写，seq：顺序读；rand：随机读
	块大小：默认为4M
	并行数: 读<span class="token operator">/</span>写并行数，默认为 16
	<span class="token operator">--</span>no-cleanup 表示测试完成后不删除测试用数据。
		<span class="token operator">-</span> 在做读测试之前，需要使用该参数来运行一遍写测试来产生测试数据，
		<span class="token operator">-</span> 在测试结束后运行 rados <span class="token operator">-</span>p &lt;存储池&gt; cleanup 清理测试数据。
注意：
	曾经的bench-<span class="token function">write</span>已经被整合到bench中了
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>创建测试存储池
<span class="token namespace">[root@admin ~]</span><span class="token comment"># ceph osd pool create pool-test 32 32</span>
pool <span class="token string">'pool-test'</span> created
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>写测试：
<span class="token namespace">[root@admin ~]</span><span class="token comment"># rados bench -p pool-test 10 write --no-cleanup</span>
hints = 1
Maintaining 16 concurrent writes of 4194304 bytes to objects of size 4194304 <span class="token keyword">for</span> up to 10 seconds or 0 objects
Object prefix: benchmark_data_admin_5683
  sec Cur ops   started  finished  avg MB/s  cur MB/s last lat<span class="token punctuation">(</span>s<span class="token punctuation">)</span>  avg lat<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    0       0         0         0         0         0           <span class="token operator">-</span>           0
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   10      16       147       131   52<span class="token punctuation">.</span>3689        64     1<span class="token punctuation">.</span>18095     1<span class="token punctuation">.</span>16048
Total time run:         10<span class="token punctuation">.</span>9577
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
Min latency<span class="token punctuation">(</span>s<span class="token punctuation">)</span>:         0<span class="token punctuation">.</span>202
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>顺序读测试
<span class="token namespace">[root@admin ~]</span><span class="token comment"># rados bench -p pool-test 10 seq</span>
hints = 1
  sec Cur ops   started  finished  avg MB/s  cur MB/s last lat<span class="token punctuation">(</span>s<span class="token punctuation">)</span>  avg lat<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    0       0         0         0         0         0           <span class="token operator">-</span>           0
   	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   10      15       139       124   45<span class="token punctuation">.</span>0608         8     9<span class="token punctuation">.</span>09797     0<span class="token punctuation">.</span>93913
Total time run:       11<span class="token punctuation">.</span>5093
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
Min latency<span class="token punctuation">(</span>s<span class="token punctuation">)</span>:       0<span class="token punctuation">.</span>0240264
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>随机读测试
<span class="token namespace">[root@admin ~]</span><span class="token comment"># rados bench -p pool-test 10 rand</span>
hints = 1
  sec Cur ops   started  finished  avg MB/s  cur MB/s last lat<span class="token punctuation">(</span>s<span class="token punctuation">)</span>  avg lat<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    0       0         0         0         0         0           <span class="token operator">-</span>           0
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   10      16       589       573   229<span class="token punctuation">.</span>081       244     0<span class="token punctuation">.</span>20209    0<span class="token punctuation">.</span>272096
Total time run:       10<span class="token punctuation">.</span>2428
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
Min latency<span class="token punctuation">(</span>s<span class="token punctuation">)</span>:       0<span class="token punctuation">.</span>0225745
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>清理环境
<span class="token namespace">[root@admin ~]</span><span class="token comment"># rados -p pool-test cleanup</span>
Removed 148 objects
</code></pre></div><p>load-gen性能测试工具</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>Ceph 自带的 rados 性能测试工具，可在集群内产生混合类型的负载，相较于bench，load-gen只做吞吐量测试。命令格式如下：
	rados <span class="token operator">-</span>p 存储池 load-gen 
参数解读：
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token operator">--</span>num-objects     	<span class="token comment"># 初始生成测试用的对象数</span>
    <span class="token operator">--</span>min-object-size 	<span class="token comment"># 最小对象大小</span>
    <span class="token operator">--</span>max-object-size 	<span class="token comment"># 最大对象大小</span>
    <span class="token operator">--</span>max-ops         	<span class="token comment"># 最大操作数目</span>
    <span class="token operator">--</span>min-op-len      	<span class="token comment"># 最小操作长度，相当于iodepth</span>
    <span class="token operator">--</span>max-op-len      	<span class="token comment"># 最大操作长度</span>
    <span class="token operator">--</span><span class="token function">read-percent</span>    	<span class="token comment"># 读操作的百分比</span>
    <span class="token operator">--</span>target-throughput <span class="token comment"># 单次提交IO的累计吞吐量上线，单位 MB/s</span>
    <span class="token operator">--</span>run-length      	<span class="token comment"># 运行时长，单位秒</span>
    <span class="token operator">--</span>percent			<span class="token comment"># 读写混合中，读操作占用比例</span>
    <span class="token operator">--</span>max_backlog		<span class="token comment"># 单次提交IO的吞吐量上限</span>
    
注意：
	iodepth就是io队列深度<span class="token punctuation">(</span>io队列里面允许出现几个命令等待操作<span class="token punctuation">)</span>，它的作用是
		<span class="token operator">-</span> 控制硬盘操作的过程中的负载情况，避免系统一直发送指令，出现磁盘受不了导致系统崩溃的现象
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>在pool-test存储池中，初始对象50个，单次io的最大数量16，顺序写入4M的数据块<span class="token punctuation">,</span>测试时间10秒。
<span class="token namespace">[root@mon03 ~]</span><span class="token comment"># rados -p pool-test load-gen --num-objects 50 --min-object-size 4M --max-object-size 4M --max-object-size 4M --max-ops 16 --min-op-len 4M  --max-op-len 4M --percent 5 --target-throughput 40 --run-length 10</span>
run length 10 seconds
preparing 50 objects
load-gen will run 10 seconds
    1: throughput=0MB/sec pending <span class="token keyword">data</span>=0
READ : oid=obj-AF5uiLtTtxSNSNR off=0 len=4194304
op 0 completed<span class="token punctuation">,</span> throughput=3<span class="token punctuation">.</span>86MB/sec
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    9: throughput=0<span class="token punctuation">.</span>442MB/sec pending <span class="token keyword">data</span>=0
waiting <span class="token keyword">for</span> all operations to complete
cleaning up objects
</code></pre></div><p><strong>小结</strong></p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/vueblog/assets/js/app.81e52da8.js" defer></script><script src="/vueblog/assets/js/2.365067af.js" defer></script><script src="/vueblog/assets/js/23.bbf8853f.js" defer></script>
  </body>
</html>
