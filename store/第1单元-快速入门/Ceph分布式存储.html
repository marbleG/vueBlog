<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>1 快速入门</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/vueblog/assets/css/0.styles.9c4f8d34.css" as="style"><link rel="preload" href="/vueblog/assets/js/app.81e52da8.js" as="script"><link rel="preload" href="/vueblog/assets/js/2.365067af.js" as="script"><link rel="preload" href="/vueblog/assets/js/22.08acf871.js" as="script"><link rel="prefetch" href="/vueblog/assets/js/10.a0e23fea.js"><link rel="prefetch" href="/vueblog/assets/js/11.b758150e.js"><link rel="prefetch" href="/vueblog/assets/js/12.d02c1519.js"><link rel="prefetch" href="/vueblog/assets/js/13.0a3e45d8.js"><link rel="prefetch" href="/vueblog/assets/js/14.fd438b0f.js"><link rel="prefetch" href="/vueblog/assets/js/15.8f2f6504.js"><link rel="prefetch" href="/vueblog/assets/js/16.702f6c0f.js"><link rel="prefetch" href="/vueblog/assets/js/17.875cc70b.js"><link rel="prefetch" href="/vueblog/assets/js/18.73ef9897.js"><link rel="prefetch" href="/vueblog/assets/js/19.fcbd610b.js"><link rel="prefetch" href="/vueblog/assets/js/20.b86ab3ce.js"><link rel="prefetch" href="/vueblog/assets/js/21.17f5d888.js"><link rel="prefetch" href="/vueblog/assets/js/23.bbf8853f.js"><link rel="prefetch" href="/vueblog/assets/js/24.02668152.js"><link rel="prefetch" href="/vueblog/assets/js/25.1bc6f63b.js"><link rel="prefetch" href="/vueblog/assets/js/26.7d6104a9.js"><link rel="prefetch" href="/vueblog/assets/js/3.98cb2320.js"><link rel="prefetch" href="/vueblog/assets/js/4.b835cd21.js"><link rel="prefetch" href="/vueblog/assets/js/5.2d560cb6.js"><link rel="prefetch" href="/vueblog/assets/js/6.d57284aa.js"><link rel="prefetch" href="/vueblog/assets/js/7.51fc855c.js"><link rel="prefetch" href="/vueblog/assets/js/8.f96a8507.js"><link rel="prefetch" href="/vueblog/assets/js/9.4aff9137.js">
    <link rel="stylesheet" href="/vueblog/assets/css/0.styles.9c4f8d34.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vueblog/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vueblog/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/vueblog/zh/java/" class="nav-link">
  java
</a></div><div class="nav-item"><a href="/vueblog/redis/" class="nav-link">
  redis
</a></div><div class="nav-item"><a href="/vueblog/cicd/" class="nav-link">
  CI/CD
</a></div><div class="nav-item"><a href="/vueblog/network/" class="nav-link">
  网络
</a></div><div class="nav-item"><a href="/vueblog/store/" class="nav-link router-link-active">
  存储
</a></div><div class="nav-item"><a href="/vueblog/k8s/" class="nav-link">
  k8s
</a></div><div class="nav-item"><a href="/vueblog/linux/" class="nav-link">
  linux
</a></div><div class="nav-item"><a href="/vueblog/standard/" class="nav-link">
  规范
</a></div><div class="nav-item"><a href="https://www.baidu.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  百度一下
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://www.google.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  google
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/vueblog/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/vueblog/zh/java/" class="nav-link">
  java
</a></div><div class="nav-item"><a href="/vueblog/redis/" class="nav-link">
  redis
</a></div><div class="nav-item"><a href="/vueblog/cicd/" class="nav-link">
  CI/CD
</a></div><div class="nav-item"><a href="/vueblog/network/" class="nav-link">
  网络
</a></div><div class="nav-item"><a href="/vueblog/store/" class="nav-link router-link-active">
  存储
</a></div><div class="nav-item"><a href="/vueblog/k8s/" class="nav-link">
  k8s
</a></div><div class="nav-item"><a href="/vueblog/linux/" class="nav-link">
  linux
</a></div><div class="nav-item"><a href="/vueblog/standard/" class="nav-link">
  规范
</a></div><div class="nav-item"><a href="https://www.baidu.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  百度一下
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://www.google.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  google
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/vueblog/store/" aria-current="page" class="sidebar-link">存储</a></li><li><a href="/vueblog/store/ceph.html" class="sidebar-link">ceph分布式文件系统</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_1-快速入门"><a href="#_1-快速入门" class="header-anchor">#</a> 1 快速入门</h1> <h2 id="_1-1-基础知识"><a href="#_1-1-基础知识" class="header-anchor">#</a> 1.1 基础知识</h2> <h3 id="_1-1-1-存储基础"><a href="#_1-1-1-存储基础" class="header-anchor">#</a> 1.1.1 存储基础</h3> <p>学习目标</p> <p>这一节，我们从 基础知识、文件系统、小结 三个方面来学习。</p> <p><strong>基础知识</strong></p> <p>存储基础</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	我们知道，对于一个计算机设备来说，其存储功能是非常重要的，也就是说，任何一台电脑上，必须包含一个设备<span class="token operator">--</span>磁盘。这个磁盘就是用于数据存储的目的的。
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>常见的存储设备接口：
DAS设备：IDE、SATA、SCSI、SAS、USB
	无论是那种接口，他都是存储设备驱动下的磁盘设备，而磁盘设备其实就是一种存储，这种存储是直接接入到主板总线上去的。
	<span class="token operator">-</span> 基于数据块来进行访问
	<span class="token operator">-</span> 基于服务器方式实现互联访问，操作简单、成本低。
NAS设备：NFS、CIFS
	几乎所有的网络存储设备基本上都是以文件系统样式进行使用，无法进一步格式化操作。
	<span class="token operator">-</span> 基于文件系统方式访问
	<span class="token operator">-</span> 没有网络区域限制，支持多种协议操作文件。
SAN:scsi协议、<span class="token function">FC</span> SAN、iSCSI
	基于SAN方式提供给客户端操作系统的是一种块设备接口，所以这些设备间主要是通过scsi协议来完成正常的通信。
	scsi的结构类似于TCP/IP协议，也有很多层，但是scsi协议主要是用来进行存储数据操作的。既然是分层方式实现的，那就是说，有部分层可以被替代。比如将物理层基于<span class="token function">FC</span>方式来实现，就形成了FCSAN，如果基于以太网方式来传递数据，就形成了iSCSI模式。
	<span class="token operator">-</span> 基于数据块来实现访问
	<span class="token operator">-</span> 不受服务器约束，通过存储池实现资源的高效利用，扩展性好
</code></pre></div><p><img src="image/image-20220923150326956.png" alt="image-20220923150326956"></p> <p>存储使用</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	对于存储的使用，我们需要借助于文件系统的方式来实现，而存储在使用前往往需要进行格式化。
</code></pre></div><p><strong>文件系统</strong></p> <p>简介</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	文件系统的基本数据单位是文件，它的目的是对磁盘上的文件进行组织管理，那组织的方式不同，就会形成不同的文件系统。	Linux 文件系统会为每个文件分配两个数据结构：索引节点<span class="token punctuation">(</span>index node<span class="token punctuation">)</span>和目录项<span class="token punctuation">(</span>directory entry<span class="token punctuation">)</span>，它们主要用来记录文件的元信息和目录层次结构。

索引节点 
	<span class="token operator">-</span> 用来记录文件的元信息，比如 inode 编号、文件大小、访问权限、创建时间、等信息。
	<span class="token operator">-</span> 索引节点是文件的唯一标识，它们之间一一对应，也同样都会被存储在硬盘中，所以索引节点同样占用磁盘空间。
	<span class="token operator">-</span> 用户查找的时候，会根据inode的信息，找到对应的数据块，我们可以将inode理解为数据块的路由信息。
目录项
	<span class="token operator">-</span> 用来记录文件的名字、索引节点指针以及与其他目录项的层级关联关系。多个目录项关联起来，形成目录结构
	<span class="token operator">-</span> 它与索引节点不同，目录项是由内核维护的一个数据结构，不存放于磁盘，而是缓存在内存。
	<span class="token operator">-</span> 目录项和索引节点的关系是多对一
</code></pre></div><p>数据存储</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>数据块
	磁盘读写的最小单位是扇区，扇区的大小只有 512B 大小，文件系统把多个扇区组成了一个逻辑块，每次读写的最小单位就是逻辑块（数据块），Linux 中的逻辑块大小为 4KB，也就是一次性读写 8 个扇区，这将大大提高了磁盘的读写的效率。
	磁盘想要被文件系统使用，需要进行格式化，此时磁盘会被分成三个存储区域
		<span class="token operator">-</span> 超级块，用来存储文件系统的详细信息，比如块个数、块大小、空闲块等等。 
		<span class="token operator">-</span> 索引节点区，用来存储索引节点；
		<span class="token operator">-</span> 数据块区，用来存储文件或目录数据；
</code></pre></div><p>存储应用的基本方式</p> <p><img src="image/1636079494896.png" alt="1636079494896"></p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>为了加速文件的访问，通常会把相关信息加载到内存中，但是考虑到内存的容量限制，它们加载进内存的时机是不同的：
	超级块：当文件系统挂载时进入内存；
	索引节点区：当文件被访问时进入内存；
	数据块：文件数据使用的时候进入内；
</code></pre></div><p>文件存储</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	文件的数据是要存储在硬盘上面的，数据在磁盘上的存放方式，有两种方式：
		连续空间存放方式 
			<span class="token operator">-</span> 同一个文件存放到一个连续的存储空间
			<span class="token operator">-</span> 一旦文件删除可能导致磁盘空间碎片
			<span class="token operator">-</span> 文件内容长度扩展不方便，综合效率是非常低的。
		非连续空间存放方式
			<span class="token operator">-</span> 同一个文件存放到一个不连续的存储空间，每个空间会关联下一个空间
			<span class="token operator">-</span> 可以消除磁盘碎片，可大大提高磁盘空间的利用率，同时文件的长度可以动态扩展。
			<span class="token operator">-</span> 查找效率低，需要额外的资源消耗。
</code></pre></div><p><img src="image/image-20220923154844319.png" alt="image-20220923154844319"></p> <p><strong>小结</strong></p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div><h3 id="_1-1-2-dfs概述"><a href="#_1-1-2-dfs概述" class="header-anchor">#</a> 1.1.2 DFS概述</h3> <p>学习目标</p> <p>这一节，我们从 DFS简介、原理解读、小结 三个方面来学习。</p> <p><strong>DFS简介</strong></p> <p>存储基础</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>存储处理能力不足：
	传统的IDE的io值是100次<span class="token operator">/</span>秒，SATA固态磁盘500次<span class="token operator">/</span>秒，NVMe固态硬盘达到2000-4000次<span class="token operator">/</span>秒。即时磁盘的io能力再大数十倍，难道能够抗住网站访问高峰期数十万、数百万甚至上亿用户的同时访问么？这还受到网络io能力的限制。

存储空间能力不足：
	单块磁盘的容量再大，也无法满足用户的正常访问所需的数据容量限制。

需求：
	可以实现横向扩展的存储系统，这种存储系统在市面中的表现样式很多，不过他们有一个统一的称呼 <span class="token operator">--</span> 分布式存储系统。
</code></pre></div><p>分布式文件系统</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	随着传输技术发展，操作系统读写数据的方式，不再局限于本地I/O技术，开始支持远距离的TCP/IP方式获取数据。它相当于新增一种可以远距离传输的I/O技术，使得分散的存储设备和用户操作系统可以通过网络方式接入联合在一起，形成更大容量，更易于拓展伸缩的存储系统，对此人们引入分布式文件系统的概念。 
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>	分布式文件系统（Distributed File System，DFS）是指文件系统管理的物理存储资源不一定直接连接在本地节点上，而是通过计算机网络与节点相连；或是若干不同的逻辑磁盘分区或卷标组合在一起而形成的完整的有层次的文件系统。
	分布式文件系统的发展现后经历了三个阶段：网络文件系统、共享SAN文件系统、面向对象的并行文件系统。
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>	从本质上来说，分布式文件系统跟传统的文件系统没本质的差别，只不过是需要额外考虑多节点网络连接的可靠性、接入的存储设备的复杂性，需要文件系统、网络环境、存储策略共同协作而已。
	由于文件系统与传统一致，网络环境不受控制，所以，我们平常所说的分布式文件系统，也等同于分布式存储系统。
</code></pre></div><p>DSS简介</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	分布式存储系统，是将数据分散存储在多台独立的设备上，从而解决传统的存储系统的容量和性能限制。所以如果存储服务器的可靠性和安全性无法满足大规模存储应用的需要，那么它就会成为分布式文件系统的性能瓶颈。
	其实，分布式存储系统可以理解为多台单机存储系统的各司其职、协同合作，统一的对外提供存储的服务。
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>	分布式网络存储系统采用可扩展的系统结构，利用多台存储服务器分担存储负荷，利用位置服务器定位存储信息，它不但提高了系统的可靠性、可用性和存取效率，还易于扩展。
	按照分布式存储系统的作用场景，我们可以将其划分为 存储非结构化数据的分布式文件系统、存储结构化数据的分布式数据库、存储半结构化数据的分布式NoSQL数据库等。
</code></pre></div><p>常见的文件系统</p> <p><img src="image/image-20220923162020799.png" alt="image-20220923162020799"></p> <p><strong>原理解读</strong></p> <p>分布式数据存储</p> <p><img src="image/1636082742521.png" alt="1636082742521"></p> <p>存储角色</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>节点角色
	当我们将数据存储到分布式系统上的时候，就需要有一个路由机制，能够将我们的请求转交给对应的存储节点上。所以，根据我们对数据在单节点上的存储原理，我们就需要有一个单独的节点来存储所有数据的元数据信息，然后，分布式存储就作为block的存储区域，专门用户数据存储。
	存储元素据的节点我们把它称为NameNode，存储具体数据的节点我们称为DataNode。
	
数据拆分：
	当我们要存储的数据非常大，比如说5个G，所以我们在存储的时候，将存储的数据信息发送给元数据控制节点，然后元数据控制节点根据自定义的存储策略，将要存储的数据进行拆分<span class="token punctuation">(</span>64M一块<span class="token punctuation">)</span><span class="token operator">--</span>也就是数据切片，将切分后的数据作为一个独立的文件，然后基于同样的路由逻辑，将其分散存储到不同的存储节点上。
	元数据控制节点，在进行数据切分的时候，还需要能够组合起来，所以拆分后的数据块大小、组合时候的偏移信息、路由到的节点等信息都应该有针对性的记录。
	在切片的时候，还可以实现并行的存储逻辑效果。每一个数据块都称为一个shard。
</code></pre></div><p>数据高可用</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>元数据高可用
	由于NameNode保存了非常重要的数据信息，所以为了避免因为NameNode故障导致的问题，我们一定要对NameNode进行高可用处理。
	由于元数据非常小<span class="token punctuation">(</span>几k<span class="token punctuation">)</span>，所以NameNode上的数据是 非常密集而且io量非常小的。所以为了提高数据的查询和存储效率，我们一般将这些数据保存到内存中。所以为了防止主机断电导致数据丢失，所以我们需要随时的进行数据同步到磁盘中，因为没有办法判断每一次到底是哪种数据被访问或更改，所以在磁盘数据同步的时候，随机io是非常大的。
	同时，为了避免单节点的数据文件丢失，我们需要通过共享存储的方式将数据保存在第三方的存储设备上，同时还需要对数据存储主机进行高可用
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>数据高可用
	由于我们对元数据进行了数据切片的方式，实现了数据的高效率存取，但是我们知道，一旦这些数据块中，任意丢弃一块，就会导致所有的数据无法正常的使用。所以有必要对这些数据进行高可用的操作。对于高可用的方式，我们一般会有两种方式来实现数据的冗余。
	节点级：
		通过对主机节点进行高可用，从而实现数据的冗余，这种机制，成本太高了，不值得。
	数据级：
		我们对拆分后的数据块进行副本操作，而且还可以根据节点的数量，自定义冗余的副本数量。这是推荐的。
		主角色的数据块称为 primary shard，副本数据块称为 replica shard。
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>	在进行数据块数据冗余的时候，这些副本的策略机制是有元数据节点来进行控制的，当一个DataNode故障的时候：
		<span class="token operator">-</span> 如果主shard没有了，从所有的副本shard中选择一个主。
		<span class="token operator">-</span> 如果副本shard没有了，再创建一个副本shard即可。
		<span class="token operator">-</span> 一旦DataNode节点数量多于副本数量，控制副本数据在另一个DataNode节点上复制一个新的副本
			从而保证副本的总体是满足预期的。
	
	为了防止数据副本节点在同一个物理机架上的时候，因为机架故障，导致所有副本无效，所以我们在考虑冗余的时候，还需要考虑地理位置区域的冗余。
</code></pre></div><p><strong>小结</strong></p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div><h3 id="_1-1-3-存储简介"><a href="#_1-1-3-存储简介" class="header-anchor">#</a> 1.1.3 存储简介</h3> <p>学习目标</p> <p>这一节，我们从 存储类型、ceph简介、小结 三个方面来学习。</p> <p><strong>存储类型</strong></p> <p>三种存储</p> <p><img src="image/1636084901961.png" alt="1636084901961"></p> <p>块存储</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	块存储是将裸磁盘空间整个映射给主机使用的，主机层面操作系统识别出硬盘，与我们服务器内置的硬盘没有什么差异<span class="token punctuation">,</span>可以自由的进行磁盘进行分区、格式化，
	块存储不仅仅是直接使用物理设备，间接使用物理设备的也叫块设备，比如虚机创建虚拟磁盘、虚机磁盘格式包括raw、qcow2等。	
	常见解决方案：
		ABS<span class="token punctuation">(</span>Azure Block Storage<span class="token punctuation">)</span>、GBS<span class="token punctuation">(</span>Google Block Storage<span class="token punctuation">)</span>、EBS<span class="token punctuation">(</span>Elastic Block Storag<span class="token punctuation">)</span>
		Cinder、Ceph RBD、sheepdog
</code></pre></div><p>文件系统存储</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	最常见、最容易、最经典实现的一种存储接口。它可以直接以文件系统挂载的方式，为主机提供存储空间资源。它有别于块存储的特点就在于，可以实现共享效果，但是有可能受网络因素限制导致速度较慢。
	
	常见解决方案：
		AFS<span class="token punctuation">(</span>Azure FileStorage<span class="token punctuation">)</span>、GFS<span class="token punctuation">(</span>Google FileStorage<span class="token punctuation">)</span>、EFS<span class="token punctuation">(</span>Elastic File Storage<span class="token punctuation">)</span>
		Swift、CephFS、HDFS、NFS、CIFS、Samba、FTP
</code></pre></div><p>对象存储</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	其核心是将 数据读或写 和 元数据 分离，并且基于对象存储设备<span class="token punctuation">(</span>Object-based Storage Device，OSD<span class="token punctuation">)</span>构建存储系统，然后借助于对象存储设备的管理功能，自动管理该设备上的数据分布。
	对象存储主要包括四部分：对象、对象存储设备、元数据服务器、对象存储系统的客户端
	
	简单地说，块存储读写块，不利于共享，文件存储读写慢，利于共享，而对象存储综合了两者的优点。
	常见的解决方案：
		AS<span class="token punctuation">(</span>Azure Storage<span class="token punctuation">)</span>、<span class="token function">GCS</span><span class="token punctuation">(</span>Google Cloud Storage<span class="token punctuation">)</span>、S3<span class="token punctuation">(</span>Simple Storage Service<span class="token punctuation">)</span>
		Swift、Ceph OSD
</code></pre></div><p><strong>Ceph简介</strong></p> <p>官方介绍</p> <div class="language- extra-class"><pre class="language-text"><code>	Ceph is the future of storage; where traditional(传统的) systems fail to deliver, Ceph is designed to excel(出色). Leverage(利用) your data for better business(业务) decisions(决策) and achieve(实现) operational(运营) excellence(卓越) through scalable, intelligent(智能), reliable(可靠) and highly available(可用) storage software. Ceph supports object, block and file storage, all in one unified(统一) storage system.
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>来源：
	Ceph项目最早起源于Sage就读博士期间的工作（最早的成果于2004年发表，论文发表于2006年），并随后贡献给开源社区。
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>参考资料：
	官方地址：https:<span class="token operator">/</span><span class="token operator">/</span>ceph<span class="token punctuation">.</span>com/en/
	官方文档：https:<span class="token operator">/</span><span class="token operator">/</span>docs<span class="token punctuation">.</span>ceph<span class="token punctuation">.</span>com/en/latest/<span class="token comment">#</span>
	github地址：https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com/ceph/ceph
	最新版本：Quincy-17<span class="token punctuation">.</span>2<span class="token punctuation">.</span>3<span class="token punctuation">(</span>2022-04-19<span class="token punctuation">)</span>、Pacific-16<span class="token punctuation">.</span>2<span class="token punctuation">.</span>10<span class="token punctuation">(</span>2021-03-31<span class="token punctuation">)</span>、Octopus-15<span class="token punctuation">.</span>2<span class="token punctuation">.</span>17<span class="token punctuation">(</span>2020-03-23<span class="token punctuation">)</span>
	系统支持：
		全系列最好的系统支持是Ubuntu
		Ceph的发展对于Centos系列和Redhat系列不友好，新版本不支持旧版本系统。
</code></pre></div><p><img src="image/image-20220923170114091.png" alt="image-20220923170114091"></p> <p>软件特点</p> <p><img src="image/image-20220923163720189.png" alt="image-20220923163720189"></p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>为什么很多人用ceph？
	1 创新，Ceph能够同时提供对象存储、块存储和文件系统存储三种存储服务的统一存储架构
	2 算法，Ceph得以摒弃了传统的集中式存储元数据寻址方案，通过Crush算法的寻址操作，有相当强大的扩展性。
	3 可靠，Ceph中的数据副本数量可以由管理员自行定义，并可以通过Crush算法指定副本的物理存储位置以分隔故障域，支持数据强一致性的特性也使Ceph具有了高可靠性，可以忍受多种故障场景并自动尝试并行修复。
</code></pre></div><p>基本结构</p> <p><img src="image/1636088249032.png" alt="1636088249032"></p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	Ceph是一个多版本存储系统，它把每一个待管理的数据流（例如一个文件） 切分为一到多个固定大小的对象数据，并以其为原子单元完成数据存取。
	对象数据的底层存储服务是由多个主机（host）组成的存储集群，该集群也被称之为 RADOS（Reliable Automatic Distributed Object Store）存储集群，即可靠、自动化、 分布式对象存储系统 
	librados是RADOS存储集群的API，它支持C、C+<span class="token operator">+</span>、Java、Python、Ruby和PHP等编程语言。
</code></pre></div><p>应用场景</p> <div class="language- extra-class"><pre class="language-text"><code>	Ceph uniquely(独特的) delivers object, block, and file storage in one unified(统一) system. 
	注意：这个介绍在官网这几年基本没有变化
</code></pre></div><p><img src="image/1636099032730.png" alt="1636099032730"></p> <div class="language- extra-class"><pre class="language-text"><code>	RadosGW、RBD和CephFS都是RADOS存储服务的客户端，它们把RADOS的存储服务接口(librados)分别从不同的角度做了进一步抽象，因而各自适用于不同的应用场景。
	也就是说，ceph将三种存储类型统一在一个平台中，从而实现了更强大的适用性。
</code></pre></div><p><img src="image/1636089258096.png" alt="1636089258096"></p> <div class="language- extra-class"><pre class="language-text"><code>LIBRADOS	- 通过自编程方式实现数据的存储能力
RADOSGW		- 通过标准的RESTful接口，提供一种云存储服务
RBD			- 将ceph提供的空间，模拟出来一个一个的独立块设备使用。
				而且，ceph环境部署完毕后，服务端就准备好了rbd接口
CFS			- 通过一个标准的文件系统接口来进行数据的存储

参考图例：https://docs.ceph.com/en/pacific/_images/stack.png
</code></pre></div><p><img src="image/image-20211110140906074.png" alt="image-20211110140906074"></p> <p><strong>小结</strong></p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div><h3 id="_1-1-4-组件解析"><a href="#_1-1-4-组件解析" class="header-anchor">#</a> 1.1.4 组件解析</h3> <p>学习目标</p> <p>这一节，我们从 组件介绍、流程解读、小结 三个方面来学习。</p> <p><strong>组件介绍</strong></p> <p>组件简介</p> <div class="language- extra-class"><pre class="language-text"><code>	无论您是想向云平台提供 Ceph 对象存储和 Ceph 块设备服务、部署 Ceph 文件系统还是将 Ceph 用于其他目的，所有 Ceph 存储集群部署都从设置每个 Ceph 节点、您的网络和 Ceph 开始 存储集群。
    一个 Ceph 存储集群至少需要一个 Ceph Monitor、Ceph Manager 和 Ceph OSD（对象存储守护进程）。 运行 Ceph 文件系统客户端时也需要 Ceph 元数据服务器。
</code></pre></div><p><img src="image/1636099270839.png" alt="1636099270839"></p> <table><thead><tr><th>组件</th> <th>解析</th></tr></thead> <tbody><tr><td>Monitors</td> <td>Ceph Monitor (守护进程ceph-mon) 维护集群状态的映射，包括监视器映射、管理器映射、OSD 映射、MDS 映射和 CRUSH 映射。 这些映射是 Ceph 守护进程相互协调所需的关键集群状态。 监视器还负责管理守护进程和客户端之间的身份验证。 通常至少需要三个监视器才能实现冗余和高可用性。基于 paxos 协议实现节点间的信息同步。</td></tr> <tr><td>Managers</td> <td>Ceph 管理器 (守护进程ceph-mgr) 负责跟踪运行时指标和 Ceph 集群的当前状态，包括存储利用率、当前性能指标和系统负载。 Ceph 管理器守护进程还托管基于 Python 的模块来管理和公开 Ceph 集群信息，包括基于 Web 的 Ceph 仪表板和 REST API。 高可用性通常至少需要两个管理器。基于 raft 协议实现节点间的信息同步。</td></tr> <tr><td>Ceph OSDs</td> <td>Ceph OSD（对象存储守护进程，ceph-osd）存储数据，处理数据复制、恢复、重新平衡，并通过检查其他 Ceph OSD 守护进程的心跳来向 Ceph 监视器和管理器提供一些监控信息。 通常至少需要 3 个 Ceph OSD 来实现冗余和高可用性。本质上osd就是一个个host主机上的存储磁盘。</td></tr> <tr><td>MDSs</td> <td>Ceph 元数据服务器（MDS[Metadata Server]、ceph-mds）代表 Ceph 文件系统存储元数据。 Ceph 元数据服务器允许 POSIX（为应用程序提供的接口标准） 文件系统用户执行基本命令（如 ls、find 等），而不会给 Ceph 存储集群带来巨大负担。</td></tr> <tr><td>PG</td> <td>PG全称Placement Grouops，是一个逻辑的概念，一个PG包含多个OSD。引入PG这一层其实是为了更好的分配数据和定位数据。写数据的时候，写入主osd，冗余两份。</td></tr></tbody></table> <p><strong>流程解读</strong></p> <p>综合效果图</p> <p><img src="image/1636104082951.png" alt="1636104082951"></p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>Ceph 将数据作为对象存储在逻辑存储池中，主要包括两步：
	把对象数据 映射给 PG	
		<span class="token operator">-</span> 计算出哪个归置组应该包含该对象
		<span class="token operator">-</span> 这部分功能是由Hash算法实现的
	把 PG 映射到 host的OSD 
		<span class="token operator">-</span> 计算出哪个 Ceph OSD Daemon 应该存储该归置组
		<span class="token operator">-</span> 这部分由 CRUSH算法来决定的，CRUSH 算法使 Ceph 存储集群能够动态扩展、重新平衡和恢复。
</code></pre></div><p>数据存储逻辑</p> <p><img src="image/1636103641572.png" alt="1636103641572"></p> <p><strong>小结</strong></p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div><h3 id="_1-1-5-存储原理"><a href="#_1-1-5-存储原理" class="header-anchor">#</a> 1.1.5 存储原理</h3> <p>学习目标</p> <p>这一节，我们从 存储解读、案例解读、小结 三个方面来学习。</p> <p><strong>存储解读</strong></p> <p>存储数据</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	Ceph 存储集群从 Ceph 客户端接收数据<span class="token punctuation">,</span>无论是通过 Ceph 块设备、Ceph 对象存储、Ceph 文件系统还是您使用 librados 创建的自定义实现<span class="token punctuation">,</span> 这些数据存储为 RADOS 对象<span class="token punctuation">,</span> 每个对象都存储在一个对象存储设备上。
	Ceph OSD 守护进程处理存储驱动器上的读、写和复制操作。它主要基于两种文件方式实现：
    	<span class="token operator">-</span> Filestore方式，每个 RADOS 对象都作为一个单独的文件存储在传统文件系统（通常是 XFS）上。 
    	<span class="token operator">-</span> BlueStore方式，对象以类似整体数据库的方式存储，这是新版本ceph默认的存储方式。
	
	注意：在Ceph中，每一个文件都会被拆分为多个独立的object，然后按照上面的逻辑进行持久化。
</code></pre></div><p><img src="image/1636104261047.png" alt="1636104261047"></p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	Ceph OSD 守护进程将<span class="token string">&quot;数据&quot;</span>作为对象存储在平面命名空间中<span class="token punctuation">,</span>该对象包括如下部分：
		标识符	<span class="token operator">-</span> 在内存中唯一查找的标识
		二进制数据 <span class="token operator">-</span> 每个对象的真实数据
		属性数据 <span class="token operator">-</span> 由一组名称<span class="token operator">/</span>值对组成的元数据，语义完全取决于 Ceph 客户端。 
	例如，CephFS 使用元数据来存储文件属性，例如文件所有者、创建日期、上次修改日期等。
	
注意：
	对象 ID 在整个集群中是唯一的，而不仅仅是本地文件系统<span class="token punctuation">.</span>
</code></pre></div><p><img src="image/1636104309671.png" alt="1636104309671"></p> <p><strong>案例解读</strong></p> <p>存储示例</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>存储一个大小为16M的文件，存储的时候，需要首先进行切割，假设每个对象<span class="token punctuation">(</span>object<span class="token punctuation">)</span>大小为4M<span class="token punctuation">,</span>然后通过hash方式将object存储到对应的PG上，然后通过 CRUSH 策略将对应的数据关联到不同的host上。
	这个时候遇到一个问题：osd是一个磁盘设备，那么如何来进行存储数据
	
常见的处理措施主要有两种：
	第一种：将osd格式化为文件系统，然后挂载到对应目录，然后就可以使用了
	第二种：osd有自己的守护进程，那么直接在守护进程空间中实现数据的处理
</code></pre></div><p>方法1 - FileStore</p> <p><img src="image/1636105592444.png" alt="1636105592444"></p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>这个时候，osd就变成一个文件系统中的文件<span class="token punctuation">(</span>目录<span class="token punctuation">)</span>了。
	因此，OSD需要维护object的对象属性信息，object的元数据保存到 osd<span class="token punctuation">(</span>文件系统<span class="token punctuation">)</span>的元数据区。
	但是文件系统的元数据区只能存放文件的 属主、属组、权限、时间戳等信息。对于ceph来说，object的元数据信息却包含很多相关信息，那么这些数据保存到哪里？
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>那么为了保存文件系统默认能够保存的数据之外的元数据<span class="token punctuation">(</span>object对象的其他元数据信息<span class="token punctuation">)</span>，我们就需要将OSD做成一个XFS文件系统，在这个文件系统中，需要有一个单独的数据库<span class="token punctuation">(</span>LevelDB<span class="token punctuation">)</span>，来维护ceph的元数据信息，效果如下
</code></pre></div><p><img src="image/1636106662704.png" alt="1636106662704"></p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>由于这种方式是基于文件系统映射的方式来实现 ceph的属性存储，所以我们把这种文件的存储方式称为 FiltStore。
劣势：
	由于我们的object本来已经称为对象了，而在FileStore中，我们需要将其转换为文件方式来进行数据属性的存储，所以效率有些慢
	
附注：
	XFS是被开发用于高容量磁盘以及高性能文件系统之用的。主要规划为三个部分：
	资料区（<span class="token keyword">data</span> section）<span class="token operator">-</span> 存储包括inode、block、superblock等数据
	文件系统活动登录区（log section） <span class="token operator">-</span> 用来记录文件系统的变化
	实时运作（realtime section）<span class="token operator">-</span> 数据真正存储的地方
</code></pre></div><p>方法2 - BlueStore</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	因为osd对象是由一个ceph-osd守护进程来实现存储数据、处理数据复制、恢复、重新平衡等管理操作的。所以新版的Ceph的osd进程中，维护了一个RocksDB用于存储objects的元数据属性信息<span class="token punctuation">.</span>
	RocksDB为了实现数据的存储还需要一个文件系统，所以Ceph就为它开发了一个文件系统 BlueFS。
	
	RocksDB <span class="token operator">+</span> BlueFS 共同实现了objects的元数据的存储，所以我们把这种存储方式称为 BlueStore。新版的Ceph的存储机制，默认采用的就是 BlueStore机制。
</code></pre></div><p><img src="image/1636107225026.png" alt="1636107225026"></p> <p><strong>小结</strong></p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div><h2 id="_1-2-集群部署"><a href="#_1-2-集群部署" class="header-anchor">#</a> 1.2 集群部署</h2> <h3 id="_1-2-1-环境概述"><a href="#_1-2-1-环境概述" class="header-anchor">#</a> 1.2.1 环境概述</h3> <p>学习目标</p> <p>这一节，我们从 基础知识、环境规划、小结 三个方面来学习。</p> <p><strong>基础知识</strong></p> <p>注意事项</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	在Ceph系统的搭建过程中<span class="token punctuation">,</span>会出现各种意想不到或者预想到问题，就算整个过程中每一步都没问题，还是会出现各种问题，这些问题不仅仅在网上找不到，甚至在官网中找不到，甚至玩ceph数年的人都解决不了。
	尤其是，就算你第一次成功后，第二次重试就会出现问题。所以，如果出现问题怎么办？一步一步踏踏实实的进行研究，分析解决问题，并进行总结并梳理成册就可以了。
</code></pre></div><p>简介</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>ceph的环境部署是非常繁琐的，所以，官方帮我们提供了很多的快捷部署方式。
参考资料：
	https:<span class="token operator">/</span><span class="token operator">/</span>docs<span class="token punctuation">.</span>ceph<span class="token punctuation">.</span>com/en/pacific/install/
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>推荐方法：
Cephadm 
	使用容器和 systemd 安装和管理 Ceph 集群，并与 <span class="token function">CLI</span> 和仪表板 GUI 紧密集成。
	仅支持 Octopus 和更新版本，需要容器和 Python3支持
	与新的编排 API 完全集成
Rook
	在 Kubernetes 中运行的 Ceph 集群，同时还支持通过 Kubernetes API 管理存储资源和配置。
 	仅支持 Nautilus 和较新版本的 Ceph
 	
其他方法
ceph-ansible 	使用Ansible部署Ceph集群，对于新的编排器功能、管理功能和仪表板支持不好。
ceph-deploy 	是一个快速部署集群的工具，不支持Centos8
DeepSea			使用 Salt 安装 Ceph
ceph-mon		使用 Juju 安装 Ceph
Puppet-ceph		通过 Puppet 安装 Ceph
二进制源码		 手工安装
windows图形	   在windows主机上，通过鼠标点点点的方式进行部署。
</code></pre></div><p>版本的选择</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>版本地址：https:<span class="token operator">/</span><span class="token operator">/</span>docs<span class="token punctuation">.</span>ceph<span class="token punctuation">.</span>com/en/latest/releases/
最新版本：官网版本 v16<span class="token punctuation">.</span>2<span class="token punctuation">.</span>10 Pacific
版本特性：x<span class="token punctuation">.</span>0<span class="token punctuation">.</span>z<span class="token punctuation">(</span>开发版<span class="token punctuation">)</span>、x<span class="token punctuation">.</span>1<span class="token punctuation">.</span>z<span class="token punctuation">(</span>候选版<span class="token punctuation">)</span>、x<span class="token punctuation">.</span>2<span class="token punctuation">.</span>z<span class="token punctuation">(</span>稳定、修正版<span class="token punctuation">)</span>
</code></pre></div><p><strong>环境规划</strong></p> <p>网络规划</p> <p><img src="image/image-20211110140641473.png" alt="image-20211110140641473"></p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>公有网络<span class="token punctuation">(</span>public<span class="token punctuation">)</span>：
	<span class="token operator">-</span> 用于用户的数据通信
	<span class="token operator">-</span> 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0/16
集群网络<span class="token punctuation">(</span>cluster<span class="token punctuation">)</span>：
	<span class="token operator">-</span> 用于集群内部的管理通信
	<span class="token operator">-</span> 192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>8<span class="token punctuation">.</span>0/16
</code></pre></div><p>主机规划</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>磁盘规划
	磁盘1 <span class="token operator">-</span> VM的系统盘
	磁盘2和磁盘3 <span class="token operator">-</span> Ceph的OSD
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>主机名规划	
	主机名    公有网络     私有网络 	  	磁盘		   其他角色
	admin	10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12	192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>8<span class="token punctuation">.</span>12 	sdb、sdc
	stor01	10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>13	192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>8<span class="token punctuation">.</span>13  	sdb、sdc		mon01
	stor02	10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>14	192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>8<span class="token punctuation">.</span>14  	sdb、sdc		mon02
	stor03	10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>15	192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>8<span class="token punctuation">.</span>15 	sdb、sdc 	mon03
	stor04	10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>16	192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>8<span class="token punctuation">.</span>16  	sdb、sdc		
	stor05	10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>17	192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>8<span class="token punctuation">.</span>17 	sdb、sdc
	stor06	10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>18	192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>8<span class="token punctuation">.</span>18  	sdb、sdc
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>注意：
	由于生产中，ceph的集群角色是非常多的，当我们的主机量少的时候，只能让一台主机节点运行多个角色。
		stor01~03 这三台主机，还同时兼具 mon的角色，视情况兼容mgr角色
		主机名的完整格式是： xxx<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com 
</code></pre></div><p>其他准备</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>管理用户
	由于我们接下来的所有操作，基本上都在 admin这个主机上来运行，所以，我们不推荐直接使用root用户来管理，倾向于通过一个普通用户来操作接下来的操作。
	由于后续的安装软件，涉及到root用户权限的操作，所以这个普通用户最好具备sudo的权限。
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>时间同步
	对于任何一个集群来说，时间同步是非常重要的。
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>主机名规划
	随着生产中的主机节点越来越多，我们通过手工定制主机名的方式就不太适合集群的主机管理了。所以在企业中，我们的主机名相关的信息，倾向于通过内网dns来进行管理。
	尤其是等我们到 radosgw的时候，必须通过泛域名解析的机制来实现，更强大的面向客户端的主机名管理体系。
</code></pre></div><p>VM主机准备</p> <p><img src="image/image-20211108105810433.png" alt="image-20211108105810433"></p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>所有节点都准备三块盘，两块网卡
虚拟网络设置：
	VMnet1 设定为 192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>8<span class="token punctuation">.</span>0 网段， VMnet8 设定为 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0 网段
虚拟机设置
	额外添加两块盘，每个根据自己的情况设定容量，我这里设定为20G
	额外更加一块网络适配器，使用仅主机模式 <span class="token operator">--</span> VMnet1，mac地址必须要重新生成，避免冲突
</code></pre></div><p><strong>小结</strong></p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>
</code></pre></div><h3 id="_1-2-2-准备工作"><a href="#_1-2-2-准备工作" class="header-anchor">#</a> 1.2.2 准备工作</h3> <p>学习目标</p> <p>这一节，我们从 基本环境、软件安装、小结 三个方面来学习。</p> <p><strong>基本环境</strong></p> <p>主机名管理</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>编辑 <span class="token operator">/</span>etc/hosts 文件
10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12 admin<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com admin
10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>13 stor01<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com stor01 mon01<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com mon01
10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>14 stor02<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com stor02 mon02<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com mon02
10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>15 stor03<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com stor03 mon03<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com mon03
10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>16 stor04<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com stor04
10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>17 stor05<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com stor05
10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>18 stor06<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com stor06
注意：
	后续可能会涉及到k8s环境的部署，所以hosts文件有可能会发生变动。
</code></pre></div><p>防火墙管理</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>关闭防火墙
systemctl stop iptables firewalld 
systemctl disable iptables firewalld
systemctl status iptables firewalld 
</code></pre></div><p>跨主机通信</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>脚本文件名称 01_remote_host_auth<span class="token punctuation">.</span>sh 
<span class="token comment">#!/bin/bash</span>
<span class="token comment"># 功能: 批量设定远程主机免密码认证</span>
<span class="token comment"># 版本: v0.2</span>
<span class="token comment"># 作者: 书记</span>
<span class="token comment"># 联系: superopsmsb.com</span>

<span class="token comment"># 准备工作</span>
user_dir=<span class="token string">'/root'</span>
host_file=<span class="token string">'/etc/hosts'</span>
login_user=<span class="token string">'root'</span>
login_pass=<span class="token string">'123456'</span>
target_type=<span class="token punctuation">(</span>部署 免密 同步 主机名 退出<span class="token punctuation">)</span>

<span class="token comment"># 菜单</span>
menu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token function">echo</span> <span class="token operator">-</span>e <span class="token string">&quot;\e[31m批量设定远程主机免密码认证管理界面\e[0m&quot;</span>
  <span class="token function">echo</span> <span class="token string">&quot;=====================================================&quot;</span>
  <span class="token function">echo</span> <span class="token operator">-</span>e <span class="token string">&quot;\e[32m 1: 部署环境   2: 免密认证   3: 同步hosts \e[0m&quot;</span>
  <span class="token function">echo</span> <span class="token operator">-</span>e <span class="token string">&quot;\e[32m 4: 设定主机名 5：退出操作 \e[0m&quot;</span>
  <span class="token function">echo</span> <span class="token string">&quot;=====================================================&quot;</span>
<span class="token punctuation">}</span>
<span class="token comment"># expect环境</span>
expect_install<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">-</span>f <span class="token operator">/</span>usr/bin/expect <span class="token punctuation">]</span>
  then
     <span class="token function">echo</span> <span class="token operator">-</span>e <span class="token string">&quot;\e[33mexpect环境已经部署完毕\e[0m&quot;</span>
  <span class="token keyword">else</span>
     yum install expect <span class="token operator">-</span>y &gt;&gt; <span class="token operator">/</span>dev/null 2&gt;&amp;1 &amp;&amp; <span class="token function">echo</span> <span class="token operator">-</span>e <span class="token string">&quot;\e[33mexpect软件安装完毕\e[0m&quot;</span> <span class="token punctuation">|</span><span class="token punctuation">|</span> <span class="token punctuation">(</span><span class="token function">echo</span> <span class="token operator">-</span>e <span class="token string">&quot;\e[33mexpect软件安装失败\e[0m&quot;</span> &amp;&amp; <span class="token keyword">exit</span><span class="token punctuation">)</span>
  fi
<span class="token punctuation">}</span>
<span class="token comment"># 秘钥文件生成环境</span>
create_authkey<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment"># 保证历史文件清空</span>
  <span class="token punctuation">[</span> <span class="token operator">-</span>d $<span class="token punctuation">{</span>user_dir<span class="token punctuation">}</span><span class="token operator">/</span><span class="token punctuation">.</span>ssh <span class="token punctuation">]</span> &amp;&amp; <span class="token function">rm</span> <span class="token operator">-</span>rf $<span class="token punctuation">{</span>user_dir<span class="token punctuation">}</span><span class="token operator">/</span><span class="token punctuation">.</span>ssh/<span class="token operator">*</span> <span class="token punctuation">|</span><span class="token punctuation">|</span> mkdir <span class="token operator">-</span>p $<span class="token punctuation">{</span>user_dir<span class="token punctuation">}</span><span class="token operator">/</span><span class="token punctuation">.</span>ssh 
  <span class="token comment"># 构建秘钥文件对</span>
  <span class="token operator">/</span>usr/bin/ssh-keygen <span class="token operator">-</span>t rsa <span class="token operator">-</span>P <span class="token string">&quot;&quot;</span> <span class="token operator">-</span>f $<span class="token punctuation">{</span>user_dir<span class="token punctuation">}</span><span class="token operator">/</span><span class="token punctuation">.</span>ssh/id_rsa
  <span class="token function">echo</span> <span class="token operator">-</span>e <span class="token string">&quot;\e[33m秘钥文件已经创建完毕\e[0m&quot;</span>
<span class="token punctuation">}</span>
<span class="token comment"># expect自动匹配逻辑</span>
expect_autoauth_func<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment"># 接收外部参数</span>
  command=<span class="token string">&quot;$@&quot;</span>
  expect <span class="token operator">-</span>c <span class="token string">&quot;
    spawn ${command}
    expect {
      \&quot;</span>yes/no\<span class="token string">&quot; {send \&quot;</span>yes\r\<span class="token string">&quot;; exp_continue}
      \&quot;</span><span class="token operator">*</span>password*\<span class="token string">&quot; {send \&quot;</span>$<span class="token punctuation">{</span>login_pass<span class="token punctuation">}</span>\r\<span class="token string">&quot;; exp_continue}
      \&quot;</span><span class="token operator">*</span>password*\<span class="token string">&quot; {send \&quot;</span>$<span class="token punctuation">{</span>login_pass<span class="token punctuation">}</span>\r\<span class="token string">&quot;}
   }&quot;</span>
<span class="token punctuation">}</span>
<span class="token comment"># 跨主机传输文件认证</span>
sshkey_auth_func<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment"># 接收外部的参数</span>
  local host_list=<span class="token string">&quot;$*&quot;</span>
  <span class="token keyword">for</span> ip in $<span class="token punctuation">{</span>host_list<span class="token punctuation">}</span>
  <span class="token keyword">do</span>
     <span class="token comment"># /usr/bin/ssh-copy-id -i ${user_dir}/.ssh/id_rsa.pub root@10.0.0.12</span>
     cmd=<span class="token string">&quot;/usr/bin/ssh-copy-id -i ${user_dir}/.ssh/id_rsa.pub&quot;</span>
     remote_host=<span class="token string">&quot;${login_user}@${ip}&quot;</span>
     expect_autoauth_func $<span class="token punctuation">{</span>cmd<span class="token punctuation">}</span> $<span class="token punctuation">{</span>remote_host<span class="token punctuation">}</span>
  done
<span class="token punctuation">}</span>

<span class="token comment"># 跨主机同步hosts文件</span>
scp_hosts_func<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment"># 接收外部的参数</span>
  local host_list=<span class="token string">&quot;$*&quot;</span>
  <span class="token keyword">for</span> ip in $<span class="token punctuation">{</span>host_list<span class="token punctuation">}</span>
  <span class="token keyword">do</span>
     remote_host=<span class="token string">&quot;${login_user}@${ip}&quot;</span>
     scp $<span class="token punctuation">{</span>host_file<span class="token punctuation">}</span> $<span class="token punctuation">{</span>remote_host<span class="token punctuation">}</span>:$<span class="token punctuation">{</span>host_file<span class="token punctuation">}</span>
  done
<span class="token punctuation">}</span>

<span class="token comment"># 跨主机设定主机名规划</span>
set_hostname_func<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment"># 接收外部的参数</span>
  local host_list=<span class="token string">&quot;$*&quot;</span>
  <span class="token keyword">for</span> ip in $<span class="token punctuation">{</span>host_list<span class="token punctuation">}</span>
  <span class="token keyword">do</span>
     host_name=$<span class="token punctuation">(</span>grep $<span class="token punctuation">{</span>ip<span class="token punctuation">}</span> $<span class="token punctuation">{</span>host_file<span class="token punctuation">}</span><span class="token punctuation">|</span>awk <span class="token string">'{print $NF}'</span><span class="token punctuation">)</span>
     remote_host=<span class="token string">&quot;${login_user}@${ip}&quot;</span>
     ssh $<span class="token punctuation">{</span>remote_host<span class="token punctuation">}</span> <span class="token string">&quot;hostnamectl set-hostname ${host_name}&quot;</span>
  done
<span class="token punctuation">}</span>
<span class="token comment"># 帮助信息逻辑</span>
Usage<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token function">echo</span> <span class="token string">&quot;请输入有效的操作id&quot;</span>
<span class="token punctuation">}</span>
<span class="token comment"># 逻辑入口</span>
<span class="token keyword">while</span> true
<span class="token keyword">do</span>
  menu
  read <span class="token operator">-</span>p <span class="token string">&quot;请输入有效的操作id: &quot;</span> target_id
  <span class="token keyword">if</span> <span class="token punctuation">[</span> $<span class="token punctuation">{</span><span class="token comment">#target_type[@]} -ge ${target_id} ]</span>
  then
    <span class="token keyword">if</span> <span class="token punctuation">[</span> $<span class="token punctuation">{</span>target_type<span class="token punctuation">[</span>$<span class="token punctuation">{</span>target_id<span class="token punctuation">}</span><span class="token operator">-</span>1<span class="token punctuation">]</span><span class="token punctuation">}</span> == <span class="token string">&quot;部署&quot;</span> <span class="token punctuation">]</span>
    then
       <span class="token function">echo</span> <span class="token string">&quot;开始部署环境操作...&quot;</span>
       expect_install
       create_authkey
    elif <span class="token punctuation">[</span> $<span class="token punctuation">{</span>target_type<span class="token punctuation">[</span>$<span class="token punctuation">{</span>target_id<span class="token punctuation">}</span><span class="token operator">-</span>1<span class="token punctuation">]</span><span class="token punctuation">}</span> == <span class="token string">&quot;免密&quot;</span> <span class="token punctuation">]</span>
    then
       read <span class="token operator">-</span>p <span class="token string">&quot;请输入需要批量远程主机认证的主机列表范围(示例: {12..19}): &quot;</span> num_list
       ip_list=$<span class="token punctuation">(</span>eval <span class="token function">echo</span> 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span><span class="token variable">$num_list</span><span class="token punctuation">)</span>
       <span class="token function">echo</span> <span class="token string">&quot;开始执行免密认证操作...&quot;</span>
       sshkey_auth_func $<span class="token punctuation">{</span>ip_list<span class="token punctuation">}</span>
    elif <span class="token punctuation">[</span> $<span class="token punctuation">{</span>target_type<span class="token punctuation">[</span>$<span class="token punctuation">{</span>target_id<span class="token punctuation">}</span><span class="token operator">-</span>1<span class="token punctuation">]</span><span class="token punctuation">}</span> == <span class="token string">&quot;同步&quot;</span> <span class="token punctuation">]</span>
    then
       read <span class="token operator">-</span>p <span class="token string">&quot;请输入需要批量远程主机同步hosts的主机列表范围(示例: {12..19}): &quot;</span> num_list
       ip_list=$<span class="token punctuation">(</span>eval <span class="token function">echo</span> 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span><span class="token variable">$num_list</span><span class="token punctuation">)</span>
       <span class="token function">echo</span> <span class="token string">&quot;开始执行同步hosts文件操作...&quot;</span>
       scp_hosts_func $<span class="token punctuation">{</span>ip_list<span class="token punctuation">}</span>
    elif <span class="token punctuation">[</span> $<span class="token punctuation">{</span>target_type<span class="token punctuation">[</span>$<span class="token punctuation">{</span>target_id<span class="token punctuation">}</span><span class="token operator">-</span>1<span class="token punctuation">]</span><span class="token punctuation">}</span> == <span class="token string">&quot;主机名&quot;</span> <span class="token punctuation">]</span>
    then
       read <span class="token operator">-</span>p <span class="token string">&quot;请输入需要批量设定远程主机主机名的主机列表范围(示例: {12..19}): &quot;</span> num_list
       ip_list=$<span class="token punctuation">(</span>eval <span class="token function">echo</span> 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span><span class="token variable">$num_list</span><span class="token punctuation">)</span>
       <span class="token function">echo</span> <span class="token string">&quot;开始执行设定主机名操作...&quot;</span>
       set_hostname_func $<span class="token punctuation">{</span>ip_list<span class="token punctuation">}</span>
    elif <span class="token punctuation">[</span> $<span class="token punctuation">{</span>target_type<span class="token punctuation">[</span>$<span class="token punctuation">{</span>target_id<span class="token punctuation">}</span><span class="token operator">-</span>1<span class="token punctuation">]</span><span class="token punctuation">}</span> == <span class="token string">&quot;退出&quot;</span> <span class="token punctuation">]</span>
    then
       <span class="token function">echo</span> <span class="token string">&quot;开始退出管理界面...&quot;</span>
       <span class="token keyword">exit</span>
    fi
  <span class="token keyword">else</span>
    Usage
  fi
done
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>执行脚本文件
<span class="token namespace">[root@localhost ~]</span><span class="token comment"># /bin/bash /data/scripts/01_remote_host_auth.sh</span>
批量设定远程主机免密码认证管理界面
=====================================================
 1: 部署环境   2: 免密认证   3: 同步hosts
 4: 设定主机名 5：退出操作
=====================================================
请输入有效的操作id: 1
开始部署环境操作<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
expect环境已经部署完毕
Generating public/private rsa key pair<span class="token punctuation">.</span>
Your identification has been saved in <span class="token operator">/</span>root/<span class="token punctuation">.</span>ssh/id_rsa<span class="token punctuation">.</span>
Your public key has been saved in <span class="token operator">/</span>root/<span class="token punctuation">.</span>ssh/id_rsa<span class="token punctuation">.</span>pub<span class="token punctuation">.</span>
The key fingerprint is:
SHA256:DNQAfWAD3MYPywK4W0BrNsgK+u3ysliuI6QdF3BOuyc root@localhost
The key<span class="token string">'s randomart image is:
+---[RSA 2048]----+
|.o .o**+         |
|= + +o*.o        |
|oO * +.=         |
|B o = oo.        |
|oo   +  S        |
|.o..E .          |
|o.oo.o           |
|+++.             |
|+oo=o            |
+----[SHA256]-----+
秘钥文件已经创建完毕
批量设定远程主机免密码认证管理界面
=====================================================
 1: 部署环境   2: 免密认证   3: 同步hosts
 4: 设定主机名 5：退出操作
=====================================================
请输入有效的操作id: 2
请输入需要批量远程主机认证的主机列表范围(示例: {12..19}): {12..18}
开始执行免密认证操作...
...
Now try logging into the machine, with:   &quot;ssh '</span>root@10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12<span class="token string">'&quot;
and check to make sure that only the key(s) you wanted were added.
...
Now try logging into the machine, with:   &quot;ssh '</span>root@10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>18'&quot;
and check to make sure that only the key<span class="token punctuation">(</span>s<span class="token punctuation">)</span> you wanted were added<span class="token punctuation">.</span>

批量设定远程主机免密码认证管理界面
=====================================================
 1: 部署环境   2: 免密认证   3: 同步hosts
 4: 设定主机名 5：退出操作
=====================================================
请输入有效的操作id: 3
请输入需要批量远程主机同步hosts的主机列表范围<span class="token punctuation">(</span>示例: <span class="token punctuation">{</span>12<span class="token punctuation">.</span><span class="token punctuation">.</span>19<span class="token punctuation">}</span><span class="token punctuation">)</span>: <span class="token punctuation">{</span>12<span class="token punctuation">.</span><span class="token punctuation">.</span>18<span class="token punctuation">}</span>
开始执行同步hosts文件操作<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
hosts 	100%  520     1<span class="token punctuation">.</span>2MB/s   00:00
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
hosts	100%  520   403<span class="token punctuation">.</span>3KB/s   00:00
批量设定远程主机免密码认证管理界面
=====================================================
 1: 部署环境   2: 免密认证   3: 同步hosts
 4: 设定主机名 5：退出操作
=====================================================
请输入有效的操作id: 4
请输入需要批量设定远程主机主机名的主机列表范围<span class="token punctuation">(</span>示例: <span class="token punctuation">{</span>12<span class="token punctuation">.</span><span class="token punctuation">.</span>19<span class="token punctuation">}</span><span class="token punctuation">)</span>: <span class="token punctuation">{</span>12<span class="token punctuation">.</span><span class="token punctuation">.</span>18<span class="token punctuation">}</span>
开始执行设定主机名操作<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
批量设定远程主机免密码认证管理界面
=====================================================
 1: 部署环境   2: 免密认证   3: 同步hosts
 4: 设定主机名 5：退出操作
=====================================================
请输入有效的操作id: 5
开始退出管理界面<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>测试效果
<span class="token namespace">[root@localhost ~]</span><span class="token comment"># for i in {12..18}; do hostname=$(ssh root@10.0.0.$i &quot;hostname&quot;); echo &quot;10.0.0.$i - $hostname&quot;; done</span>
10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12 <span class="token operator">-</span> admin
10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>13 <span class="token operator">-</span> mon01
10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>14 <span class="token operator">-</span> mon02
10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>15 <span class="token operator">-</span> mon03
10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>16 <span class="token operator">-</span> stor04
10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>17 <span class="token operator">-</span> stor05
10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>18 <span class="token operator">-</span> stor06
</code></pre></div><p><strong>软件安装</strong></p> <p>用户管理</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>创建普通用户
useradd <span class="token operator">-</span>m cephadm <span class="token operator">-</span>s <span class="token operator">/</span>bin/bash
<span class="token function">echo</span> cephadm:123456 <span class="token punctuation">|</span> chpasswd

为用户配置root权限
<span class="token function">echo</span> <span class="token string">&quot;cephadm ALL = (root) NOPASSWD:ALL&quot;</span> <span class="token punctuation">|</span> sudo <span class="token function">tee</span> <span class="token operator">/</span>etc/sudoers<span class="token punctuation">.</span>d/cephadm 
chmod 0440 <span class="token operator">/</span>etc/sudoers<span class="token punctuation">.</span>d/cephadm
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>切换用户时候不输出最近登录信息
<span class="token namespace">[root@admin ~]</span><span class="token comment"># grep  &quot;se.*postlogin&quot; /etc/pam.d/su</span>
<span class="token comment"># session               include         postlogin</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>脚本方法 02_create_ceph_user<span class="token punctuation">.</span>sh 
<span class="token comment">#!/bin/bash</span>
<span class="token comment"># 功能: 创建专属的ceph管理用户</span>
<span class="token comment"># 版本: v0.1</span>
<span class="token comment"># 作者: 书记</span>
<span class="token comment"># 联系: superopsmsb.com</span>

<span class="token comment"># 准备工作</span>
login_user=<span class="token string">'cephadm'</span>
login_pass=<span class="token string">'123456'</span>

<span class="token comment"># 设定普通用户</span>
useradd <span class="token operator">-</span>m $<span class="token punctuation">{</span>login_user<span class="token punctuation">}</span> <span class="token operator">-</span>s <span class="token operator">/</span>bin/bash
<span class="token function">echo</span> $<span class="token punctuation">{</span>login_user<span class="token punctuation">}</span>:$<span class="token punctuation">{</span>login_pass<span class="token punctuation">}</span> <span class="token punctuation">|</span> chpasswd
<span class="token function">echo</span> <span class="token string">&quot;${login_user} ALL = (root) NOPASSWD:ALL&quot;</span> <span class="token punctuation">|</span> sudo <span class="token function">tee</span> <span class="token operator">/</span>etc/sudoers<span class="token punctuation">.</span>d/$<span class="token punctuation">{</span>login_user<span class="token punctuation">}</span> 
chmod 0440 <span class="token operator">/</span>etc/sudoers<span class="token punctuation">.</span>d/$<span class="token punctuation">{</span>login_user<span class="token punctuation">}</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>批量执行
<span class="token keyword">for</span> i in <span class="token punctuation">{</span>13<span class="token punctuation">.</span><span class="token punctuation">.</span>18<span class="token punctuation">}</span>
<span class="token keyword">do</span>
  ssh root@10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span><span class="token variable">$i</span> <span class="token string">&quot;mkdir /data/scripts -p&quot;</span>
  scp <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>scripts/02_create_ceph_user<span class="token punctuation">.</span>sh root@10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span><span class="token variable">$i</span>:<span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>scripts/02_create_ceph_user<span class="token punctuation">.</span>sh
  ssh root@10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span><span class="token variable">$i</span> <span class="token string">&quot;/bin/bash /data/scripts/02_create_ceph_user.sh&quot;</span>
done
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>确认效果
<span class="token namespace">[root@localhost ~]</span><span class="token comment"># for i in {12..18}; do usermsg=$(ssh root@10.0.0.$i &quot;id cephadm&quot;); echo &quot;10.0.0.$i - $usermsg&quot;; done</span>
10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12 <span class="token operator">-</span> uid=1001<span class="token punctuation">(</span>cephadm<span class="token punctuation">)</span> gid=1001<span class="token punctuation">(</span>cephadm<span class="token punctuation">)</span> 组=1001<span class="token punctuation">(</span>cephadm<span class="token punctuation">)</span>
10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>13 <span class="token operator">-</span> uid=1001<span class="token punctuation">(</span>cephadm<span class="token punctuation">)</span> gid=1001<span class="token punctuation">(</span>cephadm<span class="token punctuation">)</span> 组=1001<span class="token punctuation">(</span>cephadm<span class="token punctuation">)</span>
10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>14 <span class="token operator">-</span> uid=1001<span class="token punctuation">(</span>cephadm<span class="token punctuation">)</span> gid=1001<span class="token punctuation">(</span>cephadm<span class="token punctuation">)</span> 组=1001<span class="token punctuation">(</span>cephadm<span class="token punctuation">)</span>
10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>15 <span class="token operator">-</span> uid=1001<span class="token punctuation">(</span>cephadm<span class="token punctuation">)</span> gid=1001<span class="token punctuation">(</span>cephadm<span class="token punctuation">)</span> 组=1001<span class="token punctuation">(</span>cephadm<span class="token punctuation">)</span>
10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>16 <span class="token operator">-</span> uid=1001<span class="token punctuation">(</span>cephadm<span class="token punctuation">)</span> gid=1001<span class="token punctuation">(</span>cephadm<span class="token punctuation">)</span> 组=1001<span class="token punctuation">(</span>cephadm<span class="token punctuation">)</span>
10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>17 <span class="token operator">-</span> uid=1001<span class="token punctuation">(</span>cephadm<span class="token punctuation">)</span> gid=1001<span class="token punctuation">(</span>cephadm<span class="token punctuation">)</span> 组=1001<span class="token punctuation">(</span>cephadm<span class="token punctuation">)</span>
10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>18 <span class="token operator">-</span> uid=1001<span class="token punctuation">(</span>cephadm<span class="token punctuation">)</span> gid=1001<span class="token punctuation">(</span>cephadm<span class="token punctuation">)</span> 组=1001<span class="token punctuation">(</span>cephadm<span class="token punctuation">)</span>
</code></pre></div><p>跨主机免密码认证</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>脚本文件内容 <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>scripts/03_remote_cephadm_auth<span class="token punctuation">.</span>sh
<span class="token comment">#!/bin/bash</span>
<span class="token comment"># 功能: 批量设定远程主机免密码认证</span>
<span class="token comment"># 版本: v0.3</span>
<span class="token comment"># 作者: 书记</span>
<span class="token comment"># 联系: superopsmsb.com</span>

<span class="token comment"># 准备工作</span>
user_dir=<span class="token string">'/home/cephadm'</span>
login_user=<span class="token string">'cephadm'</span>
login_pass=<span class="token string">'123456'</span>
host_file=<span class="token string">'/etc/hosts'</span>
target_type=<span class="token punctuation">(</span>部署 免密 退出<span class="token punctuation">)</span>

<span class="token comment"># 菜单</span>
menu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token function">echo</span> <span class="token operator">-</span>e <span class="token string">&quot;\e[31m批量设定远程主机免密码认证管理界面\e[0m&quot;</span>
  <span class="token function">echo</span> <span class="token string">&quot;=====================================================&quot;</span>
  <span class="token function">echo</span> <span class="token operator">-</span>e <span class="token string">&quot;\e[32m 1: 部署环境   2: 免密认证   3: 退出操作 \e[0m&quot;</span>
  <span class="token function">echo</span> <span class="token string">&quot;=====================================================&quot;</span>
<span class="token punctuation">}</span>
<span class="token comment"># expect环境</span>
expect_install<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">-</span>f <span class="token operator">/</span>usr/bin/expect <span class="token punctuation">]</span>
  then
     <span class="token function">echo</span> <span class="token operator">-</span>e <span class="token string">&quot;\e[33mexpect环境已经部署完毕\e[0m&quot;</span>
  <span class="token keyword">else</span>
     sudo yum install expect <span class="token operator">-</span>y &gt;&gt; <span class="token operator">/</span>dev/null 2&gt;&amp;1 &amp;&amp; <span class="token function">echo</span> <span class="token operator">-</span>e <span class="token string">&quot;\e[33mexpect软件安装完毕\e[0m&quot;</span> <span class="token punctuation">|</span><span class="token punctuation">|</span> <span class="token punctuation">(</span><span class="token function">echo</span> <span class="token operator">-</span>e <span class="token string">&quot;\e[33mexpect软件安装失败\e[0m&quot;</span> &amp;&amp; <span class="token keyword">exit</span><span class="token punctuation">)</span>
  fi
<span class="token punctuation">}</span>
<span class="token comment"># 秘钥文件生成环境</span>
create_authkey<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment"># 保证历史文件清空</span>
  <span class="token punctuation">[</span> <span class="token operator">-</span>d $<span class="token punctuation">{</span>user_dir<span class="token punctuation">}</span><span class="token operator">/</span><span class="token punctuation">.</span>ssh <span class="token punctuation">]</span> &amp;&amp; <span class="token function">rm</span> <span class="token operator">-</span>rf $<span class="token punctuation">{</span>user_dir<span class="token punctuation">}</span><span class="token operator">/</span><span class="token punctuation">.</span>ssh/<span class="token operator">*</span>
  <span class="token comment"># 构建秘钥文件对</span>
  <span class="token operator">/</span>usr/bin/ssh-keygen <span class="token operator">-</span>t rsa <span class="token operator">-</span>P <span class="token string">&quot;&quot;</span> <span class="token operator">-</span>f $<span class="token punctuation">{</span>user_dir<span class="token punctuation">}</span><span class="token operator">/</span><span class="token punctuation">.</span>ssh/id_rsa
  <span class="token function">echo</span> <span class="token operator">-</span>e <span class="token string">&quot;\e[33m秘钥文件已经创建完毕\e[0m&quot;</span>
<span class="token punctuation">}</span>
<span class="token comment"># expect自动匹配逻辑</span>
expect_autoauth_func<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment"># 接收外部参数</span>
  command=<span class="token string">&quot;$@&quot;</span>
  expect <span class="token operator">-</span>c <span class="token string">&quot;
    spawn ${command}
    expect {
      \&quot;</span>yes/no\<span class="token string">&quot; {send \&quot;</span>yes\r\<span class="token string">&quot;; exp_continue}
      \&quot;</span><span class="token operator">*</span>password*\<span class="token string">&quot; {send \&quot;</span>$<span class="token punctuation">{</span>login_pass<span class="token punctuation">}</span>\r\<span class="token string">&quot;; exp_continue}
      \&quot;</span><span class="token operator">*</span>password*\<span class="token string">&quot; {send \&quot;</span>$<span class="token punctuation">{</span>login_pass<span class="token punctuation">}</span>\r\<span class="token string">&quot;}
   }&quot;</span>
<span class="token punctuation">}</span>
<span class="token comment"># 跨主机传输文件认证</span>
sshkey_auth_func<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment"># 接收外部的参数</span>
  local host_list=<span class="token string">&quot;$*&quot;</span>
  <span class="token keyword">for</span> ip in $<span class="token punctuation">{</span>host_list<span class="token punctuation">}</span>
  <span class="token keyword">do</span>
     <span class="token comment"># /usr/bin/ssh-copy-id -i ${user_dir}/.ssh/id_rsa.pub root@10.0.0.12</span>
     cmd=<span class="token string">&quot;/usr/bin/ssh-copy-id -i ${user_dir}/.ssh/id_rsa.pub&quot;</span>
     remote_host=<span class="token string">&quot;${login_user}@${ip}&quot;</span>
     host_name=$<span class="token punctuation">(</span>grep $<span class="token punctuation">{</span>ip<span class="token punctuation">}</span> $<span class="token punctuation">{</span>host_file<span class="token punctuation">}</span><span class="token punctuation">|</span>awk <span class="token string">'{print $NF}'</span><span class="token punctuation">)</span>
     remote_host1=<span class="token string">&quot;${login_user}@${host_name}&quot;</span>
     remote_host2=<span class="token string">&quot;${login_user}@${host_name}.superopsmsb.com&quot;</span>
     expect_autoauth_func $<span class="token punctuation">{</span>cmd<span class="token punctuation">}</span> $<span class="token punctuation">{</span>remote_host<span class="token punctuation">}</span>
     expect_autoauth_func $<span class="token punctuation">{</span>cmd<span class="token punctuation">}</span> $<span class="token punctuation">{</span>remote_host1<span class="token punctuation">}</span>
     expect_autoauth_func $<span class="token punctuation">{</span>cmd<span class="token punctuation">}</span> $<span class="token punctuation">{</span>remote_host2<span class="token punctuation">}</span>
  done
<span class="token punctuation">}</span>

<span class="token comment"># 帮助信息逻辑</span>
Usage<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token function">echo</span> <span class="token string">&quot;请输入有效的操作id&quot;</span>
<span class="token punctuation">}</span>
<span class="token comment"># 逻辑入口</span>
<span class="token keyword">while</span> true
<span class="token keyword">do</span>
  menu
  read <span class="token operator">-</span>p <span class="token string">&quot;请输入有效的操作id: &quot;</span> target_id
  <span class="token keyword">if</span> <span class="token punctuation">[</span> $<span class="token punctuation">{</span><span class="token comment">#target_type[@]} -ge ${target_id} ]</span>
  then
    <span class="token keyword">if</span> <span class="token punctuation">[</span> $<span class="token punctuation">{</span>target_type<span class="token punctuation">[</span>$<span class="token punctuation">{</span>target_id<span class="token punctuation">}</span><span class="token operator">-</span>1<span class="token punctuation">]</span><span class="token punctuation">}</span> == <span class="token string">&quot;部署&quot;</span> <span class="token punctuation">]</span>
    then
       <span class="token function">echo</span> <span class="token string">&quot;开始部署环境操作...&quot;</span>
       expect_install
       create_authkey
    elif <span class="token punctuation">[</span> $<span class="token punctuation">{</span>target_type<span class="token punctuation">[</span>$<span class="token punctuation">{</span>target_id<span class="token punctuation">}</span><span class="token operator">-</span>1<span class="token punctuation">]</span><span class="token punctuation">}</span> == <span class="token string">&quot;免密&quot;</span> <span class="token punctuation">]</span>
    then
       read <span class="token operator">-</span>p <span class="token string">&quot;请输入需要批量远程主机认证的主机列表范围(示例: {12..19}): &quot;</span> num_list
       ip_list=$<span class="token punctuation">(</span>eval <span class="token function">echo</span> 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span><span class="token variable">$num_list</span><span class="token punctuation">)</span>
       <span class="token function">echo</span> <span class="token string">&quot;开始执行免密认证操作...&quot;</span>
       sshkey_auth_func $<span class="token punctuation">{</span>ip_list<span class="token punctuation">}</span>
    elif <span class="token punctuation">[</span> $<span class="token punctuation">{</span>target_type<span class="token punctuation">[</span>$<span class="token punctuation">{</span>target_id<span class="token punctuation">}</span><span class="token operator">-</span>1<span class="token punctuation">]</span><span class="token punctuation">}</span> == <span class="token string">&quot;退出&quot;</span> <span class="token punctuation">]</span>
    then
       <span class="token function">echo</span> <span class="token string">&quot;开始退出管理界面...&quot;</span>
       <span class="token keyword">exit</span>
    fi
  <span class="token keyword">else</span>
    Usage
  fi
done
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>更改文件权限
chown cephadm:cephadm <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>scripts/03_remote_cephadm_auth<span class="token punctuation">.</span>sh

切换用户
su <span class="token operator">-</span> cephadm
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>执行脚本文件
<span class="token namespace">[cephadm@admin ~]</span>$ <span class="token operator">/</span>bin/bash <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>scripts/03_remote_cephadm_auth<span class="token punctuation">.</span>sh
批量设定远程主机免密码认证管理界面
=====================================================
 1: 部署环境   2: 免密认证   3: 退出操作
=====================================================
请输入有效的操作id: 1
开始部署环境操作<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
expect环境已经部署完毕
Generating public/private rsa key pair<span class="token punctuation">.</span>
Your identification has been saved in <span class="token operator">/</span>home/cephadm/<span class="token punctuation">.</span>ssh/id_rsa<span class="token punctuation">.</span>
Your public key has been saved in <span class="token operator">/</span>home/cephadm/<span class="token punctuation">.</span>ssh/id_rsa<span class="token punctuation">.</span>pub<span class="token punctuation">.</span>
The key fingerprint is:
SHA256:EvrdtcF4q+e2iyVVOovFkoHOisorCem+1eSG7WO+NCQ cephadm@admin
The key<span class="token string">'s randomart image is:
+---[RSA 2048]----+
|                 |
|         .       |
|      . . .   .  |
|     . +   * o   |
| . E.o. S + @    |
|o   Oo + . B *   |
|o. o.Bo . + =    |
|oo..+o.    =o    |
|.+=.o+o   o++o   |
+----[SHA256]-----+
秘钥文件已经创建完毕
批量设定远程主机免密码认证管理界面
=====================================================
 1: 部署环境   2: 免密认证   3: 退出操作
=====================================================
请输入有效的操作id: 2
请输入需要批量远程主机认证的主机列表范围(示例: {12..19}): {12..18}
开始执行免密认证操作...
...
Now try logging into the machine, with:   &quot;ssh '</span>cephadm@10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>18'&quot;
and check to make sure that only the key<span class="token punctuation">(</span>s<span class="token punctuation">)</span> you wanted were added<span class="token punctuation">.</span>

批量设定远程主机免密码认证管理界面
=====================================================
 1: 部署环境   2: 免密认证   3: 退出操作
=====================================================
请输入有效的操作id: 3
开始退出管理界面<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>测试效果
<span class="token namespace">[cephadm@admin ~]</span>$ <span class="token keyword">for</span> i in <span class="token punctuation">{</span>12<span class="token punctuation">.</span><span class="token punctuation">.</span>18<span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token keyword">do</span> hostname=$<span class="token punctuation">(</span>ssh cephadm@10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span><span class="token variable">$i</span> <span class="token string">&quot;hostname&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">echo</span> <span class="token string">&quot;10.0.0.<span class="token variable">$i</span> - <span class="token variable">$hostname</span>&quot;</span><span class="token punctuation">;</span> done
10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12 <span class="token operator">-</span> admin
10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>13 <span class="token operator">-</span> mon01
10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>14 <span class="token operator">-</span> mon02
10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>15 <span class="token operator">-</span> mon03
10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>16 <span class="token operator">-</span> stor04
10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>17 <span class="token operator">-</span> stor05
10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>18 <span class="token operator">-</span> stor06
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>因为10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>13-15 有两个角色，所以我们需要将相关角色的免密认证
num_list=<span class="token punctuation">{</span>1<span class="token punctuation">.</span><span class="token punctuation">.</span>3<span class="token punctuation">}</span>
<span class="token keyword">for</span> i in $<span class="token punctuation">(</span>eval <span class="token function">echo</span> stor0<span class="token variable">$num_list</span> stor0<span class="token variable">$num_list</span><span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">do</span> ssh-<span class="token function">copy-id</span> cephadm@<span class="token variable">$i</span><span class="token punctuation">;</span> done
</code></pre></div><p>定制软件源</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	对于ceph-deploy方式部署Ceph来说，Ceph的官方仓库路径是http:<span class="token operator">/</span><span class="token operator">/</span>download<span class="token punctuation">.</span>ceph<span class="token punctuation">.</span>com/，包括各种ceph版本，比如octopus、pacific、quincy等，它根据不同OS系统环境，分别位于rpm-版本号 或者 debian-版本号 的noarch目录下。比如pacific版本的软件相关源在 rpm-octopus/el7/noarch/ceph-release-1-1<span class="token punctuation">.</span>el7<span class="token punctuation">.</span>noarch<span class="token punctuation">.</span>rpm。
	注意：
		el7代表支持Red Hat 7<span class="token punctuation">.</span>x、CentOS 7<span class="token punctuation">.</span>x 系统的软件
		el8代表支持Red Hat 8<span class="token punctuation">.</span>x、CentOS 8<span class="token punctuation">.</span>x 系统的软件
		pacific版本及其更新版本，只支持CentOS 8<span class="token punctuation">.</span>x环境
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>	Ceph的pacific和Quincy版本，仅仅支持CentOS8<span class="token punctuation">.</span>X，Octopus版本虽然有CentOS7的版本，不仅仅软件不全，而且对于底层GCC库和GLIBC库要求比较高，如果升级CentOS7的底层库，会导致其他软件受到影响，无法正常使用，另外没有配套的ceph-deploy。所以对于CentOS7来说，只能部署Nautilus版本和更低版本。
	对于Ubuntu系统来说，即使多个版本对于底层环境要求有些区别，但是经过测试，问题不大，也就是说Ubuntu系统可以安装Ceph的全系列
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>安装软件源
yum install <span class="token operator">-</span>y https:<span class="token operator">/</span><span class="token operator">/</span>mirrors<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com/ceph/rpm-nautilus/el7/noarch/ceph-release-1-1<span class="token punctuation">.</span>el7<span class="token punctuation">.</span>noarch<span class="token punctuation">.</span>rpm

更新软件源
yum makecache fast
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>所有ceph节点部署软件源
<span class="token keyword">for</span> i in <span class="token punctuation">{</span>12<span class="token punctuation">.</span><span class="token punctuation">.</span>18<span class="token punctuation">}</span>
<span class="token keyword">do</span> 
  ssh root@10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span><span class="token variable">$i</span> yum install <span class="token operator">-</span>y  https:<span class="token operator">/</span><span class="token operator">/</span>mirrors<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com/ceph/rpm-nautilus/el7/noarch/ceph-release-1-1<span class="token punctuation">.</span>el7<span class="token punctuation">.</span>noarch<span class="token punctuation">.</span>rpm
  ssh root@10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span><span class="token variable">$i</span> yum makecache fast
done
</code></pre></div><p>部署依赖</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>admin主机安装ceph软件
yum update <span class="token operator">-</span>y
yum install  ceph-deploy python-setuptools python2-subprocess32 <span class="token operator">-</span>y

测试效果
su <span class="token operator">-</span> cephadm <span class="token operator">-</span>c <span class="token string">&quot;ceph-deploy --help&quot;</span>
</code></pre></div><p>命令解析</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>查看命令帮助
<span class="token namespace">[root@admin ~]</span><span class="token comment"># su - cephadm</span>
<span class="token namespace">[cephadm@admin ~]</span>$ ceph-deploy <span class="token operator">--</span>help
usage: ceph-deploy <span class="token punctuation">[</span><span class="token operator">-</span>h<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span>v <span class="token punctuation">|</span> <span class="token operator">-</span>q<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span>version<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span>username USERNAME<span class="token punctuation">]</span>
                   <span class="token punctuation">[</span><span class="token operator">--</span>overwrite-conf<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span>cluster NAME<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span>ceph-conf CEPH_CONF<span class="token punctuation">]</span>
                   COMMAND <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

Easy Ceph deployment

    <span class="token operator">-</span>^<span class="token operator">-</span>
   <span class="token operator">/</span>   \
   <span class="token punctuation">|</span>O o<span class="token punctuation">|</span>  ceph-deploy v1<span class="token punctuation">.</span>5<span class="token punctuation">.</span>25
   <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token operator">-</span><span class="token punctuation">.</span><span class="token punctuation">(</span>
  <span class="token string">'/|||\`
  | '</span><span class="token punctuation">|</span>` <span class="token punctuation">|</span>
    '<span class="token punctuation">|</span>`

Full documentation can be found at: http:<span class="token operator">/</span><span class="token operator">/</span>ceph<span class="token punctuation">.</span>com/ceph-deploy/docs

optional arguments:
  <span class="token operator">-</span>h<span class="token punctuation">,</span> <span class="token operator">--</span>help            show this help message and <span class="token keyword">exit</span>
  <span class="token operator">-</span>v<span class="token punctuation">,</span> <span class="token operator">--</span>verbose         be more verbose
  <span class="token operator">-</span>q<span class="token punctuation">,</span> <span class="token operator">--</span>quiet           be less verbose
  <span class="token operator">--</span>version             the current installed version of ceph-deploy
  <span class="token operator">--</span>username USERNAME   the username to connect to the remote host
  <span class="token operator">--</span>overwrite-conf      overwrite an existing conf file on remote host <span class="token punctuation">(</span><span class="token keyword">if</span>
                        present<span class="token punctuation">)</span>
  <span class="token operator">--</span>cluster NAME        name of the cluster
  <span class="token operator">--</span>ceph-conf CEPH_CONF
                        use <span class="token punctuation">(</span>or reuse<span class="token punctuation">)</span> a given ceph<span class="token punctuation">.</span>conf file

commands:
  COMMAND               description
    <span class="token comment"># 创建一个集群</span>
    new                 <span class="token function">Start</span> deploying a new cluster<span class="token punctuation">,</span> and <span class="token function">write</span> a
                        CLUSTER<span class="token punctuation">.</span>conf and keyring <span class="token keyword">for</span> it<span class="token punctuation">.</span>
    install             Install Ceph packages on remote hosts<span class="token punctuation">.</span>
    rgw                 Deploy ceph RGW on remote hosts<span class="token punctuation">.</span>
    mds                 Deploy ceph MDS on remote hosts<span class="token punctuation">.</span>
    mon                 Deploy ceph monitor on remote hosts<span class="token punctuation">.</span>
    gatherkeys          Gather authentication keys <span class="token keyword">for</span> provisioning new nodes<span class="token punctuation">.</span>
    disk                Manage disks on a remote host<span class="token punctuation">.</span>
    osd                 Prepare a <span class="token keyword">data</span> disk on remote host<span class="token punctuation">.</span>
    <span class="token comment"># 同步admin秘钥信息</span>
    admin               Push configuration and client<span class="token punctuation">.</span>admin key to a remote host<span class="token punctuation">.</span>
    <span class="token comment"># 同步ceph.conf文件</span>
    config              Push configuration file to a remote host<span class="token punctuation">.</span>
    uninstall           Remove Ceph packages <span class="token keyword">from</span> remote hosts<span class="token punctuation">.</span>
    purgedata           Purge <span class="token punctuation">(</span>delete<span class="token punctuation">,</span> destroy<span class="token punctuation">,</span> discard<span class="token punctuation">,</span> shred<span class="token punctuation">)</span> any Ceph <span class="token keyword">data</span>
                        <span class="token keyword">from</span> <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib/ceph
    purge               Remove Ceph packages <span class="token keyword">from</span> remote hosts and purge all <span class="token keyword">data</span><span class="token punctuation">.</span>
    forgetkeys          Remove authentication keys <span class="token keyword">from</span> the local directory<span class="token punctuation">.</span>
    pkg                 Manage packages on remote hosts<span class="token punctuation">.</span>
    calamari            Install and configure Calamari nodes<span class="token punctuation">.</span> Assumes that a
                        repository with Calamari packages is already
                        configured<span class="token punctuation">.</span> Refer to the docs <span class="token keyword">for</span> examples
                        <span class="token punctuation">(</span>http:<span class="token operator">/</span><span class="token operator">/</span>ceph<span class="token punctuation">.</span>com/ceph-deploy/docs/conf<span class="token punctuation">.</span>html<span class="token punctuation">)</span>
</code></pre></div><p><strong>小结</strong></p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div><h3 id="_1-2-3-ceph部署"><a href="#_1-2-3-ceph部署" class="header-anchor">#</a> 1.2.3 Ceph部署</h3> <p>学习目标</p> <p>这一节，我们从 集群创建、Mon环境、小结 三个方面来学习。</p> <p><strong>集群创建</strong></p> <p>准备工作</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>首先在管理节点上以cephadm用户创建集群相关的配置文件目录：
su <span class="token operator">-</span> cephadm
mkdir ceph-cluster &amp;&amp; cd ceph-cluster
</code></pre></div><p>初始化集群解析</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>操作解析
	ceph-deploy new <span class="token operator">--</span>help
	初始化第一个MON节点的命令格式为”ceph-deploy new <span class="token punctuation">{</span>initial-monitor-node<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">}</span>“，
		<span class="token operator">-</span> mon01即为第一个MON节点名称，其名称必须与节点当前实际使用的主机名称<span class="token punctuation">(</span>uname <span class="token operator">-</span>n<span class="token punctuation">)</span>保存一致
		<span class="token operator">-</span> 可以是短名称，也可以是长名称，但是最终用的仍然是短名称<span class="token punctuation">,</span>但是会导致如下报错：
			ceph-deploy new: error: hostname:  xxx is not resolvable
		<span class="token operator">-</span> 推荐使用完整写法：
			格式 hostname:fqdn，比如 mon01:mon01<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com
注意：
	如果初始化的时候，希望同时部署多个节点的换，使用空格隔开hostname:fqdn即可
	如果部署过程出现问题，需要清空
        ceph-deploy forgetkeys
        ceph-deploy purge mon01
        ceph-deploy purgedata mon01
        <span class="token function">rm</span> ceph<span class="token punctuation">.</span><span class="token operator">*</span>
</code></pre></div><p>集群初始化</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>部署3个mon节点
	<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph-deploy new <span class="token operator">--</span>public-network 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0/24 <span class="token operator">--</span>cluster-network 192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>8<span class="token punctuation">.</span>0/24 mon01:mon01<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com mon02:mon02<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com mon03:mon03<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com <span class="token operator">--</span>no-ssh-copykey
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token namespace">[ceph_deploy.new]</span><span class="token namespace">[DEBUG ]</span> Resolving host mon03<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com
    <span class="token namespace">[ceph_deploy.new]</span><span class="token namespace">[DEBUG ]</span> Monitor mon03 at 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>15
    <span class="token namespace">[ceph_deploy.new]</span><span class="token namespace">[DEBUG ]</span> Monitor initial members are <span class="token punctuation">[</span><span class="token string">'mon01'</span><span class="token punctuation">,</span> <span class="token string">'mon02'</span><span class="token punctuation">,</span> <span class="token string">'mon03'</span><span class="token punctuation">]</span>
    <span class="token namespace">[ceph_deploy.new]</span><span class="token namespace">[DEBUG ]</span> Monitor addrs are <span class="token punctuation">[</span>u<span class="token string">'10.0.0.13'</span><span class="token punctuation">,</span> u<span class="token string">'10.0.0.14'</span><span class="token punctuation">,</span> u<span class="token string">'10.0.0.15'</span><span class="token punctuation">]</span>
    <span class="token namespace">[ceph_deploy.new]</span><span class="token namespace">[DEBUG ]</span> Creating a random mon key<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token namespace">[ceph_deploy.new]</span><span class="token namespace">[DEBUG ]</span> Writing monitor keyring to ceph<span class="token punctuation">.</span>mon<span class="token punctuation">.</span>keyring<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token namespace">[ceph_deploy.new]</span><span class="token namespace">[DEBUG ]</span> Writing initial config to ceph<span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>注意：
	如果出现如下报错：
	<span class="token namespace">[ceph_deploy]</span><span class="token namespace">[ERROR ]</span> AttributeError: <span class="token string">'module'</span> object has no attribute <span class="token string">'needs_ssh'</span>
	在执行命令的时候，添加一个 <span class="token operator">--</span>no-ssh-copykey 参数即可
	这主要是因为免密认证的时候，没有进行 ssh cephadm@主机名 导致的
</code></pre></div><p>查看效果</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>查看初始化后的文件内容
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ <span class="token function">ls</span>
ceph<span class="token punctuation">.</span>conf  ceph<span class="token punctuation">.</span>log  ceph<span class="token punctuation">.</span>mon<span class="token punctuation">.</span>keyring

查看集群的配置文件
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ <span class="token function">cat</span> ceph<span class="token punctuation">.</span>conf
<span class="token namespace">[global]</span>
fsid = 7738ce65-2d87-481c-8253-9d0d4b29e8eb  <span class="token comment"># 这个地方很重要的，每次都不一样，不要乱动</span>
public_network = 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0/24
cluster_network = 192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>8<span class="token punctuation">.</span>0/24
mon_initial_members = mon01<span class="token punctuation">,</span> mon02<span class="token punctuation">,</span> mon03
mon_host = 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>13<span class="token punctuation">,</span>10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>14<span class="token punctuation">,</span>10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>15
auth_cluster_required = cephx
auth_service_required = cephx
auth_client_required = cephx
filestore_xattr_use_omap = true

查看集群通信的认证信息
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ <span class="token function">cat</span> ceph<span class="token punctuation">.</span>mon<span class="token punctuation">.</span>keyring
<span class="token namespace">[mon.]</span>
key = AQBZ9y1jAAAAABAAKnVONZ3l+EEpjUOjtK8Xmw==
caps mon = allow <span class="token operator">*</span>

查看集群初始化的日志信息
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ <span class="token function">cat</span> ceph<span class="token punctuation">.</span>log
<span class="token namespace">[ceph_deploy.conf]</span><span class="token namespace">[DEBUG ]</span> found configuration file at: <span class="token operator">/</span>home/cephadm/<span class="token punctuation">.</span>cephdeploy<span class="token punctuation">.</span>conf
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p><strong>部署Mon</strong></p> <p>部署mon软件</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>操作解析：
	ceph-deploy命令能够以远程的方式连入Ceph集群各节点完成程序包安装等操作
	
命令格式：
	ceph-deploy install <span class="token punctuation">{</span>ceph-node<span class="token punctuation">}</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>ceph-node<span class="token punctuation">}</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
	示例：ceph-deploy install <span class="token operator">--</span>nogpgcheck admin mon01 mon02 mon03
	注意：
		这里主要是ceph的工作角色的的节点
		一般情况下，不推荐使用这种直接的方法来进行安装，效率太低，而且容易干扰其他主机环境
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>注意：	
	上面会在所有节点上都来进行正常的安装部署其实还有另外一种方法，手工在所有节点上安装ceph软件<span class="token operator">--</span> 推荐
	yum install <span class="token operator">-</span>y ceph ceph-osd ceph-mds ceph-mon ceph-radosgw
	
	最后在admin角色主机上安装
	ceph-deploy install <span class="token operator">--</span>no-adjust-repos <span class="token operator">--</span>nogpgcheck admin mon01 mon02 mon03
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>执行过程
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph-deploy install <span class="token operator">--</span>no-adjust-repos <span class="token operator">--</span>nogpgcheck admin mon01 mon02 mon03
<span class="token namespace">[ceph_deploy.conf]</span><span class="token namespace">[DEBUG ]</span> found configuration file at: <span class="token operator">/</span>home/cephadm/<span class="token punctuation">.</span>cephdeploy<span class="token punctuation">.</span>conf
<span class="token namespace">[ceph_deploy.cli]</span><span class="token namespace">[INFO  ]</span> Invoked <span class="token punctuation">(</span>1<span class="token punctuation">.</span>5<span class="token punctuation">.</span>25<span class="token punctuation">)</span>: <span class="token operator">/</span>bin/ceph-deploy install <span class="token operator">--</span>no-adjust-repos admin mon01 mon02 mon03
<span class="token namespace">[ceph_deploy.install]</span><span class="token namespace">[DEBUG ]</span> Installing stable version hammer on cluster ceph hosts admin mon01 mon02 mon03
<span class="token namespace">[ceph_deploy.install]</span><span class="token namespace">[DEBUG ]</span> Detecting platform <span class="token keyword">for</span> host mon01 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token namespace">[admin]</span><span class="token namespace">[DEBUG ]</span> connection detected need <span class="token keyword">for</span> sudo
<span class="token namespace">[admin]</span><span class="token namespace">[DEBUG ]</span> connected to host: admin
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token namespace">[mon03]</span><span class="token namespace">[DEBUG ]</span> 完毕！
<span class="token namespace">[mon03]</span><span class="token namespace">[INFO  ]</span> Running command: sudo ceph <span class="token operator">--</span>version
<span class="token namespace">[mon03]</span><span class="token namespace">[DEBUG ]</span> ceph version 14<span class="token punctuation">.</span>2<span class="token punctuation">.</span>22 <span class="token punctuation">(</span>ca74598065096e6fcbd8433c8779a2be0c889351<span class="token punctuation">)</span> nautilus <span class="token punctuation">(</span>stable<span class="token punctuation">)</span>
</code></pre></div><p>集群通信认证</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>配置初始MON节点<span class="token punctuation">,</span>同时向所有节点同步配置
ceph-deploy mon create-initial
注意：
	为了避免因为认证方面导致的通信失败，尤其是在现有环境上，推荐使用 <span class="token operator">--</span>overwrite-conf 参数
	ceph-deploy <span class="token operator">--</span>overwrite-conf config push mon01 mon02 mon03
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>执行效果
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph-deploy mon create-initial
<span class="token namespace">[ceph_deploy.conf]</span><span class="token namespace">[DEBUG ]</span> found configuration file at: <span class="token operator">/</span>home/cephadm/<span class="token punctuation">.</span>cephdeploy<span class="token punctuation">.</span>conf
<span class="token namespace">[ceph_deploy.cli]</span><span class="token namespace">[INFO  ]</span> Invoked <span class="token punctuation">(</span>2<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1<span class="token punctuation">)</span>: <span class="token operator">/</span>bin/ceph-deploy mon create-initial
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span> status <span class="token keyword">for</span> monitor: mon<span class="token punctuation">.</span>mon01
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span> <span class="token punctuation">{</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>   <span class="token string">&quot;election_epoch&quot;</span>: 0<span class="token punctuation">,</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>   <span class="token string">&quot;extra_probe_peers&quot;</span>: <span class="token punctuation">[</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>   <span class="token string">&quot;feature_map&quot;</span>: <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>   <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>   <span class="token string">&quot;features&quot;</span>: <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>   <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>   <span class="token string">&quot;monmap&quot;</span>: <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>     <span class="token string">&quot;mons&quot;</span>: <span class="token punctuation">[</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>       <span class="token punctuation">{</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>         <span class="token string">&quot;addr&quot;</span>: <span class="token string">&quot;10.0.0.13:6789/0&quot;</span><span class="token punctuation">,</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>         <span class="token string">&quot;name&quot;</span>: <span class="token string">&quot;mon01&quot;</span><span class="token punctuation">,</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>         <span class="token string">&quot;public_addr&quot;</span>: <span class="token string">&quot;10.0.0.13:6789/0&quot;</span><span class="token punctuation">,</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>         <span class="token string">&quot;public_addrs&quot;</span>: <span class="token punctuation">{</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>           <span class="token string">&quot;addrvec&quot;</span>: <span class="token punctuation">[</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>             <span class="token punctuation">{</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>               <span class="token string">&quot;addr&quot;</span>: <span class="token string">&quot;10.0.0.13:3300&quot;</span><span class="token punctuation">,</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>               <span class="token string">&quot;nonce&quot;</span>: 0<span class="token punctuation">,</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>               <span class="token string">&quot;type&quot;</span>: <span class="token string">&quot;v2&quot;</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>             <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>             <span class="token punctuation">{</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>               <span class="token string">&quot;addr&quot;</span>: <span class="token string">&quot;10.0.0.13:6789&quot;</span><span class="token punctuation">,</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>               <span class="token string">&quot;nonce&quot;</span>: 0<span class="token punctuation">,</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>               <span class="token string">&quot;type&quot;</span>: <span class="token string">&quot;v1&quot;</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>             <span class="token punctuation">}</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>           <span class="token punctuation">]</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>         <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>         <span class="token string">&quot;rank&quot;</span>: 0
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>       <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>       <span class="token punctuation">{</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>         <span class="token string">&quot;addr&quot;</span>: <span class="token string">&quot;0.0.0.0:0/1&quot;</span><span class="token punctuation">,</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>         <span class="token string">&quot;name&quot;</span>: <span class="token string">&quot;mon02&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>         <span class="token string">&quot;rank&quot;</span>: 1
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>       <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>       <span class="token punctuation">{</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>         <span class="token string">&quot;addr&quot;</span>: <span class="token string">&quot;0.0.0.0:0/2&quot;</span><span class="token punctuation">,</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>         <span class="token string">&quot;name&quot;</span>: <span class="token string">&quot;mon03&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>         <span class="token string">&quot;rank&quot;</span>: 2
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>       <span class="token punctuation">}</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>     <span class="token punctuation">]</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>   <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>   <span class="token string">&quot;name&quot;</span>: <span class="token string">&quot;mon01&quot;</span><span class="token punctuation">,</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>   <span class="token string">&quot;outside_quorum&quot;</span>: <span class="token punctuation">[</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>     <span class="token string">&quot;mon01&quot;</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>   <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>   <span class="token string">&quot;quorum&quot;</span>: <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>   <span class="token string">&quot;rank&quot;</span>: 0<span class="token punctuation">,</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>   <span class="token string">&quot;state&quot;</span>: <span class="token string">&quot;probing&quot;</span><span class="token punctuation">,</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span>   <span class="token string">&quot;sync_provider&quot;</span>: <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span> <span class="token punctuation">}</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[INFO  ]</span> monitor: mon<span class="token punctuation">.</span>mon01 is running
<span class="token namespace">[mon01]</span><span class="token namespace">[INFO  ]</span> Running command: sudo ceph <span class="token operator">--</span>cluster=ceph <span class="token operator">--</span>admin-daemon <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>run/ceph/ceph-mon<span class="token punctuation">.</span>mon01<span class="token punctuation">.</span>asok mon_status
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token namespace">[ceph_deploy.gatherkeys]</span><span class="token namespace">[INFO  ]</span> Storing ceph<span class="token punctuation">.</span>bootstrap-osd<span class="token punctuation">.</span>keyring
<span class="token namespace">[ceph_deploy.gatherkeys]</span><span class="token namespace">[INFO  ]</span> Storing ceph<span class="token punctuation">.</span>bootstrap-rgw<span class="token punctuation">.</span>keyring
<span class="token namespace">[ceph_deploy.gatherkeys]</span><span class="token namespace">[INFO  ]</span> Destroy temp directory <span class="token operator">/</span>tmp/tmpyal7qW
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>到mon的节点上查看mon的守护进程
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ <span class="token keyword">for</span> i in <span class="token punctuation">{</span>13<span class="token punctuation">.</span><span class="token punctuation">.</span>15<span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token keyword">do</span> ssh cephadm@10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span><span class="token variable">$i</span> <span class="token string">&quot;ps aux | grep -v grep | grep ceph-mon&quot;</span><span class="token punctuation">;</span> done
ceph        2189  0<span class="token punctuation">.</span>1  1<span class="token punctuation">.</span>8 504004 34644 ?        Ssl  11:55   0:00 <span class="token operator">/</span>usr/bin/ceph-mon <span class="token operator">-</span>f <span class="token operator">--</span>cluster ceph <span class="token operator">--</span>id mon01 <span class="token operator">--</span>setuser ceph <span class="token operator">--</span>setgroup ceph
ceph        2288  0<span class="token punctuation">.</span>1  1<span class="token punctuation">.</span>7 502984 33328 ?        Ssl  11:55   0:00 <span class="token operator">/</span>usr/bin/ceph-mon <span class="token operator">-</span>f <span class="token operator">--</span>cluster ceph <span class="token operator">--</span>id mon02 <span class="token operator">--</span>setuser ceph <span class="token operator">--</span>setgroup ceph
ceph        2203  0<span class="token punctuation">.</span>1  1<span class="token punctuation">.</span>7 502988 32912 ?        Ssl  11:55   0:00 <span class="token operator">/</span>usr/bin/ceph-mon <span class="token operator">-</span>f <span class="token operator">--</span>cluster ceph <span class="token operator">--</span>id mon03 <span class="token operator">--</span>setuser ceph <span class="token operator">--</span>setgroup ceph
结果显示：
	在所有的节点主机上，都有一套ceph-mon的进程在进行。
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>集群在初始化的时候，会为对应的mon节点生成配套的认证信息
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ <span class="token function">ls</span> <span class="token operator">/</span>home/cephadm/ceph-cluster
ceph<span class="token punctuation">.</span>bootstrap-mds<span class="token punctuation">.</span>keyring  ceph<span class="token punctuation">.</span>bootstrap-osd<span class="token punctuation">.</span>keyring  ceph<span class="token punctuation">.</span>client<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>keyring  
ceph-deploy-ceph<span class="token punctuation">.</span>log 		ceph<span class="token punctuation">.</span>bootstrap-mgr<span class="token punctuation">.</span>keyring  ceph<span class="token punctuation">.</span>bootstrap-rgw<span class="token punctuation">.</span>keyring
ceph<span class="token punctuation">.</span>conf                  	ceph<span class="token punctuation">.</span>mon<span class="token punctuation">.</span>keyring
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>结果显示：
	这里生成了一系列的与ceph集群相关的 认证文件
	ceph<span class="token punctuation">.</span>bootstrap-mds<span class="token punctuation">.</span>keyring		引导启动 mds的秘钥文件
	ceph<span class="token punctuation">.</span>bootstrap-osd<span class="token punctuation">.</span>keyring		引导启动 osd的秘钥文件
	ceph<span class="token punctuation">.</span>client<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>keyring		ceph客户端和管理端通信的认证秘钥，是最重要的
	ceph-deploy-ceph<span class="token punctuation">.</span>log		   
	ceph<span class="token punctuation">.</span>bootstrap-mgr<span class="token punctuation">.</span>keyring		引导启动 mgr的秘钥文件
	ceph<span class="token punctuation">.</span>bootstrap-rgw<span class="token punctuation">.</span>keyring		引导启动 rgw的秘钥文件
	ceph<span class="token punctuation">.</span>conf
	ceph<span class="token punctuation">.</span>mon<span class="token punctuation">.</span>keyring
	注意：
		ceph<span class="token punctuation">.</span>client<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>keyring 拥有ceph集群的所有权限，一定不能有误。
</code></pre></div><p><strong>小结</strong></p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div><h3 id="_1-2-4-ceph部署2"><a href="#_1-2-4-ceph部署2" class="header-anchor">#</a> 1.2.4 Ceph部署2</h3> <p>学习目标</p> <p>这一节，我们从 Mon认证、Mgr环境、小结、三个方面来学习</p> <p><strong>Mon认证</strong></p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	为了方便后续的监控环境认证操作，在admin角色主机上，把配置文件和admin密钥拷贝Ceph集群各监控角色节点<span class="token punctuation">,</span>拷贝前秘钥文件前的各个mon节点效果
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ <span class="token keyword">for</span> i in <span class="token punctuation">{</span>13<span class="token punctuation">.</span><span class="token punctuation">.</span>15<span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token keyword">do</span> ssh cephadm@10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span><span class="token variable">$i</span> <span class="token string">&quot;echo -----<span class="token variable">$i</span>-----; ls /etc/ceph&quot;</span><span class="token punctuation">;</span> done
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>13-<span class="token operator">--</span><span class="token operator">--</span>
ceph<span class="token punctuation">.</span>conf
rbdmap
tmpc8lO0G
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>14-<span class="token operator">--</span><span class="token operator">--</span>
ceph<span class="token punctuation">.</span>conf
rbdmap
tmpkmxmh3
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>15-<span class="token operator">--</span><span class="token operator">--</span>
ceph<span class="token punctuation">.</span>conf
rbdmap
tmp4GwYSs
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>原则上要求，所有mon节点上的 ceph<span class="token punctuation">.</span>conf 内容必须一致，如果不一致的话，可以通过下面命令同步
	ceph-deploy <span class="token operator">--</span>overwrite-conf config push mon01 mon02 mon03
	
执行集群的认证文件的拷贝动作
ceph-deploy admin mon01 mon02 mon03
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>执行认证文件信息同步
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph-deploy admin mon01 mon02 mon03
<span class="token namespace">[ceph_deploy.conf]</span><span class="token namespace">[DEBUG ]</span> found configuration file at: <span class="token operator">/</span>home/cephadm/<span class="token punctuation">.</span>cephdeploy<span class="token punctuation">.</span>conf
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token namespace">[ceph_deploy.admin]</span><span class="token namespace">[DEBUG ]</span> Pushing admin keys and conf to mon01
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[DEBUG ]</span> <span class="token function">write</span> cluster configuration to <span class="token operator">/</span>etc/ceph/<span class="token punctuation">{</span>cluster<span class="token punctuation">}</span><span class="token punctuation">.</span>conf
<span class="token namespace">[ceph_deploy.admin]</span><span class="token namespace">[DEBUG ]</span> Pushing admin keys and conf to mon02
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token namespace">[mon02]</span><span class="token namespace">[DEBUG ]</span> <span class="token function">write</span> cluster configuration to <span class="token operator">/</span>etc/ceph/<span class="token punctuation">{</span>cluster<span class="token punctuation">}</span><span class="token punctuation">.</span>conf
<span class="token namespace">[ceph_deploy.admin]</span><span class="token namespace">[DEBUG ]</span> Pushing admin keys and conf to mon03
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token namespace">[mon03]</span><span class="token namespace">[DEBUG ]</span> <span class="token function">write</span> cluster configuration to <span class="token operator">/</span>etc/ceph/<span class="token punctuation">{</span>cluster<span class="token punctuation">}</span><span class="token punctuation">.</span>conf
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看效果
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ <span class="token keyword">for</span> i in <span class="token punctuation">{</span>13<span class="token punctuation">.</span><span class="token punctuation">.</span>15<span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token keyword">do</span> ssh cephadm@10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span><span class="token variable">$i</span> <span class="token string">&quot;echo -----<span class="token variable">$i</span>-----; ls /etc/ceph&quot;</span><span class="token punctuation">;</span> done
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>13-<span class="token operator">--</span><span class="token operator">--</span>
ceph<span class="token punctuation">.</span>client<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>keyring
ceph<span class="token punctuation">.</span>conf
rbdmap
tmpc8lO0G
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>14-<span class="token operator">--</span><span class="token operator">--</span>
ceph<span class="token punctuation">.</span>client<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>keyring
ceph<span class="token punctuation">.</span>conf
rbdmap
tmpkmxmh3
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>15-<span class="token operator">--</span><span class="token operator">--</span>
ceph<span class="token punctuation">.</span>client<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>keyring
ceph<span class="token punctuation">.</span>conf
rbdmap
tmp4GwYSs
结果显示：
	所有的mon节点上多了一个 ceph的客户端与服务端进行认证的秘钥文件了。
	ceph<span class="token punctuation">.</span>client<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>keyring 主要用于 ceph客户端与管理端的一个通信认证。
	注意：如果我们不做交互式操作的话，这个文件可以不用复制。
</code></pre></div><p>认证文件权限</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	虽然我们把认证文件传递给对应的监控角色主机了，但是我们的服务式通过普通用户cephadm来进行交流的。而默认情况下，传递过去的认证文件，cephadm普通用户是无法正常访问的
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ <span class="token keyword">for</span> i in <span class="token punctuation">{</span>13<span class="token punctuation">.</span><span class="token punctuation">.</span>15<span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token keyword">do</span> ssh cephadm@10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span><span class="token variable">$i</span> <span class="token string">&quot;echo -----<span class="token variable">$i</span>-----; ls /etc/ceph/ceph.cl* -l&quot;</span><span class="token punctuation">;</span> done
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>13-<span class="token operator">--</span><span class="token operator">--</span>
<span class="token operator">-</span>rw-<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> 1 root root 151 9月  25 12:06 <span class="token operator">/</span>etc/ceph/ceph<span class="token punctuation">.</span>client<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>keyring
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>14-<span class="token operator">--</span><span class="token operator">--</span>
<span class="token operator">-</span>rw-<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> 1 root root 151 9月  25 12:06 <span class="token operator">/</span>etc/ceph/ceph<span class="token punctuation">.</span>client<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>keyring
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>15-<span class="token operator">--</span><span class="token operator">--</span>
<span class="token operator">-</span>rw-<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> 1 root root 151 9月  25 12:06 <span class="token operator">/</span>etc/ceph/ceph<span class="token punctuation">.</span>client<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>keyring
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>我们需要在Ceph集群中需要运行ceph命令的的节点上，以root用户的身份设定普通用户cephadm能够读
取<span class="token operator">/</span>etc/ceph/ceph<span class="token punctuation">.</span>client<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>keyring文件的权限。
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ <span class="token keyword">for</span> i in <span class="token punctuation">{</span>13<span class="token punctuation">.</span><span class="token punctuation">.</span>15<span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token keyword">do</span> ssh cephadm@10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span><span class="token variable">$i</span> <span class="token string">&quot;sudo setfacl -m u:cephadm:r /etc/ceph/ceph.client.admin.keyring&quot;</span><span class="token punctuation">;</span> done

查看文件权限效果
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ <span class="token keyword">for</span> i in <span class="token punctuation">{</span>13<span class="token punctuation">.</span><span class="token punctuation">.</span>15<span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token keyword">do</span> ssh cephadm@10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span><span class="token variable">$i</span> <span class="token string">&quot;echo -----<span class="token variable">$i</span>-----; ls /etc/ceph/ceph.cl* -l&quot;</span><span class="token punctuation">;</span> done
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>13-<span class="token operator">--</span><span class="token operator">--</span>
<span class="token operator">-</span>rw-r-<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span> 1 root root 151 9月  25 12:06 <span class="token operator">/</span>etc/ceph/ceph<span class="token punctuation">.</span>client<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>keyring
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>14-<span class="token operator">--</span><span class="token operator">--</span>
<span class="token operator">-</span>rw-r-<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span> 1 root root 151 9月  25 12:06 <span class="token operator">/</span>etc/ceph/ceph<span class="token punctuation">.</span>client<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>keyring
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>15-<span class="token operator">--</span><span class="token operator">--</span>
<span class="token operator">-</span>rw-r-<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span> 1 root root 151 9月  25 12:06 <span class="token operator">/</span>etc/ceph/ceph<span class="token punctuation">.</span>client<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>keyring

查看文件的授权信息
<span class="token namespace">[root@mon01 ~]</span><span class="token comment"># getfacl /etc/ceph/ceph.client.admin.keyring</span>
getfacl: Removing leading <span class="token string">'/'</span> <span class="token keyword">from</span> absolute path names
<span class="token comment"># file: etc/ceph/ceph.client.admin.keyring</span>
<span class="token comment"># owner: root</span>
<span class="token comment"># group: root</span>
user::rw-
user:cephadm:r-<span class="token operator">-</span>
<span class="token function">group</span>::<span class="token operator">--</span><span class="token operator">-</span>
mask::r-<span class="token operator">-</span>
other::<span class="token operator">--</span><span class="token operator">-</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>监控节点就可以自己来收集相关的数据了，比如我们在mon01上执行如下命令
<span class="token namespace">[root@mon01 ~]</span><span class="token comment"># ceph -s</span>
  cluster:
    id:     1d4e5773-619a-479d-861a-66ba451ce945
    health: HEALTH_WARN
            mons are allowing insecure global_id reclaim

  services:
    mon: 3 daemons<span class="token punctuation">,</span> quorum mon01<span class="token punctuation">,</span>mon02<span class="token punctuation">,</span>mon03 <span class="token punctuation">(</span>age 18m<span class="token punctuation">)</span>
    mgr: no daemons active
    osd: 0 osds: 0 up<span class="token punctuation">,</span> 0 in

  <span class="token keyword">data</span>:
    pools:   0 pools<span class="token punctuation">,</span> 0 pgs
    objects: 0 objects<span class="token punctuation">,</span> 0 B
    usage:   0 B used<span class="token punctuation">,</span> 0 B <span class="token operator">/</span> 0 B avail
    pgs:
结果显示：
	我们的cluster状态不是正常的
	对于service来说，有三个mon服务，选举的节点有三个，其他的服务没有。
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>集群状态不正常的原因，我们可以通过 ceph health命令来进行确认，效果如下
<span class="token namespace">[root@mon01 ~]</span><span class="token comment"># ceph health</span>
HEALTH_WARN mons are allowing insecure global_id reclaim
<span class="token namespace">[root@mon01 ~]</span><span class="token comment"># ceph health detail</span>
HEALTH_WARN mons are allowing insecure global_id reclaim
AUTH_INSECURE_GLOBAL_ID_RECLAIM_ALLOWED mons are allowing insecure global_id reclaim
    mon<span class="token punctuation">.</span>mon01 has auth_allow_insecure_global_id_reclaim <span class="token function">set</span> to true
    mon<span class="token punctuation">.</span>mon02 has auth_allow_insecure_global_id_reclaim <span class="token function">set</span> to true
    mon<span class="token punctuation">.</span>mon03 has auth_allow_insecure_global_id_reclaim <span class="token function">set</span> to true
结果显示：
	我们在所有的mon节点上进行提示属性的设定
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code><span class="token namespace">[root@mon01 ~]</span><span class="token comment"># ceph config set mon auth_allow_insecure_global_id_reclaim false</span>
<span class="token namespace">[root@mon01 ~]</span><span class="token comment"># ceph health detail</span>
HEALTH_OK
结果显示：
	集群状态问题已经解决了
</code></pre></div><p><strong>Mgr环境</strong></p> <p>需求</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	Ceph-MGR工作的模式是事件驱动型的，简单来说，就是等待事件，事件来了则处理事件返回结果，又继续等待。Ceph MGR 是 Ceph 12<span class="token punctuation">.</span>2 依赖主推的功能之一，它负责 Ceph 集群管理的组件，它主要功能是把集群的一些指标暴露给外界使用。根据官方的架构原则上来说，mgr要有两个节点来进行工作。
	对于我们的学习环境来说，其实一个就能够正常使用了<span class="token punctuation">,</span>为了节省资源的使用，我们这里将mon01 和mon02主机节点兼做MGR节点，为了后续的节点扩充实践，我们暂时先安装一个节点，后面再安装一个节点。
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>未部署mgr节点的集群状态效果
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ssh mon01  ceph <span class="token operator">-</span>s
  cluster:
    id:     1d4e5773-619a-479d-861a-66ba451ce945
    health: HEALTH_OK

  services:
    mon: 3 daemons<span class="token punctuation">,</span> quorum mon01<span class="token punctuation">,</span>mon02<span class="token punctuation">,</span>mon03 <span class="token punctuation">(</span>age 29m<span class="token punctuation">)</span>
    mgr: no daemons active
    osd: 0 osds: 0 up<span class="token punctuation">,</span> 0 in

  <span class="token keyword">data</span>:
    pools:   0 pools<span class="token punctuation">,</span> 0 pgs
    objects: 0 objects<span class="token punctuation">,</span> 0 B
    usage:   0 B used<span class="token punctuation">,</span> 0 B <span class="token operator">/</span> 0 B avail
    pgs:
</code></pre></div><p>mgr服务配置</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>配置Manager节点，启动ceph-mgr进程：
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph-deploy mgr create mon01
<span class="token namespace">[ceph_deploy.conf]</span><span class="token namespace">[DEBUG ]</span> found configuration file at: <span class="token operator">/</span>home/cephadm/<span class="token punctuation">.</span>cephdeploy<span class="token punctuation">.</span>conf
<span class="token namespace">[ceph_deploy.cli]</span><span class="token namespace">[INFO  ]</span> Invoked <span class="token punctuation">(</span>2<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1<span class="token punctuation">)</span>: <span class="token operator">/</span>bin/ceph-deploy mgr create mon01
<span class="token namespace">[ceph_deploy.cli]</span><span class="token namespace">[INFO  ]</span> ceph-deploy options:
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token namespace">[ceph_deploy.cli]</span><span class="token namespace">[INFO  ]</span>  mgr                           : <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'mon01'</span><span class="token punctuation">,</span> <span class="token string">'mon01'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token namespace">[mon01]</span><span class="token namespace">[INFO  ]</span> Running command: sudo systemctl <span class="token function">start</span> ceph-mgr@mon

</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>在指定的mgr节点上，查看守护进程
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ssh mon01 <span class="token function">ps</span> aux <span class="token punctuation">|</span> grep <span class="token operator">-</span>v grep <span class="token punctuation">|</span> grep ceph-mgr
ceph        3065  2<span class="token punctuation">.</span>8  6<span class="token punctuation">.</span>6 1037824 124244 ?      Ssl  12:27   0:01 <span class="token operator">/</span>usr/bin/ceph-mgr <span class="token operator">-</span>f <span class="token operator">--</span>cluster ceph <span class="token operator">--</span>id mon01 <span class="token operator">--</span>setuser ceph <span class="token operator">--</span>setgroup ceph
结果显示：
	在mon01上，部署了一个mgr的服务进程
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看集群服务的运行状态
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ssh mon01  ceph <span class="token operator">-</span>s
  cluster:
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  services:
    mon: 3 daemons<span class="token punctuation">,</span> quorum mon01<span class="token punctuation">,</span>mon02<span class="token punctuation">,</span>mon03 <span class="token punctuation">(</span>age 33m<span class="token punctuation">)</span>
    mgr: mon01<span class="token punctuation">(</span>active<span class="token punctuation">,</span> since 86s<span class="token punctuation">)</span>
    osd: 0 osds: 0 up<span class="token punctuation">,</span> 0 in
  <span class="token keyword">data</span>:
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
结果显示：
	这个时候，service上，多了一个mgr的服务，在mon01节点上，服务状态是 active。
</code></pre></div><p>admin查看状态</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>远程查看状态方式不太方便，我们可以在admin主机上进行一下操作来实现admin主机查看集群状态
sudo yum <span class="token operator">-</span>y install ceph-common
ceph-deploy admin admin
sudo setfacl <span class="token operator">-</span>m u:cephadm:rw <span class="token operator">/</span>etc/ceph/ceph<span class="token punctuation">.</span>client<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>keyring
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>确认效果
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph <span class="token operator">-</span>s
  cluster:
    id:     1d4e5773-619a-479d-861a-66ba451ce945
    health: HEALTH_WARN
            OSD count 0 &lt; osd_pool_default_size 3

  services:
    mon: 3 daemons<span class="token punctuation">,</span> quorum mon01<span class="token punctuation">,</span>mon02<span class="token punctuation">,</span>mon03 <span class="token punctuation">(</span>age 37m<span class="token punctuation">)</span>
    mgr: mon01<span class="token punctuation">(</span>active<span class="token punctuation">,</span> since 4m<span class="token punctuation">)</span>
    osd: 0 osds: 0 up<span class="token punctuation">,</span> 0 in

  <span class="token keyword">data</span>:
    pools:   0 pools<span class="token punctuation">,</span> 0 pgs
    objects: 0 objects<span class="token punctuation">,</span> 0 B
    usage:   0 B used<span class="token punctuation">,</span> 0 B <span class="token operator">/</span> 0 B avail
    pgs:
</code></pre></div><p><strong>小结</strong></p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div><h3 id="_1-2-5-osd环境"><a href="#_1-2-5-osd环境" class="header-anchor">#</a> 1.2.5 OSD环境</h3> <p>学习目标</p> <p>这一节，我们从 基本环境、OSD实践、小结、三个方面来学习。</p> <p><strong>基本环境</strong></p> <p>简介</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	我们知道对于osd来说，它进行真正数据的存储的引擎有两种：BlueStore和FileStore，自动Ceph L版之后，默认都是BlueStore了。
</code></pre></div><p>基本流程</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>一般来说，我们可以通过一下四个步骤来设置OSD环境：
	1 要知道对应的主机上有哪些磁盘可以提供给主机来进行正常的使用。
	2 格式化磁盘<span class="token punctuation">(</span>非必须<span class="token punctuation">)</span>
	3 ceph擦除磁盘上的数据
	4 添加osd
</code></pre></div><p>1 确保提供专属数据磁盘，然后进行格式化</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>根据我们的了解，我们为所有的节点主机都准备了两块额外的磁盘，
fdisk <span class="token operator">-</span>l
</code></pre></div><p>2 进行磁盘格式化</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>我们在所有的osd角色的主机上，进行磁盘的格式化操作<span class="token punctuation">,</span>对所有的osd节点主机进行磁盘格式化。
mkfs<span class="token punctuation">.</span>ext4  <span class="token operator">/</span>dev/sdb
mkfs<span class="token punctuation">.</span>ext4  <span class="token operator">/</span>dev/sdc
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看磁盘格式化效果，以mon03为例
<span class="token namespace">[root@mon03 ~]</span><span class="token comment"># blkid | egrep &quot;sd[bc]&quot;</span>
<span class="token operator">/</span>dev/sdb: UUID=<span class="token string">&quot;49b5be7c-76dc-4ac7-a3e6-1f54526c83df&quot;</span> <span class="token function">TYPE</span>=<span class="token string">&quot;ext4&quot;</span>
<span class="token operator">/</span>dev/sdc: UUID=<span class="token string">&quot;ecdc0ce6-8045-4caa-b272-2607e70700ee&quot;</span> <span class="token function">TYPE</span>=<span class="token string">&quot;ext4&quot;</span>
</code></pre></div><p>3 ceph擦除磁盘上的数据</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>保证所有包含OSD磁盘上主机上，安装ceph的命令
yum install <span class="token operator">-</span>y ceph radosgw
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>检查并列出OSD节点上所有可用的磁盘的相关信息
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph-deploy disk list stor01 stor02 stor03
<span class="token namespace">[ceph_deploy.conf]</span><span class="token namespace">[DEBUG ]</span> found configuration file at: <span class="token operator">/</span>home/cephadm/<span class="token punctuation">.</span>cephdeploy<span class="token punctuation">.</span>conf
<span class="token namespace">[ceph_deploy.cli]</span><span class="token namespace">[INFO  ]</span> Invoked <span class="token punctuation">(</span>2<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1<span class="token punctuation">)</span>: <span class="token operator">/</span>bin/ceph-deploy disk list stor01 stor02 stor03
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token namespace">[stor01]</span><span class="token namespace">[DEBUG ]</span> connection detected need <span class="token keyword">for</span> sudo
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token namespace">[stor01]</span><span class="token namespace">[INFO  ]</span> Running command: sudo fdisk <span class="token operator">-</span>l
<span class="token namespace">[stor02]</span><span class="token namespace">[DEBUG ]</span> connection detected need <span class="token keyword">for</span> sudo
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token namespace">[stor02]</span><span class="token namespace">[INFO  ]</span> Running command: sudo fdisk <span class="token operator">-</span>l
<span class="token namespace">[stor03]</span><span class="token namespace">[DEBUG ]</span> connection detected need <span class="token keyword">for</span> sudo
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token namespace">[stor03]</span><span class="token namespace">[INFO  ]</span> Running command: sudo fdisk <span class="token operator">-</span>l
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>在管理节点上使用ceph-deploy命令擦除计划专用于OSD磁盘上的所有分区表和数据以便用于OSD，
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ <span class="token keyword">for</span> i in <span class="token punctuation">{</span>1<span class="token punctuation">.</span><span class="token punctuation">.</span>3<span class="token punctuation">}</span>
<span class="token keyword">do</span> 
   ceph-deploy disk zap stor0<span class="token variable">$i</span> <span class="token operator">/</span>dev/sdb <span class="token operator">/</span>dev/sdc
done
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token namespace">[stor03]</span><span class="token namespace">[WARNIN]</span>  stderr: 记录了10+0 的读入
<span class="token namespace">[stor03]</span><span class="token namespace">[WARNIN]</span> 记录了10+0 的写出
<span class="token namespace">[stor03]</span><span class="token namespace">[WARNIN]</span> 10485760字节<span class="token punctuation">(</span>10 MB<span class="token punctuation">)</span>已复制
<span class="token namespace">[stor03]</span><span class="token namespace">[WARNIN]</span>  stderr: ，0<span class="token punctuation">.</span>018883 秒，555 MB/秒
<span class="token namespace">[stor03]</span><span class="token namespace">[WARNIN]</span> <span class="token operator">--</span>&gt; Zapping successful <span class="token keyword">for</span>: &lt;Raw Device: <span class="token operator">/</span>dev/sdc&gt;
</code></pre></div><p><strong>OSD实践</strong></p> <p>命令解析</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>对于osd的相关操作，可以通过 ceph-deploy osd 命令来进行，帮助信息如下
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph-deploy osd <span class="token operator">--</span>help
usage: ceph-deploy osd <span class="token punctuation">[</span><span class="token operator">-</span>h<span class="token punctuation">]</span> <span class="token punctuation">{</span>list<span class="token punctuation">,</span>create<span class="token punctuation">}</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

Create OSDs <span class="token keyword">from</span> a <span class="token keyword">data</span> disk on a remote host:
    ceph-deploy osd create <span class="token punctuation">{</span>node<span class="token punctuation">}</span> <span class="token operator">--</span><span class="token keyword">data</span> <span class="token operator">/</span>path/to/device

<span class="token keyword">For</span> bluestore<span class="token punctuation">,</span> optional devices can be used::
    ceph-deploy osd create <span class="token punctuation">{</span>node<span class="token punctuation">}</span> <span class="token operator">--</span><span class="token keyword">data</span> <span class="token operator">/</span>path/to/<span class="token keyword">data</span> <span class="token operator">--</span><span class="token function">block-db</span> <span class="token operator">/</span>path/to/db-device
    ceph-deploy osd create <span class="token punctuation">{</span>node<span class="token punctuation">}</span> <span class="token operator">--</span><span class="token keyword">data</span> <span class="token operator">/</span>path/to/<span class="token keyword">data</span> <span class="token operator">--</span><span class="token function">block-wal</span> <span class="token operator">/</span>path/to/wal-device
    ceph-deploy osd create <span class="token punctuation">{</span>node<span class="token punctuation">}</span> <span class="token operator">--</span><span class="token keyword">data</span> <span class="token operator">/</span>path/to/<span class="token keyword">data</span> <span class="token operator">--</span><span class="token function">block-db</span> <span class="token operator">/</span>path/to/db-device <span class="token operator">--</span><span class="token function">block-wal</span> <span class="token operator">/</span>path/to/wal-device

<span class="token keyword">For</span> filestore<span class="token punctuation">,</span> the journal must be specified<span class="token punctuation">,</span> as well as the objectstore::
    ceph-deploy osd create <span class="token punctuation">{</span>node<span class="token punctuation">}</span> <span class="token operator">--</span>filestore <span class="token operator">--</span><span class="token keyword">data</span> <span class="token operator">/</span>path/to/<span class="token keyword">data</span> <span class="token operator">--</span>journal <span class="token operator">/</span>path/to/journal

<span class="token keyword">For</span> <span class="token keyword">data</span> devices<span class="token punctuation">,</span> it can be an existing logical volume in the format of:
vg/lv<span class="token punctuation">,</span> or a device<span class="token punctuation">.</span> <span class="token keyword">For</span> other OSD components like wal<span class="token punctuation">,</span> db<span class="token punctuation">,</span> and journal<span class="token punctuation">,</span> it
can be logical volume <span class="token punctuation">(</span>in vg/lv format<span class="token punctuation">)</span> or it must be a GPT partition<span class="token punctuation">.</span>

positional arguments:
  <span class="token punctuation">{</span>list<span class="token punctuation">,</span>create<span class="token punctuation">}</span>
    list         List OSD info <span class="token keyword">from</span> remote host<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    create       Create new Ceph OSD daemon by preparing and activating a device
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>帮助显示：这里提示了两类的存储机制：
	对于bluestore来说，它主要包括三类数据：
		<span class="token operator">--</span><span class="token keyword">data</span> <span class="token operator">/</span>path/to/<span class="token keyword">data</span>						ceph 保存的对象数据
		<span class="token operator">--</span><span class="token function">block-db</span> <span class="token operator">/</span>path/to/db-device 		     	ceph 保存的对象数据
		<span class="token operator">--</span><span class="token function">block-wal</span> <span class="token operator">/</span>path/to/wal-device		      	数据库的 wal 日志
	对于filestore来说，它主要包括两类数据	
		<span class="token operator">--</span><span class="token keyword">data</span> <span class="token operator">/</span>path/to/<span class="token keyword">data</span> 		  		   		ceph的文件数据
		<span class="token operator">--</span>journal <span class="token operator">/</span>path/to/journal			     	文件系统日志数据
	对于 osd来说，它主要有两个动作：
		list	列出osd相关的信息
		create	创建osd设备
</code></pre></div><p>添加OSD命令解读</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>对于osd的创建来说，我们来看一下他的基本格式
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph-deploy osd create <span class="token operator">--</span>help
usage: ceph-deploy osd create <span class="token punctuation">[</span><span class="token operator">-</span>h<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span><span class="token keyword">data</span> <span class="token keyword">DATA</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span>journal JOURNAL<span class="token punctuation">]</span>
                              <span class="token punctuation">[</span><span class="token operator">--</span>zap-disk<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span>fs-<span class="token function">type</span> FS_TYPE<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span>dmcrypt<span class="token punctuation">]</span>
                              <span class="token punctuation">[</span><span class="token operator">--</span>dmcrypt-key-<span class="token function">dir</span> KEYDIR<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span>filestore<span class="token punctuation">]</span>
                              <span class="token punctuation">[</span><span class="token operator">--</span>bluestore<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span><span class="token function">block-db</span> BLOCK_DB<span class="token punctuation">]</span>
                              <span class="token punctuation">[</span><span class="token operator">--</span><span class="token function">block-wal</span> BLOCK_WAL<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">--</span>debug<span class="token punctuation">]</span>
                              <span class="token namespace">[HOST]</span>

positional arguments:
  HOST                  Remote host to connect

optional arguments:
  <span class="token operator">-</span>h<span class="token punctuation">,</span> <span class="token operator">--</span>help            show this help message and <span class="token keyword">exit</span>
  <span class="token operator">--</span><span class="token keyword">data</span> <span class="token keyword">DATA</span>           The OSD <span class="token keyword">data</span> logical volume <span class="token punctuation">(</span>vg/lv<span class="token punctuation">)</span> or absolute path
                        to device
  <span class="token operator">--</span>journal JOURNAL     Logical Volume <span class="token punctuation">(</span>vg/lv<span class="token punctuation">)</span> or path to GPT partition
  <span class="token operator">--</span>zap-disk            DEPRECATED <span class="token operator">-</span> cannot zap when creating an OSD
  <span class="token operator">--</span>fs-<span class="token function">type</span> FS_TYPE     filesystem to use to format DEVICE <span class="token punctuation">(</span>xfs<span class="token punctuation">,</span> btrfs<span class="token punctuation">)</span>
  <span class="token operator">--</span>dmcrypt             use dm-crypt on DEVICE
  <span class="token operator">--</span>dmcrypt-key-<span class="token function">dir</span> KEYDIR
                        directory where dm-crypt keys are stored
  <span class="token operator">--</span>filestore           filestore objectstore
  <span class="token operator">--</span>bluestore           bluestore objectstore
  <span class="token operator">--</span><span class="token function">block-db</span> BLOCK_DB   bluestore block<span class="token punctuation">.</span>db path
  <span class="token operator">--</span><span class="token function">block-wal</span> BLOCK_WAL
                        bluestore block<span class="token punctuation">.</span>wal path
  <span class="token operator">--</span>debug               Enable debug mode on remote ceph-volume calls
结果显示：
	对于osd的创建，默认情况下用的就是 bluestore类型，
</code></pre></div><p>4 添加osd</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>创建osd，我们这里全部用于存储数据。
ceph-deploy <span class="token operator">--</span>overwrite-conf osd create stor01 <span class="token operator">--</span><span class="token keyword">data</span> <span class="token operator">/</span>dev/sdb
ceph-deploy <span class="token operator">--</span>overwrite-conf osd create stor01 <span class="token operator">--</span><span class="token keyword">data</span> <span class="token operator">/</span>dev/sdc
注意：
	这里只能一个磁盘一个磁盘的添加
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看效果
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph-deploy <span class="token operator">--</span>overwrite-conf osd create stor01 <span class="token operator">--</span><span class="token keyword">data</span> <span class="token operator">/</span>dev/sdc
<span class="token namespace">[ceph_deploy.conf]</span><span class="token namespace">[DEBUG ]</span> found configuration file at: <span class="token operator">/</span>home/cephadm/<span class="token punctuation">.</span>cephdeploy<span class="token punctuation">.</span>conf
<span class="token namespace">[ceph_deploy.cli]</span><span class="token namespace">[INFO  ]</span> Invoked <span class="token punctuation">(</span>2<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1<span class="token punctuation">)</span>: <span class="token operator">/</span>bin/ceph-deploy <span class="token operator">--</span>overwrite-conf osd create stor01 <span class="token operator">--</span><span class="token keyword">data</span> <span class="token operator">/</span>dev/sdc
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token namespace">[stor01]</span><span class="token namespace">[WARNIN]</span> <span class="token operator">--</span>&gt; ceph-volume lvm activate successful <span class="token keyword">for</span> osd ID: 1
<span class="token namespace">[stor01]</span><span class="token namespace">[WARNIN]</span> <span class="token operator">--</span>&gt; ceph-volume lvm create successful <span class="token keyword">for</span>: <span class="token operator">/</span>dev/sdc
<span class="token namespace">[stor01]</span><span class="token namespace">[INFO  ]</span> checking OSD status<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token namespace">[stor01]</span><span class="token namespace">[DEBUG ]</span> find the location of an executable
<span class="token namespace">[stor01]</span><span class="token namespace">[INFO  ]</span> Running command: sudo <span class="token operator">/</span>bin/ceph <span class="token operator">--</span>cluster=ceph osd stat <span class="token operator">--</span>format=json
<span class="token namespace">[ceph_deploy.osd]</span><span class="token namespace">[DEBUG ]</span> Host stor01 is now ready <span class="token keyword">for</span> osd use<span class="token punctuation">.</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看命令执行后的ceph的集群状态
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph <span class="token operator">-</span>s
  cluster:
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  services:
    mon: 3 daemons<span class="token punctuation">,</span> quorum mon01<span class="token punctuation">,</span>mon02<span class="token punctuation">,</span>mon03 <span class="token punctuation">(</span>age 59m<span class="token punctuation">)</span>
    mgr: mon01<span class="token punctuation">(</span>active<span class="token punctuation">,</span> since 27m<span class="token punctuation">)</span>
    osd: 2 osds: 2 up <span class="token punctuation">(</span>since 98s<span class="token punctuation">)</span><span class="token punctuation">,</span> 2 in <span class="token punctuation">(</span>since 98s<span class="token punctuation">)</span>

  <span class="token keyword">data</span>:
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
结果显示：
	在services部分，的osd多了信息，有两个osd是up的状态<span class="token punctuation">,</span>而且都加入到了集群中。
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>接下来，我们通过批量操作的方式，将其他节点主机的磁盘都格式化
<span class="token keyword">for</span> i in 2 3
<span class="token keyword">do</span>
  ceph-deploy <span class="token operator">--</span>overwrite-conf osd create stor0<span class="token variable">$i</span> <span class="token operator">--</span><span class="token keyword">data</span> <span class="token operator">/</span>dev/sdb
  ceph-deploy <span class="token operator">--</span>overwrite-conf osd create stor0<span class="token variable">$i</span> <span class="token operator">--</span><span class="token keyword">data</span> <span class="token operator">/</span>dev/sdc
done

执行后的效果如下：
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>再次查看集群状态
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph <span class="token operator">-</span>s
  cluster:
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  services:
    mon: 3 daemons<span class="token punctuation">,</span> quorum mon01<span class="token punctuation">,</span>mon02<span class="token punctuation">,</span>mon03 <span class="token punctuation">(</span>age 66m<span class="token punctuation">)</span>
    mgr: mon01<span class="token punctuation">(</span>active<span class="token punctuation">,</span> since 34m<span class="token punctuation">)</span>
    osd: 6 osds: 6 up <span class="token punctuation">(</span>since 5s<span class="token punctuation">)</span><span class="token punctuation">,</span> 6 in <span class="token punctuation">(</span>since 5s<span class="token punctuation">)</span>

  <span class="token keyword">data</span>:
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
结果显示：
	osd的磁盘数量达到了 6个，都是处于up的状态。
	对于ceph集群的数据容量来说，一共有120G的磁盘空间可以使用
</code></pre></div><p>查看节点磁盘状态</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code><span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph-deploy osd list stor01
<span class="token namespace">[ceph_deploy.conf]</span><span class="token namespace">[DEBUG ]</span> found configuration file at: <span class="token operator">/</span>home/cephadm/<span class="token punctuation">.</span>cephdeploy<span class="token punctuation">.</span>conf
<span class="token namespace">[ceph_deploy.cli]</span><span class="token namespace">[INFO  ]</span> Invoked <span class="token punctuation">(</span>2<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1<span class="token punctuation">)</span>: <span class="token operator">/</span>bin/ceph-deploy osd list stor01
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token namespace">[stor01]</span><span class="token namespace">[DEBUG ]</span> connection detected need <span class="token keyword">for</span> sudo
<span class="token namespace">[stor01]</span><span class="token namespace">[DEBUG ]</span> connected to host: stor01
<span class="token namespace">[stor01]</span><span class="token namespace">[DEBUG ]</span> detect platform information <span class="token keyword">from</span> remote host
<span class="token namespace">[stor01]</span><span class="token namespace">[DEBUG ]</span> detect machine <span class="token function">type</span>
<span class="token namespace">[stor01]</span><span class="token namespace">[DEBUG ]</span> find the location of an executable
<span class="token namespace">[ceph_deploy.osd]</span><span class="token namespace">[INFO  ]</span> Distro info: CentOS Linux 7<span class="token punctuation">.</span>9<span class="token punctuation">.</span>2009 Core
<span class="token namespace">[ceph_deploy.osd]</span><span class="token namespace">[DEBUG ]</span> Listing disks on stor01<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token namespace">[stor01]</span><span class="token namespace">[DEBUG ]</span> find the location of an executable
<span class="token namespace">[stor01]</span><span class="token namespace">[INFO  ]</span> Running command: sudo <span class="token operator">/</span>usr/sbin/ceph-volume lvm list
<span class="token namespace">[stor01]</span><span class="token namespace">[DEBUG ]</span>
<span class="token namespace">[stor01]</span><span class="token namespace">[DEBUG ]</span>
<span class="token namespace">[stor01]</span><span class="token namespace">[DEBUG ]</span> ====== osd<span class="token punctuation">.</span>0 =======
<span class="token namespace">[stor01]</span><span class="token namespace">[DEBUG ]</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token namespace">[stor01]</span><span class="token namespace">[DEBUG ]</span>       <span class="token function">type</span>                      block
<span class="token namespace">[stor01]</span><span class="token namespace">[DEBUG ]</span>       vdo                       0
<span class="token namespace">[stor01]</span><span class="token namespace">[DEBUG ]</span>       devices                   <span class="token operator">/</span>dev/sdb
<span class="token namespace">[stor01]</span><span class="token namespace">[DEBUG ]</span>
<span class="token namespace">[stor01]</span><span class="token namespace">[DEBUG ]</span> ====== osd<span class="token punctuation">.</span>1 =======
<span class="token namespace">[stor01]</span><span class="token namespace">[DEBUG ]</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token namespace">[stor01]</span><span class="token namespace">[DEBUG ]</span>       <span class="token function">type</span>                      block
<span class="token namespace">[stor01]</span><span class="token namespace">[DEBUG ]</span>       vdo                       0
<span class="token namespace">[stor01]</span><span class="token namespace">[DEBUG ]</span>       devices                   <span class="token operator">/</span>dev/sdc
</code></pre></div><p>OSD的磁盘状态查看</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>对于osd来说，它还有一个专门用于osd管理的 命令 ceph，相关的帮助信息如下
ceph osd <span class="token operator">--</span>help
帮助解析：
	这里面有几个是与osd信息查看相关的
	<span class="token function">ls</span>		       	查看所有OSD的id值
	dump	     	查看 OSD 的概述性信息
	status			查看 OSD 的详细的状态信息
	stat			查看 OSD 的精简的概述性信息
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看所有OSD的id值 
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd <span class="token function">ls</span>
0
1
2
3
4
5

查看 OSD 的概述性信息
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd dump
epoch 25
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
max_osd 6
osd<span class="token punctuation">.</span>0 up   in  weight 1 up_from 5 up_thru 0 down_at 0 last_clean_interval <span class="token punctuation">[</span>0<span class="token punctuation">,</span>0<span class="token punctuation">)</span> <span class="token namespace">[v2:10.0.0.13:6802/5544,v1:10.0.0.13:6803/5544]</span> <span class="token namespace">[v2:192.168.8.13:6800/5544,v1:192.168.8.13:6801/5544]</span> exists<span class="token punctuation">,</span>up 78bd7a7e-9dcf-4d91-be20-d5de2fbec7dd
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

查看 OSD 的精简的概述性信息
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd stat
6 osds: 6 up <span class="token punctuation">(</span>since 4m<span class="token punctuation">)</span><span class="token punctuation">,</span> 6 in <span class="token punctuation">(</span>since 4m<span class="token punctuation">)</span><span class="token punctuation">;</span> epoch: e25


</code></pre></div><p><strong>小结</strong></p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div><h3 id="_1-2-6-osd操作"><a href="#_1-2-6-osd操作" class="header-anchor">#</a> 1.2.6 OSD操作</h3> <p>学习目标</p> <p>这一节，我们从 基本实践、进阶实践、小结、三个方面来学习。</p> <p><strong>基本实践</strong></p> <p>简介</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	OSD全称Object Storage Device，负责响应客户端请求返回具体数据的进程。一个Ceph集群中，有专门的osd角色主机，在这个主机中一般有很多个OSD设备。
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>对于osd来说，它还有一个专门用于osd管理的 命令 ceph，相关的帮助信息如下
	ceph osd <span class="token operator">--</span>help
帮助解析：
	这里面有几个是与osd信息查看相关的
	<span class="token function">ls</span>		       	查看所有OSD的id值
	dump	     	查看 OSD 的概述性信息
	status			查看 OSD 的详细的状态信息
	stat			查看 OSD 的精简的概述性信息
	tree 			查看 OSD 在主机上的分布信息
	perf			查看 OSD 磁盘的延迟统计信息
	df				查看 OSD 磁盘的使用率信息
</code></pre></div><p>命令查看</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>查看所有OSD的id值 
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd <span class="token function">ls</span>
0
1
2
3
4
5
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看 OSD 的数据映射信息
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd dump
epoch 25
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
max_osd 6
osd<span class="token punctuation">.</span>0 up   in  weight 1 up_from 5 up_thru 0 down_at 0 last_clean_interval <span class="token punctuation">[</span>0<span class="token punctuation">,</span>0<span class="token punctuation">)</span> <span class="token namespace">[v2:10.0.0.13:6802/5544,v1:10.0.0.13:6803/5544]</span> <span class="token namespace">[v2:192.168.8.13:6800/5544,v1:192.168.8.13:6801/5544]</span> exists<span class="token punctuation">,</span>up 78bd7a7e-9dcf-4d91-be20-d5de2fbec7dd
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

查看指定OSD节点的信息
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd dump 3
epoch 3
fsid 1d4e5773-619a-479d-861a-66ba451ce945
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
osd<span class="token punctuation">.</span>0 down out weight 0 up_from 0 up_thru 0 down_at 0 last_clean_interval <span class="token punctuation">[</span>0<span class="token punctuation">,</span>0<span class="token punctuation">)</span>   exists<span class="token punctuation">,</span>new 78bd7a7e-9dcf-4d91-be20-d5de2fbec7dd
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看 OSD 的精简的概述性信息
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd stat
6 osds: 6 up <span class="token punctuation">(</span>since 4m<span class="token punctuation">)</span><span class="token punctuation">,</span> 6 in <span class="token punctuation">(</span>since 4m<span class="token punctuation">)</span><span class="token punctuation">;</span> epoch: e25
状态解析：
	OSD节点数量<span class="token punctuation">(</span>osds<span class="token punctuation">)</span>
	集群内<span class="token punctuation">(</span>in<span class="token punctuation">)</span>、集群外<span class="token punctuation">(</span>out<span class="token punctuation">)</span>
	运行<span class="token punctuation">(</span>up<span class="token punctuation">)</span>、不再运行<span class="token punctuation">(</span>down<span class="token punctuation">)</span>
	OSD 的每一次状态变更的历史信息<span class="token punctuation">(</span>epoch<span class="token punctuation">)</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看 OSD 的详细的状态信息
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd status
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token punctuation">|</span> id <span class="token punctuation">|</span>  host <span class="token punctuation">|</span>  used <span class="token punctuation">|</span> avail <span class="token punctuation">|</span> wr ops <span class="token punctuation">|</span> wr <span class="token keyword">data</span> <span class="token punctuation">|</span> <span class="token function">rd</span> ops <span class="token punctuation">|</span> <span class="token function">rd</span> <span class="token keyword">data</span> <span class="token punctuation">|</span>   state   <span class="token punctuation">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token punctuation">|</span> 0  <span class="token punctuation">|</span> mon01 <span class="token punctuation">|</span> 1027M <span class="token punctuation">|</span> 18<span class="token punctuation">.</span>9G <span class="token punctuation">|</span>    0   <span class="token punctuation">|</span>     0   <span class="token punctuation">|</span>    0   <span class="token punctuation">|</span>     0   <span class="token punctuation">|</span> exists<span class="token punctuation">,</span>up <span class="token punctuation">|</span>
<span class="token punctuation">|</span> 1  <span class="token punctuation">|</span> mon01 <span class="token punctuation">|</span> 1027M <span class="token punctuation">|</span> 18<span class="token punctuation">.</span>9G <span class="token punctuation">|</span>    0   <span class="token punctuation">|</span>     0   <span class="token punctuation">|</span>    0   <span class="token punctuation">|</span>     0   <span class="token punctuation">|</span> exists<span class="token punctuation">,</span>up <span class="token punctuation">|</span>
<span class="token punctuation">|</span> 2  <span class="token punctuation">|</span> mon02 <span class="token punctuation">|</span> 1027M <span class="token punctuation">|</span> 18<span class="token punctuation">.</span>9G <span class="token punctuation">|</span>    0   <span class="token punctuation">|</span>     0   <span class="token punctuation">|</span>    0   <span class="token punctuation">|</span>     0   <span class="token punctuation">|</span> exists<span class="token punctuation">,</span>up <span class="token punctuation">|</span>
<span class="token punctuation">|</span> 3  <span class="token punctuation">|</span> mon02 <span class="token punctuation">|</span> 1027M <span class="token punctuation">|</span> 18<span class="token punctuation">.</span>9G <span class="token punctuation">|</span>    0   <span class="token punctuation">|</span>     0   <span class="token punctuation">|</span>    0   <span class="token punctuation">|</span>     0   <span class="token punctuation">|</span> exists<span class="token punctuation">,</span>up <span class="token punctuation">|</span>
<span class="token punctuation">|</span> 4  <span class="token punctuation">|</span> mon03 <span class="token punctuation">|</span> 1027M <span class="token punctuation">|</span> 18<span class="token punctuation">.</span>9G <span class="token punctuation">|</span>    0   <span class="token punctuation">|</span>     0   <span class="token punctuation">|</span>    0   <span class="token punctuation">|</span>     0   <span class="token punctuation">|</span> exists<span class="token punctuation">,</span>up <span class="token punctuation">|</span>
<span class="token punctuation">|</span> 5  <span class="token punctuation">|</span> mon03 <span class="token punctuation">|</span> 1027M <span class="token punctuation">|</span> 18<span class="token punctuation">.</span>9G <span class="token punctuation">|</span>    0   <span class="token punctuation">|</span>     0   <span class="token punctuation">|</span>    0   <span class="token punctuation">|</span>     0   <span class="token punctuation">|</span> exists<span class="token punctuation">,</span>up <span class="token punctuation">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看OSD在各个主机上的分布情况
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd tree
ID <span class="token keyword">CLASS</span> WEIGHT  <span class="token function">TYPE</span> NAME      STATUS REWEIGHT PRI-AFF
<span class="token operator">-</span>1       0<span class="token punctuation">.</span>11691 root default
<span class="token operator">-</span>3       0<span class="token punctuation">.</span>03897     host mon01
 0   hdd 0<span class="token punctuation">.</span>01949         osd<span class="token punctuation">.</span>0      up  1<span class="token punctuation">.</span>00000 1<span class="token punctuation">.</span>00000
 1   hdd 0<span class="token punctuation">.</span>01949         osd<span class="token punctuation">.</span>1      up  1<span class="token punctuation">.</span>00000 1<span class="token punctuation">.</span>00000
<span class="token operator">-</span>5       0<span class="token punctuation">.</span>03897     host mon02
 2   hdd 0<span class="token punctuation">.</span>01949         osd<span class="token punctuation">.</span>2      up  1<span class="token punctuation">.</span>00000 1<span class="token punctuation">.</span>00000
 3   hdd 0<span class="token punctuation">.</span>01949         osd<span class="token punctuation">.</span>3      up  1<span class="token punctuation">.</span>00000 1<span class="token punctuation">.</span>00000
<span class="token operator">-</span>7       0<span class="token punctuation">.</span>03897     host mon03
 4   hdd 0<span class="token punctuation">.</span>01949         osd<span class="token punctuation">.</span>4      up  1<span class="token punctuation">.</span>00000 1<span class="token punctuation">.</span>00000
 5   hdd 0<span class="token punctuation">.</span>01949         osd<span class="token punctuation">.</span>5      up  1<span class="token punctuation">.</span>00000 1<span class="token punctuation">.</span>00000
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看OSD磁盘的延迟统计信息
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd perf
osd commit_latency<span class="token punctuation">(</span>ms<span class="token punctuation">)</span> apply_latency<span class="token punctuation">(</span>ms<span class="token punctuation">)</span>
  5                  0                 0
  4                  0                 0
  0                  0                 0
  1                  0                 0
  2                  0                 0
  3                  0                 0
结果显示：
	主要解决单块磁盘问题，如果有问题及时剔除OSD。统计的是平均值
	commit_latency 表示从接收请求到设置commit状态的时间间隔
	apply_latency 表示从接收请求到设置apply状态的时间间隔
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看OSD磁盘的使用率信息
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd df
ID <span class="token keyword">CLASS</span> WEIGHT  REWEIGHT SIZE    RAW USE <span class="token keyword">DATA</span>    OMAP META  AVAIL   <span class="token operator">%</span>USE <span class="token keyword">VAR</span>  PGS STATUS
 0   hdd 0<span class="token punctuation">.</span>01949  1<span class="token punctuation">.</span>00000  20 GiB 1<span class="token punctuation">.</span>0 GiB 3<span class="token punctuation">.</span>2 MiB  0 B 1 GiB  19 GiB 5<span class="token punctuation">.</span>02 1<span class="token punctuation">.</span>00   0     up
 1   hdd 0<span class="token punctuation">.</span>01949  1<span class="token punctuation">.</span>00000  20 GiB 1<span class="token punctuation">.</span>0 GiB 3<span class="token punctuation">.</span>2 MiB  0 B 1 GiB  19 GiB 5<span class="token punctuation">.</span>02 1<span class="token punctuation">.</span>00   0     up
 2   hdd 0<span class="token punctuation">.</span>01949  1<span class="token punctuation">.</span>00000  20 GiB 1<span class="token punctuation">.</span>0 GiB 3<span class="token punctuation">.</span>2 MiB  0 B 1 GiB  19 GiB 5<span class="token punctuation">.</span>02 1<span class="token punctuation">.</span>00   0     up
 3   hdd 0<span class="token punctuation">.</span>01949  1<span class="token punctuation">.</span>00000  20 GiB 1<span class="token punctuation">.</span>0 GiB 3<span class="token punctuation">.</span>2 MiB  0 B 1 GiB  19 GiB 5<span class="token punctuation">.</span>02 1<span class="token punctuation">.</span>00   0     up
 4   hdd 0<span class="token punctuation">.</span>01949  1<span class="token punctuation">.</span>00000  20 GiB 1<span class="token punctuation">.</span>0 GiB 3<span class="token punctuation">.</span>2 MiB  0 B 1 GiB  19 GiB 5<span class="token punctuation">.</span>02 1<span class="token punctuation">.</span>00   0     up
 5   hdd 0<span class="token punctuation">.</span>01949  1<span class="token punctuation">.</span>00000  20 GiB 1<span class="token punctuation">.</span>0 GiB 3<span class="token punctuation">.</span>2 MiB  0 B 1 GiB  19 GiB 5<span class="token punctuation">.</span>02 1<span class="token punctuation">.</span>00   0     up
                    TOTAL 120 GiB 6<span class="token punctuation">.</span>0 GiB  20 MiB  0 B 6 GiB 114 GiB 5<span class="token punctuation">.</span>02
MIN/MAX <span class="token keyword">VAR</span>: 1<span class="token punctuation">.</span>00/1<span class="token punctuation">.</span>00  STDDEV: 0
</code></pre></div><p><strong>进阶实践</strong></p> <p>osd 暂停开启</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>命令格式：
	ceph osd pause		集群暂停接收数据
	ceph osd unpause	集群开始接收数据
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code><span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd pause
pauserd<span class="token punctuation">,</span>pausewr is <span class="token function">set</span>
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph <span class="token operator">-</span>s
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  services:
    mon: 3 daemons<span class="token punctuation">,</span> quorum mon01<span class="token punctuation">,</span>mon02<span class="token punctuation">,</span>mon03 <span class="token punctuation">(</span>age 2h<span class="token punctuation">)</span>
    mgr: mon01<span class="token punctuation">(</span>active<span class="token punctuation">,</span> since 2h<span class="token punctuation">)</span>
    osd: 6 osds: 6 up <span class="token punctuation">(</span>since 107m<span class="token punctuation">)</span><span class="token punctuation">,</span> 6 in <span class="token punctuation">(</span>since 107m<span class="token punctuation">)</span>
         flags pauserd<span class="token punctuation">,</span>pausewr			<span class="token comment"># 可以看到，多了pause的标签</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd unpause
pauserd<span class="token punctuation">,</span>pausewr is unset
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph <span class="token operator">-</span>s
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  services:
    mon: 3 daemons<span class="token punctuation">,</span> quorum mon01<span class="token punctuation">,</span>mon02<span class="token punctuation">,</span>mon03 <span class="token punctuation">(</span>age 2h<span class="token punctuation">)</span>
    mgr: mon01<span class="token punctuation">(</span>active<span class="token punctuation">,</span> since 2h<span class="token punctuation">)</span>
    osd: 6 osds: 6 up <span class="token punctuation">(</span>since 107m<span class="token punctuation">)</span><span class="token punctuation">,</span> 6 in <span class="token punctuation">(</span>since 107m<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>									<span class="token comment"># 可以看到，pause的标签已经被移除</span>
</code></pre></div><p>osd数据操作比重</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>命令格式：
	osd节点上线：ceph osd crush reweight osd<span class="token punctuation">.</span>编号 权重值
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看默认的OSD操作权重值
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd crush tree
ID <span class="token keyword">CLASS</span> WEIGHT  <span class="token function">TYPE</span> NAME
<span class="token operator">-</span>1       0<span class="token punctuation">.</span>11691 root default
<span class="token operator">-</span>3       0<span class="token punctuation">.</span>03897     host mon01
 0   hdd 0<span class="token punctuation">.</span>01949         osd<span class="token punctuation">.</span>0
 1   hdd 0<span class="token punctuation">.</span>01949         osd<span class="token punctuation">.</span>1
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

修改osd的数据操作权重值
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd crush reweight osd<span class="token punctuation">.</span>0 0<span class="token punctuation">.</span>1
reweighted item id 0 name <span class="token string">'osd.0'</span> to 0<span class="token punctuation">.</span>1 in crush map
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd crush tree
ID <span class="token keyword">CLASS</span> WEIGHT  <span class="token function">TYPE</span> NAME
<span class="token operator">-</span>1       0<span class="token punctuation">.</span>19742 root default
<span class="token operator">-</span>3       0<span class="token punctuation">.</span>11948     host mon01
 0   hdd 0<span class="token punctuation">.</span>09999         osd<span class="token punctuation">.</span>0
 1   hdd 0<span class="token punctuation">.</span>01949         osd<span class="token punctuation">.</span>1
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

恢复osd的数据操作权重值 
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd crush reweight osd<span class="token punctuation">.</span>0 0<span class="token punctuation">.</span>01949
reweighted item id 0 name <span class="token string">'osd.0'</span> to 0<span class="token punctuation">.</span>01949 in crush map
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd crush tree
ID <span class="token keyword">CLASS</span> WEIGHT  <span class="token function">TYPE</span> NAME
<span class="token operator">-</span>1       0<span class="token punctuation">.</span>11691 root default
<span class="token operator">-</span>3       0<span class="token punctuation">.</span>03897     host mon01
 0   hdd 0<span class="token punctuation">.</span>01949         osd<span class="token punctuation">.</span>0
 1   hdd 0<span class="token punctuation">.</span>01949         osd<span class="token punctuation">.</span>1

</code></pre></div><p>osd上下线</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>命令格式：
	osd节点上线：ceph osd down osd编号
	osd节点下线：ceph osd up osd编号
注意：
	由于OSD有专门的管理服务器控制，一旦发现被下线，会尝试启动它
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>将磁盘快速下线，然后查看状态
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd down 0 <span class="token punctuation">;</span> ceph osd tree
marked down osd<span class="token punctuation">.</span>0<span class="token punctuation">.</span>
ID <span class="token keyword">CLASS</span> WEIGHT  <span class="token function">TYPE</span> NAME      STATUS REWEIGHT PRI-AFF
<span class="token operator">-</span>1       0<span class="token punctuation">.</span>11691 root default
<span class="token operator">-</span>3       0<span class="token punctuation">.</span>03897     host mon01
 0   hdd 0<span class="token punctuation">.</span>01949         osd<span class="token punctuation">.</span>0    down  1<span class="token punctuation">.</span>00000 1<span class="token punctuation">.</span>00000
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

等待一秒钟后查看状态，指定的节点又上线了
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd tree
ID <span class="token keyword">CLASS</span> WEIGHT  <span class="token function">TYPE</span> NAME      STATUS REWEIGHT PRI-AFF
<span class="token operator">-</span>1       0<span class="token punctuation">.</span>11691 root default
<span class="token operator">-</span>3       0<span class="token punctuation">.</span>03897     host mon01
 0   hdd 0<span class="token punctuation">.</span>01949         osd<span class="token punctuation">.</span>0      up  1<span class="token punctuation">.</span>00000 1<span class="token punctuation">.</span>00000
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p>驱逐加入OSD对象</p> <div class="language- extra-class"><pre class="language-text"><code>命令格式：
	ceph osd out osd编号
	ceph osd in osd编号
注意：
	所谓的从OSD集群中驱离或者加入OSD对象，本质上Ceph集群数据操作的权重值调整
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>将0号OSD下线
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd out 0
marked out osd<span class="token punctuation">.</span>0<span class="token punctuation">.</span>
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd tree
ID <span class="token keyword">CLASS</span> WEIGHT  <span class="token function">TYPE</span> NAME      STATUS REWEIGHT PRI-AFF
<span class="token operator">-</span>1       0<span class="token punctuation">.</span>11691 root default
<span class="token operator">-</span>3       0<span class="token punctuation">.</span>03897     host mon01
 0   hdd 0<span class="token punctuation">.</span>01949         osd<span class="token punctuation">.</span>0      up        0 1<span class="token punctuation">.</span>00000
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 

将0号OSD上线
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd in 0<span class="token punctuation">;</span>
marked in osd<span class="token punctuation">.</span>0<span class="token punctuation">.</span>
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd tree
ID <span class="token keyword">CLASS</span> WEIGHT  <span class="token function">TYPE</span> NAME      STATUS REWEIGHT PRI-AFF
<span class="token operator">-</span>1       0<span class="token punctuation">.</span>11691 root default
<span class="token operator">-</span>3       0<span class="token punctuation">.</span>03897     host mon01
 0   hdd 0<span class="token punctuation">.</span>01949         osd<span class="token punctuation">.</span>0      up  1<span class="token punctuation">.</span>00000 1<span class="token punctuation">.</span>00000
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
结果显示：
	OSD在上下线实践的时候，所谓的REWEIGHT会进行调整，1代表上线，空代表下线
</code></pre></div><p><strong>小结</strong></p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>
</code></pre></div><h3 id="_1-2-7-osd节点"><a href="#_1-2-7-osd节点" class="header-anchor">#</a> 1.2.7 OSD节点</h3> <p>学习目标</p> <p>这一节，我们从 OSD删除、OSD添加、小结 三个方面来学习</p> <p><strong>OSD删除</strong></p> <p>基本步骤</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>将OSD删除需要遵循一定的步骤：
	1 修改osd的数据操作权重值，让数据不分布在这个节点上
	2 到指定节点上，停止指定的osd进程
	3 将移除OSD节点状态标记为out
	4 从crush中移除OSD节点，该节点不作为数据的载体
	5 删除OSD节点
	6 删除OSD节点的认证信息
</code></pre></div><p>删除OSD节点实践</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>修改osd的数据操作权重值
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd crush reweight osd<span class="token punctuation">.</span>5 0
reweighted item id 5 name <span class="token string">'osd.5'</span> to 0 in crush map
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd crush tree
ID <span class="token keyword">CLASS</span> WEIGHT  <span class="token function">TYPE</span> NAME
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">-</span>7       0<span class="token punctuation">.</span>01949     host mon03
 4   hdd 0<span class="token punctuation">.</span>01949         osd<span class="token punctuation">.</span>4
 5   hdd       0         osd<span class="token punctuation">.</span>5
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>到指定节点上，停止指定的osd进程
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ssh mon03 sudo systemctl disable ceph-osd@5
Removed symlink <span class="token operator">/</span>etc/systemd/system/ceph-osd<span class="token punctuation">.</span>target<span class="token punctuation">.</span>wants/ceph-osd@5<span class="token punctuation">.</span>service<span class="token punctuation">.</span>
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ssh mon03 sudo systemctl stop ceph-osd@5
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ssh mon03 sudo systemctl status ceph-osd@5
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
9月 25 15:25:32 mon03 systemd<span class="token punctuation">[</span>1<span class="token punctuation">]</span>: Stopped Ceph object storage daemon osd<span class="token punctuation">.</span>5<span class="token punctuation">.</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>将移除OSD节点状态标记为out
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd out osd<span class="token punctuation">.</span>5
marked out osd<span class="token punctuation">.</span>5<span class="token punctuation">.</span>
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd tree
ID <span class="token keyword">CLASS</span> WEIGHT  <span class="token function">TYPE</span> NAME      STATUS REWEIGHT PRI-AFF
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">-</span>7       0<span class="token punctuation">.</span>01949     host mon03
 4   hdd 0<span class="token punctuation">.</span>01949         osd<span class="token punctuation">.</span>4      up  1<span class="token punctuation">.</span>00000 1<span class="token punctuation">.</span>00000
 5   hdd       0         osd<span class="token punctuation">.</span>5    down        0 1<span class="token punctuation">.</span>00000
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>从crush中移除OSD节点，该节点不作为数据的载体
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd crush remove osd<span class="token punctuation">.</span>5
removed item id 5 name <span class="token string">'osd.5'</span> <span class="token keyword">from</span> crush map

查看效果
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd crush tree
ID <span class="token keyword">CLASS</span> WEIGHT  <span class="token function">TYPE</span> NAME
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">-</span>7       0<span class="token punctuation">.</span>01949     host mon03
 4   hdd 0<span class="token punctuation">.</span>01949         osd<span class="token punctuation">.</span>4
结果显示：
	osd<span class="token punctuation">.</span>5 已经被移除了
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>删除OSD节点前查看效果
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd tree
ID <span class="token keyword">CLASS</span> WEIGHT  <span class="token function">TYPE</span> NAME      STATUS REWEIGHT PRI-AFF
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">-</span>7       0<span class="token punctuation">.</span>01949     host mon03
 4   hdd 0<span class="token punctuation">.</span>01949         osd<span class="token punctuation">.</span>4      up  1<span class="token punctuation">.</span>00000 1<span class="token punctuation">.</span>00000
 5             0 osd<span class="token punctuation">.</span>5            down        0 1<span class="token punctuation">.</span>00000
 
移除无效的osd节点
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd <span class="token function">rm</span> osd<span class="token punctuation">.</span>5
removed osd<span class="token punctuation">.</span>5

再次确认效果
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd tree
ID <span class="token keyword">CLASS</span> WEIGHT  <span class="token function">TYPE</span> NAME      STATUS REWEIGHT PRI-AFF
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">-</span>7       0<span class="token punctuation">.</span>01949     host mon03
 4   hdd 0<span class="token punctuation">.</span>01949         osd<span class="token punctuation">.</span>4      up  1<span class="token punctuation">.</span>00000 1<span class="token punctuation">.</span>00000
结果显示：
	osd节点已经被移除了
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看历史认证信息
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph auth <span class="token function">ls</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
osd<span class="token punctuation">.</span>5
        key: AQCy4C9jI1wzDhAAaPjSPSQpMdu8NUPIRecctQ==
        caps: <span class="token namespace">[mgr]</span> allow profile osd
        caps: <span class="token namespace">[mon]</span> allow profile osd
        caps: <span class="token namespace">[osd]</span> allow <span class="token operator">*</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

删除OSD节点的认证信息
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph auth <span class="token function">del</span> osd<span class="token punctuation">.</span>5
updated
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph auth <span class="token function">ls</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
结果显示：
	已经没有历史的节点信息了
</code></pre></div><p><strong>OSD添加</strong></p> <p>基本步骤</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>将OSD增加到集群需要遵循一定的步骤：
	1 确定OSD节点没有被占用
	2 磁盘格式化
	3 ceph擦除磁盘上的数据
	4 添加OSD到集群
</code></pre></div><p>添加OSD节点实践简介</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>确定OSD节点没有被占用
<span class="token namespace">[root@mon03 ~]</span><span class="token comment"># blkid | egrep 'sd[bc]'</span>
<span class="token operator">/</span>dev/sdb: UUID=<span class="token string">&quot;h3NNr5-Sgr8-nJ8k-QWbY-UiRu-Pbmu-nxs3pZ&quot;</span> <span class="token function">TYPE</span>=<span class="token string">&quot;LVM2_member&quot;</span>
<span class="token operator">/</span>dev/sdc: UUID=<span class="token string">&quot;VdOW5k-zxMN-4Se5-Bxlc-8h93-uhPA-R30P3u&quot;</span> <span class="token function">TYPE</span>=<span class="token string">&quot;LVM2_member&quot;</span>

格式化磁盘失败
<span class="token namespace">[root@mon03 ~]</span><span class="token comment"># mkfs.ext4 /dev/sdc</span>
mke2fs 1<span class="token punctuation">.</span>42<span class="token punctuation">.</span>9 <span class="token punctuation">(</span>28-Dec-2013<span class="token punctuation">)</span>
<span class="token operator">/</span>dev/sdc is entire device<span class="token punctuation">,</span> not just one partition!
无论如何也要继续? <span class="token punctuation">(</span>y<span class="token punctuation">,</span>n<span class="token punctuation">)</span> y
<span class="token operator">/</span>dev/sdc is apparently in use by the system<span class="token punctuation">;</span> will not make a 文件系统 here!
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看被占用的磁盘
<span class="token namespace">[root@mon03 ~]</span><span class="token comment"># dmsetup status</span>
ceph-<span class="token operator">-</span>9dd352be-<span class="token operator">-</span>1b6e-<span class="token operator">-</span>4d60-<span class="token operator">-</span>957e-<span class="token operator">-</span>81c59eafa7b3-osd-<span class="token operator">-</span>block-<span class="token operator">-</span>49251ee9-<span class="token operator">-</span>b1cc-<span class="token operator">-</span>432f-<span class="token operator">-</span>aed7-<span class="token operator">-</span>3af897911b60: 0 41934848 linear
ceph-<span class="token operator">-</span>3712fe04-<span class="token operator">-</span>cc04-<span class="token operator">-</span>4ce4-<span class="token operator">-</span>a75e-<span class="token operator">-</span>f7f746d62d6f-osd-<span class="token operator">-</span>block-<span class="token operator">-</span>99787a7e-<span class="token operator">-</span>40ee-<span class="token operator">-</span>48ae-<span class="token operator">-</span>802a-<span class="token operator">-</span>491c4f326d0c: 0 41934848 linear

1 确定OSD节点没有被占用，注意ceph的osd挂载目录
<span class="token namespace">[root@mon03 ~]</span><span class="token comment"># cat /var/lib/ceph/osd/ceph-4/fsid</span>
49251ee9-b1cc-432f-aed7-3af897911b60

移除被占用磁盘
<span class="token namespace">[root@mon03 ~]</span><span class="token comment"># dmsetup remove ceph--3712fe04--cc04--4ce4--a75e--f7f746d62d6f-osd--block--99787a7e--40ee--48ae--802a--491c4f326d0c</span>
<span class="token namespace">[root@mon03 ~]</span><span class="token comment"># dmsetup status | grep 99787a7e</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>2 磁盘格式化
<span class="token namespace">[root@mon03 ~]</span><span class="token comment"># mkfs.ext4 /dev/sdc</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>3 ceph擦除磁盘上的数据
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph-deploy disk zap stor03 <span class="token operator">/</span>dev/sdc
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>4 添加OSD到集群
ceph-deploy <span class="token operator">--</span>overwrite-conf osd create stor03 <span class="token operator">--</span><span class="token keyword">data</span> <span class="token operator">/</span>dev/sdc
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>确认效果
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd tree
ID <span class="token keyword">CLASS</span> WEIGHT  <span class="token function">TYPE</span> NAME      STATUS REWEIGHT PRI-AFF
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">-</span>7       0<span class="token punctuation">.</span>03897     host mon03
 4   hdd 0<span class="token punctuation">.</span>01949         osd<span class="token punctuation">.</span>4      up  1<span class="token punctuation">.</span>00000 1<span class="token punctuation">.</span>00000
 5   hdd 0<span class="token punctuation">.</span>01949         osd<span class="token punctuation">.</span>5      up  1<span class="token punctuation">.</span>00000 1<span class="token punctuation">.</span>00000
结果显示：
	之前被移除的osd节点已经被找回来了
</code></pre></div><p><strong>小结</strong></p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div><h3 id="_1-2-8-存储实践"><a href="#_1-2-8-存储实践" class="header-anchor">#</a> 1.2.8 存储实践</h3> <p>学习目标</p> <p>这一节，我们从 基本环境、OSD实践、小结、三个方面来学习。</p> <p><strong>基本环境</strong></p> <p>存储术语</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>Pool
	RADOS存储集群提供的基础存储服务需要由“存储池（pool）”分割为逻辑存储 区域，此类的逻辑区域亦是对象数据的名称空间。

PG
	归置组（Placement <span class="token function">Group</span>）是用于跨OSD将数据存储在某个存储池中的内部数据 结构
	相对于存储池来说，PG是一个虚拟组件，它是对象映射到存储池时使用的虚拟层
	是实现大容量集群的关键效率技术
	
PGP	
	 <span class="token punctuation">(</span>Placement <span class="token function">Group</span> <span class="token keyword">for</span> Placement<span class="token punctuation">)</span>是用于维持PG和OSD的一种策略。
	 防止OSD重新分配时候，PG找不到之前的OSD，从而引起大范围的数据迁移
	 
CRUSH
	把对象直接映射到OSD之上会导致二者之间的紧密耦合关系，在OSD设备变动时不可避免地对整个集群产生扰动。所以需要一种策略算法来处理这种问题。
	Ceph将一个对象映射进RADOS集群的过程分为两步
    	<span class="token operator">-</span> 首先是以一致性哈希算法将对象名称映射到PG 
    	<span class="token operator">-</span> 而后是将PG ID基于CRUSH算法映射到OSD
	CRUSH<span class="token punctuation">(</span>Controlled Replication Under Scalable Hashing<span class="token punctuation">)</span><span class="token punctuation">,</span>它是一种数据分布式算法，类似于一致性哈希算法，用于为RADOS存储集群控制数据分布。
</code></pre></div><p>基本逻辑图</p> <p><img src="image/1636103641572-1664092679864.png" alt="1636103641572"></p> <p>需求</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	OSD平台的目的就是数据的存在，我们这里就先来简单的演示一下，OSD环境的数据操作。这里主要临时演示两个功能:
	数据存储 <span class="token operator">-</span> 客户端连接至RADOS集群上某存储池<span class="token punctuation">,</span>根据相关的CRUSH规则完成数据对象存储<span class="token punctuation">.</span>
	数据删除 <span class="token operator">-</span> 集合配套的命令，实现数据的移除功能。
</code></pre></div><p><strong>OSD实践</strong></p> <p>创建存储池</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>命令格式
	ceph osd pool create &lt;pool-name&gt; &lt;pg-num&gt; <span class="token namespace">[pgp-num]</span> <span class="token namespace">[replicated]</span> \ <span class="token namespace">[crush-rule-name]</span> <span class="token namespace">[expected-num-objects]</span>
	参数解析：
		pool-name：存储池名称，在一个RADOS存储集群上必须具有唯一性；
		pg-num：当前存储池中的PG数量，一定要合理
		pgp-num ：用于归置的PG数量，其值应该等于PG的数量
		replicated：存储池类型；副本存储池需更多原始存储空间，但已实现Ceph支持的所有操 作
		crush-ruleset-name：此存储池所用的CRUSH规则集的名称，引用的规则集必须事先存在
查看命令
	ceph osd pool <span class="token function">ls</span>
	rados lspools
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>创建一个存储池，名称为mypool，pg数量和pgp数量都是16
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd pool create mypool 16 16
pool <span class="token string">'mypool'</span> created

查看存储池的列表
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd pool <span class="token function">ls</span>
mypool
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rados lspools
mypool
</code></pre></div><p>数据的上传</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>命令格式：
	虽然我们目前没有形成专用的数据接口，但是ceph提供了一个原理的文件测试接口 <span class="token operator">--</span> rados命令
	rados put 文件对象名<span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">/</span>path/to/file <span class="token operator">--</span>pool=存储池 
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>提交文件到对应的osd里面
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rados put ceph-file <span class="token operator">/</span>home/cephadm/ceph-cluster/ceph<span class="token punctuation">.</span>conf <span class="token operator">--</span>pool=mypool

确认上传数据效果
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rados <span class="token function">ls</span> <span class="token operator">--</span>pool=mypool
ceph-file
</code></pre></div><p>查看数据的存储关系</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>命令格式：
	通过属性的方式获取到存储池中数据对象的具体位置信息
	ceph osd map 存储池 文件对象名<span class="token punctuation">(</span>id<span class="token punctuation">)</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看ceph-file文件对象的内部属性关系
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd map mypool ceph-file
osdmap e51 pool <span class="token string">'mypool'</span> <span class="token punctuation">(</span>1<span class="token punctuation">)</span> object <span class="token string">'ceph-file'</span> <span class="token operator">-</span>&gt; pg 1<span class="token punctuation">.</span>7753490d <span class="token punctuation">(</span>1<span class="token punctuation">.</span>d<span class="token punctuation">)</span> <span class="token operator">-</span>&gt; up <span class="token punctuation">(</span><span class="token punctuation">[</span>2<span class="token punctuation">,</span>1<span class="token punctuation">,</span>5<span class="token punctuation">]</span><span class="token punctuation">,</span> p2<span class="token punctuation">)</span> acting <span class="token punctuation">(</span><span class="token punctuation">[</span>2<span class="token punctuation">,</span>1<span class="token punctuation">,</span>5<span class="token punctuation">]</span><span class="token punctuation">,</span> p2<span class="token punctuation">)</span>
结果解析：
	可以看到文件对象的内部属性关系
	<span class="token punctuation">[</span> num <span class="token punctuation">]</span> 是副本所存储的osd id的值
</code></pre></div><p>数据删除实践</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>命令格式：
	将文件对象从pool里面删除
	rados <span class="token function">rm</span> 文件对象名<span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">--</span>pool=存储池
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>将刚才添加的文件对象从存储池里面移除
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rados <span class="token function">rm</span> ceph-file <span class="token operator">--</span>pool=mypool

查看存储池的内容
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ rados <span class="token function">ls</span> <span class="token operator">--</span>pool=mypool
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$
</code></pre></div><p><strong>小结</strong></p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div><h3 id="_1-2-9-存储解析"><a href="#_1-2-9-存储解析" class="header-anchor">#</a> 1.2.9 存储解析</h3> <p>学习目标</p> <p>这一节，我们从 存储解析、存储删除、小结、三个方面来学习。</p> <p><strong>基本环境</strong></p> <p>数据存储逻辑</p> <p><img src="image/1636103641572.png" alt="1636103641572"></p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>pool 是ceph存储数据时的逻辑分区，它起到据不同的用户场景，基于namespace实现隔离故障域的作用。
每个pool包含一定数量的PG<span class="token punctuation">,</span> PG里的对象被映射到不同的OSD上。
OSD分散到所有的主机磁盘上
</code></pre></div><p>存储池基本信息</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>命令格式
	ceph osd pool <span class="token function">ls</span> <span class="token namespace">[detail]</span>
	ceph osd pool stats <span class="token punctuation">{</span>&lt;poolname&gt;<span class="token punctuation">}</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看存储池名称
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd pool <span class="token function">ls</span>
mypool

查看存储池详情
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd pool <span class="token function">ls</span> detail
pool 1 <span class="token string">'mypool'</span> replicated size 3 min_size 2 crush_rule 0 object_hash rjenkins pg_num 16 pgp_num 16 autoscale_mode warn last_change 51 flags hashpspool stripe_width 0

确认存储池状态
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd pool stats mypool
pool mypool id 1
  nothing is going on
结果显示：
	对于mypool来说，它的id是1，该存储池里面的所有pg都是以1为开头的
</code></pre></div><p>存储池&amp;PG</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>通过 pg 查找 pool
	ceph pg dump <span class="token punctuation">|</span> grep <span class="token string">&quot;^{poolid}\.&quot;</span>
 
通过 pool 查找 pg
	ceph pg <span class="token function">ls</span><span class="token operator">-</span>by-pool <span class="token punctuation">{</span>poolname<span class="token punctuation">}</span>
	ceph pg <span class="token function">ls</span> <span class="token punctuation">{</span>poolid<span class="token punctuation">}</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>根据pg查找pools
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph pg dump <span class="token punctuation">|</span> grep <span class="token string">&quot;^1. &quot;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph pg dump pools
POOLID OBJECTS <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
1            0 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

根据存储池找PG
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph pg <span class="token function">ls</span><span class="token operator">-</span>by-pool mypool <span class="token punctuation">|</span> awk <span class="token string">'{print $1,$2,$15}'</span>
PG OBJECTS ACTING
1<span class="token punctuation">.</span>0 0 <span class="token punctuation">[</span>3<span class="token punctuation">,</span>5<span class="token punctuation">,</span>0<span class="token punctuation">]</span>p3
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
1<span class="token punctuation">.</span>e 0 <span class="token punctuation">[</span>2<span class="token punctuation">,</span>1<span class="token punctuation">,</span>5<span class="token punctuation">]</span>p2
1<span class="token punctuation">.</span>f 0 <span class="token punctuation">[</span>3<span class="token punctuation">,</span>1<span class="token punctuation">,</span>4<span class="token punctuation">]</span>p3

看出mypool的pg都是以1开头的<span class="token punctuation">,</span>确定pg的分布情况
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph pg dump pgs<span class="token punctuation">|</span>grep ^1<span class="token punctuation">|</span>awk <span class="token string">'{print $1,$2,$15,$19}'</span>
dumped pgs
1<span class="token punctuation">.</span>f 0 0<span class="token string">'0 [3,1,4]
...
1.9 0 0'</span>0 <span class="token punctuation">[</span>3<span class="token punctuation">,</span>4<span class="token punctuation">,</span>1<span class="token punctuation">]</span>
结果显示：
	每个pg都会分布在三个osd上，整个集群有6个osd
</code></pre></div><p>PG &amp; OSD</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>通过 pg 查找 osd
	ceph pg map <span class="token punctuation">{</span>pgid<span class="token punctuation">}</span>
通过 osd 查找 pg
	ceph pg <span class="token function">ls</span><span class="token operator">-</span>by-osd osd<span class="token punctuation">.</span><span class="token punctuation">{</span>osdid<span class="token punctuation">}</span>
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>根据pg找osd的分布
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph pg map 1<span class="token punctuation">.</span>1
osdmap e51 pg 1<span class="token punctuation">.</span>1 <span class="token punctuation">(</span>1<span class="token punctuation">.</span>1<span class="token punctuation">)</span> <span class="token operator">-</span>&gt; up <span class="token punctuation">[</span>5<span class="token punctuation">,</span>0<span class="token punctuation">,</span>2<span class="token punctuation">]</span> acting <span class="token punctuation">[</span>5<span class="token punctuation">,</span>0<span class="token punctuation">,</span>2<span class="token punctuation">]</span>

根据osd找pg的分布
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph pg <span class="token function">ls</span><span class="token operator">-</span>by-osd osd<span class="token punctuation">.</span>1 <span class="token punctuation">|</span> awk <span class="token string">'{print $1,$2,$10,$14,$15}'</span>
PG OBJECTS STATE UP ACTING
1<span class="token punctuation">.</span>3 0 active+clean <span class="token punctuation">[</span>1<span class="token punctuation">,</span>2<span class="token punctuation">,</span>5<span class="token punctuation">]</span>p1 <span class="token punctuation">[</span>1<span class="token punctuation">,</span>2<span class="token punctuation">,</span>5<span class="token punctuation">]</span>p1
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
1<span class="token punctuation">.</span>f 0 active+clean <span class="token punctuation">[</span>3<span class="token punctuation">,</span>1<span class="token punctuation">,</span>4<span class="token punctuation">]</span>p3 <span class="token punctuation">[</span>3<span class="token punctuation">,</span>1<span class="token punctuation">,</span>4<span class="token punctuation">]</span>p3
<span class="token operator">*</span> NOTE: and soon afterwards
</code></pre></div><p><strong>存储删除</strong></p> <p>存储池删除</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>命令格式：
	删除存储池命令存在数据丢失的风险，Ceph于是默认禁止此类操作。
	管理员需要在ceph<span class="token punctuation">.</span>conf配置文件中启用支持删除动作
	ceph osd pool <span class="token function">rm</span> 存储池名 存储池名 <span class="token operator">--</span>yes-i-really-really-mean-it
	注意：
		存储池名称必须出现两遍，后面的 参数代表是强制
</code></pre></div><p>删除实践</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>默认情况下删除存储池
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd pool <span class="token function">rm</span> mypool mypool <span class="token operator">--</span>yes-i-really-really-mean-it
Error EPERM: pool deletion is disabled<span class="token punctuation">;</span> you must first <span class="token function">set</span> the mon_allow_pool_delete config option to true before you can destroy a pool
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>主节点上修改ceph<span class="token punctuation">.</span>conf文件，增加两行配置，让其运行删除pool
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ tail <span class="token operator">-</span>n2 ceph<span class="token punctuation">.</span>conf
<span class="token namespace">[mon]</span>
mon allow pool delete = true

同步ceph<span class="token punctuation">.</span>conf文件到所有的ceph节点上
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph-deploy <span class="token operator">--</span>overwrite-conf config push admin mon01 mon02 mon03

重启所有的mon节点上的ceph-mon服务
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ <span class="token keyword">for</span> i in mon0<span class="token punctuation">{</span>1<span class="token punctuation">.</span><span class="token punctuation">.</span>3<span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token keyword">do</span> ssh <span class="token variable">$i</span> <span class="token string">&quot;sudo systemctl restart ceph-mon.target&quot;</span><span class="token punctuation">;</span> done
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>将刚才添加的文件对象从存储池里面移除
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd pool <span class="token function">rm</span> mypool mypool <span class="token operator">--</span>yes-i-really-really-mean-it
pool <span class="token string">'mypool'</span> removed

确认效果
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd pool stats
there are no pools!
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph osd pool <span class="token function">ls</span>
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$
</code></pre></div><p><strong>小结</strong></p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>
</code></pre></div><h3 id="_1-2-10-环境完善"><a href="#_1-2-10-环境完善" class="header-anchor">#</a> 1.2.10 环境完善</h3> <p>学习目标</p> <p>这一节，我们从 扩展mon、扩展mgr、小结、三个方面来学习。</p> <p><strong>扩展mon</strong></p> <p>操作mon节点基础</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>命令格式：
	ceph-deploy mon add mon节点名称
	注意：如果add换成destroy，则变成移除mon节点
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>查看ceph的mon状态
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph <span class="token operator">-</span>s
  cluster:
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  services:
    mon: 3 daemons<span class="token punctuation">,</span> quorum mon01<span class="token punctuation">,</span>mon02<span class="token punctuation">,</span>mon03 <span class="token punctuation">(</span>age 3m<span class="token punctuation">)</span>
    mgr: mon01<span class="token punctuation">(</span>active<span class="token punctuation">,</span> since 4h<span class="token punctuation">)</span>
    osd: 6 osds: 6 up <span class="token punctuation">(</span>since 60m<span class="token punctuation">)</span><span class="token punctuation">,</span> 6 in <span class="token punctuation">(</span>since 60m<span class="token punctuation">)</span>
    
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph mon stat
e1: 3 mons at <span class="token punctuation">{</span>mon01=<span class="token namespace">[v2:10.0.0.13:3300/0,v1:10.0.0.13:6789/0]</span><span class="token punctuation">,</span>mon02=<span class="token namespace">[v2:10.0.0.14:3300/0,v1:10.0.0.14:6789/0]</span><span class="token punctuation">,</span>mon03=<span class="token namespace">[v2:10.0.0.15:3300/0,v1:10.0.0.15:6789/0]</span><span class="token punctuation">}</span><span class="token punctuation">,</span> election epoch 6<span class="token punctuation">,</span> leader 0 mon01<span class="token punctuation">,</span> quorum 0<span class="token punctuation">,</span>1<span class="token punctuation">,</span>2 mon01<span class="token punctuation">,</span>mon02<span class="token punctuation">,</span>mon03
</code></pre></div><p>移除实践</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>移除mon节点
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph-deploy mon destroy mon03
<span class="token namespace">[ceph_deploy.conf]</span><span class="token namespace">[DEBUG ]</span> found configuration file at: <span class="token operator">/</span>home/cephadm/<span class="token punctuation">.</span>cephdeploy<span class="token punctuation">.</span>conf
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

查看效果
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph <span class="token operator">-</span>s
  cluster:
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  services:
    mon: 2 daemons<span class="token punctuation">,</span> quorum mon01<span class="token punctuation">,</span>mon02 <span class="token punctuation">(</span>age 9s<span class="token punctuation">)</span>
    mgr: mon01<span class="token punctuation">(</span>active<span class="token punctuation">,</span> since 4h<span class="token punctuation">)</span>
    osd: 6 osds: 6 up <span class="token punctuation">(</span>since 63m<span class="token punctuation">)</span><span class="token punctuation">,</span> 6 in <span class="token punctuation">(</span>since 63m<span class="token punctuation">)</span>
结果显示：
	mon03已经被移除了
</code></pre></div><p>扩展实践</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>扩展mon实践
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph-deploy mon add mon03
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

确认效果
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph <span class="token operator">-</span>s
  cluster:
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  services:
    mon: 3 daemons<span class="token punctuation">,</span> quorum mon01<span class="token punctuation">,</span>mon02<span class="token punctuation">,</span>mon03 <span class="token punctuation">(</span>age 2s<span class="token punctuation">)</span>
    mgr: mon01<span class="token punctuation">(</span>active<span class="token punctuation">,</span> since 4h<span class="token punctuation">)</span>
    osd: 6 osds: 6 up <span class="token punctuation">(</span>since 65m<span class="token punctuation">)</span><span class="token punctuation">,</span> 6 in <span class="token punctuation">(</span>since 65m<span class="token punctuation">)</span>
结果显示：
	mon03已经被添加到集群了
</code></pre></div><p><strong>扩展mgr</strong></p> <p>简介</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>	Ceph Manager在高可用的场景下，守护进程以“Active/Standby”模式运行，部署其它ceph-mgr守护程序可确保在Active节点或其上的ceph-mgr守护进程故障时，其中的一个Standby实例可以在不中断服务的情况下接管其任务。如果只有一个mgr服务器的话，守护进程的状态是Active。
</code></pre></div><div class="language-powershell extra-class"><pre class="language-powershell"><code>确认效果
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph <span class="token operator">-</span>s
  cluster:
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  services:
    mon: 3 daemons<span class="token punctuation">,</span> quorum mon01<span class="token punctuation">,</span>mon02<span class="token punctuation">,</span>mon03 <span class="token punctuation">(</span>age 2s<span class="token punctuation">)</span>
    mgr: mon01<span class="token punctuation">(</span>active<span class="token punctuation">,</span> since 4h<span class="token punctuation">)</span>
    osd: 6 osds: 6 up <span class="token punctuation">(</span>since 65m<span class="token punctuation">)</span><span class="token punctuation">,</span> 6 in <span class="token punctuation">(</span>since 65m<span class="token punctuation">)</span>
</code></pre></div><p>扩展实践</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>在当前的环境中，添加mgr节点
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph-deploy mgr create mon02
<span class="token namespace">[ceph_deploy.conf]</span><span class="token namespace">[DEBUG ]</span> found configuration file at: <span class="token operator">/</span>home/cephadm/<span class="token punctuation">.</span>cephdeploy<span class="token punctuation">.</span>conf
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

查看效果
<span class="token namespace">[cephadm@admin ceph-cluster]</span>$ ceph <span class="token operator">-</span>s
  cluster:
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  services:
    mon: 3 daemons<span class="token punctuation">,</span> quorum mon01<span class="token punctuation">,</span>mon02<span class="token punctuation">,</span>mon03 <span class="token punctuation">(</span>age 3m<span class="token punctuation">)</span>
    mgr: mon01<span class="token punctuation">(</span>active<span class="token punctuation">,</span> since 4h<span class="token punctuation">)</span><span class="token punctuation">,</span> standbys: mon02
    osd: 6 osds: 6 up <span class="token punctuation">(</span>since 69m<span class="token punctuation">)</span><span class="token punctuation">,</span> 6 in <span class="token punctuation">(</span>since 69m<span class="token punctuation">)</span>
结果显示：
	mon01节点就是我们的主角色节点，mon02是我们的从角色节点。
</code></pre></div><p><strong>小结</strong></p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/vueblog/assets/js/app.81e52da8.js" defer></script><script src="/vueblog/assets/js/2.365067af.js" defer></script><script src="/vueblog/assets/js/22.08acf871.js" defer></script>
  </body>
</html>
