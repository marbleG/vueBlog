(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{269:function(t,s,n){t.exports=n.p+"assets/img/img.f0498600.png"},270:function(t,s,n){t.exports=n.p+"assets/img/img_1.98ff5299.png"},298:function(t,s,n){"use strict";n.r(s);var a=n(10),e=Object(a.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"设计流程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#设计流程"}},[t._v("#")]),t._v(" 设计流程")]),t._v(" "),s("h3",{attrs:{id:"_6-详细设计"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6-详细设计"}},[t._v("#")]),t._v(" 6.详细设计")]),t._v(" "),s("blockquote",[s("p",[t._v("详细设计: 具体指导开发的设计部分，包括流程、数据模型、具体用到的算法、和客户端的接口，等等.这一部分很重要，如果没做好，没对齐，那么搞不好就要返工，耽误进度。")])]),t._v(" "),s("ol",[s("li",[t._v("流程设计\n2. 流程图或时序图描述业务流程")]),t._v(" "),s("li",[t._v("算法设计")]),t._v(" "),s("li",[t._v("数据模型设计")]),t._v(" "),s("li",[t._v("接口设计")]),t._v(" "),s("li",[t._v("异常处理")])]),t._v(" "),s("h2",{attrs:{id:"任务管理器"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#任务管理器"}},[t._v("#")]),t._v(" 任务管理器")]),t._v(" "),s("h3",{attrs:{id:"ovirt-engine-任务流程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#ovirt-engine-任务流程"}},[t._v("#")]),t._v(" ovirt-engine 任务流程")]),t._v(" "),s("ol",[s("li",[t._v("bll 每个操作在ActionType 枚举中都有一个值.每个枚举值都有一个对应的类，类由工厂通过反射实例化。")]),t._v(" "),s("li",[t._v("Backend.RunAction：入口，通过 CommandFactory.CreateCommand 接收枚举值和命令参数，并实例化相应的命令。然后，该命令实例通过command.executeAction（）运行，\n"),s("ol",[s("li",[t._v("首先运行所有命令的基类：CommandBase的executeAction初始实现。")]),t._v(" "),s("li",[t._v("CommandBase.executeAction 首先检查命令范围的验证，然后运行派生的命令实现。")]),t._v(" "),s("li",[t._v("在验证阶段，填充字段“returnValue”，包括其子字段“canDoAction”和“errorMessage”。")]),t._v(" "),s("li",[t._v("命令的行为与函数非常相似，因此其“returnValue”字段充当函数实际返回值的隐喻。如果验证成功，则开始执行阶段，其中填充“成功”和“异常”。")])])]),t._v(" "),s("li",[t._v("当用户一次运行多个命令时，后端使用MultipleActionsRunner，execute方法同时异步运行所有命令的验证，然后等待所有验证线程，完成所有验证后，两种：1.全部通过 2.每个命令执行通过验证")]),t._v(" "),s("li",[t._v("internalValidate() 验证命令 和 execute() 执行命令")]),t._v(" "),s("li",[s("img",{attrs:{src:n(269),alt:"img.png"}})]),t._v(" "),s("li",[s("img",{attrs:{src:n(270),alt:"img_1.png"}})])]),t._v(" "),s("div",{staticClass:"language-markdown extra-class"},[s("pre",{pre:!0,attrs:{class:"language-markdown"}},[s("code",[s("span",{pre:!0,attrs:{class:"token title important"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("###")]),t._v(" 主线程（接受请求并响应）")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 判断删除虚拟机操作是否可以执行\n   "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 通过命令工厂创建删除虚拟机命令(RemoveVmCommand)实例(实例化和创建命令上下文)\n   "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" 判断删除虚拟机命令是否可以执行，判断失败返回\n      "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 判断虚拟机信息是否存在，失败返回\n      "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" 判断虚拟机类型是否可以执行删除命令，失败返回\n      "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("3.")]),t._v(" 通过虚拟机id从数据库获取中更新示例虚拟机实例信息\n      "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("4.")]),t._v(" 判断虚拟机是否运行（Unassigned，Down，ImageIllegal，ImageLocked），失败返回\n      "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("5.")]),t._v(" 判断虚拟机是否绑定池，失败返回\n      "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("6.")]),t._v(" 判断虚拟机是否正在进行快照，失败返回\n      "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("7.")]),t._v(" 判断存储池是否可用，失败返回\n      "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("8.")]),t._v(" 判断虚拟机是否正在进行备份，失败返回\n   "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("3.")]),t._v(" 将删除虚拟机命令和关联id提交到EngineThreadPool线程池中。\n"),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" 返回删除虚拟机操作是否可以执行的结果给前端\n\n"),s("span",{pre:!0,attrs:{class:"token title important"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("###")]),t._v(" EngineThreadPool 线程池（执行删除虚拟机操作）")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 对删除虚拟机命令进行监控 (prepareCommandForMonitoring())\n   "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 判断删除虚拟机命令是否可以监控，判断失败返回\n   "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" 持久化删除虚拟机作业到数据库job表中。名称：RemoveVm，状态：STARTED\n"),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" 执行删除虚拟机操作 (executeAction())\n   "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 生成删除虚拟机命令的参数对象 RemoveVmParameters\n   "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" 设置删除虚拟机操作状态为EXECUTE\n   "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("3.")]),t._v(" 新增删除虚拟机作业的验证步骤\n      "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 持久化新增删除虚拟机作业验证步骤到数据库step表中。名称：VALIDATING，状态：STARTED\n   "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("4.")]),t._v(" 判断删除虚拟机命令是否可以执行（通过主线程验证结果可跳过）\n   "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("5.")]),t._v(" 完成删除虚拟机作业的验证步骤\n      "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 持久化更新删除虚拟机作业验证步骤到数据库step表中。名称：VALIDATING，状态：FINISHED\n   "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("6.")]),t._v(" 判断5的验证结果，如果验证失败则终止删除虚拟机命令，返回执行结果false\n      "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 执行删除虚拟机 (execute())\n         "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 更新删除虚拟机命令状态为ACTIVE\n         "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" 判断是否持久化命令，如果删除虚拟机命令包含callback或父命令包含callback\n            "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" true：持久化新增删除虚拟机命令实体到数据库command_entities表中。名称：RemoveVm，状态：ACTIVE\n            "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" 将新增删除虚拟机命令实体添加到commandsCache中\n            "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("3.")]),t._v(" 将"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("删除虚拟机命令id,定时器")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("添加到callbacksTiming中，后续由定时任务invokeCallbackMethods更新该命令状态\n         "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("3.")]),t._v(" 新增删除虚拟机作业的执行步骤\n            "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 持久化新增删除虚拟机作业执行步骤到数据库step表中。名称：EXECUTING，状态：STARTED\n         "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("4.")]),t._v(" 处理删除虚拟机命令步骤\n            "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 判断删除虚拟机命令参数对象中是否包含步骤\n            "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" 关联删除虚拟机命令和相关步骤\n         "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("5.")]),t._v(" 获取删除虚拟机命令参数中事务的范围\n         "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("6.")]),t._v(" 根据事务范围执行删除虚拟机命令 (executeInScope)(Suppress)\n            "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 如果当前存在事务，暂停事务\n            "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" 判断删除虚拟机操作的状态，执行操作或终止操作\n               "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" EXECUTE\n                  "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 执行删除虚拟机（RemoveVm）操作(executeActionInTransactionScope())(executeAction())\n                     "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 执行删除虚拟机命令(executeCommand())\n                        "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 判断虚拟机是否锁定\n                           "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" false: 锁定当前虚拟机\n                           "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" 创建数据库事务1将虚拟机状态更新为lock\n                           "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("3.")]),t._v(" 通过vds更新vm的状态\n                           "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("4.")]),t._v(" 更新business_entity_snapshot表\n                           "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("5.")]),t._v(" 提交数据库事务1\n                        "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" 删除虚拟机（removeVM()）\n                           "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 执行删除虚拟机快照操作，如果失败记录日志\n                           "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" 创建数据库事务2\n                           "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("3.")]),t._v(" 删除数据库中虚拟机相关信息(Users,Network,Snapshots,Static,Icons)\n                           "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("4.")]),t._v(" 判断是否删除虚拟机关联的磁盘\n                              "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 更新数据库中images虚拟机关联的磁盘状态为LOCKED\n                           "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("5.")]),t._v(" 提交数据库事务2\n                           "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("6.")]),t._v(" 执行删除虚拟机所有磁盘（RemoveAllVmImages）操作(runInternalActionWithTasksContext())\n                              "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 设置删除虚拟机所有磁盘操作状态为EXECUTE\n                              "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" 判断删除虚拟机所有磁盘命令是否可以执行\n                              "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("3.")]),t._v(" 执行删除虚拟机所有磁盘(execute())\n                                 "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 持久化删除虚拟机任务删除所有磁盘命令到数据库command_entities表中。名称：RemoveAllVmImages ，状态：ACTIVE\n                                 "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" 将"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("删除虚拟机所有磁盘命令id,定时器")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("添加到callbacksTiming中，后续由定时任务invokeCallbackMethods更新该命令状态\n                                 "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("3.")]),t._v(" 执行删除虚拟机所有磁盘命令(executeCommand())\n                                    "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 执行删除磁盘(RemoveImage)操作(runAction())\n                                       "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 设置删除磁盘操作状态为EXECUTE\n                                       "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" 判断删除磁盘命令是否可以执行\n                                       "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("3.")]),t._v(" 执行删除磁盘(execute())\n                                          "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 持久化删除磁盘命令（RemoveImage）到数据库command_entities表中。名称：RemoveImages ，状态：ACTIVE\n                                          "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" 执行删除磁盘命令(executeCommand())\n                                             "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 持久化vdsm删除磁盘异步任务到数据库async_tasks表中。\n                                             "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" 添加vdsm删除磁盘异步任务到任务管理器中。\n                                             "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("3.")]),t._v(" 获取vdsm删除磁盘命令vdsmTaskId添加vdsmTask列表中"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("命令id，删除磁盘异步任务")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n                                          "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("3.")]),t._v(" 判断删除磁盘命令是否成功\n                                             "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" true：将删除磁盘命令关联的vdsm任务状态置为polling，后续由定时任务timerElapsed更新任务状态\n                                       "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("4.")]),t._v(" 根据命令执行结果数据库command_entities表命令状态\n                                    "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" 返回删除磁盘操作结果\n                                 "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("4.")]),t._v(" 判断删除虚拟机所有磁盘命令是否成功\n                                    "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" true：将删除虚拟机所有磁盘命令关联的vdsm任务状态置为polling，后续由定时任务timerElapsed更新任务状态startPollingAsyncTasks()\n                              "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("4.")]),t._v(" 根据命令执行结果数据库command_entities表命令状态\n                           "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("7.")]),t._v(" vmDeleted fire 事件\n                        "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("3.")]),t._v(" 设置删除虚拟机执行结果\n                     "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" 根据命令执行结果数据库command_entities表命令状态\n                  "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" 判断删除虚拟机操作结果\n                     "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" true：返回执行结果\n                     "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" false：通过任务管理器执行任务的stop命令，返回执行结果\n               "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" 非EXECUTE\n                  "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 执行终止删除虚拟机操作(endActionInTransactionScope())\n            "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("3.")]),t._v(" 如果当前存在事务，恢复事务\n         "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("7.")]),t._v(" 判断删除虚拟机命令是否成功\n            "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" true：将删除虚拟机命令关联的vdsm任务状态置为polling，后续由定时任务timerElapsed更新任务状态startPollingAsyncTasks()\n   "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("7.")]),t._v(" 更新数据库删除虚拟机命令信息\n   "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("8.")]),t._v(" 返回执行删除虚拟机结果\n   "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("9.")]),t._v(" 创建并提交事务3 删除数据库中的异步任务\n\n"),s("span",{pre:!0,attrs:{class:"token title important"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("###")]),t._v(" CommandCallbacksPoller 定时任务 invokeCallbackMethods")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 定时任务-》获取callbacksTiming中所有命令\n   "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 获取删除虚拟机所有磁盘命令的id\n      "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 通过命令id获取删除虚拟机所有磁盘(RemoveAllVmImages)命令实体\n      "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" 判断删除虚拟机所有磁盘命令的状态\n         "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" FAILED、SUCCEEDED\n            "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 执行命令的endCallback方法\n               "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 执行删除虚拟机所有磁盘命令的结束操作(endAction)\n         "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" ACTIVE\n            "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 执行命令对应回调类的doPolling方法\n               "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 通过coco获取删除虚拟机所有磁盘命令状态\n               "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" 遍历获取删除虚拟机所有磁盘命令的子命令的状态\n                  "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" ACTIVE：记录日志\n                  "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" SUCCEEDED：持久化更新删除所有磁盘命令到数据库command_entities表中。名称：RemoveAllVmImages ，状态：SUCCEEDED\n   "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" 获取删除虚拟机命令的id\n      "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 通过命令id获取删除虚拟机(RemoveVm)命令实体\n      "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" 判断删除虚拟机命令的状态\n         "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" FAILED、SUCCEEDED\n            "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 执行命令的endCallback方法\n               "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 执行删除虚拟机所有磁盘命令的结束操作(endAction)\n               "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" 终止删除虚拟机作业\n                  "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 持久化删除虚拟机作业到数据库job表中。名称：RemoveVm，状态：FINISHED\n               "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("3.")]),t._v(" 更新删除虚拟机命令\n                  "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 更新数据库command_entities表中删除虚拟机命令状态。名称：RemoveVm ，状态：ENDED_SUCCESSFULLY\n               "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("4.")]),t._v(" 清理删除虚拟机命令\n                  "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 删除数据库command_entities表中删除虚拟机和相关子命令\n               "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("5.")]),t._v(" 从callbacksTiming移除命令\n         "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" ACTIVE\n            "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 执行命令对应回调类的doPolling方法\n               "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 通过coco获取删除虚拟机状态\n               "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" 遍历获取删除虚拟机的子命令（RemoveAllVmImages和RemoveImage）的状态\n                  "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" ACTIVE：记录日志\n                  "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" SUCCEEDED：持久化更新删除虚拟机命令到数据库command_entities表中。名称：RemoveVm ，状态：SUCCEEDED\n"),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" 判断未完成命令处理后的状态\n   "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" FAILED、SUCCEEDED：从callbacksTiming删除当前命令\n   "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" ACTIVE：继续下次循环\n\n"),s("span",{pre:!0,attrs:{class:"token title important"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("###")]),t._v(" AsyncTaskManager 定时任务 timerElapsed")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 定时任务-》获取vdsmTask列表中的处于polling状态的所有任务\n   "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 获取删除磁盘对应的storage_pool下所有的任务\n   "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" 通过执行vds命令SPMGetAllTasksStatuses 获取SPM中任务的状态\n   "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("3.")]),t._v(" 遍历更新任务状态(updateTaskStatuses)\n      "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 判断vdsm删除磁盘命令状态\n         "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" Polling\n            "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 判断任务是否完成\n               "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 完成：\n                  "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 更新删除磁盘任务状态为Ended\n                  "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" 判断删除磁盘任务是否成功\n                     "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 成功：\n                        "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 获取删除磁盘任务对应的步骤step，持久化更新step表中DELETE_IMAGE行的状态STARTED-》FINISHED\n                        "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" 判断删除磁盘命令和删除磁盘命令子命令是否完成\n                        "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("3.")]),t._v(" 完成。线程池执行endCommandAction()\n                           "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 持久化更新删除磁盘命令（RemoveImage）到数据库command_entities表中。名称：RemoveImages ，状态：SUCCESSED\n                           "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" 新增删除磁盘的结束步骤到数据库step表中。名称：FINALIZING，状态：STARTED\n                           "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("3.")]),t._v(" 根据事务范围执行删除虚拟机命令 (executeInScope)(Required)\n                              "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 非EXECUTE\n                                 "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 执行终止删除虚拟机操作(endActionInTransactionScope())\n                                 "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" 更新删除磁盘的结束步骤到数据库step表中。名称：FINALIZING，状态：FINISHED\n                           "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("4.")]),t._v(" 持久化更新删除磁盘命令（RemoveImage）到数据库command_entities表中。名称：RemoveImages ，状态：ENDED_SUCCESSFULLY\n                           "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("5.")]),t._v(" 删除async_tasks异步任务表中数据\n                     "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" 失败：\n                        "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 获取删除磁盘任务对应的步骤step，持久化更新step表中DELETE_IMAGE行的状态STARTED-》FAILED\n                        "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" 调用clearAsyncTask()清理方法，删除数据库中删除磁盘异步任务数据。\n               "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" 未完成\n                  "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 继续下次循环\n         "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" Ended\n            "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 获取删除磁盘异步任务对应的步骤，更新状态STARTED-》FINISHED\n            "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("2.")]),t._v(" 删除async表中异步任务记录\n         "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("3.")]),t._v(" ClearFailed\n            "),s("span",{pre:!0,attrs:{class:"token list punctuation"}},[t._v("1.")]),t._v(" 调用clearAsyncTask()清理方法，删除数据库中删除磁盘异步任务数据。\n")])])])])}),[],!1,null,null,null);s.default=e.exports}}]);