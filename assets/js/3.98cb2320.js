(window.webpackJsonp=window.webpackJsonp||[]).push([[3],{272:function(s,a,t){s.exports=t.p+"assets/img/img_2.48b40515.png"},273:function(s,a,t){s.exports=t.p+"assets/img/img_1.5ce39609.png"},274:function(s,a,t){s.exports=t.p+"assets/img/img_3.de84e30c.png"},275:function(s,a,t){s.exports=t.p+"assets/img/img_4.a79cd096.png"},276:function(s,a,t){s.exports=t.p+"assets/img/img_5.f776ee95.png"},277:function(s,a,t){s.exports=t.p+"assets/img/img_6.40ef356b.png"},278:function(s,a,t){s.exports=t.p+"assets/img/img_7.cd17868b.png"},300:function(s,a,t){"use strict";t.r(a);var e=t(10),r=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"ceph分布式文件系统"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ceph分布式文件系统"}},[s._v("#")]),s._v(" ceph分布式文件系统")]),s._v(" "),a("h2",{attrs:{id:"_1-快速入门"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-快速入门"}},[s._v("#")]),s._v(" 1.快速入门")]),s._v(" "),a("h3",{attrs:{id:"_1-集群安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-集群安装"}},[s._v("#")]),s._v(" 1.集群安装")]),s._v(" "),a("h4",{attrs:{id:"通过cephadm部署集群"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#通过cephadm部署集群"}},[s._v("#")]),s._v(" 通过cephadm部署集群")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("./cephadm add-repo "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--release")]),s._v(" octopus\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-q")]),s._v(" -O- "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'https://mirrors.aliyun.com/ceph/keys/release.asc'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" apt-key "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" -\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" apt-add-repository "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'deb https://mirrors.aliyun.com/ceph/debian-octopus/ buster main'")]),s._v("\n./cephadm "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" /etc/ceph\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#部署集群")]),s._v("\ncephadm bootstrap --mon-ip "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".56.101\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#新增节点")]),s._v("\nceph cephadm get-pub-key "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" ~/ceph.pub\nssh-copy-id "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" ~/ceph.pub root@marble-p2c\nceph orch "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("host")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" marble-p2c "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".56.102\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#新增osd")]),s._v("\nceph orch daemon "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" osd marble-p2c:/dev/sdb\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#开启restful")]),s._v("\nceph restful create-self-signed-cert\nceph restful create-key admin\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#新增cephfs")]),s._v("\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#删除集群")]),s._v("\ncephadm rm-cluster "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--fsid")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("3b0b3cc8-80e0-11ed-bc04-5254008e5538 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--force")]),s._v("\n")])])]),a("h4",{attrs:{id:"通过cephadm移除集群"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#通过cephadm移除集群"}},[s._v("#")]),s._v(" 通过cephadm移除集群")]),s._v(" "),a("ol",[a("li",[s._v("cddea848-8fe8-11ed-908a-5254008e5538")]),s._v(" "),a("li",[a("code",[s._v("cephadm rm-cluster --fsid cddea848-8fe8-11ed-908a-5254008e5538 --force")])]),s._v(" "),a("li")]),s._v(" "),a("h3",{attrs:{id:"_1-集群部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-集群部署"}},[s._v("#")]),s._v(" 1.集群部署")]),s._v(" "),a("h4",{attrs:{id:"osd模块"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#osd模块"}},[s._v("#")]),s._v(" osd模块")]),s._v(" "),a("ol",[a("li",[s._v("osd部署 本地磁盘挂载至ceph中\n2. 分类\n2. blueStore ceph-osd 进程\n3. FileStore xfs+ leveldb"),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#格式化，非必须")]),s._v("\nmkfs.ext4 /dev/sdb\nblkid\nceph-deplay disk list\nceph-deplay disk zap "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#擦除")]),s._v("\n   \nceph-deplay osd create "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--data")]),s._v(" /dev/sdb --block-db \nceph osd tree\nceph osd "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("\nceph osd dump\nceph osd status\nceph osd perf "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#统计延迟")]),s._v("\nceph osd "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("df")]),s._v("\n")])])])]),s._v(" "),a("li",[s._v("osd操作"),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("ceph osd pause "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#暂停接受数据")]),s._v("\nceph osd unpause\nceph osd crush reweight osd.编号 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#修改权重值")]),s._v("\nceph osd down osd.编号 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#关闭也会重新启动，只能停服务")]),s._v("\nceph osd up osd.编号 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\nceph osd out osd.编号 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#驱逐出及集群")]),s._v("\nceph osd "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" osd.编号 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#加回集群")]),s._v("\n")])])])]),s._v(" "),a("li",[s._v("osd节点"),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#删除")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#1.修改权重 osd crush reweight")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#2.停止指定osd进程 systemctl stop")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#3.驱逐出 osd out")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#4.从crush移除osd节点 osd crush  rm")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#5.删除节点 osd rm")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#6.删除osd认证节点 auth rm")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#添加")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".没有被占用 \n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(".格式化\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(".加入集群 ceph-deploy\n")])])])])]),s._v(" "),a("h4",{attrs:{id:"存储实践"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#存储实践"}},[s._v("#")]),s._v(" 存储实践")]),s._v(" "),a("ol",[a("li",[s._v("概念\n"),a("ol",[a("li",[s._v("Pool 逻辑存储区域")]),s._v(" "),a("li",[s._v("PG 归置组 pool->pg->osd")]),s._v(" "),a("li",[s._v("PGP 维持pg和osd的一种策略")]),s._v(" "),a("li",[s._v("CRUSH\n5. 一致性hash算法将对象名称映射到PG\n6. 将PG id 基于crush算法映射到OSD")])])]),s._v(" "),a("li",[s._v("操作")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("ceph osd pool create 存储池名 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#16个pg，16个组")]),s._v("\nceph osd pool "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("\nceph osd pool "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" detail\nceph osd pool stats\nrados lspools\nrados put 文件对象名"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" /path/to/file "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--pool")]),s._v(" 存储池名 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#上传文件")]),s._v("\nceph osd map 存储池 文件对象名"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nrados "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" 文件对象名"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--pool")]),s._v(" 存储池名 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#上传文件")]),s._v("\n\nceph pg dump\nceph pg "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("\nceph pg ls-by-pool\nceph pg ls-by-osd\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#删除")]),s._v("\nceph osd pool "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" 存储池名 存储池名 \n")])])]),a("p",[a("img",{attrs:{src:t(272),alt:"img_2.png"}}),s._v(" "),a("img",{attrs:{src:t(273),alt:"img_1.png"}})]),s._v(" "),a("h2",{attrs:{id:"_4-综合实践"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-综合实践"}},[s._v("#")]),s._v(" 4. 综合实践")]),s._v(" "),a("ol",[a("li",[s._v("可视化工具\n"),a("ol",[a("li",[s._v("calamari")]),s._v(" "),a("li",[s._v("VSM")]),s._v(" "),a("li",[s._v("Inksope")]),s._v(" "),a("li",[s._v("dashboard python 开发的监控页面，安装在mgr节点上")])])]),s._v(" "),a("li",[s._v("dashboard")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("\n")])])]),a("ol",{attrs:{start:"3"}},[a("li",[s._v("tls\n对dashboard 提供证书访问")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code")])]),a("ol",{attrs:{start:"4"}},[a("li",[s._v("rgw\n默认dashboard未开启")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("radosgw-admin user create "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--uid")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("rgw --display-name"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("rgw "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--lsb_release")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-a")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" access_key/secret_key "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/2.file\nceph dashboard set-rgw-api-access-key "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".file\nceph dashboard set-rgw-api-secret-key "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".file\n")])])]),a("ol",[a("li",[s._v("监控"),a("br"),s._v("\nprometheus"),a("br"),s._v("\n架构")])]),s._v(" "),a("h3",{attrs:{id:"crush"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#crush"}},[s._v("#")]),s._v(" crush")]),s._v(" "),a("h4",{attrs:{id:"基础知识"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#基础知识"}},[s._v("#")]),s._v(" 基础知识")]),s._v(" "),a("ol",[a("li",[s._v("数据分发算法，多维度的")]),s._v(" "),a("li",[s._v("寻址的三次映射\n3. File和object映射：文件数据object的数据块切片操作，便于多数据的并行化处理\n4. object和PG映射：将文件数据切分后的每一个object通过简单的hash算法归到一个PG中\n5. PG和OSD映射：将PG映射到主机实际的OSD数据磁盘上")]),s._v(" "),a("li",[s._v("配置和更改和数据动态再平衡等关键特性\n7. osd动态平衡，osd出现异常，避免故障风暴\n"),a("img",{attrs:{src:t(274),alt:"img_3.png"}})]),s._v(" "),a("li",[s._v("crush map 不同层次的逻辑Buckets和Devices组成\n8. buckets：Root多区域，datacenter数据中心，room机房，rack机柜，host是主机\n9. devices: 各种OSD存储设备")])]),s._v(" "),a("p",[s._v("buckets 示例")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("host")]),s._v(" mon01"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-3")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-4")]),s._v(" class hdd\n  weight "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.039")]),s._v("\n  alg straw2\n  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("hash")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n  item osd.0 weight "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.019")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#低一层级的bucket名称")]),s._v("\n  item osd.1 weight "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.019")]),s._v("\n  \n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n")])])]),a("p",[s._v("相关操作")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#1.获取crush信息")]),s._v("\nceph osd crush dump\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#2.操作相关信息 格式转换->再次应用")]),s._v("\n\nceph osd getcrushmap "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" crushmap_file.txt\ncrushtool "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" crushmap_file.txt \ncrushtool "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v(" crushmap_file.txt "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" new.txt\nceph osd setcrushmap "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" new_crushmap_file.txt\nceph osd crush dump"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" max_size\n")])])]),a("p",[s._v("实践：将不同数据存在不同的磁盘中\n"),a("img",{attrs:{src:t(275),alt:"img_4.png"}}),s._v("\n修改部分\n"),a("img",{attrs:{src:t(276),alt:"img_5.png"}}),s._v(" "),a("img",{attrs:{src:t(277),alt:"img_6.png"}}),s._v("\n定制规则\n"),a("img",{attrs:{src:t(278),alt:"img_7.png"}}),s._v(" "),a("img",{attrs:{src:"img_8.png",alt:"img_8.png"}})])])}),[],!1,null,null,null);a.default=r.exports}}]);