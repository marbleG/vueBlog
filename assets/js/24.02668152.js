(window.webpackJsonp=window.webpackJsonp||[]).push([[24],{303:function(s,t,a){"use strict";a.r(t);var e=a(10),n=Object(e.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"_1-综合实践"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-综合实践"}},[s._v("#")]),s._v(" 1 综合实践")]),s._v(" "),t("h2",{attrs:{id:"_1-1-存储池"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-存储池"}},[s._v("#")]),s._v(" 1.1 存储池")]),s._v(" "),t("h3",{attrs:{id:"_1-1-1-创建实践"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-1-创建实践"}},[s._v("#")]),s._v(" 1.1.1 创建实践")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("简介")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t存储的常用管理操作包括列出、创建、重命名和删除等操作，常用相关的工具都是 “ceph osd pool”的子命令，包括"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("、create、rename和"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v("等\n")])])]),t("p",[s._v("创建存储池")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("副本型存储池创建命令\n\tceph osd pool create <pool-name> <pg-num> "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[pgp-num]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[replicated]")]),s._v(" \\ "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[crush-rule-name]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[expected-num-objects]")]),s._v("\n\t\n纠删码池创建命令\n\tceph osd pool create <pool-name> <pg-num> <pgp-num> erasure \\ "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[erasure-code-profile]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[crush-rule-name]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[expected-num-objects]")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("命令格式中常用的参数\n\tpool-name：存储池名称，在一个RADOS存储集群上必须具有唯一性；\n\tpg-num：当前存储池中的PG数量，合理的PG数量对于存储池的数据分布及性能表现来说至关重要；\n\tpgp-num ：用于归置的PG数量，其值应该等于PG的数量\n\treplicated"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("erasure：存储池类型；副本存储池需更多原始存储空间，但已实现Ceph支持的所有操作，而纠删码存储池所需原始存储空间较少，但目前仅实现了Ceph的部分操作\n\tcrush-ruleset-name：此存储池所用的CRUSH规则集的名称，不过，引用的规则集必须事先存在\n")])])]),t("p",[s._v("获取存储池")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("列出存储池\n\tceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[detail]")]),s._v("\n\n获取存储池的统计数据\n\tceph osd pool stats "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[pool-name]")]),s._v("\n\n显示存储池的用量信息\n\trados df\n")])])]),t("p",[s._v("重命名存储池")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("重命名存储池\n\tceph osd pool rename old-name "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("new-name")]),s._v("\n")])])]),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("查看存储池信息")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("列出所有存储池名称\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("root\ndefault"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("control\ndefault"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("meta\ndefault"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("log\ndefault"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("buckets"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("index\ndefault"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("buckets"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v("\ndefault"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("otp\ndefault"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("buckets"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("non-ec\ncephfs-metadata\ncephfs-"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v("\n\n获取所有存储池的详细信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" detail\npool 6 "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'.rgw.root'")]),s._v(" replicated size 3 min_size 2 crush_rule 0 object_hash rjenkins pg_num 32 pgp_num 32 autoscale_mode warn last_change 117 flags hashpspool stripe_width 0 application rgw\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n结果显示：\n\t可以看到，所有存储池的详情信息\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("获取所有存储池的统计数据\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool stats\npool "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("root id 6\n  nothing is going on\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\npool cephfs-"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(" id 15\n  nothing is going on\n  \n获取制定存储池的统计数据\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool stats cephfs-"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v("\npool cephfs-"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(" id 15\n  nothing is going on\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("显示存储池的用量信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rados df\nPOOL_NAME                     USED OBJECTS "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" RD_OPS      "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("RD")]),s._v(" WR_OPS      WR "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("root                  768 KiB       4 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("      0     0 B      4   4 KiB "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\ndefault"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("otp                0 B       0 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("      0     0 B      0     0 B "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\ntotal_objects    328\ntotal_used       7"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0 GiB\ntotal_avail      113 GiB\ntotal_space      120 GiB\n")])])]),t("p",[s._v("创建副本存储池")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建副本型存储池\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool create replicated-pool 32 32\npool "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'replicated-pool'")]),s._v(" created\n\n查看副本统计信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool stats replicated-pool\npool replicated-pool id 18\n  nothing is going on\n\n查看副本详情信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" detail "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" grep replicated-pool\npool 18 "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'replicated-pool'")]),s._v(" replicated size 3 min_size 2 crush_rule 0 object_hash rjenkins pg_num 32 pgp_num 32 autoscale_mode warn last_change 507 flags hashpspool stripe_width 0\n")])])]),t("p",[s._v("创建纠偏码池")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建纠删码池\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool create erasure-pool 16 16 erasure\npool "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'erasure-pool'")]),s._v(" created\n\n查看副本统计信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool stats erasure-pool\npool erasure-pool id 19\n  nothing is going on\n\n查看副本详情信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" detail "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" grep erasure-pool\npool 19 "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'erasure-pool'")]),s._v(" erasure size 3 min_size 2 crush_rule 1 object_hash rjenkins pg_num 16 pgp_num 16 autoscale_mode warn last_change 511 flags hashpspool stripe_width 8192\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-1-2-删除实践"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-2-删除实践"}},[s._v("#")]),s._v(" 1.1.2 删除实践")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("简介")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("意外删除存储池会导致数据丢失，因此 Ceph 实施了两个机制来防止删除存储池，要删除存储池，必须先禁用这两个机制\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("第一个机制是NODELETE标志，其值需要为false，默认也是false\n\t查看命令：ceph osd pool get pool-name nodelete\n\t修改命令：ceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" pool-name nodelete false\n\n第二个机制是集群范围的配置参数mon allow pool delete，其默认值为 “false”，这表示默认不能删除存储池，临时设定的方法如下\n\tceph tell mon"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" injectargs "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("mon-allow-pool-delete="),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("true"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("false"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\t建议删除之前将其值设置为true，删除完成后再改为false\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("删除存储池命令格式\nceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" pool-name pool-name "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("yes-i-really-really-mean-it\n")])])]),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("删除存储池")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看删除标识\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool get replicated-pool nodelete\nnodelete: false\n\n删除存储池\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" replicated-pool replicated-pool "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("yes-i-really-really-mean-it\nError EPERM: pool deletion is disabled"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" you must first "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" the mon_allow_pool_delete config option to true before you can destroy a pool\n结果显示:\n\t默认无法删除存储池\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("修改删除标识\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph tell mon"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" injectargs "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("mon-allow-pool-delete=true\nmon"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("mon01: injectargs:mon_allow_pool_delete = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'true'")]),s._v("\nmon"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("mon02: injectargs:mon_allow_pool_delete = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'true'")]),s._v("\nmon"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("mon03: injectargs:mon_allow_pool_delete = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'true'")]),s._v("\n\n再次删除存储池\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" replicated-pool replicated-pool "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("yes-i-really-really-mean-it\npool "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'replicated-pool'")]),s._v(" removed\n")])])]),t("p",[s._v("永久删除方法")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("将所有的ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf文件中，增加默认允许删除存储池的配置\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/ceph/ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[mon]")]),s._v("\nmon_allow_pool_delete = true\n\n然后同步到所有节点，重启mon服务\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph-deploy "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("overwrite-conf config push admin mon01 mon02 mon03\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" i in mon0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v(" ssh "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$i")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sudo systemctl restart ceph-mon.target"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" done\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("修改删除标识\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph tell mon"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" injectargs "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("mon-allow-pool-delete=false\n\n创建存储池\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool create replicated-pool 16 16\npool "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'replicated-pool'")]),s._v(" created\n\n删除存储池\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" replicated-pool replicated-pool "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("yes-i-really-really-mean-it\npool "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'replicated-pool'")]),s._v(" removed\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-1-3-配额管理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-3-配额管理"}},[s._v("#")]),s._v(" 1.1.3 配额管理")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("设置存储池配额")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("Ceph支持为存储池设置可存储对象的最大数量（max_objects）和可占用的最大空间（ max_bytes）两个纬度的配额\n\tceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set-quota")]),s._v(" <pool-name> max_objects"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("max_bytes <val>\n\n获取存储池配额的相关信息\n\tceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("get-quota")]),s._v(" <pool-name>\n")])])]),t("p",[s._v("配置存储池参数")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("存储池的诸多配置属性保存于配置参数中\n\t获取配置：ceph osd pool get <pool-name>\n\t设定配置：ceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" <pool-name> <key> \n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("常用的可配置参数\n    size：\t\t\t存储池中的对象副本数；\n    min_size：\t\tI/O所需要的最小副本数；\n    pg_num：\t\t\t存储池的PG数量；\n    pgp_num：\t\t计算数据归置时要使用的PG的有效数量；\n    crush_ruleset：\t用于在集群中映射对象归置的规则组；\n    nodelete：\t\t控制是否可删除存储池；\n    nopgchange：\t\t控制是否可更改存储池的pg_num和pgp_num；\n    nosizechange：\t控制是否可更改存储池的大小；\n    noscrub和nodeep-scrub：\t控制是否可整理或深层整理存储池以解决临时高I/O负载的问题\n    scrub_min_interval：\t集群负载较低时整理存储池的最小时间间隔；\n                默认值为0，表示其取值来自于配置文件中的osd_scrub_min_interval参数；\n    scrub_max_interval：整理存储池的最大时间间隔；\n                默认值为0，表示其取值来自于配置文件中的osd_scrub_max_interval参数；\n    deep_scrub_interval：深层整理存储池的间隔；\n                默认值为0，表示其取值来自于配置文件中的osd_deep_scrub参数；\n")])])]),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("设置存储池配额")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("获取存储池配额的相关信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("get-quota")]),s._v(" erasure-pool\nquotas "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" pool "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'erasure-pool'")]),s._v(":\n  max objects: N/A\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 表示没有限制")]),s._v("\n  max bytes  : N/A\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 表示没有限制")]),s._v("\n\n设置存储池配额的值\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set-quota")]),s._v(" erasure-pool max_objects 10000\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set-quota")]),s._v(" max_objects = 10000 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" pool erasure-pool\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set-quota")]),s._v(" erasure-pool max_bytes 1024000\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set-quota")]),s._v(" max_bytes = 1024000 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" pool erasure-pool\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("get-quota")]),s._v(" erasure-pool\nquotas "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" pool "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'erasure-pool'")]),s._v(":\n  max objects: 10k objects\n  max bytes  : 1000 KiB\n")])])]),t("p",[s._v("配置存储池参数")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建存储池\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool create replicated-pool 16 16\npool "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'replicated-pool'")]),s._v(" created\n\n获取配置\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool get replicated-pool size\nsize: 3\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("调整配置属性\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" replicated-pool size 4\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" pool 21 size to 4\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool get replicated-pool size\nsize: 4\n\n调整配置属性\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" replicated-pool size 3\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" pool 21 size to 3\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool get replicated-pool size\nsize: 3\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-1-4-快照管理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-4-快照管理"}},[s._v("#")]),s._v(" 1.1.4 快照管理")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("简介")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("关于存储池快照\n\t存储池快照是指整个存储池的状态快照\n\t通过存储池快照，可以保留存储池状态的历史\n\t创建存储池快照可能需要大量存储空间，具体取决于存储池的大小\n")])])]),t("p",[s._v("常见操作")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建存储池快照\n\tceph osd pool mksnap <pool-name> <snap-name>\n\trados "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p <pool-name> mksnap <snap-name>\n\n列出存储池的快照\n\trados "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p <pool-name> lssnap\n\n回滚存储池至指定的快照\n\trados "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p <pool-name> rollback <snap-name>\n\n删除存储池快照\n\tceph osd pool rmsnap <pool-name> <snap-name>\n\trados "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p <pool-name> rmsnap <snap-name>\n")])])]),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("查看快照")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看制定存储池的快照数量\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rados "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p replicated-pool lssnap\n0 snaps\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rados "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p erasure-pool lssnap\n0 snaps\n")])])]),t("p",[s._v("制作快照")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建快照\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool mksnap replicated-pool replicated-snap\ncreated pool replicated-pool snap replicated-snap\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool mksnap erasure-pool erasure-snap\ncreated pool erasure-pool snap erasure-snap\n\n查看效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rados "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p replicated-pool lssnap\n1       replicated-snap 2062"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("09"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("28 22:28:33\n1 snaps\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rados "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p erasure-pool lssnap\n1       erasure-snap    2062"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("09"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("28 22:28:43\n1 snaps\n\n结果分析：\n\t创建过image的存储池无法再创建存储池快照了，因为存储池当前已经为unmanaged snaps mode 或者 selfmanaged_snaps模式，而没有创建image的，就可以做存储池快照。\n")])])]),t("p",[s._v("快照还原")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("添加文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rados put ceph-file "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("home/cephadm/ceph-cluster/ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool=erasure-pool\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rados "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool=erasure-pool\nceph-file\n\n添加快照\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool mksnap erasure-pool erasure-snap1\ncreated pool erasure-pool snap erasure-snap1\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rados "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p erasure-pool lssnap\n1       erasure-snap    2062"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("09"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("28 22:28:43\n2       erasure-snap1   2062"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("09"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("28 22:30:17\n2 snaps\n\n回滚快照\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rados "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p erasure-pool rollback ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf erasure-snap\nrolled back pool erasure-pool to snapshot erasure-snap\n")])])]),t("p",[s._v("删除快照")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("删除快照\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool rmsnap erasure-pool erasure-snap1\nremoved pool erasure-pool snap erasure-snap1\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool rmsnap erasure-pool erasure-snap\nremoved pool erasure-pool snap erasure-snap\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rados "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool=erasure-pool lssnap\n0 snaps\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-1-5-压缩管理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-5-压缩管理"}},[s._v("#")]),s._v(" 1.1.5 压缩管理")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("简介")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\tBlueStore存储引擎提供即时数据压缩，以节省磁盘空间\n")])])]),t("p",[s._v("启用压缩")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("ceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" <pool-name> compression_algorithm snappy\n\t压缩算法有none、zlib、lz4、zstd和snappy等几种，默认为snappy；\n\tzstd有较好的压缩比，但比较消耗CPU；\n\tlz4和snappy对CPU占用比例较低；\n\t不建议使用zlib；\n\nceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" <pool-name> compression_mode aggressive\n\t压缩模式：none、aggressive、passive和force，默认值为none；\n\tnone：不压缩\n\tpassive：若提示COMPRESSIBLE，则压缩\n\taggressive：除非提示INCOMPRESSIBLE，否则就压缩；\n\tforce：始终压缩\n\t\n注意：如果需要全局压缩，最好在配置文件中定制\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("其它可用的压缩参数\n\tcompression_required_ratio：指定压缩比，取值格式为双精度浮点型，其值为\nSIZE_COMPRESSED/SIZE_ORIGINAL，即压缩后的大小与原始内容大小的比值，默认为 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("875；\n\tcompression_max_blob_size：压缩对象的最大体积，无符号整数型数值，默认为0；\n\tcompression_min_blob_size：压缩对象的最小体积，无符号整数型数值，默认为0；\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("全局压缩选项\n\t可在ceph配置文件中设置压缩属性，它将对所有的存储池生效，可设置的相关参数如下\n\tbluestore_compression_algorithm\n\tbluestore_compression_mode\n\tbluestore_compression_required_ratio\n\tbluestore_compression_min_blob_size\n\tbluestore_compression_max_blob_size\n\tbluestore_compression_min_blob_size_ssd\n\tbluestore_compression_max_blob_size_ssd\n\tbluestore_compression_min_blob_size_hdd\n\tbluestore_compression_max_blob_size_hdd\n")])])]),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("查看默认的算法")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@mon01 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph daemon osd.0 config show | grep compression")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"bluestore_compression_algorithm"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"snappy"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"bluestore_compression_mode"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"none"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"bluestore_compression_required_ratio"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0.875000"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"rbd_compression_hint"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"none"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n结果显示：\n\t默认的压缩算法是 snappy"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("默认的压缩模式是 node"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("压缩比例是0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("875\n注意：\n\t这条命令最好指定节点下执行\n")])])]),t("p",[s._v("更改压缩算法")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("管理节点设定压缩算法\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" erasure-pool compression_algorithm zstd\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" pool 19 compression_algorithm to zstd\n\n存储池查看效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" detail "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" grep erasure-pool\npool 19 "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'erasure-pool'")]),s._v(" erasure "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" compression_algorithm zstd\n")])])]),t("p",[s._v("更改算法模式")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("更改算法模式\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" erasure-pool compression_mode aggressive\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" pool 19 compression_mode to aggressive\n\n查看存储池算法模式\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" detail "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" grep erasure-pool\npool 19 "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'erasure-pool'")]),s._v(" erasure "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" compression_mode aggressive\n")])])]),t("p",[s._v("还原算法模式和算法")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("还原算法和模式\nceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" erasure-pool compression_algorithm snappy\nceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" erasure-pool compression_mode none\n\n查看效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" detail "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" grep erasure-pool\npool 19 "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'erasure-pool'")]),s._v(" erasure "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" compression_algorithm snappy compression_mode none\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-1-6-纠删码基础"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-6-纠删码基础"}},[s._v("#")]),s._v(" 1.1.6 纠删码基础")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("场景介绍")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t纠删码理论"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("erasure coding，EC"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("始于 20 世纪 60 年代"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("它是一种数据保护方法。从原理上说，它将数据分割成片段，把冗余数据块扩展、编码，并将其存储在不同的位置，比如磁盘、存储节点或者其它地理位置。\n\t总数据块 = 原始数据块 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" 校验块， 常见表示为，n = k "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" m\n\t当冗余级别为n时，将这些数据块分别存放在n个硬盘上，这样就能容忍小于m个（假设初始数据有k个）硬盘发生故障。当不超过m个硬盘发生故障时，只需任意选取k个正常的数据块就能计算得到所有的原始数据。\n\t在云存储中，我们通常会使用副本的方式来保证系统的可用性。问题是当存储达到 PB 级别后要求的容量将会非常高。通过使用纠删码技术可以在保证相同可用性的情况下，节省大量存储空间，从而大大的降低 TCO（总体成本）。Ceph 从 Firefly 版本开始支持纠删码。\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t比如8块磁盘的总数"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("N"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("，5个数据盘"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("K"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 通过5个数据块计算出3个校验块"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("m"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("，我们可以用RS"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("5"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("来代表。在这样的场景中，每份数据都会切分5份"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("5*5的逆向矩阵，它可以容忍任意 3 块磁盘的故障。如果某些数据块丢失，可以通过剩下的可用数据恢复出原始的数据内容。\n")])])]),t("p",[t("img",{attrs:{src:"image/image-20220928232215966.png",alt:"image-20220928232215966"}})]),s._v(" "),t("p",[s._v("ceph纠偏码")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\tCeph纠删码实现了高速的计算，但有2个缺点：速度慢、只支持对象的部分操作。ceph中的EC编码是以插件的形式来提供的。EC编码有三个指标：空间利用率、数据可靠性和恢复效率。ceph提供以下几种纠删码插件：clay"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("coupled-layer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("、jerasure、lrc、shec、isa等\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\tCeph支持以插件方式加载使用的纠删编码插件，存储管理员可根据存储场景的需要优化选择合用的插件。\njerasure：\n\t最为通用的和灵活的纠删编码插件，它也是纠删码池默认使用的插件；不过，任何一个OSD成员的丢失，都需要余下的所有成员OSD参与恢复过程；另外，使用此类插件时，管理员还可以通过technique选项指定要使用的编码技术：\n\treed_sol_van：最灵活的编码技术，管理员仅需提供k和m参数即可；\n\tcauchy_good：更快的编码技术，但需要小心设置PACKETSIZE参数；\n\treed_sol_r6_op、liberation、blaum_roth或liber8tion：\n\t\t\t仅支持使用m=2的编码技术，功能特性类同于RAID 6；\nlrc：\n\t全称为Locally Repairable Erasure Code，即本地修复纠删码，除了默认的m个编码块之外，它会额外在本地创建指定数量（l）的奇偶校验块，从而在一个OSD丢失时，可以仅通过l个奇偶校验块完成恢复\n\nisa：\n\t仅支持运行在intel CPU之上的纠删编码插件，它支持reed_sol_van和cauchy两种技术\n\nshec：\n\tshec"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("k"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("m"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("l"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("，k为数据块，m为校验块，l代表计算校验块时需要的数据块数量。\n\t其最大允许失效数据块为：ml/k，恢复失效的单个数据块（"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(" chunk）只需要额外读取l个数据块。\n")])])]),t("p",[s._v("基础概念")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("块（chunk）\n\t基于纠删码编码时，每次编码将产生若干大小相同的块"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("有序"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("。\n\tceph通过数量相等的PG将这些分别存储在不同的osd中。\n条带（strip）\n\t如果编码对象太大，可分多次进行编码，每次完成编码的部分称为条带。同一个对内的条带时有序的。\n分片（shared）\n\t同一个对象中所有序号相同的块位于同一个PG上，他们组成对象的一个分片，分片的编号就是块的序号。\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("空间利用率（rate）：\n\t通过k/n计算。\n对象尺寸： \n\tCeph 存储集群里的对象有最大可配置尺寸，对象尺寸必须足够大"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("而且应该是条带单元的整数倍。\n条带数量（strip_size）： \n\tCeph 客户端把一系列条带单元写入由条带数量所确定的一系列对象，这一系列的对象称为一个对象集。\n\t客户端写到对象集内的最后一个对象时，再返回到第一个。\n条带宽度（strip_width）： \n\t条带都有可配置的单元尺寸。Ceph 客户端把数据等分成适合写入对象的条带单元。\n\tstrip_width = chunk_size "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" strip_size\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t假设有EC（k=4，m=2），strip_size=4，chunk_size=1K，那么strip_width=4K。在ceph中，strip_width默认为4K。\n\t假如object对象内容是 ABCDEFGHIJKL；将该数据对象写入pool时，纠删码函数把object分4个数据块：第1个是ABC"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("第2个是DEF，第3个是GHI，第4个是JKL；如果object的长度不是K的倍数，object会被填充一些内容；纠删码函数同时创建2个编码块：第4个是xxx，第5个是yyy；\n")])])]),t("p",[t("img",{attrs:{src:"image/image-20220928234255383.png",alt:"image-20220928234255383"}})]),s._v(" "),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("创建纠删码池")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("命令格式\n\tceph osd pool create <pool-name> <pg-num> <pgp-num> erasure "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[erasure-code-profile]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[crush-rule-name]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[expected-num-objects]")]),s._v("\n\n要点解析\n\t未指定要使用的纠删编码配置文件时，创建命令会为其自动创建一个，并在创建相关的CRUSH规则集时使用到它\n\t默认配置文件自动定义k=2和m=1，这意味着Ceph将通过三个OSD扩展对象数据，并且可以丢失其中一个OSD而不会丢失数据，因此，在冗余效果上，它相当于一个大小为2的副本池 ，不过，其存储空间有效利用率为2/3而非1/2。\n")])])]),t("p",[s._v("其他命令")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("列出纠删码配置文件\n\tceph osd erasure-code-profile "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("\n\n获取指定的配置文件的相关内容\n\tceph osd erasure-code-profile get default\n\n自定义纠删码配置文件\n\tceph osd erasure-code-profile "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" <name> "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("<directory=directory>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("<plugin=plugin>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("<crush-device-"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(">"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("<crush-failure-domain>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("<key=value> "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("force"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" directory：加载纠删码插件的目录路径，默认为"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("usr/lib/ceph/erasure-code；\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" plugin：用于生成及恢复纠删码块的插件名称，默认为jerasure；\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" crush-device-"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v("：设备类别，例如hdd或ssd，默认为none，即无视类别；\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" crush-failure-domain：故障域，默认为host，支持使用的包括osd、host、rack、row和room等 ；\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("force：强制覆盖现有的同名配置文件；\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("示例：\n\t例如，如果所需的体系结构必须承受两个OSD的丢失，并且存储开销为40％\n\tceph osd erasure-code-profile "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" myprofile  k=4  m=2 crush-failure-domain=osd\n\t例如，下面的命令创建了一个使用lrc插件的配置文件LRCprofile，其本地奇偶校验块为3，故障域为osd\n\tceph osd erasure-code-profile "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" LRCprofile plugin=lrc k=4 m=2 l=3 crush-failure-domain=osd\n")])])]),t("p",[s._v("查看纠删码池")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("列出纠删码配置文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd erasure-code-profile "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("\ndefault\n\n获取指定的配置文件的相关内容\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd erasure-code-profile get default\nk=2\nm=1\nplugin=jerasure\ntechnique=reed_sol_van\n")])])]),t("p",[s._v("自定义纠删码配置")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建纠删码配置\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd erasure-code-profile "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" myprofile  k=4  m=2 crush-failure-domain=osd\n\n查看纠删码配置信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd erasure-code-profile "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("\ndefault\nmyprofile\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd erasure-code-profile get myprofile\ncrush-device-"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v("=\ncrush-failure-domain=osd\ncrush-root=default\njerasure-per-chunk-alignment=false\nk=4\nm=2\nplugin=jerasure\ntechnique=reed_sol_van\nw=8\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建定制的纠偏码池\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool create erasure-pool-myprofile 8 8 erasure myprofile\npool "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'erasure-pool-myprofile'")]),s._v(" created\n\n查看效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" detail "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" grep erasure-pool-myprofile\npool 22 "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'erasure-pool-myprofile'")]),s._v(" erasure size 6 min_size 5 crush_rule 2 object_hash rjenkins pg_num 8 pgp_num 8 autoscale_mode warn last_change 540 flags hashpspool stripe_width 16384\n解析：\n\terasure size 6 代表有"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("K+m"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("6个osd磁盘\n")])])]),t("p",[s._v("基于插件定制纠偏码配置")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("基于纠偏码算法定制专属配置\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd erasure-code-profile "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" LRCprofile plugin=lrc k=4 m=2 l=3 crush-failure-domain=osd\n\n查看纠删码配置信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd erasure-code-profile "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("\nLRCprofile\ndefault\nmyprofile\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd erasure-code-profile get LRCprofile\ncrush-device-"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v("=\ncrush-failure-domain=osd\ncrush-root=default\nk=4\nl=3\nm=2\nplugin=lrc\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建定制配置的纠偏码池\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool create erasure-pool-LRCprofile 1 1 erasure LRCprofile\npool "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'erasure-pool-LRCprofile'")]),s._v(" created\n\n查看效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" detail "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" grep erasure-pool-LRCprofile\npool 23 "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'erasure-pool-LRCprofile'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" flags hashpspool stripe_width 16384\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-1-7-纠删码实践"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-7-纠删码实践"}},[s._v("#")]),s._v(" 1.1.7 纠删码实践")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 数据实践、异常实践、小结三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("数据实践")])]),s._v(" "),t("p",[s._v("纠删码池数据实践")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建存储池\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool create ecpool 12 12 erasure\npool "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'ecpool'")]),s._v(" created\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("数据写入实践\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("echo")]),s._v(" ABCDEFGHI "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" rados "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool ecpool put object_data "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("\n\n数据读取实践\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rados "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool ecpool get object_data "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("\nABCDEFGHI\n\n注意：\n\t数据写入和读取的实践命令末尾必须有一个 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" \n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("文件写入实践\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("echo")]),s._v(" test > test"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("txt\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rados "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p ecpool put test test"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("txt\n\n文件读取实践\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rados "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p ecpool get test file"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("txt\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" file"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("txt\ntest\n")])])]),t("p",[s._v("纠删码池不支持部分image功能")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("启用rbd功能\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool application enable ecpool rbd\nenabled application "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'rbd'")]),s._v(" on pool "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'ecpool'")]),s._v("\n\n创建image操作\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd create myimg "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p ecpool "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("size 1024\n2062-09-29 01:01:01"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("144 7faafbfff700 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("1 librbd::image::ValidatePoolRequest: handle_overwrite_rbd_info: pool missing required overwrite support\n2062-09-29 01:01:01"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("144 7faafbfff700 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("1 librbd::image::CreateRequest: 0x55a667ec7190 handle_validate_data_pool: pool does not support RBD images\nrbd: create error: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("22"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" Invalid argument\n结果显示：\n\t纠偏码池不支持RBD images的参数操作\n")])])]),t("p",[t("strong",[s._v("异常实践")])]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建纠删码配置\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd erasure-code-profile  "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" Ecprofile crush-failure-domain=osd k=3 m=2\n\n查看纠删码配置信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd erasure-code-profile "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("\nEcprofile\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd erasure-code-profile get  Ecprofile\ncrush-device-"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v("=\ncrush-failure-domain=osd\ncrush-root=default\njerasure-per-chunk-alignment=false\nk=3\nm=2\nplugin=jerasure\ntechnique=reed_sol_van\nw=8\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("基于纠删码配置文件创建erasure类型的Ceph池：\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool create Ecpool 16 16 erasure Ecprofile\npool "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Ecpool'")]),s._v(" created\n\n确认效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd dump "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" grep Ecpool\npool 25 "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Ecpool'")]),s._v(" erasure size 5 min_size 4 crush_rule 4 object_hash rjenkins pg_num 16 pgp_num 16 autoscale_mode warn last_change 566 flags hashpspool stripe_width 12288\n结果显示：\n\terasure size 5 表示 3+2=5 个osd磁盘来存储数据和校验码\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建文件后提交文件到纠删码池\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("echo")]),s._v(" test_ecpool > test_file"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("txt\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rados put "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p Ecpool object1 test_file"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("txt\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rados "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p Ecpool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("\nobject1\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("检查纠删码池中和object1的OSDmap\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd map Ecpool object1\nosdmap e566 pool "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Ecpool'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("25"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" object "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'object1'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("> pg 25"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("bac5debc "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("25"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("c"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("> up "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("4"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("5"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" p2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" acting "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("4"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("5"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" p2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n结果显示：\n\t0-5的osd磁盘上都有我们的数据库和校验块\n")])])]),t("p",[s._v("测试效果")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("找到两台节点，将两个被用到的osd移除，比如mon02主机上的osd2，mon03主机上的osd5\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ssh mon03 sudo systemctl stop ceph-osd@5\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ssh mon02 sudo systemctl stop ceph-osd@2\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd tree\nID "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CLASS")]),s._v(" WEIGHT  "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("TYPE")]),s._v(" NAME      STATUS REWEIGHT PRI-AFF\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("5       0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("03897     host mon02\n 2   hdd 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("01949         osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("2    down  1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("00000 1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("00000\n 3   hdd 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("01949         osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("3      up  1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("00000 1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("00000\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("7       0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("03897     host mon03\n 4   hdd 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("01949         osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("4      up  1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("00000 1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("00000\n 5   hdd 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("01949         osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("5    down  1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("00000 1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("00000\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("检查EC池和object1的OSDmap\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd map Ecpool object1\nosdmap e574 pool "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Ecpool'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("25"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" object "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'object1'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("> pg 25"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("bac5debc "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("25"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("c"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("> up "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[NONE,1,0,4,NONE]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" p1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" acting "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[NONE,1,0,4,NONE]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" p1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n结果显示：\n\tosd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("5和osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("2 已经不管用了\n\t\n获取文件查看\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rados "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p Ecpool get object1 ok"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("txt\n结果显示：\n\t查看文件失败，可以看到，不允许有超过2个osd失败的效果\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h2",{attrs:{id:"_1-2-存储进阶"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-存储进阶"}},[s._v("#")]),s._v(" 1.2 存储进阶")]),s._v(" "),t("h3",{attrs:{id:"_1-2-1-原理解读"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-1-原理解读"}},[s._v("#")]),s._v(" 1.2.1 原理解读")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("存储池")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\tRADOS存储集群提供的基础存储服务需要由“pool”分割为逻辑存储区域 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v(" 对象数据的名称空间。我们在部署ceph集群的过程中，涉及到大量的应用程序，而这些应用程序在创建的时候，需要专属的数据存储空间"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("存储池，比如rbd存储池、rgw存储池、cephfs存储池等。\n\t存储池还可以再进一步细分为一至多个子名称空间，比如我们在看pool的时候\n\t"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("root\n    default"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("control\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("根命名空间"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("应用命名空间"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("子空间"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t对于Ceph集群来说，它的存储池主要由默认的副本池"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("replicated pool"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("和纠删码池"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("erasure code"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" 两种类型组成。\n\t客户端在使用这些存储池的时候，往往依赖于相关用户信息的认证机制。\n")])])]),t("p",[s._v("数据存储逻辑")]),s._v(" "),t("p",[t("img",{attrs:{src:"image/1636103641572.png",alt:"1636103641572"}})]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\tCeph 在 RADOS 集群中动态存储、复制和重新平衡数据对象。由于许多不同的用户在无数 OSD 上出于不同目的将对象存储在不同的池中，因此 Ceph 操作需要一些数据放置规划。Ceph 中主要的数据放置规划概念包括：\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("Pools（池）：\n\tCeph 将数据存储在pool中，pool是用于存储对象的逻辑组。首次部署集群而不创建pool时，Ceph 使用默认pool来存储数据。\n\tpool主要管理的内容有：PG的数量、副本的数量和pool的 CRUSH 规则。\n\t当然了。要将数据存储在池中，您必须有一个经过身份验证的用户，该用户具有该池的权限。\n参考资料：https:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("docs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com/en/quincy/rados/operations/pools/\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("Placement Groups（归置组）：\n\t归置组 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("PG"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" 是 Ceph 如何分发数据的内部实现细节。\n\tCeph 将对象映射到归置组"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("PG"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("，归置组"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("PG"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("是逻辑对象池的分片或片段，它们将对象作为一个组放置到OSD中。当 Ceph 将数据存储在 OSD 中时，放置组会减少每个对象的元数据量。\n\t每个 PG 都属于一个特定的Pool，因此当多个Pool使用相同的 OSD 时，必须注意每个OSD的PG副本的总和不能超过OSD自身允许的PG数量阈值。\n参考资料：https:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("docs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com/en/quincy/rados/operations/placement-groups\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("CRUSH Maps（CRUSH 映射）： \n\tCRUSH 是让 Ceph 在正常运行情况下进行数据扩展的重要部分。CRUSH 映射为 CRUSH 算法提供集群的物理拓扑数据，以确定对象及其副本的数据应该存储在哪里，以及如何跨故障域以增加数据安全等。\n参考资料：https:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("docs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com/en/quincy/rados/operations/crush-map。\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("Balancer：\n\t平衡器是一个功能，它会自动优化PG跨设备的分布，以实现数据的均衡分布，最大化集群中可以存储的数据量，并在OSD之间平均分配工作负载。\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("Pool数量、CRUSH规则和PG数量决定了 Ceph 将如何放置数据\n")])])]),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("Ceph 的 RADOS中，引入了 PG 的概念用以更好地管理数据。PG 的引入降低对数量巨大的对象的管理难度。\n\t1、对象数量时刻处于变化中。而PG的数量经过人工规划因而严格可控。\n\t2、PG数量远小于对象，且生命周期稳定。因此以PG为单位进行数据同步或者迁移，相比较对象难度更小。\n\nPG 最引人注目之处在于其可以在OSD之间（根据CRUSH的实时计算结果）自由迁移，这是ceph赖以实现自动数据恢复、自动数据平衡等高级特性的基础。\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\tRADOS 提供的是基于 Object 的存储功能，每个 Object 会先通过简单的 Hash 算法归到一个 PG 中，PGID 再作为"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"参数"')]),s._v("通过 CRUSH 计算置入到多个 OSD 中。\n\tObject "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 可以理解为一个文件\n\tPG     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 可以理解为一个目录\n\tOSD    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 可以理解我一个PG目录下的简易文件系统\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("存储池在操作资源对象的时候，需要设置：对象的所有权"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("访问权、归置组的数量、CRUSH 规则 \n")])])]),t("p",[s._v("PG 映射到 OSD")]),s._v(" "),t("p",[t("img",{attrs:{src:"image/image-20220930074909586.png",alt:"image-20220930074909586"}})]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t每个Pool都有许多归置组。当 Ceph 客户端存储对象时，CRUSH 会将每个对象映射到一个归置组"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("然后CRUSH 将 PG 动态映射到 OSD。\n\t所以说，PG相当于 OSD守护进程 和 Ceph客户端之间的一个中间层：\n\t\t1 通过CRUSH实现数据对象动态平衡的分散到所有OSD中，同时也可以让客户端知道数据在哪个OSD中\n\t\t2 中间层还允许新加入的OSD和其他OSD在数据负载时候实现动态平衡\n")])])]),t("p",[s._v("PG id")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t当 Ceph客户端绑定到 Ceph Mon节点时，它会检索 Cluster Map的最新副本。客户端可以通过Cluster Map了解集群中的所有监视器、OSD和元数据服务器信息。由于数据对象与Cluster Map无关，所以它对对象位置一无所知。\n\t客户端操作数据对象的时候，需要指定 对象ID"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("就是对象名称"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("和Pool。\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("CRUSH算法允许客户端计算对象应该存储在哪里，从而实现客户端能够快速联系主 OSD 以存储或检索对象。\n\t1 Ceph 客户端输入Pool名称和对象ID\n\t\trados put "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("object_name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("path/to/local_file "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool="),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("pool_name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\t2 Ceph 获取对象ID后对其进行hash处理\n\t\thash"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("对象ID名称"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v("PG_num\n\t3 Ceph 基于PG数为模对PG进行哈希计算后获取 PG ID，比如 58\n\t4 Ceph 根据pool名称获取Pool ID，比如 4\n\t5 Ceph 将pool ID 附加到 PG ID，比如 4"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("58\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\tCeph OSD 守护进程会检查彼此的心跳并向 Ceph Mon节点报告状态信息。\n\tCeph OSD 守护进程会将同一组PG中所有对象的状态进行一致性同步，同步异常往往会自动解决\n")])])]),t("p",[s._v("数据一致性")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t为了保证Ceph 存储集群的数据安全向，它被设计为存储至少两个对象副本，以便它可以在保持数据安全的同时继续在某个状态下运行。\n\t"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@mon01 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph daemon osd.0 config show | grep default_size")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"osd_pool_default_size"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"3"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@mon01 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph osd pool get ecpool size")]),s._v("\n\tsize: 3\n\t所以PG在关联的时候，往往会关联多个OSD的id值，我们会将同一个PG关联的多个OSD集合称为 Acting "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Set")]),s._v("，注意该"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Set")]),s._v("是一个有序集合。其中第一个OSD，我们将其称为 Primary OSD，然后依次类推为 Secondary OSD等等。注意Primary OSD守护进程会维护同一组PG的所有OSD副本数据状态的一致性。\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t对于Acting "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Set")]),s._v("的 Ceph OSD 守护进程状态主要有四种：\n\t\tUP"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("启动已运行"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("、Down"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("关闭未运行"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("、In"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("集群中"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("、Out"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("集群外"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\n\t我们可以通过 ceph "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("s、ceph osd tree、ceph osd stat来查看OSD的状态信息\n\t"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@mon01 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph osd stat")]),s._v("\n\t6 osds: 6 up "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("since 14h"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 6 in "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("since 14h"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" epoch: e631\n\t注意：\n\t\tOSD和PG上的每一次状态变更的历史信息，我们称为epoch\n")])])]),t("p",[t("img",{attrs:{src:"image/image-20220930111350189.png",alt:"image-20220930111350189"}})]),s._v(" "),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-2-2-归置组"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-2-归置组"}},[s._v("#")]),s._v(" 1.2.2 归置组")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("PG简介")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t当用户在Ceph存储集群中创建存储池Pool的时候，我们往往会为它创建PG和PGS，如果我们没有指定PG和PGP的话，则Ceph使用配置文件中的默认值来创建Pool的PG和PGP。通常情况下，我们建议用户根据实际情况在配置文件中自定义pool的对象副本数量和PG数目。\n参考资料：\n\thttps:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("docs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com/en/latest/rados/configuration/pool-pg-config-ref/\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t关于对象副本数目，用户可以根据自身对于数据安全性的要求程度进行设置，Ceph默认存储一份主数据对象和两个副本数据"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("osd pool default size = 3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("。对于PG数目，假如数据对象副本数目为N，集群OSD数量为M，则每个OSD上的PG数量为X，官方提供了一个默认的PG数量计算公式。\n\tPG"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("PGP 数量 = M "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" X "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" N\n注意：\n\t官方推荐X默认的值为100\n\t再一个，PG算出来的数据往往不是一个整数，但是我们往往将该值取为最接近2的幂次方值。\t\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("PG数量计数：\n\t假如Ceph集群有100个OSD，数据副本为3，则PG数量值为 100*100/3=3333"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("33"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("该值不是一个整数，我们将该值取为4096"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("2^12"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("所以我们可以将PG相关的属性设置为\n\t"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[global]")]),s._v("\n    osd pool default size = 4\n    osd pool default min size = 1\n    osd pool default pg mum = 4096\n    osd pool default pgp mum = 4096\n\n常见数量统计：\n\tOSD<5个，pg_num 设置为 256；5个<OSD<10个，pg_num 设置为 512；\n\t10个<OSD<50个，pg_num 设置为 2048；50个<OSD，pg_num 设置为 4096；\n")])])]),t("p",[s._v("信息查看")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("存储池的归置组数量设置好之后，还可以增加，但不可以减少\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph osd pool create mypool 128\npool "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mypool'")]),s._v(" created\n\n获取PG和PGP的数量\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph osd pool get mypool pg_num\npg_num: 128\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph osd pool get mypool pgp_num\npgp_num: 128\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("调整PG的数量\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" mypool pg_num 256\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" pool 7 pg_num to 256\n\n调整PGP的数量"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("不允许大于PG梳理"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" mypool pgp_num 512\nError EINVAL: specified pgp_num 512 > pg_num 256\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" mypool pgp_num 256\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" pool 7 pgp_num to 256\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("获取完整的PG的统计信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph pg dump\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph pg dump "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("format=json\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph pg dump "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("format=json-pretty\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("获取精简的PG统计信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("s "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" grep pgs\n    pools:   1 pools"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 256 pgs\n    pgs:     256 active+clean\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph pg dump_stuck\nok\n\n查看所有PG的状态\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph pg stat\n256 pgs: 256 active+clean"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" 0 B "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 122 MiB used"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 114 GiB "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" 120 GiB avail\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看指定PG值的统计信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph pg 7"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("c4 query\n")])])]),t("p",[s._v("状态")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("检查集群状态时"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ceph "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("， Ceph 会报告归置组状态"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("其最优状态为 active+clean。其他常见状态有：\n    Creating \t\t\tCeph 仍在创建归置组。\n    Active\t\t\t\tCeph 可处理到归置组的请求。\n    Clean\t\t\t\tCeph 把归置组内的对象复制了规定次数。\n    Down\t\t\t\t包含必备数据的副本挂了，所以归置组离线。\n    Replay\t\t\t\t某 OSD 崩溃后，归置组在等待客户端重放操作。\n    Splitting\t\t\tCeph 正在把一归置组分割为多个。（实现了？）\n    Scrubbing\t\t\tCeph 正在检查归置组的一致性。\n    Degraded\t\t\t归置组内的对象还没复制到规定次数。\n    Inconsistent\t\tCeph 检测到了归置组内一或多个副本间不一致现象。\n    Peering\t\t\t\t归置组正在互联。\n    Repair\t\t\t\tCeph 正在检查归置组、并试图修复发现的不一致（如果可能的话）。\n    Recovering\t\t\tCeph 正在迁移"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("同步对象及其副本。\n    Backfill\t\t\tCeph 正在扫描并同步整个归置组的内容，Backfill 是恢复的一种特殊情况。\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Wait-backfill")]),s._v("\t\t归置组正在排队，等候回填。\n    Backfill-toofull\t一回填操作在等待，因为目标 OSD 使用率超过了占满率。\n    Incomplete\t\t\tCeph 探测到某一归置组异常。\n    Stale\t\t\t\t归置组处于一种未知状态，从归置组运行图变更起就没再收到它的更新。\n    Remapped\t\t\t归置组被临时映射到了另外一组 OSD ，它们不是 CRUSH 算法指定的。\n    Undersized\t\t\t此归置组的副本数小于配置的存储池副本水平。\n    Peered\t\t\t\t此归置组已互联，因为副本数没有达到标准，不能向客户端提供服务\n    \n异常状态标识\n\tInactive \t\t\t归置组不能处理读写，因为它们在等待一个有最新数据的 OSD 复活且进入集群。\n\tUnclean \t\t\t归置组含有复制数未达到期望数量的对象，它们应该在恢复中。\n\tStale \t\t\t\t归置组处于未知状态：存储它们的 OSD 有段时间没向监视器报告了。\n")])])]),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("获取特殊状态的PG")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph pg dump_stuck stale\nok\n注意：\n\t其他的异常状态有：inactive"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("unclean"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("stale"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("undersized"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("degraded\n")])])]),t("p",[s._v("列举不一致pg信息")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("列出不一致的PG：\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ rados list-inconsistent-pg mypool\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n列出不一致的 rados 对象：\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ rados list-inconsistent-obj 7"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("c4\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"epoch"')]),s._v(":156"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"inconsistents"')]),s._v(":"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n列出给定置放群组中不一致的快照集：\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ rados list-inconsistent-snapset 7"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("c4\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"epoch"')]),s._v(":156"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"inconsistents"')]),s._v(":"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),t("p",[s._v("修复损坏pg信息")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph pg repair 7"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("c4\ninstructing pg 7"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("c4 on osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("4 to repair\n")])])]),t("p",[s._v("临时PG")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t假设一个PG的acting "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v("为"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("列表。此时如果osd0出现故障，导致CRUSH算法重新分配该PG的acting "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v("为"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("。此时osd3为该PG的主OSD，但是OSD3为新加入的OSD，并不能负担该PG上的读操作。所以PG向Monitor申请一个临时的PG，osd1为临时的主OSD，这是up "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v("变为"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("，acting "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v("依然为"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("，导致acting "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v("和up "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v("不同。当osd3完成Backfill过程之后，临时PG被取消，该PG的up "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v("修复为acting "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v("，此时acting "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v("和up "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v("都是"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("列表。\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-2-3-运行图"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-3-运行图"}},[s._v("#")]),s._v(" 1.2.3 运行图")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("map简介")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t对于Ceph集群来说，有个非常重要的特点就是高性能，而高性能有一个非常突出的特点就是单位时间内处理业务数据的量。Ceph为了实现业务数据的精准高效操作，它主要是通过五种Map分别来实现特定的功能：\n\tMonitor Map\n\t\tMon节点和所有节点的连接信息，包括ceph集群ID，monitor 节点名称，IP地址和端口等。\n\tCRUSH Map \n\t\t让 Ceph 在正常运行情况下进行高效数据操作的重要支撑部分，包括数据的写入和查询用到的设备列表、存储桶信息、故障域结构，故障域规则等。\n\tOSD Map\n\t\t保存OSD的基本信息，包括ID，状态，副本、PG、OSD信息等，便于数据的均衡性操作。\n\tMDS Map\n\t\t保存MDS的基本信息，包括版本号、创建和修改时间、数据和元数据存储池、数量、MDS状态等。\n\tPG Map\n\t\t保存PG的基本信息，包括PG的ID、数量、状态、版本号、时间戳、容量百分比等。\n")])])]),t("p",[t("img",{attrs:{src:"image/image-20220930074909586.png",alt:"image-20220930074909586"}})]),s._v(" "),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("基本map关联关系")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看mon相关的关联关系\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$  ceph mon dump\nepoch 3\nfsid d932ded6-3765-47c1-b0dc-e6957051e31a\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n2: "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[v2:10.0.0.15:3300/0,v1:10.0.0.15:6789/0]")]),s._v(" mon"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("mon03\ndumped monmap epoch 3\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看osd相关信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph osd dump\nepoch 158\nfsid d932ded6-3765-47c1-b0dc-e6957051e31a\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nosd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("5 up   in  weight 1 up_from 146 up_thru 156 down_at 145 last_clean_interval "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("125"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("142"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[v2:10.0.0.15:6800/1274,v1:10.0.0.15:6805/1274]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[v2:192.168.8.15:6804/1274,v1:192.168.8.15:6805/1274]")]),s._v(" exists"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("up 67282205-0c58-49c8-9af6-878198d05f2e\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看mds相关信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph mds dump\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看crush相关信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph osd crush dump\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"devices"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" \t\t\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设备列表信息")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"id"')]),s._v(": 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"osd.0"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"class"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hdd"')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"types"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\t\t\t\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 资源类型列表12类，主要有")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\t\t\t\t\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# osd、host、chassis、rack")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"type_id"')]),s._v(": 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# row、pdu、pod、room")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"osd"')]),s._v("\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# datacenter、zone、region、root")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"buckets"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\t\t\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 存储桶列表")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"id"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"default"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"rules"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\t\t\t\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 数据映射规则列表")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"rule_id"')]),s._v(": 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"rule_name"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"replicated_rule"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"tunables"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\t\t\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可调节的相关属性")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"choose_local_tries"')]),s._v(": 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"choose_args"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\t\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可选择的其他参数")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),t("p",[s._v("查看PG的相关信息")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看pg相关的信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph pg dump\nversion 3481\nstamp 2062-10-08 20:54:41"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("007647\nlast_osdmap_epoch 0\nlast_pg_scan 0\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nOSD_STAT USED    AVAIL   USED_RAW TOTAL   HB_PEERS    PG_SUM PRIMARY_PG_SUM\n5         20 MiB  19 GiB  1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0 GiB  20 GiB "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("4"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("    137             44\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nsum      122 MiB 114 GiB  6"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("1 GiB 120 GiB\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看PG-OSD关系图\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph pg map 7"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("c4\nosdmap e158 pg 7"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("c4 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("7"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("c4"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("> up "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("4"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" acting "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("4"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("提交文件到对应的osd里面\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rados put ceph-file "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("home/cephadm/ceph-cluster/ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool=mypool\nobject-PG-OSD关系图 查看ceph-file文件对象的内部属性关系\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd map mypool ceph-file\nosdmap e51 pool "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mypool'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" object "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'ceph-file'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("> pg 1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("7753490d "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("d"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("> up "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("5"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" p2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" acting "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("5"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" p2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-2-4-crush"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-4-crush"}},[s._v("#")]),s._v(" 1.2.4 CRUSH")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("简介")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\tCRUSH"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Controlled Replication Under Scalable Hashing"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("是ceph的核心设计之一，它本质上是Ceph存储集群使用的一种数据分发算法，类似于OpenStack的Swift和AQS的对象存储所使用的哈希和一致性hash数据分布算法。\n\tCRUSH算法通过接受多维参数，通过一定的计算对客户端对象数据进行分布存储位置的确定，来解决数据动态分发的问题。因此ceph客户端无需经过传统查表的方式来获取数据的索引，进而根据索引来读写数据，只需通过crush算法计算后直接和对应的OSD交互进行数据读写。这样，ceph就避免了查表这种传统中心化架构存在的单点故障、性能瓶颈以及不易扩展的缺陷。这也是Ceph相较于其他分布式存储系统具有高扩展性、高可用和高性能特点的主要原因。\n")])])]),t("p",[s._v("CRUSH Map简介")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("Ceph中的寻址至少要经历以下三次映射：\n\tFile 和 object 映射：文件数据object的数据块切片操作，便于多数据的并行化处理。\n\tObject 和 PG 映射：将文件数据切分后的每一个Object通过简单的 Hash 算法归到一个 PG 中。\n\tPG 和 OSD 映射：将PG映射到主机实际的OSD数据磁盘上。\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\tCRUSH算法提供了配置和更改和数据动态再平衡等关键特性，而CRUSH算法存储数据对象的过程可通过CRUSH Map控制并进行自定义修改，CRUSH Map是Ceph集群物理拓扑结构、副本策略以及故障域等信息抽象配置段，借助于CRUSH Map可以将数据伪随机地分布到集群的各个OSD上。\n")])])]),t("p",[t("img",{attrs:{src:"image/image-20221008220724118.png",alt:"image-20221008220724118"}})]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("CRUSH Map 由不同层次的逻辑Buckets 和 Devices组成：\n\tBuckets "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" Root指的是多区域，datacenter是数据中心，room是机房、rack是机柜，host是主机\n\tDevices "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 主要指各种OSD存储设备\n注意：\n\t对于每一个Ceph集群来说，CRUSH Map在正式上线前已经确定好了，如果用户需要自定义更改CRUSH Map的话，必须在集群上线前进行更改和核实，然后应用到CRUSH算法中。\n")])])]),t("p",[s._v("Buckets")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("CRUSH Map中的Buckets是用户自定义增加的，每个层级的Bucket对应不同的故障域，在实际应用中，为了更加精细化地隔离故障域，用户还可以增加PDU、POD、ROW、CHASSIS等，这些名称是用户随意定义的。\n对于Ceph N版本来说，它默认声明了12种Buckets。\n\troot-根分区、region-可用区域、zone-数据区域、datacenter-数据中心\n\troom-机房、pod-机房单间、pdu-电源插座、row-机柜排\n\track-机柜、chassis-机箱、host-主机、osd-磁盘\n")])])]),t("p",[s._v("配置文件解读")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# begin crush map  设定修正bug、优化算法、以及向后兼容老版本等属性信息")]),s._v("\ntunable choose_local_tries 0\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 为做向后兼容应保持为0")]),s._v("\ntunable choose_local_fallback_tries 0\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 为做向后兼容应保持为0")]),s._v("\ntunable choose_total_tries 50\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 选择bucket的最大重试次数")]),s._v("\ntunable chooseleaf_descend_once 1\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 为做向后兼容应保持为1")]),s._v("\ntunable chooseleaf_vary_r 1\t\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修复旧bug，为做向后兼容应保持为1")]),s._v("\ntunable chooseleaf_stable 1\t\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 避免不必要的pg迁移，为做向后兼容应保持为1")]),s._v("\ntunable straw_calc_version 1\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# straw算法版本，为做向后兼容应保持为1")]),s._v("\ntunable allowed_bucket_algs 54\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 允许使用的bucket选择算法，通过位运算计算得出的值")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# devices 该部分保存了 Ceph 集群中所有 OSD 设备和 ceph-osd 守护进程的映射关系。")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 格式： device {num} {osd.name} [class {class}]")]),s._v("\ndevice 0 osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" hdd\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\ndevice 5 osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("5 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" hdd\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# types 该部分定义了在 CRUSH 层次结构中用到的 buckets 类型。")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 格式：type {num} {bucket-name}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" 0 osd\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# OSD守护进程编号（如：osd.1,osd.2等）")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" 1 host\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# OSD所在主机名称")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" 2 chassis\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# host所在机箱名称")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" 3 rack\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 机箱所在机柜名称")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" 4 row\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 机柜所在排名称")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" 5 pdu\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 机柜排所在的电源插座")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" 6 pod\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 电源插座专属的单间")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" 7 room\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 房间所属的机房")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" 8 datacenter\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 机房所属的数据中心")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" 9 zone\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 数据中心所属的数据区域")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" 10 region\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 数据区域所属的可用区域")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" 11 root\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设备管理的根路径")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# buckets 该部分定义了一个个具体的type类型的设备区域")]),s._v("\nhost mon01 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("3           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# do not change unnecessarily")]),s._v("\n        id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("4 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" hdd         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# do not change unnecessarily")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# weight 0.039")]),s._v("\n        alg straw2\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# straw2算法减少了集群发生了改变后的数据移动")]),s._v("\n        hash 0  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# bucket使用的hash算法，默认是rjenkins1")]),s._v("\n        item osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0 weight 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("019\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 低一层级的bucket名称，以及其对应的weight")]),s._v("\n        item osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("1 weight 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("019\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rules 部分定义了存储池的属性，以及存储池中数据的存放方式，尤其是复制(replication)和放置(placement)数据的策略。默认的 CRUSH map 包含了适用于默认存储池 rbd 的一条规则。")]),s._v("\nrule replicated_rule "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        id 0\t\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 定制所属规则集")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" replicated\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 作用副本存储池范围")]),s._v("\n        min_size 1\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 副本少于1个，规则失效")]),s._v("\n        max_size 10\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 副本大于10个，规则失效")]),s._v("\n        step take default\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 作用于default类型的bucket")]),s._v("\n        step chooseleaf firstn 0 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" host\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 作用于包含3个子bucket的host")]),s._v("\n        step emit  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 表示数据处理的方式，处理完数据后，清理处理过程")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# end crush map")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("bucket 实例的属性解析\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[bucket类型]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[bucket名称]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n   id "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("负整数表示bucket唯一ID"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n   weight "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("表示设备容量之间的权重差异，权重1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("00代表1T容量，权重0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("5代表500G容量"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n   alg "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[bucket类型的算法选择: uniform|list|tree|straw|straw2，它是性能和效率之间的一种妥协]")]),s._v("\n   hash "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[hash算法类型: 0 是默认的rjenkins1算法]")]),s._v("\n   item "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("当前bucket的子项元素"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" weight "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("相对权重值"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n算法解读：\n\tuniform 每次设备变动，数据都会进行均衡处理，要求所有设备的权重一致，效率极低\n\tlist 设备的变动场景以链表方式实现，大规模设备场景下，效率极其低下。\n\ttree 设备的变动场景以二叉树方式实现，综合数据处理性能叫均衡。\n\tstraw 设备的变动场景在list和tree之间选择最优方式进行，同时支持副本放置时公平竞争处理和二级权重处理\n\tstraw2 进阶版的straw，即使出现数据变动，不会影响到跨高层的数据操作。\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("rule 实例的属性解析\nrule <rule名称>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    ruleset <当前规则所属的规则集，整数标识>\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("指定rule作用的存储池类型 replicated"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("erasure"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    min_size <存储池的副本份数小于min_size值后，rule不起作用>\n    max_size <存储池的副本份数大于max_size值后，rule不起作用>\n    step take <获取一个 bucket类型名称，开始遍历其结构>\n    step "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[choose|chooseleaf]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[firstn|indep]")]),s._v(" <num> <bucket-"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(">\n    step emit\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n注意：\n\tchoose：选择到预期数量和类型的bucket即可结束\n\tchooseleaf：选择到预期数量和类型的bucket，并最终从这些bucket中选出叶子节点\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("\n\t当出现osd 异常情况时，\n\t\t副本池选择firstn方式，表示新节点以追加方式追加到osd列表\n\t\t纠删码池选择indep方式，表示新节点以原位置插入添加到osd列表，其他保持有序状态\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("\n\t如果 num==0，选择 N 个 bucket。\n  \t如果 num > 0 并且 num<N，选择 num 个 bucket。\n  \t如果 num < 0，选择 N-num 个 bucket\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("举例1：\n  \tstep choose firstn 1 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" row\n  \tnum=1，存储池的副本份数为3，0<num<3，因此，crush map会选择包含 1 个 bucket 的row进行处理。\n  \t\n  \tstep chooseleaf firstn 0 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" row\n  \tnum=0，存储池的副本份数为3，num==0，因此，crush map会从包含 3 个 bucket 的row的每一个叶子节点中选择一个子元素。\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("举例2：\n\t一个PG的5个副本分布在OSD 1，2，3，4，5上，然后3 down了。\n\t在firstn模式下：\n\t\tCRUSH算法发现3其down掉后，最后在末尾追加一个新的未down的OSD 6，OSD变迁过程为：\n\t\t\t1，2，3，4，5 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("> 1，2，4，5，6。\n\t在indep模式下：\n\t\tCRUSH算法发现3其down掉后，会在3位置插入一个新的未down的OSD 6，OSD变迁过程为：\n\t\t\t1，2，3，4，5 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("> 1，2，6，4，5。\n")])])]),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("Crush map操作步骤解读")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("crush 相关的信息，我们可以通过两种方法来进行操作：\n\t1 获取crush相关信息\n\t\tceph osd crush dump\n\t2 操作crush相关信息\n\t\t获取crush map信息后进行格式转换，编辑文件后再次应用crush map数据\n")])])]),t("p",[s._v("操作crush信息")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("1、从monitor节点上获取CRUSH map\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph osd getcrushmap "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("o crushmap_file\n23\n\n默认获取的文件并不是普通的文本文件，无法直接查看\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ file crushmap_file\ncrushmap_file: MS Windows icon resource "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 8 icons"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 1-colors\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("2、获取该crushmap文件后，编译为可读文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ crushtool "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("d crushmap_file "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("o crushmap_file"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("txt\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ file crushmap_file"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("txt\ncrushmap_file"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("txt: ASCII text\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看文件内容\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" crushmap_file"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("txt\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 参考上述的文件格式解读")]),s._v("\n")])])]),t("p",[s._v("crush map信息修改")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("修改crushmap_file文件内容\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ vim crushmap_file"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("txt\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nrule replicated_rule "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n        max_size 20     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改该值")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n3、将修改后的crushmap_file"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("txt编译为二进制文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ crushtool "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("c crushmap_file"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("txt "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("o new_crushmap_file"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("txt\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("4、将新的crushmap注入到ceph集群\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph osd setcrushmap "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("i new_crushmap_file"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("txt\n24\n\n确认效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph osd crush dump "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" grep max_size\n            "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"max_size"')]),s._v(": 20"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph osd crush rule dump "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" grep max_size\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"max_size"')]),s._v(": 20"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n结果显示：\n\tcrush map的数据修改成功了\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-2-5-实践解读"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-5-实践解读"}},[s._v("#")]),s._v(" 1.2.5 实践解读")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("案例需求")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t随着存储技术的发展，目前存储平台中的存储介质的类型也越来越多了，目前主要有两大类型：SSD磁盘和SAS"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("SATA磁盘。我们可以根据应用对于场景的使用特点，高性能场景的数据存储使用SSD磁盘，而普通数据的存储我们采用SAS磁盘，所以在SSD场景中，我们就可以基于SSD磁盘组成高性能POOL，将基于SAS"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("SATA磁盘组成常规POOL。\n\t以OpenStack场景为例，对于VM实例来说，Nova对于实时数据IO要求较高，所以推荐使用SSD存储池；VM实例创建过程中不高的冷数据，比如Glance镜像数据和Cinder块设备备份数据，推荐使用SAS"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("SATA的常规POOL。\n")])])]),t("p",[s._v("场景规划")]),s._v(" "),t("p",[t("img",{attrs:{src:"image/image-20221009234113283.png",alt:"image-20221009234113283"}})]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t为了区分SSD和SAS磁盘，需要在CRUSH Map中增加Root层，增加SAS和SSD区域。\n        业务A对性能要求较高，将SSD作为数据盘，需创建3副本的SSD存储池\n        业务B对性能要求不高，但数据量较大，将SAS作为数据盘降低成本，需创建3副本的SAS存储池\n")])])]),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("定制crush map")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("定制专属文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" crushmap_file_case"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("txt\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# begin crush map")]),s._v("\ntunable choose_local_tries 0\ntunable choose_local_fallback_tries 0\ntunable choose_total_tries 50\ntunable chooseleaf_descend_once 1\ntunable chooseleaf_vary_r 1\ntunable chooseleaf_stable 1\ntunable straw_calc_version 1\ntunable allowed_bucket_algs 54\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# devices")]),s._v("\ndevice 0 osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" ssd\ndevice 1 osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("1 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" sas\ndevice 2 osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("2 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" ssd\ndevice 3 osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("3 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" sas\ndevice 4 osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("4 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" ssd\ndevice 5 osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("5 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" sas\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# types")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" 0 osd\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" 1 host\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" 2 chassis\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" 3 rack\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" 4 row\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" 5 pdu\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" 6 pod\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" 7 room\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" 8 datacenter\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" 9 zone\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" 10 region\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" 11 root\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# buckets")]),s._v("\nhost mon01-ssd "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("3           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# do not change unnecessarily")]),s._v("\n        id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("4 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" ssd         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# do not change unnecessarily")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# weight 0.039")]),s._v("\n        alg straw2\n        hash 0  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rjenkins1")]),s._v("\n        item osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0 weight 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("019\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nhost mon02-ssd "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("5           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# do not change unnecessarily")]),s._v("\n        id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("6 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" ssd         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# do not change unnecessarily")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# weight 0.039")]),s._v("\n        alg straw2\n        hash 0  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rjenkins1")]),s._v("\n        item osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("2 weight 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("019\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nhost mon03-ssd "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("7           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# do not change unnecessarily")]),s._v("\n        id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("8 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" ssd         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# do not change unnecessarily")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# weight 0.039")]),s._v("\n        alg straw2\n        hash 0  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rjenkins1")]),s._v("\n        item osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("4 weight 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("019\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nhost mon01-sas "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("9 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" sas\n        alg straw2\n        hash 0\n        item osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("1 weight 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("019\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nhost mon02-sas "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("10 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" sas\n        alg straw2\n        hash 0\n        item osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("3 weight 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("019\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nhost mon03-sas "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("11 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" sas\n        alg straw2\n        hash 0\n        item osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("5 weight 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("019\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nroot ssd "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("1\n    id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("2 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" ssd\n    alg straw2\n    hash 0\n    item mon01-ssd weight 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("019\n    item mon02-ssd weight 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("019\n    item mon03-ssd weight 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("019\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nroot sas "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("127\n    id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("128 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" sas\n    alg straw2\n    hash 0\n    item mon01-sas weight 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("019\n    item mon02-sas weight 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("019\n    item mon03-sas weight 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("019\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rules")]),s._v("\nrule ssd_rule "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    id 0\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" replicated\n    min_size 1\n    max_size 10\n    step take ssd\n    step chooseleaf firstn 0 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" host\n    step emit\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nrule sas_rule "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    id 1\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" replicated\n    min_size 1\n    max_size 10\n    step take sas\n    step chooseleaf firstn 0 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" host\n    step emit\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# end crush map")]),s._v("\n注意：\n\t每个元素都应该有自己的id值\n\t原则上来说，每个bucket名称最好不要一致，即使是同一台主机\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("3、将修改后的crushmap_file"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("txt编译为二进制文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ crushtool "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("c crushmap_file_case"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("txt "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("o crushmap_file_case\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("4、将新的crushmap注入到ceph集群\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph osd setcrushmap "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("i crushmap_file_case\n25\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("确认效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph osd crush dump\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph osd crush rule dump\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n结果显示：\n\tcrush map的数据修改成功了\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("确认osd的状态树\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph osd tree\nID   "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CLASS")]),s._v(" WEIGHT  "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("TYPE")]),s._v(" NAME          STATUS REWEIGHT PRI-AFF\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("127       0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("05699 root sas\n "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("12       0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("01900     host mon01-sas\n   1   sas 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("01900         osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("1          up  1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("00000 1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("00000\n "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("13       0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("01900     host mon02-sas\n   3   sas 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("01900         osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("3          up  1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("00000 1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("00000\n "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("14       0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("01900     host mon03-sas\n   5   sas 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("01900         osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("5          up  1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("00000 1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("00000\n  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("1       0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("05699 root ssd\n  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("3       0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("01900     host mon01-ssd\n   0   ssd 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("01900         osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0          up  1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("00000 1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("00000\n  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("5       0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("01900     host mon02-ssd\n   2   ssd 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("01900         osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("2          up  1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("00000 1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("00000\n  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("7       0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("01900     host mon03-ssd\n   4   ssd 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("01900         osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("4          up  1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("00000 1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("00000\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建ssd存储池\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph osd pool create ssd_pool 16 16 replicated ssd_rule\npool "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'ssd_pool'")]),s._v(" created\n\n创建sas存储池\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph osd pool create sas_pool 16 16 replicated sas_rule\npool "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'sas_pool'")]),s._v(" created\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("确认不同的pool所使用的osd效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph pg "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("by-pool  ssd_pool "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("awk "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{print $1,$2,$15}'")]),s._v("\nPG OBJECTS ACTING\n15"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0 0 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("4"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("p4\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n15"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("f 0 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("4"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("p2\n\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph pg "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("by-pool  sas_pool "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("awk "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{print $1,$2,$15}'")]),s._v("\nPG OBJECTS ACTING\n16"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0 0 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("5"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("p3\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n16"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("f 0 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("5"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("p5\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\n")])])]),t("h2",{attrs:{id:"_1-3-可视化"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-可视化"}},[s._v("#")]),s._v(" 1.3 可视化")]),s._v(" "),t("h3",{attrs:{id:"_1-3-1-dashboard"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-1-dashboard"}},[s._v("#")]),s._v(" 1.3.1 dashboard")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("简介")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\tCeph dashboard 是通过一个web界面，对已经运行的ceph集群进行状态查看以及功能配置等功能，早起ceph使用的是第三方的dashboard组件。\n\t\n\t关于dashboard是通过模块的方式来进行加载的，而且默认情况下，该模块是具备输出所有ceph集群状态的一个模块，因为这里面涉及到某些敏感信息，所以默认情况下，使用https协议来进行访问。\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("参考资料：\n\thttps:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("docs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com/en/latest/mgr/dashboard/\n")])])]),t("p",[s._v("常见 监控模块工具")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("工具")]),s._v(" "),t("th",[s._v("解析")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("calamari")]),s._v(" "),t("td",[s._v("对外提供了十分漂亮的web管理和监控界面，以及一套改进的REST API接口，在一定程度上简化了ceph管理，最初calamari是作为lnktank公司的ceph企业级商业产品来销售，红帽2015年收购后为了更好地推动ceph的发展，对外宣布calamari开源")])]),s._v(" "),t("tr",[t("td",[s._v("VSM")]),s._v(" "),t("td",[s._v("Virtual Storage Manager是Inter公司研发并且开源的一款ceph集群管理和监控软件，简化了一些ceph集群部署的一些步骤，可以简单的通过web页面来操作")])]),s._v(" "),t("tr",[t("td",[s._v("Inksope")]),s._v(" "),t("td",[s._v("Inksope是一个ceph的管理和监控系统，依赖于ceph提供的API，使用MongoDB来存储实时的监控数据和历史信息")])]),s._v(" "),t("tr",[t("td",[s._v("dashboard")]),s._v(" "),t("td",[s._v("是用python开发的一个ceph的监控面板，用来监控ceph的运行状态。同时提供REST API来访问状态数据，该插件必须安装在mgr节点上。")])])])]),s._v(" "),t("p",[s._v("查看模块相关的命令")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查与模块相关的功能\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph mgr "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("help "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" grep module\nmgr module disable <module>                               disable mgr module\nmgr module enable <module> "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("force"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("                      enable mgr module\nmgr module "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("                                             list active mgr modules\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看模块功能\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph mgr module "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"always_on_modules"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"balancer"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"crash"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"devicehealth"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"orchestrator_cli"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"progress"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"rbd_support"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"status"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"volumes"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"enabled_modules"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"iostat"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"restful"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"disabled_modules"')]),s._v(":\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"alerts"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("p",[s._v("部署dashboard模块")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("默认情况下，ceph是没有dashboard模块的\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph mgr module "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" grep dashboard\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("在所有的mgr节点上部署dashoard模块\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" i in mon01 mon02\n> "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n> ssh cephadm@"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$i")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sudo yum install ceph-mgr-dashboard -y"')]),s._v("\n> done\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("确认ceph集群是否启动了dashboard的模块\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph mgr module "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" grep dashboard                          "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dashboard"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n")])])]),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("启用dashboard")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("启用dashboard模块\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph mgr module enable dashboard\n\n查看已经启用的功能模块\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph mgr module "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" grep "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("A4 "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"enabled_modules"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"enabled_modules"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dashboard"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"iostat"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"restful"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n")])])]),t("p",[s._v("查看状态")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("关闭dashboard的tls功能\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph config "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" mgr mgr/dashboard/ssl false\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("确认dashboard的服务效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph mgr services\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dashboard"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"http://stor01.superopsmsb.com:8080/"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n查看服务器启动端口\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" i in mon01 mon02"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v(" ssh cephadm@"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$i")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sudo netstat -tnulp | grep 8080"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" done\ntcp6       0      0 :::8080       :::"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("       LISTEN      1963/ceph-mgr\ntcp6       0      0 :::8080       :::"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("       LISTEN      1903/ceph-mgr\n")])])]),t("p",[s._v("配置模块")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("配置dashboard监听的mon节点地址和端⼝：\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph config "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" mgr mgr/dashboard/mon01/server_addr 10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("13 \n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph config "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" mgr mgr/dashboard/mon01/server_port 8080\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph config "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" mgr mgr/dashboard/mon02/server_addr 10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("14 \n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph config "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" mgr mgr/dashboard/mon02/server_port 8080\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("重启mgr服务\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@mon01 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl restart ceph-mgr.target")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@mon02 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl restart ceph-mgr.target")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("再次确认监听端口的效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" i in mon01 mon02"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v(" ssh cephadm@"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$i")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sudo netstat -tnulp | grep 8080"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" done\ntcp        0      0 10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("13:8080   0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("    LISTEN      2549/ceph-mgr\ntcp        0      0 10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("14:8080   0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("    LISTEN      2211/ceph-mgr\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("浏览器访问：10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("13:8080 或者 10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("14:8080 查看效果\n")])])]),t("p",[t("img",{attrs:{src:"image/image-20221013195313762.png",alt:"image-20221013195313762"}})]),s._v(" "),t("p",[s._v("设定登录密码")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("设定登录的用户名和密码\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"12345678"')]),s._v(" >> dashboard_passwd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("txt\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph dashboard "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set-login")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("credentials admin "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("i dashboard_passwd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("txt\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("          WARNING: this command is deprecated"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("              "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" Please use the "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ac")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("user-"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" related commands to manage users"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("\nUsername and password updated\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("使用用户"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("admin"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("和密码"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("12345678"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("浏览器登录dashboard的效果\n")])])]),t("p",[t("img",{attrs:{src:"image/image-20221013195513390.png",alt:"image-20221013195513390"}})]),s._v(" "),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-3-2-tls实践"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-2-tls实践"}},[s._v("#")]),s._v(" 1.3.2 tls实践")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("简介")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t如果我们希望ceph具有更加安全的访问能力的话，我们可以为dashboard能力提供tls能力。对于ceph来说，它的tls能力主要有两种方式：\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 使用默认的tls能力\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 使用自签证书实现tls能力\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("注意：\n\t对于tls能力来说，我们需要提前对于ceph启用tls的功能\n\tceph config "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" mgr mgr/dashboard/ssl true\n")])])]),t("p",[s._v("基本步骤")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("方法1：使用默认的tls能力\n\tceph dashboard create-self-signed-cert\n方法2：使用自签证书实现tls能力\n\topenssl req "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("new "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("nodes "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("x509 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("subj "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/O=IT/CN=ceph.superopsmsb.com"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("days 3650 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("keyout dashboard"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("key "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("out dashboard"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("crt "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("extensions v3_ca\n\n配置dashboard加载证书\nceph config-key "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" mgr mgr/dashboard/crt "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("i dashboard"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("crt \nceph config-key "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" mgr mgr/dashboard/key "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("i dashboard"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("key\n")])])]),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("使用自动生成证书")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("重启模块\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ mkdir tls && cd tls\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin tls]")]),s._v("$ ceph mgr module disable dashboard\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin tls]")]),s._v("$ ceph mgr module enable dashboard\n\n启用tls服务\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin tls]")]),s._v("$ ceph config "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" mgr mgr/dashboard/ssl true\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("生成自签证书\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin tls]")]),s._v("$ ceph dashboard create-self-signed-cert\nSelf-signed certificate created\n\n创建 web 登录用户密码\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin tls]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"12345678"')]),s._v(" >> dashboard_passwd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("txt\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin tls]")]),s._v("$ ceph dashboard "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set-login")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("credentials admin "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("i dashboard_passwd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("txt\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("重启mgr服务\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@mon01 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl restart ceph-mgr.target")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@mon02 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl restart ceph-mgr.target")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("再次确认监听端口的效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin tls]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" i in mon01 mon02"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v(" ssh cephadm@"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$i")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sudo netstat -tnulp | grep ceph-mgr"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" done\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\ntcp        0      0 10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("13:8443    0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("     LISTEN      3093/ceph-mgr\ntcp        0      0 10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("14:8443    0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("     LISTEN      2491/ceph-mgr\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("使用用户"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("admin"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("和密码"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("12345678"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("浏览器访问：https:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("13:8443 或者 https:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("14:8443 查看效果\n")])])]),t("p",[t("img",{attrs:{src:"image/image-20221013201943746.png",alt:"image-20221013201943746"}})]),s._v(" "),t("p",[s._v("使用自签名证书")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("重启模块\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin tls]")]),s._v("$ ceph mgr module disable dashboard\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin tls]")]),s._v("$ ceph mgr module enable dashboard\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("生成自签证书\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin tls]")]),s._v("$ openssl req "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("new "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("nodes "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("x509 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("subj "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/O=IT/CN=ceph.superopsmsb.com"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("days 3650 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("keyout dashboard"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("key "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("out dashboard"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("crt "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("extensions v3_ca\nGenerating a 2048 bit RSA private key\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v("\nwriting new private key to "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'dashboard.key'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("\n查看效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin tls]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("\ndashboard"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("crt  dashboard"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("key  dashboard_passwd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("txt\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("应用自签证书\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin tls]")]),s._v("$ ceph config-key "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" mgr mgr/dashboard/crt "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("i dashboard"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("crt \n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin tls]")]),s._v("$ ceph config-key "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" mgr mgr/dashboard/key "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("i dashboard"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("key\n\n创建 web 登录用户密码\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin tls]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"12345678"')]),s._v(" >> dashboard_passwd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("txt\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin tls]")]),s._v("$ ceph dashboard "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set-login")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("credentials admin-openssl "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("i dashboard_passwd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("txt\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("          WARNING: this command is deprecated"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("              "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" Please use the "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ac")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("user-"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" related commands to manage users"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("\nUsername and password updated\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("宿主机hosts 文件定制\n10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("13 ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("superopsmsb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("使用用户"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("admin-openssl"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("和密码"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("12345678"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("浏览器访问 https:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("superopsmsb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com:8443 效果：\n")])])]),t("p",[t("img",{attrs:{src:"image/image-20221013203249531.png",alt:"image-20221013203249531"}})]),s._v(" "),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-3-3-rgw实践"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-3-rgw实践"}},[s._v("#")]),s._v(" 1.3.3 RGW实践")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("简介")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\tceph的dashboard很多都是可以直接使用的，但是对于 rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("cephfs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("iscsi"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("监控等功能，需要基于手工方式启用功能。\n")])])]),t("p",[t("img",{attrs:{src:"image/image-20221013204353270.png",alt:"image-20221013204353270"}})]),s._v(" "),t("p",[s._v("准备rgw环境")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看rgw的效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("s "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" grep rgw\n    rgw: 1 daemon active "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("stor04"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("用户准备")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建专属的用户信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ radosgw-admin user create "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("uid=rgw "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("display-name=rgw "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("system\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user_id"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"rgw"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"keys"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"rgw"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"access_key"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"NAS972R98010Q2HUYW1F"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"secret_key"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"AvQO7AepS0017A75ClRAZxkhFmzFwXxahkyQFHdX"')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    \n确认效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ radosgw-admin user info "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("uid=rgw\n")])])]),t("p",[s._v("为Dashboard设置access_key 和 secret_key")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("注意：ceph的rgw属性定制是使用文件方式来实现\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("定制access-key认证信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'NAS972R98010Q2HUYW1F'")]),s._v(" > access-key"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("file\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph dashboard "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set-rgw")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("api-access-key "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("i access-key"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("file\nOption RGW_API_ACCESS_KEY updated\n\n定制secret_key认证信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'AvQO7AepS0017A75ClRAZxkhFmzFwXxahkyQFHdX'")]),s._v(" > secret_key"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("file\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph dashboard "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set-rgw")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("api-secret-key "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("i secret_key"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("file\nOption RGW_API_SECRET_KEY updated\n")])])]),t("p",[s._v("重启mgr服务")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@mon01 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl restart ceph-mgr.target")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@mon02 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl restart ceph-mgr.target")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看dashboard的RGW效果\n")])])]),t("p",[t("img",{attrs:{src:"image/image-20221013210433473.png",alt:"image-20221013210433473"}})]),s._v(" "),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-3-4-nfs实践"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-4-nfs实践"}},[s._v("#")]),s._v(" 1.3.4 NFS实践")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("简介")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\tceph的dashboard很多都是可以直接使用的，但是对于 rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("nfs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("iscsi"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("监控等功能，需要基于手工方式启用功能。自从Ceph 的J版本开始，ceph引入了 nfs-ganesha软件，ganesha通过rgw和cephfs两种方式实现ceph以nfs的方式实现外部功能访问。从Ceph Nautilus版本开始，Ceph Dashboard中可以直接支持配置这两种方式的NFS。\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" FSAL_RGW 调用librgw2将NFS协议转义为S3协议再通过RGW存入到Ceph中\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" FSAL_CEPH 调用libcephfs2将NFS转义为Cephfs协议再存入到Ceph 中\n")])])]),t("p",[t("img",{attrs:{src:"image/image-20221013211051686.png",alt:"image-20221013211051686"}})]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("参考资料：\n\thttps:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("docs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com/en/latest/cephfs/nfs/"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#nfs")]),s._v("\n")])])]),t("p",[s._v("我们以stor04主机为ganesha节点")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看是否安装librgw2和libcephfs2软件包\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rpm -qa |grep librgw")]),s._v("\nlibrgw2-14"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("22-0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("el7"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("x86_64\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rpm -qa |grep libcephfs")]),s._v("\nlibcephfs2-14"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("22-0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("el7"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("x86_64\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("定制软件源\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" >> "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/yum"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("repos"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("d/nfs-ganesha"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("repo<< eof\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[nfs-ganesha]")]),s._v("\nname=nfs-ganesha\nbaseurl=http:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("us-west"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com/nfs-ganesha/rpm-V2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("7-stable/nautilus/x86_64/\nenabled=1\npriority=1\neof\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("部署ganesha服务\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum install nfs-ganesha nfs-ganesha-ceph nfs-ganesha-rgw -y")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("启动服务\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl start nfs-ganesha.service")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl status nfs-ganesha.service")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl enable nfs-ganesha.service")]),s._v("\n")])])]),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("定制存储池")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("新建 ganesha_data的pool，用来存放一些dashboard的nfs相关配置文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph osd pool create ganesha_data 16 16\npool "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'ganesha_data'")]),s._v(" created\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("新建空的daemon"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("txt文本文件。\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$  touch daemon"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("txt\n\n导入daemon文件到ganesha_data pool中\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ rados "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p ganesha_data put conf-stor04"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("localdomain daemon"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("txt\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("注意事项：\n\t存入rados的文件名必须要是conf-<daemon_id>格式，其中<daemon_id>对应于运行此服务的节点名称。\n\t后续Dashboard创建NFS后，conf-<daemon_id>会有内容，每个conf-<daemon_id>都包含指向NFS-Ganesha守护程序应服务的导出的RADOS URL。\n\t\t格式为："),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v("url rados:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("<pool_name>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("<namespace>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("export-<id>\n\tconf-<daemon_id>和export-<id>对象必须存储在同一个RADOS池"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("命名空间\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("确认效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ rados "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p ganesha_data "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("\nconf-mon02"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("localdomain\nconf-mon03"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("localdomain\nconf-mon01"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("localdomain\n")])])]),t("p",[s._v("确定rgw认证信息")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看当前Ceph节点的rgw认证信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph auth get client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("stor04\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[client.rgw.stor04]")]),s._v("\n        key = AQCkOEJj/uBgIRAALPAxf3NIp0EbGiCDgLegig==\n        caps mon = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow rw"')]),s._v("\n        caps osd = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow rwx"')]),s._v("\nexported keyring "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("stor04\n")])])]),t("p",[s._v("配置ganesha配置文件")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("修改所有rgw节点上的ganesha配置文件 \n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /etc/ganesha/ganesha.conf")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 定制rados的连接配置")]),s._v("\nRADOS_URLS "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    ceph_conf = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/etc/ceph/ceph.conf"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    Userid = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"admin"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    watch_url = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"rados://ganesha_data/conf-stor04.localdomain"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v("url rados:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("ganesha_data/conf-stor04"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("localdomain\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 定制rgw的连接配置")]),s._v("\nRGW "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        ceph_conf = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/etc/ceph/ceph.conf"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        name = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"client.rgw.stor04.localdomain"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        cluster = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ceph"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("配置解析：\n\tRADOS_URLS 定制rados的连接配置\n\t\twatch_url 指定rados的专属文件地址\n\tRGW 定制rgw的连接配置\n\t\tname 定制rgw的专属认证账户信息\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("重启ganesha服务\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 /etc/ceph]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl restart nfs-ganesha")]),s._v("\n")])])]),t("p",[s._v("启用NFS-Ganesha能力")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("设定dashboard的nfs配置所在位置\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph dashboard "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set-ganesha")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("clusters-rados-pool-namespace ganesha_data\nOption GANESHA_CLUSTERS_RADOS_POOL_NAMESPACE updated\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("重启mgr服务\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@mon01 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl restart ceph-mgr.target")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@mon02 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl restart ceph-mgr.target")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("重新查看Dashboard的NFS功能效果\n")])])]),t("p",[t("img",{attrs:{src:"image/image-20221013222600422.png",alt:"image-20221013222600422"}})]),s._v(" "),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h2",{attrs:{id:"_1-4-监控"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-监控"}},[s._v("#")]),s._v(" 1.4 监控")]),s._v(" "),t("h3",{attrs:{id:"_1-4-1-prom基础"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-1-prom基础"}},[s._v("#")]),s._v(" 1.4.1 prom基础")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、术语解析、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("软件简介")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("    Prometheus 作为生态圈 Cloud Native Computing Foundation（CNCF）中的重要一员\n\n    Prometheus 本身基于Go语言开发的一套开源的系统监控报警框架和时序列数据库"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("TSDB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("。它启发于 Google 的 borgmon 监控系统，在一定程度上可以理解为，Google BorgMon监控系统的开源版本。\n    该软件由工作在 SoundCloud 的 google 前员工在 2012 年创建，作为社区开源项目进行开发，并于 2015 年正式发布。2016 年，Prometheus 正式加入 Cloud Native Computing Foundation，随着容器技术的迅速发展，Kubernetes 已然成为大家追捧的容器集群管理系统。其活跃度仅次于 Kubernetes的开源项目"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 现已广泛用于容器集群的监控系统中，当然不仅限于容器集群。。\n    Prometheus功能更完善、更全面，性能也足够支撑上万台规模的集群。\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("网站：https:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("prometheus"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("io/\ngithub：https:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("github"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com/prometheus\n最新版本：2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("39"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("1 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" 2022-10-07\n")])])]),t("p",[s._v("prometheus的架构效果图如下：")]),s._v(" "),t("p",[t("img",{attrs:{src:"image/1.1.3-2.png",alt:"architecture"}})]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\t从上图可以看出，Prometheus 的主要模块包括：Prometheus server, exporters, Pushgateway, PromQL, Alertmanager 以及图形界面。\n")])])]),t("p",[s._v("其大概的工作流程是：")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",[t("code",[s._v("1 Prometheus server 定期从配置好的 jobs 或者 exporters 中拉 metrics，或者接收来自 Pushgateway 发过来的 metrics，或者从其他的 Prometheus server 中拉 metrics。\n2 Prometheus server 在本地存储收集到的 metrics，并运行已定义好的 alert.rules，记录新的时间序列或者向 Alertmanager 推送警报，实现一定程度上的完全冗余功能。\n3 Alertmanager 根据配置文件，对接收到的警报进行去重分组，根据路由配置，向对应主机发出告警。\n4 集成Grafana或其他API作为图形界面，用于可视化收集的数据。\n")])])]),t("p",[s._v("Prometheus 由几个主要的软件组件组成，其职责概述如下。")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("组件")]),s._v(" "),t("th",[s._v("解析")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("Prometheus Server")]),s._v(" "),t("td",[s._v("彼此独立运行，仅依靠其本地存储来实现其核心功能：抓取时序数据，规则处理和警报等。")])]),s._v(" "),t("tr",[t("td",[s._v("Client Library")]),s._v(" "),t("td",[s._v("客户端库，为需要监控的服务生成相应的 metrics 并暴露给 Prometheus server。当 Prometheus server 来 pull 时，直接返回实时状态的 metrics。")])]),s._v(" "),t("tr",[t("td",[s._v("Push Gateway")]),s._v(" "),t("td",[s._v("主要用于短期的 jobs。由于这类 jobs 存在时间较短，可能在 Prometheus 来 pull 之前就消失了。为此，这次 jobs 可以直接向 Prometheus server 端推送它们的 metrics。这种方式主要用于服务层面的 metrics，对于机器层面的 metrices，需要使用 node exporter。")])]),s._v(" "),t("tr",[t("td",[s._v("Exporters")]),s._v(" "),t("td",[s._v("部署到第三方软件主机上，用于暴露已有的第三方服务的 metrics 给 Prometheus。")])]),s._v(" "),t("tr",[t("td",[s._v("Alertmanager")]),s._v(" "),t("td",[s._v("从 Prometheus server 端接收到 alerts 后，会进行去除重复数据，分组，并路由到对应的接受方式，以高效向用户完成告警信息发送。常见的接收方式有：电子邮件，pagerduty，OpsGenie, webhook 等,一些其他的工具。")])]),s._v(" "),t("tr",[t("td",[s._v("Data Visualization")]),s._v(" "),t("td",[s._v("Prometheus Web UI （Prometheus Server内建），及Grafana等")])]),s._v(" "),t("tr",[t("td",[s._v("Service Discovery")]),s._v(" "),t("td",[s._v("动态发现待监控的Target，从而完成监控配置的重要组件，在容器化环境中尤为有用；该组件目前由Prometheus Server内建支持；")])])])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",[t("code",[s._v("在上诉的组件中，大多数都是用Go编写的，因此易于构建和部署为静态二进制文件。\n")])])]),t("p",[t("strong",[s._v("术语解析")])]),s._v(" "),t("p",[s._v("metrics")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\tPrometheus中存储的数据为时间序列，即基于同一度量标准或者同一时间维度的数据流。除了时间序列数据的正常存储之外，Prometheus还会基于原始数据临时生成新的时间序列数据，用于后续查询的依据或结果。\n\t每个时间序列都由metric名称和标签"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("可选键值对"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("组合成唯一标识。\n\t\n\t查询语言允许基于这些维度进行过滤和聚合。更改任何标签值，包括添加或删除标签，都会创建一个新的时间序列。\n")])])]),t("p",[t("img",{attrs:{src:"image/image-20211013134435251.png",alt:"image-20211013134435251"}})]),s._v(" "),t("p",[s._v("数据获取")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t这些metric数据，是基于HTTP call方式来进行获取的，从对方的配置文件中指定的网络端点"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("endpoint"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("上周期性获取指标数据。每一个端点上几乎不可能只有一个数据指标。\n\t用Prometheus术语来说，一个单独 scrape"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("host:port"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("的目标称为instance，通常对应于单个进程。 一组同种类型的 instances集合称为jobs，主要用于保证可扩展性和可靠性。\n")])])]),t("p",[t("img",{attrs:{src:"image/image-20211013111443902.png",alt:"image-20211013111443902"}})]),s._v(" "),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-4-2-prom部署"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-2-prom部署"}},[s._v("#")]),s._v(" 1.4.2 prom部署")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 prometheus部署、grafana部署、exporter部署、小结 四个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("prometheus部署")])]),s._v(" "),t("p",[s._v("准备工作")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建软件目录\nmkdir "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("server"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("softs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p\ncd "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("softs\n\n注意：\n\t以上所有的prometheus软件都去https:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("prometheus"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("io/download/网站下载。\n\thttps:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("github"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com/prometheus/prometheus/releases/download/v2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("39"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("1/prometheus-2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("39"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("linux-amd64"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("tar"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("gz\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("解压软件\ntar xf prometheus-2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("39"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("linux-amd64"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("tar"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("gz "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("C "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("server/\ncd "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("server\nln "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("s "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("server/prometheus-2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("39"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("linux-amd64 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("server/prometheus\n")])])]),t("p",[s._v("安装软件")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("配置准备\nmkdir "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("server/prometheus/"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("cfg"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("logs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("bin"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p\ncd "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("server/prometheus\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" prometheus promtool bin/\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" prometheus"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yml cfg/\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("环境变量定制\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /etc/profile.d/prometheus.sh ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#!/bin/bash")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# set prometheus env")]),s._v("\nexport PROMETHEUS_HOME="),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("server/prometheus\nexport PATH="),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$PATH")]),s._v(":$"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("PROMETHEUS_HOME"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("bin\n\n应用环境变量文件\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# source /etc/profile.d/prometheus.sh ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# chmod +x /etc/profile.d/prometheus.sh")]),s._v("\n")])])]),t("p",[s._v("服务定制")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("定制prometheus服务文件\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /usr/lib/systemd/system/prometheus.service")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[Unit]")]),s._v("\nDescription=prometheus server project\nAfter=network"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("target\n\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[Service]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Type")]),s._v("=simple\nExecStart="),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("server/prometheus/bin/prometheus "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("config"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("file="),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("server/prometheus/cfg/prometheus"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yml "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("storage"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("tsdb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("path="),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("server/prometheus/"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v("\nRestart=on-failure\n\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[Install]")]),s._v("\nWantedBy=multi-user"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("target\n\n配置解析：\n\t在这里，我们需要将定制的prometheus的配置文件和数据目录作为启动参数配置好\n\t其它的参数，我们可以基于prometheus "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("help 查看更多\n\t\n启动服务\nsystemctl daemon-reload\nsystemctl "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("start")]),s._v(" prometheus"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("service\nsystemctl status prometheus"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("service\nsystemctl enable prometheus"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("service\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("检查效果\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# netstat -tnulp | egrep 'Pro|pro'")]),s._v("\nProto Recv-Q "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Send-Q")]),s._v(" Local Address           Foreign Address         State       PID/Program name    \ntcp6       0      0 :::9090                 :::"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("                    LISTEN      25082/prometheus \n结果显示：\n\t可以看到当前主机上可以看到一个端口9090，我们可通过可以看到prometheus的服务页面\n\t\n浏览器访问 http:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("18:9090/，查看效果\n")])])]),t("p",[t("img",{attrs:{src:"image/image-20221013232913546.png",alt:"image-20221013232913546"}})]),s._v(" "),t("p",[t("strong",[s._v("grafana部署")])]),s._v(" "),t("p",[s._v("准备工作")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建软件目录\ncd "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("softs\nwget https:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("dl"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("grafana"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com/enterprise/release/grafana-enterprise-9"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0-1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("x86_64"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rpm\n注意：\n\tgrafana软件从 https:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("grafana"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com/grafana/download 下载\n")])])]),t("p",[s._v("安装软件")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("安装软件\nsudo yum install grafana-enterprise-9"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0-1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("x86_64"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rpm\n注意：\n\t这里安装的是本地文件，所以要加文件路径\n\n安装插件\ngrafana-"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cli")]),s._v(" plugins list-remote\ngrafana-"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cli")]),s._v(" plugins install grafana-piechart-panel\ngrafana-"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cli")]),s._v(" plugins "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("\n\n启动服务\nsystemctl daemon-reload\nsystemctl "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("start")]),s._v(" grafana-server"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("service\nsystemctl status grafana-server"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("service\nsystemctl enable grafana-server"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("service\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("检查效果\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# netstat -tnulp | egrep 'Pro|gra'")]),s._v("\nProto Recv-Q "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Send-Q")]),s._v(" Local Address           Foreign Address         State       PID/Program name    \ntcp6       0      0 :::3000                 :::"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("                    LISTEN      25839/grafana-serve \n结果显示：\n\t当前主机上出现了一个端口3000\n\t\n浏览器访问 http:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("18:3000/，查看效果\n")])])]),t("p",[t("img",{attrs:{src:"image/image-20221013233232284.png",alt:"image-20221013233232284"}})]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("输入用户名和密码：admin/admin，就会进入到更改密码的页面，重置过密码后，查看效果\n")])])]),t("p",[t("img",{attrs:{src:"image/image-20221013233326269.png",alt:"image-20221013233326269"}})]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("添加数据源: 点击 "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Add your data source"')]),s._v(" 选择 "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Prometheus"')]),s._v(" 出现添加界面\n")])])]),t("p",[t("img",{attrs:{src:"image/image-20221013233442609.png",alt:"image-20221013233442609"}})]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("点击最下面的 save & test\n")])])]),t("p",[t("strong",[s._v("exporter部署")])]),s._v(" "),t("p",[s._v("准备工作")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("解压软件\ncd "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("softs\ntar xf node_exporter-1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("4"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("linux-amd64"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("tar"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("gz "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("C "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("server/\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("配置命令\nln "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("s "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("server/node_exporter-1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("4"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("linux-amd64 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("server/node_exporter\nmkdir "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("server/node_exporter/bin\ncd "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("server/node_exporter\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" node_exporter bin/\n\n配置环境变量\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /etc/profile.d/node_exporter.sh")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#!/bin/bash")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# set node_exporter env")]),s._v("\nexport PROMETHEUS_HOME="),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("server/node_exporter\nexport PATH="),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$PATH")]),s._v(":$"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("PROMETHEUS_HOME"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("bin\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("服务文件\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /usr/lib/systemd/system/node_exporter.service")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[Unit]")]),s._v("\nDescription=node exporter project\nAfter=network"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("target\n\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[Service]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Type")]),s._v("=simple\nExecStart="),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("server/node_exporter/bin/node_exporter\nRestart=on-failure\n\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[Install]")]),s._v("\nWantedBy=multi-user"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("target\n\n启动服务\nsystemctl daemon-reload\nsystemctl "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("start")]),s._v(" node_exporter"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("service\nsystemctl status node_exporter"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("service\nsystemctl enable node_exporter"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("service\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("检查效果\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# netstat -tnulp | egrep 'Pro|node'    ")]),s._v("\nProto Recv-Q "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Send-Q")]),s._v(" Local Address           Foreign Address         State       PID/Program name    \ntcp6       0      0 :::9100                 :::"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("                    LISTEN      24650/node_exporter \n结果显示：\n\t可以看到当前主机上可以看到一个端口9100\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("访问http:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("18:9100/metrics 就可以看到node export所在节点的所有定制好的监控项。\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 /data/server/node_exporter]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl -s http://10.0.0.18:9100/metrics | head")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# TYPE go_gc_duration_seconds summary")]),s._v("\ngo_gc_duration_seconds"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("quantile="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("000104469\ngo_gc_duration_seconds"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("quantile="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0.25"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("000104469\n")])])]),t("p",[s._v("环境集成")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("编辑prometheus配置文件\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim /data/server/prometheus/cfg/prometheus.yml")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nscrape_configs:\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" job_name: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'node_exporter'")]),s._v("\n    static_configs:\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" targets: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'10.0.0.12:9100'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    \n    属性解析：\n        新增一个job_name 和 static_configs的属性\n        targets 就是我们在基本概念中讲到的instance，格式就是"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ip:port"')]),s._v("\n        \n重启服务        \nsystemctl restart prometheus"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("service    \n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("浏览器访问 http:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("18:9090/targets 就可以看到node_exporter已经被prometheus加载到监控中了，效果如下\n")])])]),t("p",[t("img",{attrs:{src:"image/image-20221013234058265.png",alt:"image-20221013234058265"}})]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("登录到Grafana界面，点击左侧边栏"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"+"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("选择"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"import"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("在dashboard的输入框中输入 https:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("grafana"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com/dashboards/8919"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("查看效果\n")])])]),t("p",[t("img",{attrs:{src:"image/image-20221013234413884.png",alt:"image-20221013234413884"}})]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("点击完 load后，在当前界面的下方找到数据集 prometheus，最后点击 import，效果如下\n")])])]),t("p",[t("img",{attrs:{src:"image/image-20221013234455785.png",alt:"image-20221013234455785"}})]),s._v(" "),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-4-3-ceph监控"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-3-ceph监控"}},[s._v("#")]),s._v(" 1.4.3 ceph监控")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("简介")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\tCeph Manager内置了众多模块，包括prometheus模块，⽤于直接输出Prometheus⻛格的指标数据。我们只需要开启该功能即可，Prometheus模块默认监听于TCP协议的9283端⼝。\n")])])]),t("p",[s._v("开启ceph的prometheus模块")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("开启ceph的监听模块\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph mgr module enable prometheus\n\n查看模块效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph mgr module "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"enabled_modules"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dashboard"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"iostat"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nfs"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"prometheus"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"restful"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\n检查mgr的暴露端口\nroot@mon02:~"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# netstat -tnulp | grep mgr")]),s._v("\ntcp        0      0 10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("14:8443          0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("    LISTEN      8111/ceph-mgr\ntcp6       0      0 :::9283                 :::"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("         LISTEN      8111/ceph-mgr\n")])])]),t("p",[s._v("配置prometheus的监控配置")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim /data/server/prometheus/cfg/prometheus.yml")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nscrape_configs:\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" job_name: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'ceph'")]),s._v("\n    static_configs:\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" targets: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'10.0.0.13:9283'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    \n    属性解析：\n        新增一个job_name 和 static_configs的属性\n        targets 就是我们在基本概念中讲到的instance，格式就是"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ip:port"')]),s._v("\n        \n重启服务        \nsystemctl restart prometheus"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("service    \n\n浏览器访问 http:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("18:9090/targets 就可以看到node_exporter已经被prometheus加载到监控中了，效果如下\n")])])]),t("p",[t("img",{attrs:{src:"image/image-20221013235206075.png",alt:"image-20221013235206075"}})]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("登录到Grafana界面，点击左侧边栏"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"+"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("选择"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"import"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("在dashboard的输入框中输入 https:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("grafana"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com/dashboards/2842"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("查看效果\n")])])]),t("p",[t("img",{attrs:{src:"image/image-20221013235316552.png",alt:"image-20221013235316552"}})]),s._v(" "),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h2",{attrs:{id:"_1-5-k8s实践"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-5-k8s实践"}},[s._v("#")]),s._v(" 1.5 k8s实践")]),s._v(" "),t("h3",{attrs:{id:"_1-5-1-基础环境"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-5-1-基础环境"}},[s._v("#")]),s._v(" 1.5.1 基础环境")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 集群规划、主机认证、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("集群规划")])]),s._v(" "),t("p",[s._v("简介")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("在这里，我们以单主分布式的主机节点效果来演示kubernetes的最新版本的集群环境部署。\n")])])]),t("p",[t("img",{attrs:{src:"image/image-20220715092558666.png",alt:"image-20220715092558666"}})]),s._v(" "),t("p",[s._v("节点集群组件规划")]),s._v(" "),t("p",[t("img",{attrs:{src:"image/image-20220715093007357.png",alt:"image-20220715093007357"}})]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("master节点\n\tkubeadm"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("集群环境"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("、kubectl"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("集群管理"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("、kubelet"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("节点状态"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\tkube-apiserver、kube-controller-manager、kube-scheduler、etcd\n\tcontainerd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("docker方式部署"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("、flannel"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("插件部署"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nnode节点\n\tkubeadm"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("集群环境"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("、kubelet"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("节点状态"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\tkube-proxy、containerd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("docker方式部署"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("、flannel"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("插件部署"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),t("p",[s._v("主机名规划")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("序号")]),s._v(" "),t("th",[s._v("主机ip")]),s._v(" "),t("th",[s._v("主机名规划")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("1")]),s._v(" "),t("td",[s._v("10.0.0.19")]),s._v(" "),t("td",[s._v("kubernetes-master.superopsmsb.com  kubernetes-master")])]),s._v(" "),t("tr",[t("td",[s._v("2")]),s._v(" "),t("td",[s._v("10.0.0.20")]),s._v(" "),t("td",[s._v("kubernetes-node1.superopsmsb.com  kubernetes-node1")])]),s._v(" "),t("tr",[t("td",[s._v("3")]),s._v(" "),t("td",[s._v("10.0.0.21")]),s._v(" "),t("td",[s._v("kubernetes-node2.superopsmsb.com  kubernetes-node2")])])])]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("修改master节点主机的hosts文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@localhost ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /etc/hosts")]),s._v("\n10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("19 kubernetes-master"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("superopsmsb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com kubernetes-master\n10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("20 kubernetes-node1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("superopsmsb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com  kubernetes-node1\n10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("21 kubernetes-node2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("superopsmsb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com  kubernetes-node2\n")])])]),t("p",[t("strong",[s._v("主机认证")])]),s._v(" "),t("p",[s._v("简介")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t因为整个集群节点中的很多文件配置都是一样的，所以我们需要配置跨主机免密码认证方式来定制集群的认证通信机制，这样后续在批量操作命令的时候，就非常轻松了。\n")])])]),t("p",[s._v("脚本内容")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@localhost ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /data/scripts/01_remote_host_auth.sh")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#!/bin/bash")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 功能: 批量设定远程主机免密码认证")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 版本: v0.2")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 作者: 书记")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 联系: superopsmsb.com")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 准备工作")]),s._v("\nuser_dir="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/root'")]),s._v("\nhost_file="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/etc/hosts'")]),s._v("\nlogin_user="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'root'")]),s._v("\nlogin_pass="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'123456'")]),s._v("\ntarget_type="),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("部署 免密 同步 主机名 退出"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 菜单")]),s._v("\nmenu"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("e "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"\\e[31m批量设定远程主机免密码认证管理界面\\e[0m"')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"====================================================="')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("e "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"\\e[32m 1: 部署环境   2: 免密认证   3: 同步hosts \\e[0m"')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("e "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"\\e[32m 4: 设定主机名 5：退出操作 \\e[0m"')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"====================================================="')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# expect环境")]),s._v("\nexpect_install"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("usr/bin/expect "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  then\n     "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("e "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"\\e[33mexpect环境已经部署完毕\\e[0m"')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v("\n     yum install expect "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("y >> "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("dev/null 2>&1 && "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("e "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"\\e[33mexpect软件安装完毕\\e[0m"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("e "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"\\e[33mexpect软件安装失败\\e[0m"')]),s._v(" && "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("exit")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  fi\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 秘钥文件生成环境")]),s._v("\ncreate_authkey"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 保证历史文件清空")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("d $"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("user_dir"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ssh "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" && "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("rf $"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("user_dir"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ssh/"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 构建秘钥文件对")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("usr/bin/ssh-keygen "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("t rsa "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("P "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f $"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("user_dir"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ssh/id_rsa\n  "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("e "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"\\e[33m秘钥文件已经创建完毕\\e[0m"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# expect自动匹配逻辑")]),s._v("\nexpect_autoauth_func"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 接收外部参数")]),s._v("\n  command="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"$@"')]),s._v("\n  expect "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("c "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"\n    spawn ${command}\n    expect {\n      \\"')]),s._v("yes/no\\"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('" {send \\"')]),s._v("yes\\r\\"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"; exp_continue}\n      \\"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("password*\\"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('" {send \\"')]),s._v("$"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("login_pass"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\\r\\"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"; exp_continue}\n      \\"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("password*\\"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('" {send \\"')]),s._v("$"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("login_pass"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\\r\\"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"}\n   }"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 跨主机传输文件认证")]),s._v("\nsshkey_auth_func"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 接收外部的参数")]),s._v("\n  local host_list="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"$*"')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" ip in $"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("host_list"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /usr/bin/ssh-copy-id -i ${user_dir}/.ssh/id_rsa.pub root@10.0.0.12")]),s._v("\n     cmd="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/usr/bin/ssh-copy-id -i ${user_dir}/.ssh/id_rsa.pub"')]),s._v("\n     remote_host="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"${login_user}@${ip}"')]),s._v("\n     expect_autoauth_func $"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("cmd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" $"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("remote_host"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  done\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 跨主机同步hosts文件")]),s._v("\nscp_hosts_func"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 接收外部的参数")]),s._v("\n  local host_list="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"$*"')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" ip in $"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("host_list"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n     remote_host="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"${login_user}@${ip}"')]),s._v("\n     scp $"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("host_file"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" $"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("remote_host"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(":$"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("host_file"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  done\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 跨主机设定主机名规划")]),s._v("\nset_hostname_func"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 接收外部的参数")]),s._v("\n  local host_list="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"$*"')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" ip in $"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("host_list"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n     host_name=$"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("grep $"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("ip"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" $"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("host_file"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("awk "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{print $NF}'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n     remote_host="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"${login_user}@${ip}"')]),s._v("\n     ssh $"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("remote_host"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hostnamectl set-hostname ${host_name}"')]),s._v("\n  done\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 帮助信息逻辑")]),s._v("\nUsage"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"请输入有效的操作id"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 逻辑入口")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" true\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n  menu\n  read "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"请输入有效的操作id: "')]),s._v(" target_id\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" $"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#target_type[@]} -ge ${target_id} ]")]),s._v("\n  then\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" $"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("target_type"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("$"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("target_id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" == "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"部署"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    then\n       "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"开始部署环境操作..."')]),s._v("\n       expect_install\n       create_authkey\n    elif "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" $"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("target_type"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("$"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("target_id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" == "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"免密"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    then\n       read "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"请输入需要批量远程主机认证的主机列表范围(示例: {12..19}): "')]),s._v(" num_list\n       ip_list=$"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("eval "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("echo")]),s._v(" 10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$num_list")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n       "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"开始执行免密认证操作..."')]),s._v("\n       sshkey_auth_func $"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("ip_list"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    elif "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" $"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("target_type"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("$"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("target_id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" == "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"同步"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    then\n       read "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"请输入需要批量远程主机同步hosts的主机列表范围(示例: {12..19}): "')]),s._v(" num_list\n       ip_list=$"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("eval "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("echo")]),s._v(" 10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$num_list")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n       "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"开始执行同步hosts文件操作..."')]),s._v("\n       scp_hosts_func $"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("ip_list"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    elif "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" $"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("target_type"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("$"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("target_id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" == "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"主机名"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    then\n       read "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"请输入需要批量设定远程主机主机名的主机列表范围(示例: {12..19}): "')]),s._v(" num_list\n       ip_list=$"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("eval "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("echo")]),s._v(" 10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$num_list")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n       "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"开始执行设定主机名操作..."')]),s._v("\n       set_hostname_func $"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("ip_list"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    elif "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" $"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("target_type"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("$"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("target_id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" == "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"退出"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    then\n       "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"开始退出管理界面..."')]),s._v("\n       "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("exit")]),s._v("\n    fi\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v("\n    Usage\n  fi\ndone\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("为了更好的把环境部署成功，最好提前更新一下软件源信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@localhost ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum makecache")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看脚本执行效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@localhost ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /bin/bash /data/scripts/01_remote_host_auth.sh")]),s._v("\n批量设定远程主机免密码认证管理界面\n=====================================================\n 1: 部署环境   2: 免密认证   3: 同步hosts\n 4: 设定主机名 5：退出操作\n=====================================================\n请输入有效的操作id: 1\n开始部署环境操作"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nexpect环境已经部署完毕\nGenerating public/private rsa key pair"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nYour identification has been saved in "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("root/"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ssh/id_rsa"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nYour public key has been saved in "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("root/"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ssh/id_rsa"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pub"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nThe key fingerprint is:\nSHA256:u/Tzk0d9sNtG6r9Kx+6xPaENNqT3Lw178XWXQhX1yMw root@kubernetes-master\nThe key"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s randomart image is:\n+---[RSA 2048]----+\n|               .+|\n|             + o.|\n|              E .|\n|             o.  |\n|        S   +  +.|\n|         . . *=+B|\n|        o   o+B%O|\n|       . o. +.O+X|\n|        . .o.=+XB|\n+----[SHA256]-----+\n秘钥文件已经创建完毕\n批量设定远程主机免密码认证管理界面\n=====================================================\n 1: 部署环境   2: 免密认证   3: 同步hosts\n 4: 设定主机名 5：退出操作\n=====================================================\n请输入有效的操作id: 2\n请输入需要批量远程主机认证的主机列表范围(示例: {12..19}): {19..21}\n开始执行免密认证操作...\nspawn /usr/bin/ssh-copy-id -i /root/.ssh/id_rsa.pub root@10.0.0.19\n...\nNow try logging into the machine, with:   \"ssh '")]),s._v("root@10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("21'\"\nand check to make sure that only the key"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" you wanted were added"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\n批量设定远程主机免密码认证管理界面\n=====================================================\n 1: 部署环境   2: 免密认证   3: 同步hosts\n 4: 设定主机名 5：退出操作\n=====================================================\n请输入有效的操作id: 3\n请输入需要批量远程主机同步hosts的主机列表范围"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("示例: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("12"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("19"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("19"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("21"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n开始执行同步hosts文件操作"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nhosts                                    100%  470   226"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("5KB/s   00:00\nhosts                                    100%  470   458"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("8KB/s   00:00\nhosts                                    100%  470   533"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("1KB/s   00:00\n批量设定远程主机免密码认证管理界面\n=====================================================\n 1: 部署环境   2: 免密认证   3: 同步hosts\n 4: 设定主机名 5：退出操作\n=====================================================\n请输入有效的操作id: 4\n请输入需要批量设定远程主机主机名的主机列表范围"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("示例: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("12"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("19"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("19"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("21"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n开始执行设定主机名操作"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n批量设定远程主机免密码认证管理界面\n=====================================================\n 1: 部署环境   2: 免密认证   3: 同步hosts\n 4: 设定主机名 5：退出操作\n=====================================================\n请输入有效的操作id: 5\n开始退出管理界面"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("p",[s._v("检查效果")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@localhost ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# exec /bin/bash")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# for i in {19..21}")]),s._v("\n> "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n> name=$"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ssh root@10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$i")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hostname"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n> "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("echo")]),s._v(" 10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$i")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$name")]),s._v("\n> done\n10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("19 kubernetes-master\n10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("20 kubernetes-node1\n10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("21 kubernetes-node2\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-5-2-集群准备"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-5-2-集群准备"}},[s._v("#")]),s._v(" 1.5.2 集群准备")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 内核调整、软件源配置、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("内核调整")])]),s._v(" "),t("p",[s._v("简介")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("根据kubernetes官方资料的相关信息，我们需要对kubernetes集群是所有主机进行内核参数的调整。\n")])])]),t("p",[s._v("禁用swap")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t部署集群时，kubeadm默认会预先检查当前主机是否禁用了Swap设备，并在未禁用时强制终止部署过程。因此，在主机内存资源充裕的条件下，需要禁用所有的Swap设备，否则，就需要在后文的kubeadm init及kubeadm join命令执行时额外使用相关的选项忽略检查错误\n\n关闭Swap设备，需要分两步完成。\n首先是关闭当前已启用的所有Swap设备：\nswapoff "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("a\n        \n而后编辑"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/fstab配置文件，注释用于挂载Swap设备的所有行。\n方法一：手工编辑\nvim "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/fstab\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# UUID=0a55fdb5-a9d8-4215-80f7-f42f75644f69 none  swap    sw      0       0")]),s._v("\n\n方法二：\nsed "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("i "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/.*swap.*/#&/'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/fstab \n \t替换后位置的&代表前面匹配的整行内容\n注意：\n\t只需要注释掉自动挂载SWAP分区项即可，防止机子重启后swap启用\n\n内核"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("禁用swap"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("参数\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" >> "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/sysctl"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("d/k8s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf << EOF\nvm"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("swappiness=0\nEOF\nsysctl "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/sysctl"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("d/k8s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf\n")])])]),t("p",[s._v("网络参数")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("配置iptables参数，使得流经网桥的流量也经过iptables/netfilter防火墙\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" >> "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/sysctl"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("d/k8s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf << EOF\nnet"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("bridge"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("bridge-nf-call-ip6tables = 1\nnet"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("bridge"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("bridge-nf-call-iptables = 1\nnet"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ipv4"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ip_forward = 1\nEOF\n\n配置生效\nmodprobe br_netfilter\nmodprobe overlay\nsysctl "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/sysctl"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("d/k8s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("脚本方式\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@localhost ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /data/scripts/02_kubernetes_kernel_conf.sh")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#!/bin/bash")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 功能: 批量设定kubernetes的内核参数调整")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 版本: v0.1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 作者: 书记")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 联系: superopsmsb.com")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 禁用swap")]),s._v("\nswapoff "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("a\nsed "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("i "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/.*swap.*/#&/'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/fstab\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" >> "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/sysctl"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("d/k8s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf << EOF\nvm"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("swappiness=0\nEOF\nsysctl "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/sysctl"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("d/k8s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 打开网络转发")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" >> "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/sysctl"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("d/k8s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf << EOF\nnet"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("bridge"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("bridge-nf-call-ip6tables = 1\nnet"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("bridge"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("bridge-nf-call-iptables = 1\nnet"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ipv4"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ip_forward = 1\nEOF\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 加载相应的模块")]),s._v("\nmodprobe br_netfilter\nmodprobe overlay\nsysctl "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/sysctl"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("d/k8s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf\n")])])]),t("p",[s._v("脚本执行")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("master主机执行效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /bin/bash /data/scripts/02_kubernetes_kernel_conf.sh")]),s._v("\nvm"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("swappiness = 0\nvm"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("swappiness = 0\nnet"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("bridge"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("bridge-nf-call-ip6tables = 1\nnet"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("bridge"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("bridge-nf-call-iptables = 1\nnet"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ipv4"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ip_forward = 1\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("所有node主机执行效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# for i in 20 21;do ssh root@10.0.0.$i mkdir /data/scripts -p; scp /data/scripts/02_kubernetes_kernel_conf.sh root@10.0.0.$i:/data/scripts/02_kubernetes_kernel_conf.sh;ssh root@10.0.0.$i "/bin/bash /data/scripts/02_kubernetes_kernel_conf.sh";done')]),s._v("\n")])])]),t("p",[t("strong",[s._v("软件源配置")])]),s._v(" "),t("p",[s._v("简介")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t由于我们需要在多台主机上初始化kubernetes主机环境，所以我们需要在多台主机上配置kubernetes的软件源，以最简便的方式部署kubernetes环境。\n")])])]),t("p",[s._v("定制阿里云软件源")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("定制阿里云的关于kubernetes的软件源\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat > /etc/yum.repos.d/kubernetes.repo << EOF")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[kubernetes]")]),s._v("\nname=Kubernetes\nbaseurl=https:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("mirrors"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("aliyun"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com/kubernetes/yum/repos/kubernetes-el7-x86_64\nenabled=1\ngpgcheck=0\nrepo_gpgcheck=0\ngpgkey=https:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("mirrors"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("aliyun"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com/kubernetes/yum/doc/yum-key"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("gpg https:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("mirrors"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("aliyun"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com/kubernetes/yum/doc/rpm-package-key"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("gpg\nEOF\n\n更新软件源\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum makecache fast")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum install kubeadm-1.23.9-0 kubectl-1.23.9-0 kubelet-1.23.9-0 -y")]),s._v("\n")])])]),t("p",[s._v("其他节点主机同步软件源")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# for i in 20 21;do scp /etc/yum.repos.d/kubernetes.repo root@10.0.0.$i:/etc/yum.repos.d/kubernetes.repo;ssh root@10.0.0.$i "yum makecache fast; yum install kubeadm-1.23.9-0 kubelet-1.23.9-0 -y";done')]),s._v("\n\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-5-3-容器环境"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-5-3-容器环境"}},[s._v("#")]),s._v(" 1.5.3 容器环境")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 Docker环境、环境配置、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("Docker环境")])]),s._v(" "),t("p",[s._v("简介")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t由于kubernetes1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("24版本才开始将默认支持的容器引擎转换为了Containerd了，所以这里我们还是以Docker软件作为后端容器的引擎，因为目前的CKA考试环境是以kubernetes1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("23版本为基准的。\n")])])]),t("p",[s._v("软件源配置")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("安装基础依赖软件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum install -y yum-utils device-mapper-persistent-data lvm2")]),s._v("\n\n定制专属的软件源\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo")]),s._v("\n")])])]),t("p",[s._v("安装软件")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("确定最新版本的docker\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum list docker-ce --showduplicates | sort -r")]),s._v("\n\n安装最新版本的docker\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum install -y docker-ce")]),s._v("\n")])])]),t("p",[s._v("检查效果")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("启动docker服务\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl restart docker")]),s._v("\n\n检查效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker version")]),s._v("\nClient: Docker Engine "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" Community\n Version:           20"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("17\n API version:       1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("41\n Go version:        go1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("17"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("11\n Git commit:        100c701\n Built:             Mon Jun  6 23:05:12 2022\n OS/Arch:           linux/amd64\n Context:           default\n Experimental:      true\n\nServer: Docker Engine "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" Community\n Engine:\n  Version:          20"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("17\n  API version:      1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("41 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("minimum version 1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("12"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  Go version:       go1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("17"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("11\n  Git commit:       a89b842\n  Built:            Mon Jun  6 23:03:33 2022\n  OS/Arch:          linux/amd64\n  Experimental:     false\n containerd:\n  Version:          1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("6"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("6\n  GitCommit:        10c12954828e7c7c9b6e0ea9b0c02b01407d3ae1\n runc:\n  Version:          1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("2\n  GitCommit:        v1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("2-0-ga916309\n docker-init:\n  Version:          0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("19"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0\n  GitCommit:        de40ad0\n")])])]),t("p",[t("strong",[s._v("环境配置")])]),s._v(" "),t("p",[s._v("需求")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("1 镜像仓库\n\t默认安装的docker会从官方网站上获取docker镜像，有时候会因为网络因素无法获取，所以我们需要配置国内镜像仓库的加速器\n2 kubernetes的改造\n\tkubernetes的创建容器，需要借助于kubelet来管理Docker，而默认的Docker服务进程的管理方式不是kubelet的类型，所以需要改造Docker的服务启动类型为systemd方式。\n\t\n注意：\n\t默认情况下，Docker的服务修改有两种方式：\n\t\t1 Docker服务 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 需要修改启动服务文件，需要重载服务文件，比较繁琐。\n\t\t2 daemon"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("json文件 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 修改文件后，只需要重启docker服务即可，该文件默认情况下不存在。\n")])])]),t("p",[s._v("定制docker配置文件")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("定制配置文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat >> /etc/docker/daemon.json <<-EOF")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"registry-mirrors"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"http://74f21445.m.daocloud.io"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://registry.docker-cn.com"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"http://hub-mirror.c.163.com"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://docker.mirrors.ustc.edu.cn"')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" \n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"insecure-registries"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"10.0.0.20:80"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" \n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"exec-opts"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"native.cgroupdriver=systemd"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nEOF\n\n重启docker服务\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl restart docker")]),s._v("\n")])])]),t("p",[s._v("检查效果")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看配置效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker info")]),s._v("\nClient:\n "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\nServer:\n "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n Cgroup Driver: systemd\n "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n Insecure Registries:\n  10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("20:80\n  127"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0/8\n Registry Mirrors:\n  http:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("74f21445"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("m"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("daocloud"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("io/\n  https:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("registry"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("docker-cn"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com/\n  http:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("hub-mirror"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("c"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("163"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com/\n  https:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("docker"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("mirrors"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ustc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("edu"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("cn/\n Live Restore Enabled: false\n")])])]),t("p",[s._v("docker环境定制脚本")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看脚本内容\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@localhost ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /data/scripts/03_kubernetes_docker_install.sh")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#!/bin/bash")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 功能: 安装部署Docker容器环境")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 版本: v0.1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 作者: 书记")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 联系: superopsmsb.com")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 准备工作")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 软件源配置")]),s._v("\nsofts_base"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装基础软件")]),s._v("\n  yum install "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("y yum-utils device-mapper-persistent-"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(" lvm2\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 定制软件仓库源")]),s._v("\n  yum-config-manager "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("add-repo")]),s._v(" http:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("mirrors"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("aliyun"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com/docker-ce/linux/centos/docker-ce"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("repo\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 更新软件源")]),s._v("\n  systemctl restart network\n  yum makecache fast\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 软件安装")]),s._v("\nsoft_install"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装最新版的docker软件")]),s._v("\n  yum install "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("y docker-ce\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重启docker服务")]),s._v("\n  systemctl restart docker\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 加速器配置")]),s._v("\nspeed_config"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 定制加速器配置")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" > "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/docker/daemon"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("json <<"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("EOF\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"registry-mirrors"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"http://74f21445.m.daocloud.io"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://registry.docker-cn.com"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"http://hub-mirror.c.163.com"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://docker.mirrors.ustc.edu.cn"')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"insecure-registries"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"10.0.0.20:80"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"exec-opts"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"native.cgroupdriver=systemd"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nEOF\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重启docker服务")]),s._v("\n  systemctl restart docker\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 环境监测")]),s._v("\ndocker_check"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  process_name=$"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("docker info "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" grep "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'p D'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" awk "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{print $NF}'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"${process_name}"')]),s._v(" == "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"systemd"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" && "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Docker软件部署完毕"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Docker软件部署失败"')]),s._v(" && "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("exit")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 软件部署")]),s._v("\nmain"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  softs_base\n  soft_install\n  speed_config\n  docker_check\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 调用主函数")]),s._v("\nmain\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("其他主机环境部署docker\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# for i in {19..21}; do ssh root@10.0.0.$i "mkdir -p /data/scripts"; scp /data/scripts/03_kubernetes_docker_install.sh root@10.0.0.$i:/data/scripts/03_kubernetes_docker_install.sh; done')]),s._v("\n\n其他主机各自执行下面的脚本\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("bin/bash "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("scripts/03_kubernetes_docker_install"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sh\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-5-4-k8s环境"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-5-4-k8s环境"}},[s._v("#")]),s._v(" 1.5.4 k8s环境")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 集群部署、其他配置、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("集群部署")])]),s._v(" "),t("p",[s._v("镜像获取")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("镜像获取脚本内容\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@localhost ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /data/scripts/04_kubernetes_get_images.sh")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#!/bin/bash")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 功能: 获取kubernetes依赖的Docker镜像文件")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 版本: v0.1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 作者: 书记")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 联系: superopsmsb.com")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 定制普通环境变量")]),s._v("\nali_mirror="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'registry.aliyuncs.com'")]),s._v("\nharbor_mirror="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'kubernetes-register.superopsmsb.com'")]),s._v("\nharbor_repo="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'google_containers'")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 环境定制")]),s._v("\nkubernetes_image_get"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 获取脚本参数")]),s._v("\n  kubernetes_version="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),s._v('"')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 获取制定kubernetes版本所需镜像")]),s._v("\n  images=$"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("kubeadm config images list "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("kubernetes-version=$"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("kubernetes_version"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" awk "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("F "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{print $NF}'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 获取依赖镜像")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" i in $"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("images"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n    docker pull $"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("ali_mirror"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("$"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("harbor_repo"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$i")]),s._v("\n    docker tag $"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("ali_mirror"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("$"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("harbor_repo"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$i")]),s._v("  $"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("harbor_mirror"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("$"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("harbor_repo"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$i")]),s._v("\n    docker rmi $"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("ali_mirror"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("$"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("harbor_repo"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$i")]),s._v("\n  done\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 脚本的帮助")]),s._v("\nUsage"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/bin/bash '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$0")]),s._v(' "')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 脚本主流程")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" $"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -eq 0 ]")]),s._v("\nthen\n   read "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"请输入要获取kubernetes镜像的版本(示例: v1.23.9): "')]),s._v(" kubernetes_version\n   kubernetes_image_get $"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("kubernetes_version"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v("\n   Usage\nfi\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("脚本执行效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /bin/bash /data/scripts/04_kubernetes_get_images.sh")]),s._v("\n请输入要获取kubernetes镜像的版本"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("示例: v1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("23"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("9"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": v1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("23"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("9\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("node节点获取镜像\ndocker pull registry"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("aliyuncs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com/google_containers/kube-proxy:v1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("23"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("9\ndocker pull registry"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("aliyuncs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com/google_containers/pause:3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("6\n")])])]),t("p",[s._v("master环境初始化")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("环境初始化命令\nkubeadm init "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("kubernetes-version=1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("23"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("9 \\\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("apiserver-advertise-address=10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("19 \\\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("image-repository registry"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("aliyuncs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com/google_containers \\\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("service-cidr=10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("96"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0/12 \\\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pod-network-cidr=10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("244"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0/16 \\\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("ignore-preflight-errors=Swap\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("设定kubernetes的认证权限\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mkdir -p $HOME/.kube")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sudo chown $(id -u):$(id -g) $HOME/.kube/config")]),s._v("\n\n再次检测\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get nodes")]),s._v("\nNAME                STATUS     ROLES                  AGE     VERSION\nkubernetes-master   NotReady   control-plane"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("master   4m10s   v1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("23"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("9\n")])])]),t("p",[s._v("node环境初始化")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("node节点环境初始化\nkubeadm join 10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("19:6443 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("token vfiiwc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("se99g4ai8wl2md9r  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("discovery-token-ca-cert-hash sha256:0c552edf7b884431dfc1877e6f09a0660460ddbdc567d2366dae43dbc10e9554\n")])])]),t("p",[t("strong",[s._v("其他配置")])]),s._v(" "),t("p",[s._v("网络环境配置")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建基本目录\nmkdir "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("kubernetes/flannel "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p\ncd "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("kubernetes/flannel\n\n获取配置文件\nwget https:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("raw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("githubusercontent"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com/flannel-io/flannel/master/Documentation/kube-flannel"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yml\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("所有节点获取镜像\ndocker pull docker"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("io/rancher/mirrored-flannelcni-flannel-cni-plugin:v1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0\ndocker pull docker"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("io/rancher/mirrored-flannelcni-flannel:v0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("19"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("2\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("应用网络环境配置文件\nkubectl apply "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f kube-flannel"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yml\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("确认效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@localhost /data/kubernetes/flannel]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl  get nodes")]),s._v("\nNAME                STATUS   ROLES                  AGE     VERSION\nkubernetes-master   Ready    control-plane"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("master   10m     v1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("23"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("9\nkubernetes-node1    Ready    <none>                 9m56s   v1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("23"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("9\nkubernetes-node2    Ready    <none>                 9m52s   v1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("23"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("9\n")])])]),t("p",[s._v("命令优化")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("放到当前用户的环境文件中\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# echo "source <(kubectl completion bash)" >> ~/.bashrc')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# echo "source <(kubeadm completion bash)" >> ~/.bashrc')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# source ~/.bashrc")]),s._v("\n\n测试效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get n")]),s._v("\nnamespaces                         networkpolicies"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("networking"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("k8s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("io  nodes\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubeadm co")]),s._v("\ncompletion  config\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-5-5-rbd实践"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-5-5-rbd实践"}},[s._v("#")]),s._v(" 1.5.5 rbd实践")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("简介")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("自从k8s1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("13版本以来，ceph与k8s的集成越来越紧密。ceph为k8s提供存储服务主要有两种方式，cephfs和ceph rdb；cephfs方式支持k8s的pv的3种访问模式ReadWriteOnce，ReadOnlyMany，ReadWriteMany ，RBD支持ReadWriteOnce，ReadOnlyMany。\n")])])]),t("p",[s._v("准备工作")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("跨主机免密码认证\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@admin /data/scripts]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /bin/bash 01_remote_host_auth.sh")]),s._v("\n批量设定远程主机免密码认证管理界面\n=====================================================\n 1: 部署环境   2: 免密认证   3: 同步hosts\n 4: 设定主机名 5：退出操作\n=====================================================\n请输入有效的操作id: 2\n请输入需要批量远程主机认证的主机列表范围"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("示例: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("12"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("19"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("19"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("21"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n开始执行免密认证操作"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nspawn "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("usr/bin/ssh-"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("copy-id")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("i "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("root/"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ssh/id_rsa"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pub root@10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("19\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nNow "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try")]),s._v(" logging into the machine"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" with:   "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"ssh 'root@10.0.0.21'\"")]),s._v("\nand check to make sure that only the key"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" you wanted were added"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\n批量设定远程主机免密码认证管理界面\n=====================================================\n 1: 部署环境   2: 免密认证   3: 同步hosts\n 4: 设定主机名 5：退出操作\n=====================================================\n请输入有效的操作id: 5\n开始退出管理界面"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("ceph环境准备工作\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@admin /data/scripts]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# for i in {19..21}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n  scp "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/yum"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("repos"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("d/ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("repo root@10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$i")]),s._v(":"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/yum"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("repos"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("d/\n  ssh root@10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$i")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"yum install ceph -y"')]),s._v("\ndone\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("准备文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@admin /data/scripts]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# for i in {19..21};do scp 02_create_ceph_user.sh 03_remote_cephadm_auth.sh root@10.0.0.$i:/data/scripts; done")]),s._v("\n\n准备专属用户\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("bin/bash "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("scripts/02_create_ceph_user"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sh\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("定制数据目录的认证\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("bin/bash "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("scripts/03_remote_cephadm_auth"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sh\n批量设定远程主机免密码认证管理界面\n=====================================================\n 1: 部署环境   2: 免密认证   3: 退出操作\n=====================================================\n请输入有效的操作id: 2\n请输入需要批量远程主机认证的主机列表范围"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("示例: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("12"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("19"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("19"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("21"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n开始执行免密认证操作"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nspawn "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("usr/bin/ssh-"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("copy-id")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("i "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("home/cephadm/"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ssh/id_rsa"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pub cephadm@10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("19\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("同步配置文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph-deploy config push kubernetes-master kubernetes-node1 kubernetes-node2\n")])])]),t("p",[s._v("创建rbd相关的存储池")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建存储池\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool create kube-rbddata 16 16\npool "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'kube-rbddata'")]),s._v(" created\n\n启用rbd功能\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool application enable kube-rbddata rbd\nenabled application "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'rbd'")]),s._v(" on pool "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'kube-rbddata'")]),s._v("\n\n存储池初始化\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd pool init "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p kube-rbddata\n\n创建存储镜像\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd create kube-rbddata/kubeimg "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("size 2Gi\n\n查看效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p kube-rbddata "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("l\nNAME     SIZE   PARENT  FMT  PROT  LOCK\nkubeimg  2 GiB            2\n\n查看镜像属性\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ rbd info kube-rbddata/kubeimg\nrbd image "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'kubeimg'")]),s._v(":\n        size 2 GiB in 512 objects\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n        features: layering"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" exclusive-lock"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" object-map"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" fast-"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("diff")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" deep-flatten\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("注意：\n\t有可能在k8s使用rbd的时候，提示不支持 object-map"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" fast-"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("diff")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" deep-flatten 属性，那么我们到时候执行如下命令：\n\trbd feature disable kube-rbddata/kubeimg exclusive-lock object-map fast-"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("diff")]),s._v(" deep-flatten\n")])])]),t("p",[s._v("创建专属的访问存储池的用户账号")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建专属的账号信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph auth "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("get-or")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("create client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("k8s mon "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'allow r'")]),s._v(" osd "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'allow * pool=kube-rbddata'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("o ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("k8s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring\n\n查看秘钥环文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("k8s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[client.k8s]")]),s._v("\n        key = AQCAR0hj6rCdNhAAFPIDxBTzujdX3SpFDE+pOQ==\n \n完善秘钥环文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph auth get client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("k8s "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("o ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("k8s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring\nexported keyring "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("k8s\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("k8s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[client.k8s]")]),s._v("\n        key = AQCAR0hj6rCdNhAAFPIDxBTzujdX3SpFDE+pOQ==\n        caps mon = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow r"')]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("传递秘钥环文件到所有k8s节点\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" i in "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("19"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("21"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n  scp ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("k8s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring root@10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$i")]),s._v(":"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/ceph/\ndone\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rbd --user k8s -p kube-rbddata ls")]),s._v("\nkubeimg\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph --user k8s -s")]),s._v("\n  cluster:\n    id:     d932ded6-3765-47c1-b0dc-e6957051e31a\n    health: HEALTH_WARN\n            application not enabled on 1 pool"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("p",[s._v("ceph查看效果")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看当前ceph的pool信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph --user k8s osd pool ls | grep kube")]),s._v("\nkube-rbddata\n\n创建对应的镜像信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rbd --user k8s create kube-rbddata/podimg02 --size 1G")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rbd --user k8s ls -p kube-rbddata | grep od")]),s._v("\npodimg01\n")])])]),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("准备工作")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("待测试客户端准备镜像\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-node1 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker pull redis:6.2.5")]),s._v("\n")])])]),t("p",[s._v("定制pod测试1")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("定制专属的pod测试资源清单文件 01-ceph-k8s-pod-test"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\napiVersion: v1\nkind: Pod\nmetadata:\n  name: redis-with-rdb-test\nspec:\n  nodeName: kubernetes-node1\n  containers:\n  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" name: redis\n    image: redis:6"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("5\n    imagePullPolicy: IfNotPresent\n    volumeMounts:\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" mountPath: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/data"')]),s._v("\n      name: redis-cephrbd-vol\n  volumes:\n  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" name: redis-cephrbd-vol\n    rbd:\n      monitors:\n      "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("13:6789\n      "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("14:6789\n      "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("15:6789\n      pool: kube-rbddata\n      image: kubeimg\n      fsType: xfs\n      user: k8s\n      keyring: "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/ceph/ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("k8s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring\n      \n应用资源清单文件\nkubectl apply "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f 01-ceph-k8s-pod-test"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("检查效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master /data/kubernetes/ceph]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pod -o wide")]),s._v("\nNAME                  READY   STATUS    RESTARTS   AGE   IP           NODE      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nredis-with-rdb-test   1/1     Running   0          22s   10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("244"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("2   k8s-node1 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\n查看信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master /data/kubernetes/ceph]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl describe  pod redis-with-rdb-test")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看宿主机绑定效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-node1 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rbd showmapped")]),s._v("\nid pool         namespace image   snap device\n0  kube-rbddata           kubeimg "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("dev/rbd0\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-node1 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mount | grep rbd")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("dev/rbd0 on "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("lib/kubelet/plugins/kubernetes"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("io/rbd/mounts/kube-rbddata-image-kubeimg "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" xfs "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("rw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("relatime"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("attr2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("inode64"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("sunit=8192"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("swidth=8192"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("noquota"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("dev/rbd0 on "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("lib/kubelet/pods/006fb6bd-6623-4f29-88d9-53e6f4fe5222/volumes/kubernetes"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("io~rbd/redis-cephrbd-vol "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" xfs "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("rw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("relatime"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("attr2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("inode64"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("sunit=8192"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("swidth=8192"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("noquota"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看pod\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master /data/kubernetes/ceph]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pod")]),s._v("\nNAME                  READY   STATUS    RESTARTS   AGE\nredis-with-rdb-test   1/1     Running   0          7m39s\n\n进入pod查看效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master /data/kubernetes/ceph]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl  exec -it redis-with-rdb-test -- bash")]),s._v("\nroot@redis-with-rdb-test:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mount | grep rbd")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("dev/rbd0 on "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" xfs "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("rw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("relatime"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("attr2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("inode64"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("sunit=8192"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("swidth=8192"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("noquota"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\nredis使用rdb效果\nroot@redis-with-rdb-test:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls")]),s._v("\nlost+found\nroot@redis-with-rdb-test:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis-cli")]),s._v("\n127"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("1:6379> "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" nihao nihao\nOK\n127"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("1:6379> "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" buhao buhao\nOK\n127"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("1:6379> keys "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("\n1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"buhao"')]),s._v("\n2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nihao"')]),s._v("\n127"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("1:6379> BGSAVE\nBackground saving started\n127"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("1:6379> "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("exit")]),s._v("\nroot@redis-with-rdb-test:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls")]),s._v("\ndump"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rdb  lost+found\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("宿主机确认效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-node1 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls /var/lib/kubelet/plugins/kubernetes.io/rbd/mounts/kube-rbddata-image-kubeimg")]),s._v("\ndump"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rdb\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("收尾动作\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master /data/kubernetes/ceph]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl  delete -f 01-ceph-k8s-pod-test.yaml")]),s._v("\npod "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"redis-with-rdb-test"')]),s._v(" deleted\n")])])]),t("p",[s._v("定制pod实践2")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建专属的镜像磁盘\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd create kube-rbddata/kubeimg02 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("size 2Gi\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p kube-rbddata "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("l\nNAME       SIZE   PARENT  FMT  PROT  LOCK\nkubeimg    2 GiB            2        excl\nkubeimg02  2 GiB            2\n\n清理磁盘格式\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd feature disable kube-rbddata/kubeimg02 exclusive-lock object-map fast-"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("diff")]),s._v(" deep-flatten\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看ceph的keyring的信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("k8s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[client.k8s]")]),s._v("\n        key = AQDh47ZhqWklMRAAY+6UM0wkbSRc2DeLctQY+A==\n        \n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph auth print-key client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("k8s\nAQDh47ZhqWklMRAAY+6UM0wkbSRc2DeLctQY+A==\n\n生成对应的base64编码信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph auth print-key client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("k8s "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" base64\nQVFEaDQ3WmhxV2tsTVJBQVkrNlVNMHdrYlNSYzJEZUxjdFFZK0E9PQ==\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("定制专属的pod测试资源清单文件 02-ceph-k8s-pod-secret"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\napiVersion: v1\nkind: Secret\nmetadata:\n  name: ceph-secret\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kubernetes.io/rbd"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(":\n  key: QVFEaDQ3WmhxV2tsTVJBQVkrNlVNMHdrYlNSYzJEZUxjdFFZK0E9PQ==\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("\napiVersion: v1\nkind: Pod\nmetadata:\n  name: redis-with-secret-test\nspec:\n  nodeName: kubernetes-node1\n  containers:\n  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" name: redis\n    image: redis:6"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("5\n    imagePullPolicy: IfNotPresent\n    volumeMounts:\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" mountPath: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/data"')]),s._v("\n      name: redis-cephrbd-vol\n  volumes:\n  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" name: redis-cephrbd-vol\n    rbd:\n      monitors:\n      "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("13:6789\n      "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("14:6789\n      "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("15:6789\n      pool: kube-rbddata\n      image: kubeimg02\n      fsType: xfs\n      readOnly: false\n      user: k8s\n      secretRef:\n        name: ceph-secret\n      \n应用资源清单文件\nkubectl apply "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f 02-ceph-k8s-pod-secret"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master /data/kubernetes/ceph]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl  get pod -o wide")]),s._v("\nNAME                     READY   STATUS    RESTARTS   AGE   IP           NODE      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nredis-with-secret-test   1/1     Running   0          13s   10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("244"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("3   k8s-node2 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("收尾动作\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master /data/kubernetes/ceph]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl delete -f 02-ceph-k8s-pod-secret.yaml")]),s._v("\nsecret "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ceph-secret"')]),s._v(" deleted\npod "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"redis-with-secret-test"')]),s._v(" deleted\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-5-6-cephfs实践"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-5-6-cephfs实践"}},[s._v("#")]),s._v(" 1.5.6 CephFS实践")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("需求")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("k8s对ceph rbd模式不支持ReadWriteMany（RWX）"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("为了满足k8s的灵活性需求"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("采用支持多点挂载的cephfs工作模式\n")])])]),t("p",[s._v("准备工作")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("检查cephfs环境\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph  fs  "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("\nname: cephfs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" metadata pool: cephfs-metadata"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(" pools: "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephfs-data ]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("s "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" grep mds\n    mds: cephfs:1 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("0=stor05=up:active"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("保存用户账号的密钥信息于secret文件，用于客户端挂载操作认证之用\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph auth print-key client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fsclient > fsclient"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("key\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" fsclient"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("key\nAQBgdTJj+LVdFBAAZOjGIsw4t+o1swZlW4CvKQ==\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("将秘钥文件传递给所有的k8s节点主机\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" i in "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("19"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("21"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n  scp fsclient"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("key root@10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$i")]),s._v(":"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/ceph/\ndone\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建专属的数据目录\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-node2 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mkdir /cephfs-data/")]),s._v("\n\n挂载cephFS对象\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-node2 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mount -t ceph 10.0.0.13:6789,10.0.0.14:6789,10.0.0.15:6789:/ /cephfs-data/ -o name=fsclient,secretfile=/etc/ceph/fsclient.key")]),s._v("\n注意：\n\t内核空间挂载ceph文件系统，要求必须指定ceph文件系统的挂载路径\n\t\n确认挂载效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-node2 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mount | grep cephfs")]),s._v("\n10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("13:6789"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("14:6789"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("15:6789:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" on "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("cephfs-"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" ceph "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("rw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("relatime"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("name=fsclient"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("secret=<hidden>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("acl"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("wsize=16777216"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("创建资源清单文件")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("获取秘钥信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master /data/kubernetes/ceph]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /etc/ceph/fsclient.key")]),s._v("\nAQDYCUpjmLjUDxAAYkfNGUG5FUYaFVE6jlFgrQ==\n\n生成专属的秘钥信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master /data/kubernetes/ceph]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# echo -n 'AQDYCUpjmLjUDxAAYkfNGUG5FUYaFVE6jlFgrQ==' | base64")]),s._v("\nQVFEWUNVcGptTGpVRHhBQVlrZk5HVUc1RlVZYUZWRTZqbEZnclE9PQ==\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建secret资源清单文件 03-cephfs-k8s-test"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\napiVersion: v1\nkind: Secret\nmetadata:\n  name: ceph-secret\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(":\n  key: QVFEWUNVcGptTGpVRHhBQVlrZk5HVUc1RlVZYUZWRTZqbEZnclE9PQ==\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("\napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: cephfs-pv\n  labels:\n    pv: cephfs-pv\nspec:\n  capacity:\n    storage: 1Gi\n  accessModes:\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" ReadWriteMany\n  cephfs:\n    monitors:\n      "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("13:6789\n      "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("14:6789\n      "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("15:6789\n    user: fsclient\n    secretRef:\n      name: ceph-secret\n    readOnly: false\n  persistentVolumeReclaimPolicy: Delete\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("\nkind: PersistentVolumeClaim\napiVersion: v1\nmetadata:\n  name: cephfs-pvc\nspec:\n  accessModes:\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" ReadWriteMany\n  resources:\n    requests:\n      storage: 1Gi\n  selector:\n    matchLabels:\n      pv: cephfs-pv\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("定制资源清单 04-cephfs-k8s-pod-redis"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\napiVersion: v1\nkind: Pod\nmetadata:\n  name: superopsmsb-redis\nspec:\n  nodeName: kubernetes-node1\n  volumes:\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" name: redis-cephfs-vol\n      persistentVolumeClaim:\n        claimName: cephfs-pvc\n  containers:\n  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" name: redis\n    image: redis:6"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("5\n    imagePullPolicy: IfNotPresent\n    volumeMounts:\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" mountPath: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/data"')]),s._v("\n      name: redis-cephfs-vol\n")])])]),t("p",[s._v("测试效果")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("应用资源清单文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master /data/kubernetes/ceph]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl  apply -f 03-cephfs-k8s-test.yaml -f 04-cephfs-k8s-pod-redis.yaml")]),s._v("\n\n确认效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master /data/kubernetes/ceph]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl describe pod superopsmsb-redis")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("客户端确认效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-node1 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mount | grep ceph")]),s._v("\n10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("13:6789"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("14:6789"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("15:6789:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" on "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("lib/kubelet/pods/41a1af23-da66-486c-b80d-a2e084f75edc/volumes/kubernetes"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("io~cephfs/cephfs-pv "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" ceph "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("rw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("relatime"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("name=fsclient"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("secret=<hidden>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("acl"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("wsize=16777216"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("收尾操作\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master /data/kubernetes/ceph]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl  delete -f 04-cephfs-k8s-pod-redis.yaml -f 03-cephfs-k8s-test.yaml")]),s._v("\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-5-7-sc基础"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-5-7-sc基础"}},[s._v("#")]),s._v(" 1.5.7 SC基础")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("需求")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("    对于手工方式为应用提供指定的存储能力是可行的，但是在k8s动态变化的场景中，尤其是面对无状态的集群服务，如何自由的提供存储能力，是想当要考量的一个话题，对于这种场景，我们可以在"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("SC")]),s._v("的基础上，实现动态的为应用服务提供存储能力。\n")])])]),t("p",[s._v("ceph-csi")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\tceph-csi扩展各种存储类型的卷的管理能力，实现第三方存储ceph的各种操作能力与k8s存储系统的结合。调用第三方存储ceph的接口或命令，从而提供ceph数据卷的创建"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("删除、挂载"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("解除挂载的具体操作实现。前面分析组件中的对于数据卷的创建"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("删除、挂载"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("解除挂载操作，全是调用ceph-csi，然后由ceph-csi调用ceph提供的命令或接口来完成最终的操作。\n\t自从kubernetes 1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("13版本之后，ceph-csi为k8s环境动态地提供相关的存储能力。\n")])])]),t("p",[s._v("版本支持")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("Ceph CSI Version")]),s._v(" "),t("th",[s._v("Container Orchestrator Name")]),s._v(" "),t("th",[s._v("Version Tested")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("v3.7.1")]),s._v(" "),t("td",[s._v("Kubernetes")]),s._v(" "),t("td",[s._v("v1.22, v1.23, v1.24")])]),s._v(" "),t("tr",[t("td",[s._v("v3.7.0")]),s._v(" "),t("td",[s._v("Kubernetes")]),s._v(" "),t("td",[s._v("v1.22, v1.23, v1.24")])]),s._v(" "),t("tr",[t("td",[s._v("v3.6.1")]),s._v(" "),t("td",[s._v("Kubernetes")]),s._v(" "),t("td",[s._v("v1.21, v1.22, v1.23")])]),s._v(" "),t("tr",[t("td",[s._v("v3.6.0")]),s._v(" "),t("td",[s._v("Kubernetes")]),s._v(" "),t("td",[s._v("v1.21, v1.22, v1.23")])])])]),s._v(" "),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("组件功能")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建 pvc:\n\texternal-provisioner组件监听到pvc创建事件后，负责拼接请求，然后调用ceph-csi的CreateVolume方法来创建存储；\n删除 pvc:\n\tpv对象状态由bound变为release，external-provisioner监听到pv更新事件后，负责调用ceph-csi的DeleteVolume方法来删除存储。\n\npod关联pvc:\n\tkubelet会调用ceph-csi组件将创建好的存储从ceph集群挂载到pod所在的node上，然后再挂载到pod相应的目录上；\n\npod断开pvc:\n\tkubelet会调用ceph-csi组件相应方法，解除存储在pod目录上的挂载，再解除存储在node上的挂载。\n")])])]),t("p",[s._v("服务组成")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\tceph-csi含有rbdType、cephfsType、livenessType三大类型服务"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("它们可以通过启动参数指定一种服务来进行启动。\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" rbdType主要进行rbd的操作完成与ceph的交互\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" cephfsType主要进行cephfs的操作完成与ceph交互\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" livenessType该服务主要是定时向csi endpoint探测csi组件的存活，然后统计到prometheus指标中。\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("rbdType、cephfsType类型的服务可以细分为如下三个子服务：\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" ControllerServer：主要负责创建、删除cephfs/rbd存储等操作。\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" NodeServer：部署在k8s中的每个node上，主要负责cephfs、rbd在node节点上相关的操作。\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" IdentityServer：主要是返回自身服务的相关信息，如返回服务身份信息、服务能力、暴露存活探测接口等\n\t\n注意：\n\t其中NodeServer与ControllerServer只能选其一进行启动\n\tIdentityServer会伴随着NodeServer或ControllerServer的启动而启动。\n")])])]),t("p",[t("img",{attrs:{src:"image/image-20221015174850734.png",alt:"image-20221015174850734"}})]),s._v(" "),t("p",[s._v("应用组件")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\tceph-csi 在部署的时候，主要涉及到以下组件\nexternal-provisioner（csi-provisioner）：\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 创建provision环境，然后负责监听pvc是否需要动态创建和删除存储卷\n\t\nexternal-attacher（csi-attacher）：\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 负责获取PV的所有信息，然后判断是否调用CSI Plugin的ControllerPublish做attach，还是调用CntrollerUnpublish接口做detach\n\t\nexternal-snapshotter：\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 对镜像文件进行快照相关操作，同时负责判断PVC中是否调整需求的存储容量空间大小\n\t\nnode-driver-registrar\n\t调用CSI Plugin的接口获取插件信息，通过Kubelet的插件注册机制将CSI Plugin注册到kubelet\n\nlivenessprobe\n\t调用CSI Plugin的Probe接口，同时在"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("healthz暴露HTTP健康检查探针\n")])])]),t("p",[t("img",{attrs:{src:"image/image-20221015175059810.png",alt:"image-20221015175059810"}})]),s._v(" "),t("p",[s._v("部署解读")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t对于ceph-csi环境的部署来说，主要涉及到两个文件：\n\tcsi-xxxplugin-provisioner"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml部署的相关组件：\n\t\tcsi-provisioner\t 核心"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sc")]),s._v("服务能力，负责根据pvc来管理pv对象，动态的管理ceph中的image\n\t\tcsi-snapshotter  负责处理存储快照相关的操作\n\t\tcsi-attacher\t 负责操作VolumeAttachment对象，并没有操作存储。\n\t\tcsi-resizer\t\t 负责处理存储扩容相关的操作\n\t\tcsi-xxxplugin\t 核心的ceph-csi组件，负责与kubernetes对接存储相关的操作\n\t\tliveness-prometheus\t负责探测并上报csi-rbdplugin服务的存活情况\n\tcsi-xxxplugin"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml部署的相关组件：\n\t\tdriver-registrar 向kubelet传入csi-xxxplugin容器提供服务的socket地址等信息。\n\t\tcsi-xxxplugin\t 负责与kubernetes对接存储相关的操作\n\t\tliveness-prometheus  负责探测并上报csi-xxxplugin服务的存活情况\t\n\t注意：\n\t\txxx 主要有两类：rdb和cephfs\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-5-8-sc-rbd实践"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-5-8-sc-rbd实践"}},[s._v("#")]),s._v(" 1.5.8 SC-rbd实践")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础环境、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("参考资料：\n\thttps:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("docs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com/en/quincy/rbd/rbd-kubernetes/\n")])])]),t("p",[s._v("准备工作")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("获取代码环境\ncd "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("kubernetes/\ngit clone https:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("github"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com/ceph/ceph-csi"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("git\ncd ceph-csi/deploy/rbd/kubernetes/\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("获取基本状态信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph mon dump\nepoch 3\nfsid d932ded6-3765-47c1-b0dc-e6957051e31a\nlast_changed 2062-09-30 23:25:47"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("516433\ncreated 2062-09-30 19:05:03"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("907227\nmin_mon_release 14 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("nautilus"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n0: "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[v2:10.0.0.13:3300/0,v1:10.0.0.13:6789/0]")]),s._v(" mon"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("mon01\n1: "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[v2:10.0.0.14:3300/0,v1:10.0.0.14:6789/0]")]),s._v(" mon"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("mon02\n2: "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[v2:10.0.0.15:3300/0,v1:10.0.0.15:6789/0]")]),s._v(" mon"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("mon03\n这里重点关注：\n\tfsid-ceph集群的id 和 mon节点的列表\n")])])]),t("p",[s._v("部署rbd环境")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("修改核心配置文件 csi-config-map"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ceph-csi-config"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(":\n  config"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("json: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"clusterID"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"d932ded6-3765-47c1-b0dc-e6957051e31a"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"monitors"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"10.0.0.13:6789"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"10.0.0.14:6789"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"10.0.0.15:6789"')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n注意：\n\t修改 clusterID 和 monitors 部分内容\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建依赖的configmap文件\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" <<EOF > ceph-config-map"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("\napiVersion: v1\nkind: ConfigMap\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(":\n  config"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("json: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nmetadata:\n  name: ceph-csi-encryption-kms-config\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("\napiVersion: v1\nkind: ConfigMap\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(":\n  ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[global]")]),s._v("\n    auth_cluster_required = cephx\n    auth_service_required = cephx\n    auth_client_required = cephx\n  keyring: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("\nmetadata:\n  name: ceph-config\nEOF\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("修改部署资源清单文件 csi-rbdplugin-provisioner"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nkind: Deployment\napiVersion: apps/v1\nmetadata:\n  name: csi-rbdplugin-provisioner\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# replace with non-default namespace name")]),s._v("\n  namespace: default\nspec:\n  replicas: 2   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将3修改为2")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("部署资源清单文件\nkubectl apply "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f csi-config-map"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\nkubectl apply "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f ceph-config-map"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\nkubectl apply "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f csidriver"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\nkubectl apply "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f csi-provisioner-rbac"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\nkubectl apply "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f csi-nodeplugin-rbac"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\nkubectl apply "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f csi-rbdplugin-provisioner"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\nkubectl apply "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f csi-rbdplugin"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\n注意：\n\tcsidriver"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml 对于pod挂载pvc是非常重要的，如果不执行会导致挂载失败\n")])])]),t("p",[s._v("确认效果")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("检查效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master /data/kubernetes/ceph-csi/deploy/rbd/kubernetes]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl  get pod")]),s._v("\nNAME                                         READY   STATUS    RESTARTS   AGE\ncsi-rbdplugin-8xq6m                          3/3     Running   0          53s\ncsi-rbdplugin-nbf8g                          3/3     Running   0          53s\ncsi-rbdplugin-provisioner-8599998d64-77zqd   7/7     Running   0          54s\ncsi-rbdplugin-provisioner-8599998d64-p48wm   7/7     Running   0          54s\n")])])]),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("ceph环境准备")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建专属的存储池\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph osd pool create kubernetes 64\npool "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'kubernetes'")]),s._v(" created\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ rbd pool init kubernetes\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建专属的用户 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v(" 可选\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph auth "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("get-or")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("create client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("kubernetes mon "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'profile rbd'")]),s._v(" osd "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'profile rbd pool=kubernetes'")]),s._v(" mgr "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'profile rbd pool=kubernetes'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[client.kubernetes]")]),s._v("\n        key = AQA7VUpjyHt/OxAAh1GTn8eWEWBmW2lJ61NmjQ==\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("我们这里以admin用户为例 \n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph auth get client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("admin\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[client.admin]")]),s._v("\n        key = AQByzTZjaEaCCRAAolAFknx1x/LgTYhNyy50cw==\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("p",[s._v("应用测试")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("进入专属测试文件目录\ncd "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("kubernetes/ceph-csi/examples/rbd/\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("修改secret文件  secret"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nstringData:\n  userID: admin\n  userKey: AQByzTZjaEaCCRAAolAFknx1x/LgTYhNyy50cw==\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n修改：\n\t根据提示信息修改 userID 和 userKey 的信息\n\t这里的userKey无需进行base64加密\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("修改"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("SC")]),s._v("配置 storageclass"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nparameters:\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n  clusterID: d932ded6-3765-47c1-b0dc-e6957051e31a\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n  pool: kubernetes\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n修改：\n\t根据提示信息修改 clusterID 和 pool 的信息\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("应用资源清单文件\nkubectl  apply "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f secret"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\nkubectl  apply "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f storageclass"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\nkubectl  apply "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f pvc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\nkubectl  apply "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f pod"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\n")])])]),t("p",[s._v("测试效果")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("确定pvc和pv的效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master /data/kubernetes/ceph-csi/examples/rbd]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl  get  pvc")]),s._v("\nNAME      STATUS   VOLUME                                     CAPACITY   "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nrbd-pvc   Bound    pvc-441dbf43-5051-4130-b8d7-a539e5395ba1   1Gi        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master /data/kubernetes/ceph-csi/examples/rbd]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl  get  pv")]),s._v("\nNAME                                       CAPACITY   ACCESS MODES   "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\npvc-441dbf43-5051-4130-b8d7-a539e5395ba1   1Gi        RWO            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("确定pod效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master /data/kubernetes/ceph-csi/examples/rbd]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl  describe pod csi-rbd-demo-pod  | grep -A3 Volumes:")]),s._v("\nVolumes:\n  mypvc:\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Type")]),s._v(":       PersistentVolumeClaim "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("a reference to a PersistentVolumeClaim in the same namespace"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    ClaimName:  rbd-pvc\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("ceph环境中确认效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ rbd "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool kubernetes "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("l\nNAME                                         SIZE  PARENT FMT PROT LOCK\ncsi-vol-0a8bcde0-ddd0-4ca8-a194-70bf61aaf691 1 GiB          2\n")])])]),t("p",[s._v("移除应用")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("移除应用\nkubectl  delete "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f pod"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\nkubectl  delete "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f pvc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\n\nceph环境中确认效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ rbd "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool kubernetes "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("l\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$\n")])])]),t("p",[s._v("环境收尾")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("清理应用环境\ncd "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("kubernetes/ceph-csi/examples/rbd\nkubectl  delete "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f storageclass"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f secret"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\n\n清理"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sc")]),s._v("环境\ncd "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("kubernetes/ceph-csi/deploy/rbd/kubernetes\nkubectl  delete "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("清理ceph环境\nceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" kubernetes kubernetes "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("yes-i-really-really-mean-it\nceph auth "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("kubernetes\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-5-9-sc-cephfs实践"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-5-9-sc-cephfs实践"}},[s._v("#")]),s._v(" 1.5.9 SC-cephfs实践")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础环境、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("准备工作")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("获取代码环境\ncd "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("kubernetes/ceph-csi/deploy/cephfs/kubernetes/\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("获取基本状态信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph mon dump\nepoch 3\nfsid d932ded6-3765-47c1-b0dc-e6957051e31a\nlast_changed 2062-09-30 23:25:47"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("516433\ncreated 2062-09-30 19:05:03"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("907227\nmin_mon_release 14 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("nautilus"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n0: "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[v2:10.0.0.13:3300/0,v1:10.0.0.13:6789/0]")]),s._v(" mon"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("mon01\n1: "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[v2:10.0.0.14:3300/0,v1:10.0.0.14:6789/0]")]),s._v(" mon"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("mon02\n2: "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[v2:10.0.0.15:3300/0,v1:10.0.0.15:6789/0]")]),s._v(" mon"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("mon03\n这里重点关注：\n\tfsid-ceph集群的id 和 mon节点的列表\n")])])]),t("p",[s._v("部署rbd环境")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("修改核心配置文件 csi-config-map"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ceph-csi-config"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(":\n  config"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("json: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"clusterID"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"d932ded6-3765-47c1-b0dc-e6957051e31a"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"monitors"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"10.0.0.13:6789"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"10.0.0.14:6789"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"10.0.0.15:6789"')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n注意：\n\t修改 clusterID 和 monitors 部分内容\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建依赖的configmap文件\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" <<EOF > ceph-config-map"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("\napiVersion: v1\nkind: ConfigMap\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(":\n  ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[global]")]),s._v("\n    auth_cluster_required = cephx\n    auth_service_required = cephx\n    auth_client_required = cephx\n  keyring: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("\nmetadata:\n  name: ceph-config\nEOF\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("修改部署资源清单文件 csi-cephfsplugin-provisioner"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nkind: Deployment\napiVersion: apps/v1\nmetadata:\n  name: csi-cephfsplugin-provisioner\nspec:\n  selector:\n    matchLabels:\n      app: csi-cephfsplugin-provisioner\n  replicas: 2   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将3修改为2")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n      containers:\n        "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" name: csi-provisioner\n          "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"--extra-create-metadata=false"')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" name: csi-snapshotter\n          "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"--extra-create-metadata=false"')]),s._v("\n注意：\n\t一定要将 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("extra-create-metadata 的值设为 false，否则后续对于subvolume要求较高，报错信息：\n\t\tAPI call not implemented server-side: No handler found "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'fs subvolume metadata set'")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("部署资源清单文件\nkubectl  apply "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("\n\n注意：\n\tcsidriver"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml 对于pod挂载pvc是非常重要的，如果不执行会导致挂载失败\t\n")])])]),t("p",[s._v("确认效果")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("检查效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master /data/kubernetes/ceph-csi/deploy/cephfs/kubernetes]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl  get pod")]),s._v("\nNAME                                            READY   STATUS    RESTARTS   AGE\ncsi-cephfsplugin-dtdsn                          3/3     Running   0          27s\ncsi-cephfsplugin-provisioner-65d8546b95-k2rzt   5/5     Running   0          27s\ncsi-cephfsplugin-provisioner-65d8546b95-zwhws   5/5     Running   0          26s\ncsi-cephfsplugin-sd9rk                          3/3     Running   0          27s\n\n")])])]),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("ceph环境准备")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("如果没有cephfs环境的话，执行如下命令\nceph osd pool create cephfs-"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(" 16 16\nceph osd pool create cephfs-metadata 16 16\nceph fs new cephfs cephfs-metadata cephfs-"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("确认当前的cephfs环境\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph fs "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("\nname: cephfs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" metadata pool: cephfs-metadata"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(" pools: "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephfs-data ]")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建专属的用户 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v(" 可选\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph auth "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("get-or")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("create client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fsclient mon "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'allow r'")]),s._v(" mds "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'allow rw'")]),s._v(" osd "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'allow rwx pool=cephfs-data'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("o ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fsclient"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("我们这里以admin 和 fsclient用户为例 \n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph auth "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("get-key")]),s._v(" client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fsclient\nAQDYCUpjmLjUDxAAYkfNGUG5FUYaFVE6jlFgrQ==\n\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin cephadm-cluster]")]),s._v("$ ceph auth "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("get-key")]),s._v(" client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("admin\nAQByzTZjaEaCCRAAolAFknx1x/LgTYhNyy50cw==\n")])])]),t("p",[s._v("应用测试")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("进入专属测试文件目录\ncd "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("kubernetes/ceph-csi/examples/cephfs/\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("修改secret文件  secret"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nstringData:\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Required for statically provisioned volumes")]),s._v("\n  userID: fsclient\n  userKey: AQDYCUpjmLjUDxAAYkfNGUG5FUYaFVE6jlFgrQ==\n\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Required for dynamically provisioned volumes")]),s._v("\n  adminID: admin\n  adminKey: AQByzTZjaEaCCRAAolAFknx1x/LgTYhNyy50cw==\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n修改：\n\t根据提示信息修改 userID 和 userKey 的信息\n\t这里的userKey无需进行base64加密\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("修改"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("SC")]),s._v("配置 storageclass"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nparameters:\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n  clusterID: d932ded6-3765-47c1-b0dc-e6957051e31a\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n  fsName: cephfs\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# (optional) Ceph pool into which volume data shall be stored")]),s._v("\n  pool: cephfs-"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n  mounter: kernel\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nmountOptions:\n  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" discard\n修改：\n\t根据提示信息修改 clusterID、fsName、pool、mounter 的信息\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("应用资源清单文件\nkubectl  apply "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f secret"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\nkubectl  apply "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f storageclass"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\nkubectl  apply "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f pvc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\nkubectl  apply "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f pod"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\n")])])]),t("p",[s._v("测试效果")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("确定pvc和pv的效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master /data/kubernetes/ceph-csi/examples/cephfs]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl  get  pvc")]),s._v("\nNAME             STATUS   VOLUME                                     CAPACITY   "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\ncsi-cephfs-pvc   Bound    pvc-6868b7d4-5daa-4c56-ba38-02334bc7a3aa   1Gi        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master /data/kubernetes/ceph-csi/examples/cephfs]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl  get  pv")]),s._v("\nNAME                                       CAPACITY   ACCESS MODES   "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\npvc-6868b7d4-5daa-4c56-ba38-02334bc7a3aa   1Gi        RWX            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("确定pod效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master /data/kubernetes/ceph-csi/examples/rbd]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl  describe pod csi-cephfs-demo-pod  | grep -A3 Volumes:")]),s._v("\nVolumes:\n  mypvc:\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Type")]),s._v(":       PersistentVolumeClaim "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("a reference to a PersistentVolumeClaim in the same namespace"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    ClaimName:  csi-cephfs-pvc\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("pod环境中确认效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master /data/kubernetes/ceph-csi/deploy/cephfs/kubernetes]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl  exec -it csi-cephfs-demo-pod -- mount | grep ceph")]),s._v("\n10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("13:6789"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("14:6789"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("15:6789:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("volumes/csi/csi-vol-b7cd7860-8d68-4a20-91ee-b3031ef8c3a9/78b1871c-1274-4c47-8bd6-1f255a5275ed on "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("lib/www "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" ceph "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("rw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("relatime"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("name=admin"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("secret=<hidden>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("fsid=00000000-0000-0000-0000-000000000000"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("acl"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("mds_namespace=cephfs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("wsize=16777216"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),t("p",[s._v("环境收尾")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("清理应用环境\ncd "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("kubernetes/ceph-csi/examples/rbd\nkubectl  delete "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f pod"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f pvc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\nkubectl  delete "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f storageclass"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f secret"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\n\n清理"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sc")]),s._v("环境\ncd "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("kubernetes/ceph-csi/deploy/rbd/kubernetes\nkubectl  delete "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("清理ceph环境\nceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" kubernetes kubernetes "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("yes-i-really-really-mean-it\nceph auth "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("kubernetes\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-5-10-集群部署"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-5-10-集群部署"}},[s._v("#")]),s._v(" 1.5.10 集群部署")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("简介")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\tRook 是 Kubernetes 的开源云原生存储编排器，为各种存储解决方案提供平台、框架和支持，以与云原生环境进行原生集成。\n\tRook 将存储软件转变为自我管理、自我扩展和自我修复的存储服务。它通过自动化部署、引导、配置、供应、扩展、升级、迁移、灾难恢复、监控和资源管理来实现这一点。Rook 使用底层云原生容器管理、调度和编排平台提供的设施来履行其职责。\tRook 利用扩展点深度集成到云原生环境中，并为调度、生命周期管理、资源管理、安全性、监控和用户体验提供无缝体验。\n\tRook 是用 golang 实现的。Ceph 是用 C+"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" 实现的，其中数据路径经过高度优化。\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\tRook是一个自管理的分布式存储编排系统，可以为Kubernetes提供便利的存储解决方案，Rook本身并不提供存储，而是在Kubernetes和存储之间提供适配层，简化存储系统的部署和维护工作。目前，主要支持存储系统包括但不限于Ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("主推"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("、Cassandra、NFS。\n\t从本质上来说，Rook 是一个可以提供 Ceph 集群管理能力的 Operator。Rook 使用 CRD 一个控制器来对 Ceph 之类的资源进行部署和管理。\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("最新版本: 1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("3\n官方地址：https:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("rook"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("io/docs/rook/v1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("9/ceph-storage"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("html\ngithub: https:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("github"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com/rook/rook\n")])])]),t("p",[t("img",{attrs:{src:"image/kubernetes.png",alt:"img"}})]),s._v(" "),t("p",[s._v("环境要求")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" K8s集群，1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("16版本"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v("\n2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" K8s至少3个工作节点\n3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" 每个工作节点有一块未使用的硬盘\n4"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" Rook支持部署Ceph Nautilus以上版本\n")])])]),t("p",[s._v("准备工作")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看master节点的污点\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl describe nodes kubernetes-master | grep Taints:")]),s._v("\nTaints:             node-role"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("kubernetes"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("io/master:NoSchedule\n\n移除master节点的污点\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl taint nodes kubernetes-master node-role.kubernetes.io/master:NoSchedule-")]),s._v("\nnode/kubernetes-master untainted\n\n确认效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl describe nodes kubernetes-master | grep Taints:")]),s._v("\nTaints:             <none>\n")])])]),t("p",[s._v("部署环境")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("获取软件\ncd "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("kubernetes\ngit clone https:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("github"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com/rook/rook"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("git\ncd rook/deploy/examples\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建rook\nkubectl apply "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f crds"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f common"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f operator"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("部署ceph\nkubectl apply "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f cluster"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("部署Rook Ceph工具\nkubectl apply "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f toolbox"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("部署Ceph UI\nkubectl apply "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f dashboard-external-https"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\n")])])]),t("p",[s._v("检查效果")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("检查pod\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master /data/kubernetes/rook/deploy/examples]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl  get pod -n rook-ceph")]),s._v("\nNAME                                                          READY   "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\ncsi-cephfsplugin-cs9z7                                        2/2     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\ncsi-cephfsplugin-l2bgm                                        2/2     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\ncsi-cephfsplugin-provisioner-657868fc8c-66nsc                 5/5     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\ncsi-cephfsplugin-provisioner-657868fc8c-phdxm                 5/5     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\ncsi-cephfsplugin-x7d7k                                        2/2     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\ncsi-rbdplugin-425nc                                           2/2     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\ncsi-rbdplugin-kthc2                                           2/2     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\ncsi-rbdplugin-provisioner-9d6787bcd-4pzvf                     5/5     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\ncsi-rbdplugin-provisioner-9d6787bcd-q6gnf                     5/5     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\ncsi-rbdplugin-zt2qc                                           2/2     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nrook-ceph-crashcollector-kubernetes-master-6795cf77b5-k6m98   1/1     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nrook-ceph-crashcollector-kubernetes-node1-7986cf44b-m7fdv     1/1     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nrook-ceph-crashcollector-kubernetes-node2-7d666d4f7c-lhvcw    1/1     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nrook-ceph-mgr-a-567fc6fbf9-tr9kq                              2/2     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nrook-ceph-mgr-b-56496f5b65-7mtzb                              2/2     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nrook-ceph-mon-a-74dd858bcf-rn6bs                              1/1     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nrook-ceph-mon-b-7dbffc8dd8-ddvsl                              1/1     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nrook-ceph-mon-c-6f7567b6dc-n7c47                              1/1     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nrook-ceph-operator-785cc8f794-l8dc5                           1/1     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nrook-ceph-osd-0-98876dbd6-49wl4                               1/1     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nrook-ceph-osd-1-c867b6ddc-clc6c                               1/1     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nrook-ceph-osd-2-d74bd646-rhwbs                                1/1     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nrook-ceph-osd-3-779b6dc974-q6lbm                              1/1     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nrook-ceph-osd-4-5646549855-crjqf                              1/1     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nrook-ceph-osd-5-7b96ffbf6c-jsdsm                              1/1     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nrook-ceph-osd-prepare-kubernetes-master-fxtbp                 0/1     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nrook-ceph-osd-prepare-kubernetes-node1-l4f2s                  0/1     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nrook-ceph-osd-prepare-kubernetes-node2-k6wx4                  0/1     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nrook-ceph-tools-7c8ddb978b-sqlj2                              1/1     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("检查svc\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master /data/kubernetes/rook/deploy/examples]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl  get svc -n rook-ceph")]),s._v("\nNAME                                     "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("TYPE")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("  PORT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("S"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("             AGE\nrook-ceph-mgr                            ClusterIP   "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("  9283/TCP            26m\nrook-ceph-mgr-dashboard                  ClusterIP   "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("  8443/TCP            26m\nrook-ceph-mgr-dashboard-external-https   NodePort    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("  8443:31825/TCP      44m\nrook-ceph-mon-a                          ClusterIP   "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("  6789/TCP"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("3300/TCP   36m\nrook-ceph-mon-b                          ClusterIP   "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("  6789/TCP"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("3300/TCP   35m\nrook-ceph-mon-c                          ClusterIP   "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("  6789/TCP"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("3300/TCP   29m\n")])])]),t("p",[s._v("查看dashboard")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("获取Ceph Dashboard登录密码\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master /data/kubernetes/rook/deploy/examples]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl -n rook-ceph get secret rook-ceph-dashboard-password -o jsonpath=\"{['data']['password']}\" | base64 -d")]),s._v("\n^B7+jmpcdh+"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("u^"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("@n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("K\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("浏览器访问： https:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("19:31825，输入用户名admin，密码^B7+jmpcdh+"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("u^"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("@n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("K\n")])])]),t("p",[t("img",{attrs:{src:"image/image-20221016004235785.png",alt:"image-20221016004235785"}})]),s._v(" "),t("p",[s._v("命令环境监测")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("获取ceph-tools工具\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl  get pod -n rook-ceph  | grep tools")]),s._v("\nrook-ceph-tools-7c8ddb978b-sqlj2     1/1     Running     0             18m\n\n进入到专用工具环境\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl -n rook-ceph exec -it rook-ceph-tools-7c8ddb978b-sqlj2 -- /bin/bash")]),s._v("\nbash-4"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("4$\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("检查ceph环境\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl -n rook-ceph exec -it rook-ceph-tools-7c8ddb978b-sqlj2 -- /bin/bash")]),s._v("\nbash-4"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("4$ ceph "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("s\n  cluster:\n    id:     d20c23c6-4d4f-4926-a0ca-fed583a907a0\n    health: HEALTH_WARN\n            clock skew detected on mon"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("c\n\n  services:\n    mon: 3 daemons"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" quorum a"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("b"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("c "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("age 17m"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    mgr: b"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("active"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" since 19m"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" standbys: a\n    osd: 6 osds: 6 up "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("since 18m"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 6 in "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("since 22m"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(":\n    pools:   1 pools"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 1 pgs\n    objects: 2 objects"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 449 KiB\n    usage:   92 MiB used"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 120 GiB "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" 120 GiB avail\n    pgs:     1 active+clean\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("bash-4"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("4$ ceph df\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" RAW STORAGE "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CLASS")]),s._v("     SIZE    AVAIL    USED  RAW USED  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v("RAW USED\nhdd    120 GiB  120 GiB  92 MiB    92 MiB       0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("08\nTOTAL  120 GiB  120 GiB  92 MiB    92 MiB       0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("08\n\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" POOLS "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("\nPOOL  ID  PGS   STORED  OBJECTS     USED  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v("USED  MAX AVAIL\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("mgr   1    1  449 KiB        2  449 KiB      0     38 GiB\n")])])]),t("p",[s._v("部署rbd 和 cephfs环境")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("部署rbd环境\nkubectl apply "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f csi/rbd/storageclass"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\n\n部署cephfs环境\nkubectl apply "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f filesystem"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\nkubectl apply "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f csi/cephfs/storageclass"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("检查环境\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master /data/kubernetes/rook/deploy/examples]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl  get sc")]),s._v("\nNAME              PROVISIONER                     RECLAIMPOLICY   "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nrook-ceph-block   rook-ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rbd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("csi"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com      Delete          "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nrook-cephfs       rook-ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("cephfs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("csi"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com   Delete          "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("存储测试")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("定制资源清单文件 pvc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: mysql-pv-claim\n  labels:\n    app: wordpress\nspec:\n  storageClassName: rook-ceph-block\n  accessModes:\n  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" ReadWriteOnce\n  resources:\n    requests:\n      storage: 20Gi\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("应用资源对象文件\nkubectl apply "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f pvc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("确定效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master /data/kubernetes/rook/deploy/examples]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl  get pvc")]),s._v("\nNAME             STATUS        VOLUME                                     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nmysql-pv-claim   Bound         pvc-fa8d837b-a087-471f-8d00-0c8a9fe65835   "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master /data/kubernetes/rook/deploy/examples]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl -n rook-ceph exec -it rook-ceph-tools-7c8ddb978b-sqlj2 -- rbd ls --pool replicapool -l")]),s._v("\nNAME                                          SIZE    PARENT  FMT  PROT  LOCK\ncsi-vol-c7d28742-4ca9-11ed-bffb-d22d32d7a8e9  20 GiB            2\n")])])]),t("p",[s._v("wordpress测试")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("应用资源对象文件\nkubectl  apply "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f mysql"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f wordpress"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("yaml\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("获取pvc的效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master /data/kubernetes/rook/deploy/examples]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pvc -l app=wordpress")]),s._v("\nNAME             STATUS   VOLUME                                     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("   AGE\nmysql-pv-claim   Bound    pvc-38487272-e3cf-46a2-be06-0e20af42054f   "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("   25s\nwp-pv-claim      Bound    pvc-17da7479-cb6d-46b5-a4fe-0f230f0ae780   "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("   25s\n\n获取pod的效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master /data/kubernetes/rook/deploy/examples]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pods -l app=wordpress")]),s._v("\nNAME                               READY   STATUS    RESTARTS   AGE\nwordpress-b98c66fff-gbxbc          1/1     Running   0          38s\nwordpress-mysql-79966d6c5b-6g82t   1/1     Running   0          38s\n\n获取svc的效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@kubernetes-master /data/kubernetes/rook/deploy/examples]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get svc -l app=wordpress")]),s._v("\nNAME              "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("TYPE")]),s._v("           CLUSTER-IP      EXTERNAL-IP   PORT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("S"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("        AGE\nwordpress         LoadBalancer   10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("98"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("101"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("125   <pending>     80:31606/TCP   47s\nwordpress-mysql   ClusterIP      None            <none>        3306/TCP       47s\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("浏览器访问： http:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("19:31606，可以看到wordpress的部署页面\n")])])]),t("p",[t("img",{attrs:{src:"image/image-20221016011450922.png",alt:"image-20221016011450922"}})]),s._v(" "),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])])])}),[],!1,null,null,null);t.default=n.exports}}]);