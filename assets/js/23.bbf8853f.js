(window.webpackJsonp=window.webpackJsonp||[]).push([[23],{302:function(s,t,a){"use strict";a.r(t);var n=a(10),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"_1-核心实践"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-核心实践"}},[s._v("#")]),s._v(" 1 核心实践")]),s._v(" "),t("h2",{attrs:{id:"_1-1-认证管理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-认证管理"}},[s._v("#")]),s._v(" 1.1 认证管理")]),s._v(" "),t("h3",{attrs:{id:"_1-1-1-认证基础"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-1-认证基础"}},[s._v("#")]),s._v(" 1.1.1 认证基础")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("简介")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\tCeph作为一个分布式存储系统，支持对象存储、块设备和文件系统。为了在网络传输中防止数据被篡改，做到较高程度的安全性，加入了Cephx加密认证协议。其目的是客户端和管理端之间的身份识别，加密、验证传输中的数据。\n\t注意：所谓的client就是使用ceph命令的客户端\n\t\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("ceph集群默认开启了cephx协议功能\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[global]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nauth_cluster_required = cephx\nauth_service_required = cephx\nauth_client_required = cephx\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\n如果我们提供的是公共的信息 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v(" 不需要进行认证，所以我们可以禁用CephX功能。将对应的属性值设置为 none即可，比如\nauth_cluster_required = none\n")])])]),t("p",[s._v("认证场景")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("命令行与Ceph集群操作，包括：\n    RadosGW 对象网关认证（对象网关认证系统"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v("cephx）\n    RBD 认证\n    CephFS 用户认证（文件路径"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v("cephx）\nCeph集群内部组件之间通信\n\t执行ceph命令时，会使用client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("admin 用户并加载 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/ceph/ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("admin"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring文件\n")])])]),t("p",[s._v("认证和授权")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t在ceph系统中，所有元数据保存在mon节点的ceph-mon的进程中，mon保存了系统中重要的认证相关元数据，例如每个用户的key以及权限。样式结构如下：\n\t\n    名称\t\t\t\tkey\t\tCaps（权限）\n    client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("admin\txxxxxx\t  osd allow rw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" mon allow rw\n    \n    \n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("对于ceph的认证和授权来说，主要涉及到三个内容：ceph用户、资源权限、用户授权。\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" Ceph用户必须拥有执行权限才能执行Ceph的管理命令\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" Ceph用户需要拥有存储池访问权限才能到ceph中读取和写入数据\n")])])]),t("p",[s._v("基本概念")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("用户 \n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" ceph创建出来的用户，可以进入到ceph集群里面\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" ceph支持多种类型，可管理的用户属于Client类型\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" MON、OSD和MDS等系统组件属于系统参与者客户端\n授权\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 将某些资源的使用权限交给特定的用户。\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" allow\n权限\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 描述用户可针对MON、OSD或MDS等资源的使用权限范围或级别\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" MON具备的权限包括r、w、x和allow profile cap\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" OSD具备的权限包括r、w、x和"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("read、"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("write")]),s._v("和profile osd、存储池和名称空间设置\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" OSD具备的权限包括allow\n")])])]),t("p",[s._v("权限解析")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("allow\n\t需先于守护进程的访问设置指定，标识赋予的xx权限\nr：读取权限，访问MON以检索CRUSH时依赖此使能\nw：对象写入权限\nx：调用类方法（读取和写入）的能力，以及在MON上执行auth操作的能力\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("read：x能力的子集，授予用户调用类读取方法的能力\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("write")]),s._v("：x的子集，授予用户调用类写入方法的能力\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("：授予用户对特定守护进程"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("存储池的读取、写入和执行权限，以及执行管理命令的能力\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("profile osd\n\t授予用户以某个OSD身份连接到其他OSD或监视器的权限\nprofile mds\n\t授予用户以某个MDS身份连接到其他MDS或监视器的权限\nprofile bootstrap-osd\n\t授予用户引导OSD的权限，在部署时候产生\nprofile bootstrap-mds\n\t授予用户引导元数据服务器的权限，在部署时候产生\n")])])]),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("CephX身份验正流程")]),s._v(" "),t("p",[t("img",{attrs:{src:"image/image-20211206175437937.png",alt:"image-20211206175437937"}})]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\tclient和osd都有一个叫做monclient的模块负责认证和密钥交换。而monitor上有一个AuthMonitor的服务模块负责与monclient对话。\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("Ceph使用cephx协议对客户端进行身份认证\n\t每个MON都可以对客户端进行身份验正并分发密钥，不存在单点故障和性能瓶颈"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("MON会返回用于身份验正的数据结构，其包含获取Ceph服务时用到的session key"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" session key通过客户端密钥进行加密\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 客户端使用session key向MON请求所需的服务\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" MON向客户端提供一个ticket，用于向实际处理数据的OSD等验正客户端身份\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" MON和OSD共享同一个secret，因此OSD会信任由MON发放的ticket\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" ticket存在有效期限\n注意：\n\tCephX身份验正功能仅限制Ceph的各组件之间，它不能扩展到其它非Ceph组件；\n\t它并不解决数据传输加密的问题；\n")])])]),t("p",[s._v("CephX身份验正-MDS和OSD")]),s._v(" "),t("p",[t("img",{attrs:{src:"image/image-20211206175909027.png",alt:"image-20211206175909027"}})]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("1 当client与Monitor实现基本的认证后，monitor与后端的mds和osd会自动进行认证信息的同步\n2 当client与Monitor实现基本的通信认证后\n\t可以独立与后端的MDS服务发送请求。\n\t可以独立与后端的OSD服务发送请求\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-1-2-用户基础"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-2-用户基础"}},[s._v("#")]),s._v(" 1.1.2 用户基础")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("简介")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("Ceph集群管理员能够直接在Ceph集群中创建、更新和删除用户\n注意：\n\t创建用户时，可能需要将密钥分发到客户端，以便将密钥添加到密钥环\n")])])]),t("p",[s._v("常见命令")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("列出用户\n\t命令：ceph auth list\n\t用户标识："),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("TYPE")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ID，因此，osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0表示OSD类型的用户，用户ID为0\n\n检索特定用户\n\t命令：ceph auth get "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("TYPE")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ID或者ceph auth export "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("TYPE")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ID\n\t\n列出用户的密钥\n\t命令：ceph auth print-key "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("TYPE")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ID\n")])])]),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("信息查看")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看用户账号\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph auth list\nosd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0\n        key: AQCv3i9j34BWKhAAII3+THENuLJTv5Yr2NwDxA==\n        caps: "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[mgr]")]),s._v(" allow profile osd\n        caps: "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[mon]")]),s._v(" allow profile osd\n        caps: "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[osd]")]),s._v(" allow "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n结果显示：\n\t每个osd都有类似的caps权限信息\n\tclient"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("admin具备的权限是非常多的\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看制定的认证信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph auth get osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[osd.0]")]),s._v("\n        key = AQCv3i9j34BWKhAAII3+THENuLJTv5Yr2NwDxA==\n        caps mgr = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow profile osd"')]),s._v("\n        caps mon = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow profile osd"')]),s._v("\n        caps osd = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow *"')]),s._v("\nexported keyring "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看秘钥文件信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/ceph/\nceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("admin"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring  ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf  rbdmap  tmpr0oj5H\n\t\n查看秘钥环相关的信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/ceph/ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("admin"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[client.admin]")]),s._v("\n        key = AQAr0S9jK8RNLxAAD/xpDZgnAx1kQEV3+"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("utWw==\n        caps mds = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow *"')]),s._v("\n        caps mgr = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow *"')]),s._v("\n        caps mon = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow *"')]),s._v("\n        caps osd = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow *"')]),s._v("\n注意：\n\t一个秘钥环里面可以存放很多秘钥信息的\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("列出用户秘钥信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph auth print-key mgr"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("mon01\nAQC12C9j/hAgKhAA6lOZiUpz5kqA55PFv3eHng==\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-1-3-用户实践"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-3-用户实践"}},[s._v("#")]),s._v(" 1.1.3 用户实践")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("简介")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t在ceph中，针对用户主要有两种场景：增删和导出导入\n")])])]),t("p",[s._v("命令解析")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("添加用户\n\tceph auth add：创建用户、生成密钥并添加指定的caps\n\tceph auth "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("get-or")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("create：创建用户并返回密钥文件格式的密钥信息，用户存在时返回密钥信息\n\tceph auth "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("get-or")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("create-key：创建用户并返回密钥信息，用户存在时返回密钥信息\n\n注意：\n\t典型的用户至少对 Ceph monitor 具有读取功能，并对 Ceph OSD 具有读取和写入功能；\n\t另外，用户的 OSD 权限通常应该限制为只能访问特定的存储池，\n\t否则，他将具有访问集群中所有存储池的权限\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("导入用户\n\t命令：ceph auth import\n\n修改用户caps\n\t命令：ceph auth caps\n\t\t会覆盖用户现有的caps，因此建立事先使用ceph auth get "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("TYPE")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ID命令查看用户的caps\n\t若是为添加caps，则需要先指定现有的caps"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("命令格式如下：\n\t\tceph auth caps "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("TYPE")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ID daemon "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'allow [r|w|x|*|...] [pool=pool-name]'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\n删除用户\n\t命令：ceph auth "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("del")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("TYPE")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ID\n")])])]),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("添加用户")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看帮助信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph auth "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("help\n\n General usage:\n ==============\nusage: ceph "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("h"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("c CEPHCONF"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("i INPUT_FILE"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("o OUTPUT_FILE"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("setuser SETUSER"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("setgroup SETGROUP"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("id CLIENT_ID"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("name CLIENT_NAME"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("cluster CLUSTER"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("admin-daemon ADMIN_SOCKET"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("w"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("watch-debug")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("watch-info")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("watch-sec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("watch-warn")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("watch-error")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("watch-channel")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("cluster"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("audit"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("version"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("verbose"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("concise"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("json"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("json-pretty"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("xml"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("xml-pretty"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("plain"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("connect-timeout")]),s._v(" CLUSTER_TIMEOUT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("block"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("period PERIOD"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建普通用户\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph auth add client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("testuser mon "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'allow r'")]),s._v(" osd "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'allow rw pool=rdbpool'")]),s._v("\nadded key "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("testuser\n\n获取创建的用户信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph auth get client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("testuser\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[client.testuser]")]),s._v("\n        key = AQDfOTBjsmRaEhAATcpXwDluXBpshy4420/zgg==\n        caps mon = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow r"')]),s._v("\n        caps osd = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow rw pool=rdbpool"')]),s._v("\nexported keyring "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("testuser\n\n列出用户的秘钥信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph auth print-key client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("testuser\nAQDfOTBjsmRaEhAATcpXwDluXBpshy4420/zgg==\n")])])]),t("p",[s._v("用户授权")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("修改用户的授权\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph auth caps client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("testuser mon "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'allow rw'")]),s._v(" osd "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'allow rw pool=rdbpool1'")]),s._v("\nupdated caps "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("testuser\n\n查看修改后的授权信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph auth get client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("testuser\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[client.testuser]")]),s._v("\n        key = AQDfOTBjsmRaEhAATcpXwDluXBpshy4420/zgg==\n        caps mon = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow rw"')]),s._v("\n        caps osd = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow rw pool=rdbpool1"')]),s._v("\nexported keyring "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("testuser\n")])])]),t("p",[s._v("导出用户")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看导出信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph auth export client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("testuser\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[client.testuser]")]),s._v("\n        key = AQDfOTBjsmRaEhAATcpXwDluXBpshy4420/zgg==\n        caps mon = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow rw"')]),s._v("\n        caps osd = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow rw pool=rdbpool1"')]),s._v("\nexport auth"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("key=AQDfOTBjsmRaEhAATcpXwDluXBpshy4420/zgg=="),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("导出信息到一个备份文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph auth export client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("testuser > testuser"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("file\nexport auth"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("key=AQDfOTBjsmRaEhAATcpXwDluXBpshy4420/zgg=="),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" testuser"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("file\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[client.testuser]")]),s._v("\n        key = AQDfOTBjsmRaEhAATcpXwDluXBpshy4420/zgg==\n        caps mon = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow rw"')]),s._v("\n        caps osd = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow rw pool=rdbpool1"')]),s._v("\n")])])]),t("p",[s._v("删除用户")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("删除用户信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph auth "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("del")]),s._v(" client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("testuser\nupdated\n\n查看效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph auth get client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("testuser\nError ENOENT: failed to find client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("testuser in keyring\n")])])]),t("p",[s._v("导入用户")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("导入用户文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph auth  import "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("i testuser"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("file\nimported keyring\n\n查看文件效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph auth get client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("testuser\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[client.testuser]")]),s._v("\n        key = AQDfOTBjsmRaEhAATcpXwDluXBpshy4420/zgg==\n        caps mon = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow rw"')]),s._v("\n        caps osd = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow rw pool=rdbpool1"')]),s._v("\nexported keyring "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("testuser\n")])])]),t("p",[s._v("尝试创建一个未知的用户")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建一个已知的用户\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph auth "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("get-or")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("create client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("testuser\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[client.testuser]")]),s._v("\n        key = AQDfOTBjsmRaEhAATcpXwDluXBpshy4420/zgg==\n结果显示：\n\t如果是一个已存在的用户名，则会返回具体的信息，而且不会覆盖现有的用户信息\n\t\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph auth get client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("testuser\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[client.testuser]")]),s._v("\n        key = AQDfOTBjsmRaEhAATcpXwDluXBpshy4420/zgg==\n        caps mon = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow rw"')]),s._v("\n        caps osd = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow rw pool=rdbpool1"')]),s._v("\nexported keyring "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("testuser\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建一个未知的用户\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph auth "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("get-or")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("create client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("testuser2 mon "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'allow r'")]),s._v(" osd "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'allow rw pool=rdbpool'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[client.testuser2]")]),s._v("\n        key = AQAwPDBjHPByABAA+nMEvAXztrzE8FSCZkNGgg==\n        \n如果从未出现过的用户，则直接创建新的用户\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph auth get client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("testuser2\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[client.testuser2]")]),s._v("\n        key = AQAwPDBjHPByABAA+nMEvAXztrzE8FSCZkNGgg==\n        caps mon = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow r"')]),s._v("\n        caps osd = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow rw pool=rdbpool"')]),s._v("\nexported keyring "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("testuser2\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-1-4-秘钥管理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-4-秘钥管理"}},[s._v("#")]),s._v(" 1.1.4 秘钥管理")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("keyring")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t密钥环文件是“存储机密、密码、密钥、证书并使它们可用于应用程序的组件的集合”。密钥环文件存储一个或多个 Ceph 身份验证密钥以及可能的相关功能规范。\n\n注意：\n\t每个键都与一个实体名称相关联，形式为 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("mon"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("mds"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("name。\n\tceph-authtool 是一个用于创建、查看和修改 Ceph 密钥环文件的实用程序。\n")])])]),t("p",[s._v("秘钥环文件信息")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("访问Ceph集群时，客户端会于本地查找密钥环，只有，认证成功的对象，才可以正常使用。\n\n默认情况下，Ceph会使用以下四个密钥环名称预设密钥环\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/ceph/cluster-name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("user-name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring：保存单个用户的keyring\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/ceph/cluster"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring：保存多个用户的keyring\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/ceph/keyring\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/ceph/keyring"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("bin\n\t注意：\n\t\tcluster-name是为集群名称，user-name是为用户标识（"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("TYPE")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ID）\n\t\tclient"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("admin用户的在名为ceph的集群上的密钥环文件名为ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("admin"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring\n")])])]),t("p",[s._v("keyring的管理")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建keyring\n\tceph auth add等命令添加的用户还需要额外使用ceph-authtool命令为其创建用户密钥环文件"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("ceph客户端通过keyring文件查找用户名并检索密钥\n\t命令：ceph-authtool "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("create-keyring "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("path/to/kerying\n注意\n\tkeyring文件一般应该保存于"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/ceph目录中，以便客户端能自动查找\n\t创建包含多个用户的keyring文件时，应该使用cluster-name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring作为文件名\n\t创建仅包含单个用户的kerying文件时，应该使用cluster-name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("user-name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring作为文件名\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("将用户添加至keyring\n\t可将某个用户从包含多个用户的keyring中导出，并保存于一个专用的keyring文件\n\t命令：ceph auth get "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("TYPE")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ID "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("o "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/ceph/cluster-name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("user-name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring\n\n\t也可将用户的keyring合并至一个统一的keyring文件中\n\t命令：ceph-authtool "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/ceph/cluster-name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("import-key")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/ceph/clustername"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nuser-name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("ceph-authtool命令可直接创建用户、授予caps并创建keyring\n\tceph-authtool keyringfile "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("C "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("create-keyring"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("n "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("name entityname"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("genkey"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("a "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("add-key")]),s._v(" base64_key"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("cap "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("caps capfile"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\t\n注意：\n\t此种方式添加的用户仅存在于keyring文件中，管理员还需要额外将其添加至Ceph集群上；\n\t命令： ceph auth add "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("TYPE")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ID "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("i "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("PATH/TO/keyring\n")])])]),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("创建携带秘钥环的账号")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建普通格式的用户\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph auth "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("get-or")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("create client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("kube mon "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'allow r'")]),s._v(" osd "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'allow * pool=kube'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[client.kube]")]),s._v("\n        key = AQA11TBjzq6NEhAAF2tyvEY0L+XYMP7IOykkcQ==\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看用户信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph auth get client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("kube\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[client.kube]")]),s._v("\n        key = AQA11TBjzq6NEhAAF2tyvEY0L+XYMP7IOykkcQ==\n        caps mon = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow r"')]),s._v("\n        caps osd = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow * pool=kube"')]),s._v("\nexported keyring "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("kube\n\n查看文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("\nceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("bootstrap-mds"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring  ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("bootstrap-rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring  ceph-deploy-ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("log\nceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("bootstrap-mgr"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring  ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("admin"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring   ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("mon"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring\nceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("bootstrap-osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring  ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf                   testuser"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("file                  \n结果显示：\n\t没有生成对应的用户秘钥环文件\n")])])]),t("p",[s._v("导出秘钥环文件")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("将普通的用户导出为keyring\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph auth get client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("kube "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("o ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("kube"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring\nexported keyring "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("kube\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ll "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("kube*\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("rw-rw-r-"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 1 cephadm cephadm 117 9月  26 06:26 ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("kube"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("kube"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[client.kube]")]),s._v("\n        key = AQA11TBjzq6NEhAAF2tyvEY0L+XYMP7IOykkcQ==\n        caps mon = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow r"')]),s._v("\n        caps osd = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow * pool=kube"')]),s._v("\n")])])]),t("p",[s._v("合并秘钥环文件")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建要合并的文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph-authtool "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("create-keyring cluster"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring\ncreating cluster"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ll cluster"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("rw-"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v(" 1 cephadm cephadm 0 9月  26 06:28 cluster"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring\n\n合并要导入的keyring文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph-authtool cluster"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("import-keyring")]),s._v(" ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("kube"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring\nimporting contents of ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("kube"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring into cluster"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" cluster"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[client.kube]")]),s._v("\n        key = AQA11TBjzq6NEhAAF2tyvEY0L+XYMP7IOykkcQ==\n        caps mon = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow r"')]),s._v("\n        caps osd = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow * pool=kube"')]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("再来合并一个用户\nc"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph-authtool cluster"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("import-keyring")]),s._v(" ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("admin"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring\nimporting contents of ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("admin"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring into cluster"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring\n\n查看合并后效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" cluster"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[client.admin]")]),s._v("\n        key = AQAr0S9jK8RNLxAAD/xpDZgnAx1kQEV3+"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("utWw==\n        caps mds = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow *"')]),s._v("\n        caps mgr = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow *"')]),s._v("\n        caps mon = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow *"')]),s._v("\n        caps osd = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow *"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[client.kube]")]),s._v("\n        key = AQA11TBjzq6NEhAAF2tyvEY0L+XYMP7IOykkcQ==\n        caps mon = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow r"')]),s._v("\n        caps osd = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow * pool=kube"')]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("专用查看keyring的内容\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph-authtool "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("l cluster"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[client.admin]")]),s._v("\n        key = AQAr0S9jK8RNLxAAD/xpDZgnAx1kQEV3+"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("utWw==\n        caps mds = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow *"')]),s._v("\n        caps mgr = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow *"')]),s._v("\n        caps mon = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow *"')]),s._v("\n        caps osd = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow *"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[client.kube]")]),s._v("\n        key = AQA11TBjzq6NEhAAF2tyvEY0L+XYMP7IOykkcQ==\n        caps mon = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow r"')]),s._v("\n        caps osd = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow * pool=kube"')]),s._v("\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h2",{attrs:{id:"_1-2-rbd接口"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-rbd接口"}},[s._v("#")]),s._v(" 1.2 RBD接口")]),s._v(" "),t("h3",{attrs:{id:"_1-2-1-基础知识"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-1-基础知识"}},[s._v("#")]),s._v(" 1.2.1 基础知识")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("简介")]),s._v(" "),t("p",[t("img",{attrs:{src:"image/1636089258096.png",alt:"1636089258096"}})]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\tCeph块设备，也称为RADOS块设备（简称RBD），是一种基于RADOS存储系统支持超配（thin-provisioned）、可伸缩的条带化数据存储系统，它通过librbd库与OSD进行交互。RBD为KVM等虚拟化技术和云OS（如OpenStack和CloudStack）提供高性能和无限可扩展性的存储后端，这些系统依赖于libvirt和QEMU实用程序与RBD进行集成。\n")])])]),t("p",[s._v("RBD")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("RBD，全称RADOS Block Devices，是一种建构在RADOS存储集群之上为客户端提供块设备接口的存储服务中间层"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 这类的客户端包括虚拟化程序KVM（结合qemu）和云的计算操作系统OpenStack和CloudStack等\n\nRBD基于RADOS存储集群中的多个OSD进行条带化，支持存储空间的简配（thinprovisioning）和动态扩容等特性，并能够借助于RADOS集群实现快照、副本和一致性。同时，RBD自身也是RADOS存储集群的客户端，它通过将存储池提供的存储服务抽象为一到多个image（表现为块设备）向客户端提供块级别的存储接口\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" RBD支持两种格式的image，不过v1格式因特性较少等原因已经处于废弃状态\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 当前默认使用的为v2格式\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("客户端访问RBD设备的方式有两种\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 通过内核模块rbd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ko将image映射为节点本地的块设备，相关的设备文件一般为"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("dev/rdb"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#（#为设备编号，例如rdb0等）")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 通过librbd提供的API接口，它支持C/C+"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v("和Python等编程语言，qemu即是此类接口的客户端\n")])])]),t("p",[s._v("操作逻辑")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\tRBD接口在ceph环境创建完毕后，就在服务端自动提供了"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" 客户端基于librbd库即可将RADOS存储集群用作块设备。不过，RADOS集群体用块设备需要经过一系列的"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"额外操作"')]),s._v("才能够为客户端提供正常的存储功能。\n\t这个过程步骤，主要有以下几步：\n\t\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 1 创建一个专用的存储池\n\t\t\tceph osd pool create "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("pool-name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("pg-num"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("pgp-num"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\t\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 2 对存储池启用rbd功能\n\t\t\tceph osd pool application enable "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("pool-name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" rbd\n\t\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 3 对存储池进行环境初始化\n\t\t\trbd pool init "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("pool-name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\t\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 4 基于存储池创建专用的磁盘镜像\n\t\t\trbd create "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("size <megabytes> "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool <pool-name> <image-name>\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("其他命令\n\t存储池中的各image名称需要惟一，“rbd "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("”命令能够列出指定存储池中的image\n\trbd "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p <pool-name>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("format json"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("xml"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pretty-format"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" <pool-name>\n\n\t要获取指定image的详细信息，则通常使用“rbd info”命令\n\trbd info "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool <pool>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("image <image>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("format <format>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("创建专用存储池")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool create rbddata 64\npool "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'rbddata'")]),s._v(" created\n\n注意：\n\t这里面的pg数量，我们定制为64个\n")])])]),t("p",[s._v("对存储池启用rbd功能")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("启用存储池的rbd功能\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool application enable rbddata rbd\nenabled application "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'rbd'")]),s._v(" on pool "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'rbddata'")]),s._v("\n注意：\n\t如果关闭应用的话，使用disable\n\t\n查看rbc的效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool application get rbddata\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"rbd"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),t("p",[s._v("对存储池进行环境初始化")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("环境初始化\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd pool init "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p rbddata\n\n查看效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd pool stats rbddata\nTotal Images: 0\nTotal Snapshots: 0\nProvisioned Size: 0 B\n")])])]),t("p",[s._v("基于存储池创建专用的磁盘镜像")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建镜像\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd create img1 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("size 1024 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool rbddata\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p rbddata\nimg1\n\n查看状态\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd pool stats rbddata\nTotal Images: 1\nTotal Snapshots: 0\nProvisioned Size: 1 GiB\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("注意：\n\t这个时候，我们创建出来的磁盘影响文件，就可以在客户端上，通过内核机制，直接导入到内核中，在内核中被当成一个磁盘设备来进行使用，样式就是 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("dev/xxx，然后就可以针对这个rdb磁盘设备，进行各种后续分区、格式化等操作。\n")])])]),t("p",[s._v("查看磁盘信息")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看方法1：\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd info rbddata/img1\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("image img1 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool rbddata info\nrbd image "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'img1'")]),s._v(":\n        size 1 GiB in 256 objects\n        order 22 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("4 MiB objects"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        snapshot_count: 0\n        id: 3817a3738fac\n        block_name_prefix: rbd_data"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("3817a3738fac\n        format: 2\n        features: layering"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" exclusive-lock"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" object-map"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" fast-"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("diff")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" deep-flatten\n        op_features:\n        flags:\n        create_timestamp: Mon Sep 26 10:46:25 2062\n        access_timestamp: Mon Sep 26 10:46:25 2062\n        modify_timestamp: Mon Sep 26 10:46:25 2062\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("size : 就是这个块的大小，即1024MB=1G，1024MB/256 = 4M"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("共分成了256个对象"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("object"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("，每个对象4M。\norder 22： 有效范围为12-25。22是个幂编号，4M是22， 8M是23，也就是2^22 bytes = 4MB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 2^23 bytes = 8MB\nblock_name_prefix : 这个是块的最重要的属性了，这是每个块在ceph中的唯一前缀编号，有了这个前缀，把主机上的OSD都拔下来带回家，就能复活所有的VM了\nformat : 格式有两种，1和2\nfeatures：当前image启用的功能特性，其值是一个以逗号分隔的字符串列表，例如\n        \tlayering"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" exclusive-lock"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" object-map\nop_features：可选的功能特性；\n")])])]),t("p",[s._v("磁盘设备的删除")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("删除设备\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" rbddata/img1\nRemoving image: 100% complete"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("done"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\n查看效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p rbddata\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd pool stats rbddata\nTotal Images: 0\nTotal Snapshots: 0\nProvisioned Size: 0 B\n\n删除存储池\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" rbddata rbddata "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("yes-i-really-really-mean-it\npool "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'rbddata'")]),s._v(" removed\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-2-2-镜像管理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-2-镜像管理"}},[s._v("#")]),s._v(" 1.2.2 镜像管理")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("镜像属性")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("属性")]),s._v(" "),t("th",[s._v("解析")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("layering")]),s._v(" "),t("td",[s._v("分层克隆机制，磁盘的数据分层获取克隆机制")])]),s._v(" "),t("tr",[t("td",[s._v("striping")]),s._v(" "),t("td",[s._v("是否支持数据对象间的数据条带化")])]),s._v(" "),t("tr",[t("td",[s._v("exclusive-lock")]),s._v(" "),t("td",[s._v("排它锁的机制，磁盘应用于多路读写机制场景。限制同时仅能有一个客户端访问当前image")])]),s._v(" "),t("tr",[t("td",[s._v("object-map")]),s._v(" "),t("td",[s._v("对象位图机制，主要用于加速导入、导出及已用容量统计等操作，依赖于exclusive-lock特性")])]),s._v(" "),t("tr",[t("td",[s._v("fast-diff")]),s._v(" "),t("td",[s._v("快照定制机制，快速对比数据差异，便于做快照管理，依赖于object-map特性")])]),s._v(" "),t("tr",[t("td",[s._v("deep-flatten")]),s._v(" "),t("td",[s._v("数据处理机制，解除父子image及快照的依赖关系")])]),s._v(" "),t("tr",[t("td",[s._v("journaling")]),s._v(" "),t("td",[s._v("磁盘日志机制，将image的所有修改操作进行日志化，便于异地备份，依赖于exclusive-lock特性")])]),s._v(" "),t("tr",[t("td",[s._v("data-pool")]),s._v(" "),t("td",[s._v("是否支持将image的数据对象存储于纠删码存储池，主要用于将image的元数据与数据放置于不同的存储池；")])])])]),s._v(" "),t("p",[s._v("属性操作")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("镜像功能命令\ncephadm@admin:~"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("ceph-cluster$ rbd "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("help "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" grep feature\n    feature disable                   Disable the specified image feature"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    feature enable                    Enable the specified image feature"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("准备工作")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建存储池\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool create kube 64 64\npool "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'kube'")]),s._v(" created\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("\nkube\n\n\n启动rbd功能\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool application enable kube rbd\nenabled application "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'rbd'")]),s._v(" on pool "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'kube'")]),s._v("\n\n\nrbd环境初始化\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd pool init kube\n")])])]),t("p",[s._v("创建镜像")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("方法2：通过参数属性方式，创建一个2G的镜像文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd create "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool super "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("size 2G "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("image vol01\n\n查看镜像\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool kube\nvol01\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("方法2：通过<image-spec>方式，创建一个2G的镜像文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd create "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("size 2G kube/vol02\n\n查看镜像\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool kube\nvol01\nvol02\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看详情信息 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("l\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool kube "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("l\nNAME   SIZE   PARENT  FMT  PROT  LOCK\nvol01  2 GiB            2\nvol02  2 GiB            2\n\n以json格式查看详情 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("format json "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pretty-format\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool kube "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("l "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("format json "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pretty-format\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"image"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"vol01"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"size"')]),s._v(": 2147483648"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"format"')]),s._v(": 2\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"image"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"vol02"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"size"')]),s._v(": 2147483648"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"format"')]),s._v(": 2\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看镜像属性\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd info kube/vol01\nrbd image "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'vol01'")]),s._v(":\n        size 2 GiB in 512 objects\n        order 22 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("4 MiB objects"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        snapshot_count: 0\n        id: 386ed735e96b\n        block_name_prefix: rbd_data"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("386ed735e96b\n        format: 2\n        features: layering"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" exclusive-lock"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" object-map"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" fast-"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("diff")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" deep-flatten\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("p",[s._v("镜像属性")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("禁用磁盘镜像功能\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd feature disable kube/vol01 object-map fast-"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("diff")]),s._v(" deep-flatten\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd info "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool kube "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("image vol01\nrbd image "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'vol01'")]),s._v(":\n        size 2 GiB in 512 objects\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n        features: layering"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" exclusive-lock\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("启用磁盘镜像功能\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd feature enable kube/vol01 object-map fast-"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("diff")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd info "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool kube "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("image vol01\nrbd image "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'vol01'")]),s._v(":\n        size 2 GiB in 512 objects\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n        flags: object map invalid"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" fast "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("diff")]),s._v(" invalid\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-2-3-镜像实践"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-3-镜像实践"}},[s._v("#")]),s._v(" 1.2.3 镜像实践")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("磁盘使用")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("使用方法1：通过内核级别的ceph模块，将rdb设备提供给相关主机使用\n\t初始化存储池后，创建image\n\t最好禁用 object-map，fast-"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("diff")]),s._v("，deep-flatten功能\n\t需要直接与monitor角色进行通信\n\t\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 若存储集群端启用了CephX认证，还需要指定用户名和keyring文件\n\t使用rdb命令的map子命令，进行磁盘文件的映射\n\t\n注意：\n\t在客户端上可以通过 rbd showmapped 查看已经映射的image\n\t在客户端上可以通过 rbd unmap 命令断开已经映射的image\n")])])]),t("p",[s._v("admin主机管理image镜像文件的权限")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("禁用无效的属性\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd feature disable kube/vol01 object-map fast-"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("diff")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd info "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool kube "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("image vol01\nrbd image "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'vol01'")]),s._v(":\n        size 2 GiB in 512 objects\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n        features: layering"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" exclusive-lock\n")])])]),t("p",[s._v("映射命令的帮助")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd help map\nusage: rbd map "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("device-"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" <device-"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(">"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool <pool>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n               "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("namespace <namespace>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("image <image>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("snap <snap>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n               "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("read-only")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("exclusive"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("options <options>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n               <image-or-snap-spec>\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("客户端主机安装基本环境")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("客户端主机安装环境\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum install ceph ceph-common -y")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看模块效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# modinfo ceph")]),s._v("\nfilename:       "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("lib/modules/3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0-1160"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("el7"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("x86_64/kernel/fs/ceph/ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ko"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("xz\nlicense:        GPL\ndescription:    Ceph filesystem "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" Linux\nauthor:         Patience Warnick <patience@newdream"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("net>\nauthor:         Yehuda Sadeh <yehuda@hq"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("newdream"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("net>\nauthor:         Sage Weil <sage@newdream"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("net>\nalias:          fs-ceph\nretpoline:      Y\nrhelversion:    7"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("9\nsrcversion:     EB765DDC1F7F8219F09D34C\ndepends:        libceph\nintree:         Y\nvermagic:       3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0-1160"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("el7"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("x86_64 SMP mod_unload modversions\nsigner:         CentOS Linux kernel signing key\nsig_key:        E1:FD:B0:E2:A7:E8:61:A1:D1:CA:80:A2:3D:CF:0D:BA:3A:A4:AD:F5\nsig_hashalgo:   sha256\n")])])]),t("p",[s._v("管理端主机传递相关文件")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看认证信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph auth get client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("kube\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[client.kube]")]),s._v("\n        key = AQA11TBjzq6NEhAAF2tyvEY0L+XYMP7IOykkcQ==\n        caps mon = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow r"')]),s._v("\n        caps osd = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allow * pool=super"')]),s._v("\nexported keyring "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("kube\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("kube*\nceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("kube"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring\n\n传递认证文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ sudo scp ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("kube"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring root@stor06:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/ceph/\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("传递正常的ceph集群的配置文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ sudo scp ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf root@stor06:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/ceph/\n")])])]),t("p",[s._v("客户端简单使用")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("默认情况下，是无法正常连接ceph集群的\nroot@stor06:~"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph -s")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph -s")]),s._v("\n2062-09-26 11:05:04"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("530 7f7cca27f700 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("1 auth: unable to find a keyring on "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/ceph/ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("admin"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/ceph/ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/ceph/keyring"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/ceph/keyring"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("bin"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" No such file or directory\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[errno 2]")]),s._v(" error connecting to the cluster\n结果显示：\n\t默认采用的认证用户是 client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("admin账号，而我们没有。\n\t\n通过"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("user参数，使用指定的用户来访问ceph\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph --user kube -s")]),s._v("\n  cluster:\n    id:     1d4e5773-619a-479d-861a-66ba451ce945\n    health: HEALTH_OK\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("p",[s._v("rdb文件的使用")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看当前的系统磁盘效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# fdisk -l | grep '磁盘 '")]),s._v("\n磁盘 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("dev/sda：21"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("5 GB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 21474836480 字节，41943040 个扇区\n磁盘 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("dev/sdb：21"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("5 GB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 21474836480 字节，41943040 个扇区\n磁盘 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("dev/sdc：21"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("5 GB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 21474836480 字节，41943040 个扇区\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("映射远程ceph的磁盘文件到本地\nroot@stor06:~"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rbd --user kube map kube/vol01")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("dev/rbd0\n\n查看效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# fdisk -l | grep '磁盘 '")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n磁盘 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("dev/rbd0：2147 MB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 2147483648 字节，4194304 个扇区\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("格式化磁盘\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mkfs.ext4 /dev/rbd0")]),s._v("\nmke2fs 1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("45"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("5 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("07-Jan-2020"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n写入超级块和文件系统账户统计信息： 已完成\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("挂载操作\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mount /dev/rbd0 /mnt")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mount | grep rbd")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("dev/rbd0 on "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("mnt "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" ext4 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("rw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("relatime"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("stripe=1024"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v("=ordered"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n尝试使用磁盘文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cp /etc/issue /mnt/")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /mnt/issue")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("卸载操作\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# umount /mnt")]),s._v("\n")])])]),t("p",[s._v("我们还可以在客户端上，使用 rbd命令对rbd设备进行管理")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("客户端挂载操作\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mount /dev/rbd0 /mnt")]),s._v("\n\n确认效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rbd showmapped")]),s._v("\nid pool namespace image snap device\n0  kube           vol01 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("dev/rbd0\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("主服务器上，查看挂载效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool kube "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("l\nNAME  SIZE  PARENT FMT PROT LOCK\nvol01 2 GiB          2      excl\nvol02 2 GiB          2\n")])])]),t("p",[s._v("磁盘卸载操作")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("卸载操作\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rbd unmap /dev/rbd0")]),s._v("\nrbd: sysfs "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("write")]),s._v(" failed\nrbd: unmap failed: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("16"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" Device or resource busy\n\n卸载磁盘\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# umount /mnt")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rbd unmap /dev/rbd0")]),s._v("\n\n查看挂载效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rbd showmapped")]),s._v("\n\n主节点查看挂载效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool kube "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("l\nNAME   SIZE   PARENT  FMT  PROT  LOCK\nvol01  2 GiB            2\nvol02  2 GiB            2\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-2-4-容量管理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-4-容量管理"}},[s._v("#")]),s._v(" 1.2.4 容量管理")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("容量")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("如果有必要的话，我们可以针对镜像文件的大小进行容量的调整。\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd help resize\nusage: rbd resize "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool <pool>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("namespace <namespace>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n                  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("image <image>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("size <size> "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("allow-shrink"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n                  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("no-progress"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n                  <image-spec>\n")])])]),t("p",[s._v("调整image的大小")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("增大：\n\trbd resize "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool <pool>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("image <image>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("size <size>\n减少：\n\trbd resize "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool <pool>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("image <image>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("size <size> "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("allow-shrink"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])])]),t("p",[s._v("删除image")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("命令格式\n\trbd remove "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool <pool>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("image <image>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" \n\t注意：\n\t\t删除image会导致数据丢失，且不可恢复；\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t如果删除一些敏感的image，为了保险，推荐使用回收站功能trash，确定不再需要时再从trash中删除；\n命令格式：\n\trbd trash "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("list"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("move")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("purge"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("remove"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("restore"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("image的容量扩展")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看当前的image容量\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p kube "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("l\nNAME   SIZE   PARENT  FMT  PROT  LOCK\nvol01  2 GiB            2\nvol02  2 GiB            2\n\n调整image容量\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd resize "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("s 5G kube/vol01\nResizing image: 100% complete"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("done"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\n再次确认image容量大小\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p kube "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("l\nNAME   SIZE   PARENT  FMT  PROT  LOCK\nvol01  5 GiB            2\nvol02  2 GiB            2\n")])])]),t("p",[s._v("image容量的缩小")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("调整image容量\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd resize "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("s 3G kube/vol01 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("allow-shrink\nResizing image: 100% complete"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("done"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\n再次确认image容量大小\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p kube "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("l\nNAME   SIZE   PARENT  FMT  PROT  LOCK\nvol01  3 GiB            2\nvol02  2 GiB            2\n")])])]),t("p",[s._v("删除image文件")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("删除image文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" kube/vol02\nRemoving image: 100% complete"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("done"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\n查看image文件效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p kube "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("l\nNAME   SIZE   PARENT  FMT  PROT  LOCK\nvol01  3 GiB            2\n注意：\n\timage文件的删除是不可修复的\n")])])]),t("p",[s._v("image文件恢复")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看trash命令帮助\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd trash "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("help "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" grep trash\n    trash list "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("trash "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("             List trash images"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    trash "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("move")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("trash "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("             "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Move")]),s._v(" an image to the trash"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    trash purge                       Remove all expired images "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" trash"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    trash remove "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("trash "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("           Remove an image "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" trash"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    trash restore                     Restore an image "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" trash"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("p",[s._v("简介")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看回收站\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd trash "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p kube\n\n移动文件到回收站\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd trash "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("move")]),s._v(" kube/vol01\n\n查看回收站\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd trash "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p kube\n386ed735e96b vol01\n\n查看文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p kube "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("l\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("恢复image文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd trash restore "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p kube "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("image vol01 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("image-id 386ed735e96b\n\n查看回收站\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd trash "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p kube\n\n查看image文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p kube "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("l\nNAME  SIZE  PARENT FMT PROT LOCK\nvol01 3 GiB          2\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-2-5-快照管理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-5-快照管理"}},[s._v("#")]),s._v(" 1.2.5 快照管理")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("快照")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\tRBD支持image快照技术，借助于快照可以保留image的状态历史。Ceph还支持快照“分层”机制，从而可实现快速克隆VM映像。\n")])])]),t("p",[s._v("常见命令")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建快照\n\trbd snap create "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool <pool>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("image <image> "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("snap <snap>\n\t或者 rbd snap create "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("<pool-name>"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("<image-name>@<snapshot-name>\n注意：\n\t在创建映像快照之前应停止image上的IO操作，且image上存在文件系统时，还要确保其处于一致状态；\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("列出快照\n\trbd snap "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool <pool>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("image <image> "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("回滚快照\n\trbd snap rollback "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool <pool>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("image <image> "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("snap <snap> "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n注意：\n\t意味着会使用快照中的数据重写当前版本的image，回滚所需的时间将随映像大小的增加而延长\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("限制快照数量\n\t快照数量过多，必然会导致image上的原有数据第一次修改时的IO压力恶化\n\trbd snap limit "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool <pool>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("image <image>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\n解除限制\n\trbd snap limit clear "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool <pool>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("image <image>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("删除快照\n\trbd snap "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool <pool>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("image <image>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("snap <snap>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("no-progress"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("force"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n提示：\n\tCeph OSD会以异步方式删除数据，因此删除快照并不能立即释放磁盘空间"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("清理快照\n\t删除一个image的所有快照，可以使用rbd snap purge命令\n\trbd snap purge "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool <pool>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("image <image> "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("no-progress"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])])]),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("查看快照命令")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("help "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" grep "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'  snap '")]),s._v("\n    snap create "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("snap add"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("            Create a snapshot"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    snap limit clear                  Remove snapshot limit"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    snap limit "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v("                    Limit the number of snapshots"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    snap list "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("snap "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("               Dump list of image snapshots"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    snap protect                      Prevent a snapshot "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" being deleted"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    snap purge                        Delete all unprotected snapshots"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    snap remove "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("snap "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("             Delete a snapshot"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    snap rename                       Rename a snapshot"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    snap rollback "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("snap revert"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("       Rollback image to snapshot"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    snap unprotect                    Allow a snapshot to be deleted"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("p",[s._v("客户端准备rbd文件")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("客户端挂载rbd文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rbd --user kube map kube/vol01")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("dev/rbd0\n\n查看效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rbd showmapped")]),s._v("\nid  pool  namespace  image  snap  device\n0   kube             vol01  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("dev/rbd0\n\n挂载操作\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mount /dev/rbd0 /mnt")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls /mnt/")]),s._v("\nissue  lost+found\n结果显示：\n\t虽然容量调整过了，但是就有的文件仍然存在\n")])])]),t("p",[s._v("管理端创建快照")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看快照\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd snap list kube/vol01\n\n创建快照\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd snap create kube/vol01@snap01\n\n查看快照\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd snap list kube/vol01\nSNAPID NAME   SIZE  PROTECTED TIMESTAMP\n     4 snap01 3 GiB           Mon Sep 26 11:34:20 2062\n")])])]),t("p",[s._v("恢复快照动作")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("客户端将文件删除\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls /mnt/")]),s._v("\nissue  lost+found\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rm -f /mnt/issue")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls /mnt/")]),s._v("\nlost+found\n\n客户端解除磁盘的占用\nroot@stor06:~"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# umount /mnt")]),s._v("\nroot@stor06:~"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rbd unmap /dev/rbd0")]),s._v("\nroot@stor06:~"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rbd showmapped")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("服务端恢复快照\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd snap rollback kube/vol01@snap01\nRolling back to snapshot: 100% complete"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("done"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\n客户端重新加载磁盘文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rbd --user kube map kube/vol01")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("dev/rbd0\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mount /dev/rbd0 /mnt")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls /mnt/")]),s._v("\nissue  lost+found\n结果显示：\n\t快照数据恢复过来了\n")])])]),t("p",[s._v("删除快照")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("删除之前查看效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd snap list kube/vol01\nSNAPID NAME   SIZE  PROTECTED TIMESTAMP\n     4 snap01 3 GiB           Mon Sep 26 11:34:20 2062\n     \n删除快照\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd snap "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" kube/vol01@snap01\nRemoving snap: 100% complete"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("done"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\n确认删除效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd snap list kube/vol01\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ \n")])])]),t("p",[s._v("快照数量的限制")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("设定快照数量的限制\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd snap limit "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool kube "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("image vol01 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("limit 5\n\n确认效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd snap create kube/vol01@snap01\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd snap create kube/vol01@snap06\nrbd: failed to create snapshot: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("122"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" Disk quota exceeded\n\n解除快照限制\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd snap limit clear "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool kube "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("image vol01\n\n确认效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd snap create kube/vol01@snap06\nCreating snap: 100% complete"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("done"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd snap list kube/vol01\nSNAPID NAME   SIZE  PROTECTED TIMESTAMP\n     6 snap01 3 GiB           Mon Sep 26 11:38:25 2022\n     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    13 snap06 3 GiB           Mon Sep 26 11:39:07 2022\n")])])]),t("p",[s._v("清理所有快照")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("清理所有快照\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd snap purge "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool kube "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("image vol01\n\n确认效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd snap list kube/vol01\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-2-6-快照分层"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-6-快照分层"}},[s._v("#")]),s._v(" 1.2.6 快照分层")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("简介")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\tCeph支持在一个块设备快照的基础上创建一到多个COW或COR（"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Copy-On")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Read）类型的克隆，这种中间快照层机制提了一种极速创建image的方式"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("用户可以创建一个基础image并为其创建一个只读快照层，而后可以在此快照层上创建任意个克隆进行读写操作，甚至能够进行多级克隆\n\t\n例如:\n\t实践中可以为Qemu虚拟机创建一个image并安装好基础操作系统环境作为模板，对其创建创建快照层后，便可按需创建任意多个克隆作为image提供给多个不同的VM（虚拟机）使用，或者每创建一个克隆后进行按需修改，而后对其再次创建下游的克隆"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t通过克隆生成的image在其功能上与直接创建的image几乎完全相同，它同样支持读、写、克隆、空间扩缩容等功能，惟一的不同之处是克隆引用了一个只读的上游快照，而且此快照必须要置于“保护”模式之下\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("Ceph的快照支持COW和COR两种类型\n\tCOW是为默认的类型，仅在数据首次写入时才需要将它复制到克隆的image中\n\tCOR则是在数据首次被读取时复制到当前克隆中，随后的读写操作都将直接基于此克隆中的对象进行\n")])])]),t("p",[s._v("分层快照使用")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("在RBD上使用分层克隆的方法非常简单：\n\t创建一个image，对image创建一个快照并将其置入保护模式，而克隆此快照即可\n\t\n创建克隆的image时，\n\t需要指定引用的存储池、镜像和镜像快照，以及克隆的目标image的存储池和镜像名称，\n\t因此，克隆镜像支持跨存储池进行\n")])])]),t("p",[t("img",{attrs:{src:"image/image-20211210111915782.png",alt:"image-20211210111915782"}})]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("简单来说，这里的快照分层，主要说的就是：\n\t基础的模板快照和特有应用快照\n")])])]),t("p",[s._v("命令实践")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("保护上游的原始快照\n\t下游image需要引用上游快照中的数据，快照的意外删除必将导致数据服务的中止，因此在克隆操作之外，必须将上游的快照置于保护模式\n\trbd snap protect "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool <pool>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("image <image> "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("snap <snap>\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("克隆快照\n\trbd clone "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool <pool>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("image <image> "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("snap <snap> "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("dest-pool <dest-pool> "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\trbd clone "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("<pool-name>"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("<image-name>@<snapshot-name> "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("<pool-name>"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("<image-name>\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("列出快照的子项\n\trbd children "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool <pool>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("image <image> "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("snap <snap>\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("展平克隆的image\n\t克隆的映像会保留对父快照的引用，删除子克隆对父快照的引用时，可通过将信息从快照复制到克隆，进行image的“展平”操作\n\t展平克隆所需的时间随着映像大小的增加而延长\n\t要删除某拥有克隆子项的快照，必须先平展其子image\n\t命令： rbd flatten "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool <pool>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("image <image> "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("no-progress\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("取消快照保护\n\t必须先取消保护快照，然后才能删除它\n\t用户无法删除克隆所引用的快照，需要先平展其每个克隆，然后才能删除快照\n\t命令：rbd snap unprotect "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("pool <pool>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("image <image> "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("snap <snap>\n")])])]),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("清理环境")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("在客户端将磁盘取消应用\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# umount /mnt")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rbd unmap /dev/rbd0")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rbd showmapped")]),s._v("\n")])])]),t("p",[s._v("服务端定制基础快照")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("定制基础快照\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd snap create kube/vol01@clonetpl01\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd snap "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" kube/vol01\nSNAPID NAME       SIZE  PROTECTED TIMESTAMP\n    20 clonetpl01 3 GiB           Mon Sep 26 11:42:51 2062\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("将快照置于保护模式\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd snap protect kube/vol01@clonetpl01\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd snap "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" kube/vol01\nSNAPID NAME       SIZE  PROTECTED TIMESTAMP\n    20 clonetpl01 3 GiB yes       Mon Sep 26 11:42:51 2062\n结果显示：\n\t该快照已经被处于保护模式了\n")])])]),t("p",[s._v("基于快照来进行克隆操作")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("基于基础模板克隆一个镜像\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd clone kube/vol01@clonetpl01 kube/myimg01\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd clone kube/vol01@clonetpl01 kube/myimg02\n\n查看效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p kube\nmyimg01\nmyimg02\nvol01\n\n查看模板镜像的所有子镜像文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd children kube/vol01@clonetpl01\nkube/myimg01\nkube/myimg02\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("客户端尝试应用一下clone文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rbd --user kube map kube/myimg01")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("dev/rbd0\n\n查看效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rbd showmapped")]),s._v("\nid pool namespace image   snap device\n0  kube           myimg01 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("dev/rbd0\n\n挂载操作\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mount /dev/rbd0 /mnt")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls /mnt")]),s._v("\nissue  lost+found\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# echo myimg1 >> /mnt/issue")]),s._v("\n结果显示：\n\t该clone镜像文件可以正常的使用\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("客户端再次应用clone文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rbd --user kube map kube/myimg02")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("dev/rbd1\n\n查看效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rbd showmapped")]),s._v("\nid pool namespace image   snap device\n0  kube           myimg01 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("dev/rbd0\n1  kube           myimg02 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("dev/rbd1\n\n挂载操作\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mkdir /mnt1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mount /dev/rbd1 /mnt1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /mnt1/issue")]),s._v("\n\\S\nKernel \\r on an \\m\n结果显示：\n\t多个clone镜像文件可以独立的正常使用\n")])])]),t("p",[s._v("卸载操作")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("客户端卸载myimg02\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# umount /mnt1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rbd unmap kube/myimg02")]),s._v("\n\n管理端删除image镜像\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" kube/myimg02\nRemoving image: 100% complete"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("done"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd children kube/vol01@clonetpl01\nkube/myimg01\n")])])]),t("p",[s._v("展平快照文件")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t如果我们要删除底层的模板快照文件，为了避免对上层镜像的文件产生不好的影响，我们可以将底层快照的文件转移到上层clone文件中一份，这个动作叫展平快照文件\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("展平数据\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd flatten kube/myimg01\nImage flatten: 100% complete"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("done"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\n取消保护基础快照模板文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd snap unprotect kube/vol01@clonetpl01\n\n移除底层的模板文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd snap "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" kube/vol01@clonetpl01\nRemoving snap: 100% complete"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("done"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\n查看效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd snap "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" kube/vol01\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ \n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("在客户端上不影响子clone文件的操作\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls /mnt")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /mnt/issue")]),s._v("\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-2-7-rbd实践"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-7-rbd实践"}},[s._v("#")]),s._v(" 1.2.7 RBD实践")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 案例需求、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("简介")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\tceph提供的块存储能够可以为其他虚拟机提供磁盘设备来进行使用，所以接下来我们准备将ceph的磁盘文件提供给kvm进行使用。\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t我们需要按照如下的步骤来进行相关的实践：\n\t\t1 kvm环境和ceph环境准备\n\t\t2 ceph和kvm认证集成\n\t\t3 kvm到ceph中创建镜像文件\n\t\t4 启动kvm虚拟机测试ceph磁盘使用效果\n")])])]),t("p",[s._v("准备系统文件")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("获取镜像文件\nmkdir "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("images/ && cd "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("images/\nwget http:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("download"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("cirros-cloud"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("net/0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("5"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("2/cirros-0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("5"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("2-x86_64-disk"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("img\n")])])]),t("p",[s._v("部署kvm环境")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("判断CPU是否支持硬件虚拟化\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor05 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# egrep '(vmx|svm)' --color=always /proc/cpuinfo | wc -l")]),s._v("\n2\n\n检查kvm模块是否加载\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor05 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# lsmod | grep kvm")]),s._v("\nkvm_intel             188740  0\nkvm                   637289  1 kvm_intel\nirqbypass              13503  1 kvm\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("安装软件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor05 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum install -y virt-manager libvirt qemu-kvm kvm")]),s._v("\n注意：\n\tlibvirt 虚拟机管理\n\tvirt 虚拟机安装克隆\n\tqemu-kvm 管理虚拟机磁盘\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("启动服务\nsystemctl "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("start")]),s._v(" libvirtd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("service\n\n确认效果\nsystemctl status libvirtd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("service\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看虚拟网络\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor05 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# virsh net-list")]),s._v("\n 名称               状态     自动开始  持久\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("\n default              活动     是           是\n\n查看虚拟主机\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor05 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# virsh list")]),s._v("\n Id    名称                         状态\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("\n")])])]),t("p",[s._v("部署ceph环境")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("安装ceph软件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor05 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum install ceph ceph-common -y")]),s._v("\n")])])]),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("确认kvm环境支持rdb磁盘")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("内置的qemu-kvm包已经支持RBD块设备\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor05 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# qemu-img --help | grep rbd")]),s._v("\nSupported formats: vvfat vpc vmdk vhdx vdi ssh sheepdog rbd "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor05 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ldd /usr/libexec/qemu-kvm | grep rbd")]),s._v("\n        librbd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("so"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("1 => "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("lib64/librbd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("so"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("1 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("0x00007f9badca9000"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        \n结果显示：\n\tqemu-kvm具备访问RBD的能力。\n")])])]),t("p",[s._v("ceph创建专属的pool和秘钥")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("Ceph建立一个Pool，\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool create superopsmsb 16 16\npool "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'superopsmsb'")]),s._v(" created\n\n启动rbd功能\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool application enable superopsmsb rbd\nenabled application "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'rbd'")]),s._v(" on pool "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'superopsmsb'")]),s._v("\n\nrbd环境初始化\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ rbd pool init superopsmsb\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建superopsmsb的pool专属认证权限\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph auth "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("get-or")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("create client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("superopsmsb mon "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'allow r'")]),s._v(" osd "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'allow class-read object_prefix rbd_children, allow rwx pool=superopsmsb'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[client.superopsmsb]")]),s._v("\n        key = AQD5JzFjymapKxAASoWCRgp/yQt4dFGRmZDI8w==\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建专属用户的秘钥文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph auth get client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("superopsmsb "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("o ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("superopsmsb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring\nexported keyring "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("superopsmsb\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("传递认证文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ sudo scp ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("superopsmsb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring root@stor05:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/ceph/\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ sudo scp ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("admin"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring root@stor05:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/ceph/\n\n传递正常的ceph集群的配置文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ sudo scp ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf root@stor05:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/ceph/\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("确认效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor05 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph --user superopsmsb -s")]),s._v("\n  cluster:\n    id:     1d4e5773-619a-479d-861a-66ba451ce945\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("p",[s._v("kvm 集成ceph")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建认证文件 ceph-client-superopsmsb-secret"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("xml\n<secret ephemeral="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'no'")]),s._v(" private="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'no'")]),s._v(">\n\t<usage "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v("="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'ceph'")]),s._v("> \n\t\t<name>client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("superopsmsb secret<"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("name>\n\t<"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("usage>\n<"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("secret>\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("使用virsh创建secret\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor05 /data/conf]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# virsh secret-define --file ceph-client-superopsmsb-secret.xml")]),s._v("\n生成 secret caf4336b-d2de-4699-8aee-94569531559b\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("将ceph的client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("superopsmsb的密钥导⼊secret中\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor05 /data/conf]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# virsh secret-set-value --secret caf4336b-d2de-4699-8aee-94569531559b --base64 $(ceph auth get-key client.superopsmsb)")]),s._v("\nsecret 值设定\n\n确认效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor05 /data/conf]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# virsh secret-list")]),s._v("\n UUID                                  用量\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("\n caf4336b-d2de-4699-8aee-94569531559b  ceph client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("superopsmsb secret\n")])])]),t("p",[s._v("镜像创建")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建空的image，或者导⼊已经的磁盘镜像内容\n方法1：导入镜像\nqemu-img convert "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f qcow2 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("O raw "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("path/to/image"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("img rbd:<pool-name>"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("<image-name>\n方法2：创建镜像\nqemu-img xxx create "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f rbd rbd:<pool-name>"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("<image-name> size\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建镜像\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor05 /data/conf]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# qemu-img create -f rbd rbd:superopsmsb/superopsmsb-image 1G")]),s._v("\nFormatting "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'rbd:superopsmsb/superopsmsb-image'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" fmt=rbd size=10737418240 cluster_size=0\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("确认镜像文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor05 /data/conf]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# qemu-img info /data/images/cirros-0.5.2-x86_64-disk.img")]),s._v("\nimage: cirros-0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("5"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("2-x86_64-disk"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("img\nfile format: qcow2\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\n导入镜像文件到rdb\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor05 /data/conf]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# qemu-img convert -f qcow2 -O raw /data/images/cirros-0.5.2-x86_64-disk.img rbd:superopsmsb/cirros-0.5.2")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("确认效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor05 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rbd --user superopsmsb ls superopsmsb -l")]),s._v("\nNAME              SIZE    PARENT FMT PROT LOCK\ncirros-0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("5"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("2      112 MiB          2\nsuperopsmsb-image  10 GiB          2\n注意：\n\t因为是远程查看，所以信息展示有可能缓慢，我们可以直接在admin主机上进行快速查看\n")])])]),t("p",[s._v("虚拟机创建")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("定制虚拟机配置文件 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("conf/node1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("xml\n<domain "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v("="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'kvm'")]),s._v(">\n  <name>node1<"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("name>\n  <memory unit="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'KiB'")]),s._v(">512000<"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("memory>\n  <currentMemory unit="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'KiB'")]),s._v(">512000<"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("currentMemory>\n  <vcpu placement="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'static'")]),s._v(">1<"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("vcpu>\n  <os>\n    <"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" arch="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'x86_64'")]),s._v(">hvm<"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(">\n  <"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("os>\n  <devices>\n    <emulator>"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("usr/libexec/qemu-kvm<"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("emulator>\n    <disk "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v("="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'network'")]),s._v(" device="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'disk'")]),s._v(">\n      <source protocol="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'rbd'")]),s._v(" name="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'superopsmsb/cirros-0.5.2'")]),s._v(">\n        <host name="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mon01'")]),s._v(" port="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'6789'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(">\n      <"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("source>\n      <auth username="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'superopsmsb'")]),s._v(">\n        <secret "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v("="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'ceph'")]),s._v(" uuid="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'caf4336b-d2de-4699-8aee-94569531559b'")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(">\n      <"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("auth>\n      <target dev="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'vda'")]),s._v(" bus="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'virtio'")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(">\n    <"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("disk>\n    <interface "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v("="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'network'")]),s._v(">\n      <mac address="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'52:54:01:74:1c:9e'")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(">\n      <source network="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'default'")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(">\n      <model "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v("="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'virtio'")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(">\n    <"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("interface>\n    <serial "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v("="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'pty'")]),s._v(">\n      <target "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v("="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'isa-serial'")]),s._v(" port="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'0'")]),s._v(">\n        <model name="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'isa-serial'")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(">\n      <"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("target>\n    <"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("serial>\n    <console "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v("="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'pty'")]),s._v(">\n      <target "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v("="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'serial'")]),s._v(" port="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'0'")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(">\n    <"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("console>\n    <graphics "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v("="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'vnc'")]),s._v(" port="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'-1'")]),s._v(" autoport="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'yes'")]),s._v(">\n      <listen "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v("="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'address'")]),s._v(" address="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'0.0.0.0'")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(">\n    <"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("graphics>\n  <"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("devices>\n<"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("domain>\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建虚拟机\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor05 /data/conf]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# virsh define node1.xml")]),s._v("\n定义域 node1（从 node1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("xml）\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor05 /data/conf]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# virsh start node1")]),s._v("\n域 node1 已开始\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看主机状态\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor05 /data/conf]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# virsh list --all")]),s._v("\n Id    名称                         状态\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("\n 2     node1                          running\n\n查看设备信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor05 /data/conf]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# virsh domblklist node1")]),s._v("\n目标     源\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("\nvda        superopsmsb/cirros-0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("5"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("2\n\n可以借助于vnc viewer 连接到虚拟机查看效果\n注意：\n\t启动很慢，但是运行需要等待3分钟左右\n")])])]),t("p",[s._v("磁盘挂载")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("关闭虚拟机\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor05 /data/conf]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# virsh destroy node1")]),s._v("\n域 node1 被删除\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("编写专有设备文件 device"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("xml \n<disk "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v("="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'network'")]),s._v(" device="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'disk'")]),s._v(">\n  <driver name="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'qemu'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v("="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'raw'")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(">\n  <auth username="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'superopsmsb'")]),s._v(">\n    <secret "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v("="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'ceph'")]),s._v(" uuid="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'caf4336b-d2de-4699-8aee-94569531559b'")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(">\n  <"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("auth>\n  <source protocol="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'rbd'")]),s._v(" name="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'superopsmsb/superopsmsb-image'")]),s._v(">\n    <host name="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mon01'")]),s._v(" port="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'6789'")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(">\n  <"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("source>\n  <target dev="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'vdc'")]),s._v(" bus="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'virtio'")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(">\n<"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("disk>\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("将设备追加到虚拟机中\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor05 /data/conf]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# virsh attach-device node1 device.xml --persistent")]),s._v("\n成功附加设备\n\n确认磁盘挂载效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor05 /data/conf]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# virsh domblklist node1")]),s._v("\n目标     源\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("\nvda        superopsmsb/cirros-0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("5"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("2\nvdc        superopsmsb/superopsmsb-image\n")])])]),t("p",[s._v("环境还原")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("删除虚拟机\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor05 /data/conf]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# virsh undefine node1")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("删除pool\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" superopsmsb superopsmsb "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("yes-i-really-really-mean-it\npool "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'superopsmsb'")]),s._v(" removed\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" kube kube  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("yes-i-really-really-mean-it\npool "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'kube'")]),s._v(" removed\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h2",{attrs:{id:"_1-3-rgw接口"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-rgw接口"}},[s._v("#")]),s._v(" 1.3 RGW接口")]),s._v(" "),t("h3",{attrs:{id:"_1-3-1-基础知识"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-1-基础知识"}},[s._v("#")]),s._v(" 1.3.1 基础知识")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("OSS简介")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("对象存储"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Object Storage"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" 是无层次结构的数据存储方法，通常用于云计算环境中。不同于其他数据存储方法，基于对象的存储不使用目录树\n\t数据作为单独的对象进行存储\n\t数据并不放置在目录层次结构中，而是存在于平面地址空间内的同一级别\n\t应用通过唯一地址来识别每个单独的数据对象\n\t每个对象可包含有助于检索的元数据\n\t专为使用API在应用级别（而非用户级别）进行访问而设计\n")])])]),t("p",[s._v("对象")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("对象是对象存储系统中数据存储的基本单位，每个Object是数据和数据属性集的综合体，数据属性可以根据应用的需求进行设置，包括数据分布、服务质量等\n\t每个对象自我维护其属性，从而简化了存储系统的管理任务\n\t对象的大小可以不同，甚至可以包含整个数据结构，如文件、数据库表项等\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("对象存储系统一般是一类智能设备，它具有自己的存储介质、处理器、内存以及网络系统等，负责管理本地的对象，是对象存储系统的核心"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("p",[t("img",{attrs:{src:"image/image-20220926182809531.png",alt:"image-20220926182809531"}})]),s._v(" "),t("p",[s._v("术语解析")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("一般说来，一个对象存储系统的核心资源类型应该包括用户（User）、存储桶（ bucket）和对象（object）\n它们之间的关系是：\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" User将Object存储到存储系统上的Bucket\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 存储桶属于某个用户并可以容纳对象，一个存储桶用于存储多个对象\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 同一个用户可以拥有多个存储桶，不同用户允许使用相同名称的bucket\n")])])]),t("p",[t("img",{attrs:{src:"image/image-20211210163113908.png",alt:"image-20211210163113908"}})]),s._v(" "),t("p",[s._v("常见方案")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("各种存储方案，虽然在设计与实现上有所区别，但大多数对象存储系统对外呈现的核心资源类型大同小异\n")])])]),t("table",[t("thead",[t("tr",[t("th",[s._v("方案")]),s._v(" "),t("th",[s._v("描述")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("Amazon S3")]),s._v(" "),t("td",[s._v("提供了user、bucket和object分别表示用户、存储桶和对象，其中bucket隶属于user，因此user名称即可做为bucket的名称空间，不同用户允许使用相同名称的bucket")])]),s._v(" "),t("tr",[t("td",[s._v("OpenStack Swift")]),s._v(" "),t("td",[s._v("提供了user、container和object分别对应于用户、存储桶和对象，不过它还额外为user提供了父级组件account，用于表示一个项目或租户，因此一个account中可包含一到多个user，它们可共享使用同一组container，并为container提供名称空间")])]),s._v(" "),t("tr",[t("td",[s._v("RadosGW")]),s._v(" "),t("td",[s._v("提供了user、subuser、bucket和object，其中的user对应于S3的user，而subuser则对应于Swift的user，不过user和subuser都不支持为bucket提供名称空间，因此 ，不同用户的存储桶也不允许同名；不过，自Jewel版本起，RadosGW引入了tenant（租户）用于为user和bucket提供名称空间，但它是个可选组件"),t("br"),s._v("Jewel版本之前，radosgw的所有user位于同一名称空间，它要求所有user的ID必须惟一，并且即便是不同user的bucket也不允许使用相同的bucket ID")])])])]),s._v(" "),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("简介")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\tCeph对象存储使用Ceph对象网关守护进程（radosgw），它是用于与Ceph存储群集进行交互的HTTP服务器。由于它提供与OpenStack Swift和Amazon S3兼容的接口，因此Ceph对象网关具有自己的用户管理。Ceph对象网关可以将数据存储在用于存储来自Ceph文件系统客户端或Ceph块设备客户端的数据的同一Ceph存储群集中。S3和Swift API共享一个公共的名称空间，因此可以使用一个API编写数据，而使用另一个API检索数据。\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("Ceph RGW基于librados，是为应用提供RESTful类型的对象存储接口。RGW提供两种类型的接口：\n　　1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" S3：兼容Amazon S3RESTful API；\n　　2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" Swift：兼容OpenStack Swift API。\n　　\n同时，RGW为了实现RESTful接口的功能，默认使用Civetweb作为其Web Sevice，而Civetweb默认使用端口7480提供服务，如果想修改端口（如80端口），就需要修改Ceph的配置文件。\n")])])]),t("p",[s._v("要点")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("RGW在创建的时候，自动会初始化自己的存储池，而且RGW还需要自己独有的守护进程服务才可以正常的使用\n\nRGW并非必须的接口，仅在需要用到与S3和Swift兼容的RESTful接口时才需要部署RGW实例\n")])])]),t("p",[t("img",{attrs:{src:"image/image-20220926220715586.png",alt:"image-20220926220715586"}})]),s._v(" "),t("p",[s._v("RGW内部逻辑处理层级结构图")]),s._v(" "),t("p",[t("img",{attrs:{src:"image/image-20220928111659491.png",alt:"image-20220928111659491"}})]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("HTTP 前端: \n\t接收数据操作请求。\nREST API接口：\n\t从http请求中解析出 S3 或 Swift 数据并进行一系列检查。\nAPI操作逻辑:\n\t经Restful 接口检查通过后，根据内部业务逻辑交由不同业务模块进行数据处理。\nRADOS接口：\n\t如果需要写入或者操作ceph集群数据，则经由RADOS "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" librados 调用将数据发送给集群的后端主机\n")])])]),t("p",[s._v("常见属性")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t自0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("80版本起，Ceph放弃了基于apache和fastcgi提供radosgw服务的传统而代之以默认嵌入在ceph-radosgw进程中的Citeweb，这种新的实现方式更加轻便和简洁，但直到Ceph 11"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("1版本，Citeweb才开始支持SSL协议"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\t\n\tCiteweb默认监听于TCP协议的7480端口提供http服务，修改配置需要编辑ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf配置文件，以如下格式进行定义\n\t"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[client.rgw.<gateway-node>]")]),s._v("\n\trgw_host = <hostname OR ipaddr>\n\trgw_frontends = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"civetweb port=80"')]),s._v("\n\t\n\t配置完成后需要重启ceph-radosgw进程以生效新配置\n\tceph-radosgw@rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("<gateway-node>\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("其他相关的配置 \n配置https\n\t额外添加参数ssl_certificate="),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("PATH/TO/PEM_FILE\n\t定义port=443s，或者port=80+443s\n\n其它配置参数\n\tnum_threads：Citeweb以线程模型处理客户端请求，它为每个连接请求分配一个专用线\n程，因而此参数定义了其支持的最大并发连接数，默认值为50\n\trequest_timeout_ms：网络发送与接收操作的超时时长，以ms为单位，默认值为30000\n；可以在必要时通过增大此值实现长连接的效果\n\taccess_log_file：访问日志的文件路径，默认为空\n\terror_log_file：错误日志的文件路径，默认为空\n\trgw_dns_name： 定制专属的dns服务解析域名\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-3-2-基础操作"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-2-基础操作"}},[s._v("#")]),s._v(" 1.3.2 基础操作")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("部署RGW主机")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("到stor04主机上的部署ceph环境\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum install -y ceph-radosgw")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("admin节点上，创建rgw的主机环境\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph-deploy rgw create stor04\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[ceph_deploy.conf]")]),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[DEBUG ]")]),s._v(" found configuration file at: "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("home/cephadm/"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("cephdeploy"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[ceph_deploy.rgw]")]),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[INFO  ]")]),s._v(" The Ceph Object Gateway "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("RGW"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" is now running on host stor04 and default port 7480\n")])])]),t("p",[s._v("查看效果")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看集群的状态\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("s\n  cluster:\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n  services:\n    mon: 3 daemons"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" quorum mon01"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("mon02"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("mon03 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("age 3h"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    mgr: mon01"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("active"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" since 30h"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" standbys: mon02\n    osd: 6 osds: 6 up "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("since 26h"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 6 in "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("since 26h"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    rgw: 1 daemon active "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("stor04"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看服务状况\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# netstat -tnulp | grep radosgw")]),s._v("\ntcp        0      0 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0:7480   0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("  LISTEN      4295/radosgw\ntcp6       0      0 :::7480        :::"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("       LISTEN      4295/radosgw\n\n查看服务进程\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ps aux | grep -v grep | grep radosgw")]),s._v("\nceph       4295  0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("5  2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("1 5145976 39612 ?       Ssl  18:37   0:00 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("usr/bin/radosgw "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("cluster ceph "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("name client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("stor04 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("setuser ceph "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("setgroup ceph\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("RGW会在rados集群上生成包括如下存储池的一系列存储池\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("root\ndefault"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("control\ndefault"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("meta\ndefault"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("log\n结果显示：\n\t默认情况下，rgw自动创建4个存储池\n")])])]),t("p",[s._v("RGW提供了一个简单的web接口，用于数据的交流")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("web访问接口\n\tRGW提供的是REST接口，客户端通过http与其进行交互，完成数据的增删改查等管理操作。浏览器查看 10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("16:7480 的web简单应用效果\n")])])]),t("p",[t("img",{attrs:{src:"image/image-20211206115942508.png",alt:"image-20211206115942508"}})]),s._v(" "),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("更改端口实践")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("默认情况下，RGW实例监听于TCP协议的7480端口7480，需要定制的话，可以通过在运行RGW的节点上编辑其主配置文件ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf进行修改，相关参数如下所示：\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /etc/ceph/ceph.conf")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[client.rgw.stor04]")]),s._v("\nrgw_frontends = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"civetweb port=8080"')]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("重启服务\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl restart ceph-radosgw@rgw.stor04")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl status ceph-radosgw@rgw.stor04")]),s._v("\n\t\n查看效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# netstat -tnulp | grep 8080")]),s._v("\ntcp     0   0 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0:8080    0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("    LISTEN  152636/radosgw\n")])])]),t("p",[t("img",{attrs:{src:"image/image-20211210173544875.png",alt:"image-20211210173544875"}})]),s._v(" "),t("p",[s._v("ssl通信")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("需要提供pem证书文件，需要将 证书和私钥文件放在同一个文件里面\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("生成秘钥\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mkdir /etc/ceph/ssl && cd /etc/ceph/ssl")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 /etc/ceph/ssl]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# openssl genrsa -out civetweb.key 2048")]),s._v("\n\n生成证书\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 /etc/ceph/ssl]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# openssl req -new -x509 -key civetweb.key -out civetweb.crt -days 3650 -subj "/CN=stor04.superopsmsb.com"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 /etc/ceph/ssl]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls")]),s._v("\ncivetweb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("crt  civetweb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("key\n\n合并证书信息\nroot@stor04:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/ceph/ssl"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat civetweb.key civetweb.crt > civetweb.pem")]),s._v("\n")])])]),t("p",[s._v("修改认证信息")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("在运行RGW的节点上编辑其主配置文件ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf进行修改，相关参数如下所示：\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /etc/ceph/ceph.conf")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[client.rgw.stor04]")]),s._v("\nrgw_frontends = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"civetweb port=8443s ssl_certificate=/etc/ceph/ssl/civetweb.pem"')]),s._v("\n注意：\n\t这里的8443s，最后的s代表必须使用ssl通信方式\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("重启服务\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl restart ceph-radosgw@rgw.stor04")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl status ceph-radosgw@rgw.stor04")]),s._v("\n\t\n查看效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# netstat -tnulp | grep 8443")]),s._v("\ntcp        0      0 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0:8443   0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("     LISTEN      153319/radosgw\n")])])]),t("p",[t("img",{attrs:{src:"image/image-20211210174100106.png",alt:"image-20211210174100106"}})]),s._v(" "),t("p",[s._v("同时开启 https和http方式来进行访问")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("在运行RGW的节点上编辑其主配置文件ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf进行修改，相关参数如下所示：\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat ceph.conf")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[client.rgw.stor04]")]),s._v("\nrgw_frontends = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"civetweb port=7480+8443s ssl_certificate=/etc/ceph/ssl/civetweb.pem"')]),s._v("\n注意：\n\t通过 port+port 的方式实现多端口开启服务\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("重启服务\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl restart ceph-radosgw@rgw.stor04")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl status ceph-radosgw@rgw.stor04")]),s._v("\n\t\n查看效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# netstat -tnulp | grep radosgw")]),s._v("\ntcp        0      0 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0:7480   0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("     LISTEN      153941/radosgw\ntcp        0      0 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0:8443   0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("     LISTEN      153941/radosgw\n")])])]),t("p",[t("img",{attrs:{src:"image/image-20211210174340551.png",alt:"image-20211210174340551"}})]),s._v(" "),t("p",[s._v("高并发配置")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('对于ceph来说，它内部的高并发主要是通过线程方式定义的，而且默认值是50，如果我们要调整并发数量的话，可以调整num_threads的属性值\n\n配置示例：\n\t[client.rgw.stor04]\n    rgw_frontends = "civetweb port=7480+8443s ssl_certificate=/etc/ceph/ssl/civetweb.pem num_threads=2000"\n')])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-3-3-泛域名实践"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-3-泛域名实践"}},[s._v("#")]),s._v(" 1.3.3 泛域名实践")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("简介")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("S3的存储桶是用于存储对象的容器，每个对象都必须储存在一个特定的存储桶中，且每个对象都要直接通过RESTful API基于URL进行访问，URL格式为\n\t“http"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(":"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("bucket-name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("radowgw-host"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(":port"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("key”\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t例如，对于存储在rgw01"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("superopsmsb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("io上的S3 API对象存储系统上eshop存储桶中的名为images/1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("jpg 的对象，可通过 http:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("eshop"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw01"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("superopsmsb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("io/images/1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("jpg对其进行寻址\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t因此，radosgw的S3 API接口的功能强依赖于DNS的泛域名解析服务，它必须能够正常解析任何“<bucket-name>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("<radowgw-host>”格式的名称至radosgw主机。\n\t除此之外，我们还需要配置每个radowgw守护进程的rgw_dns_name为其DNS名称\n")])])]),t("p",[s._v("dns环境配置")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("安装软件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@admin ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum -y install bind bind-chroot bind-utils bind-libs")]),s._v("\n备注：\n  bind           提供了域名服务的主要程序及相关文件  \n  bind-utils     提供了对DNS服务器的测试工具程序（如nslookup、dig等）\n  bind-chroot    为bind提供一个伪装的根目录以增强安全性\n  \n启动服务\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@admin ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl  start named")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@admin ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl  status named")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看版本信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@admin ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# named -v")]),s._v("\nBIND 9"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("11"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("4-P2-RedHat-9"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("11"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("4-26"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("P2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("el7_9"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("9 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Extended Support Version"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" <id:7107deb>\n\n查看配置文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@admin ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rpm -ql bind | grep named.conf")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/named"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("usr/lib/tmpfiles"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("d/named"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("usr/share/doc/bind-9"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("11"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("4/man"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("named"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("html\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("usr/share/doc/bind-9"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("11"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("4/named"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("default\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("usr/share/doc/bind-9"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("11"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("4/sample/etc/named"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("usr/share/man/man5/named"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("5"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("gz\n\n查看暴露端口\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@admin ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# netstat -tnulp | grep 53")]),s._v("\ntcp        0      0 127"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("1:53    0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("    LISTEN    17563/named\ntcp        0      0 127"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("1:953   0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("    LISTEN    17563/named\ntcp6       0      0 ::1:53          :::"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("         LISTEN    17563/named\ntcp6       0      0 ::1:953         :::"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("         LISTEN    17563/named\nudp        0      0 127"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("1:53    0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("              17563/named\nudp6       0      0 ::1:53          :::"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("                   17563/named\n")])])]),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("定制zone的配置")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("定制正向解析zone的配置\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@admin ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tail /etc/named.conf -n 9")]),s._v("\noptions "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        listen-on port 53 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" any"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" 监听任何ip对53端口的请求\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n        allow-query     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" any"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" 接收任何来源查询dns记录\n\t\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" 定制网站主域名的zone配置\nzone "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"superopsmsb.com"')]),s._v(" IN "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" master"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        file "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"superopsmsb.com.zone"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" 定制泛域名网站的zone配置\nzone "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"stor04.superopsmsb.com"')]),s._v(" IN "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" master"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        file "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"stor04.superopsmsb.com.zone"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\ninclude "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/etc/named.rfc1912.zones"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\ninclude "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/etc/named.root.key"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("定制主域名的zone文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@admin ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /var/named/superopsmsb.com.zone")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" BIND reverse "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(" file "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" local loopback interface\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$TTL")]),s._v("    604800\n@       IN      SOA     ns"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("superopsmsb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" admin"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("superopsmsb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n                              1         "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" Serial\n                         604800         "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" Refresh\n                          86400         "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" Retry\n                        2419200         "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" Expire\n                         604800 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("       "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" Negative Cache TTL\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        IN      NS      ns\nns      IN      A       10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("12\nstor02  IN      A       10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("14\nstor03  IN      A       10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("15\nstor04  IN     NS    ns\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("定制泛域名的zone文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@admin ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /var/named/stor04.superopsmsb.com.zone")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" BIND reverse "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(" file "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" local loopback interface\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$TTL")]),s._v("    604800\n@       IN      SOA     ns"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("superopsmsb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" admin"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("superopsmsb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n                              1         "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" Serial\n                         604800         "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" Refresh\n                          86400         "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" Retry\n                        2419200         "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" Expire\n                         604800 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("       "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" Negative Cache TTL\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        IN      NS      ns\nns      IN      A       10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("12\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("        IN     A       10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("16\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("检查配置文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@admin ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# named-checkconf")]),s._v("\n\n重启dns服务\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@admin ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl restart named")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@admin ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl status named")]),s._v("\n\n定制本地主机专属的dns域名服务器\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@admin ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /etc/resolv.conf")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Generated by NetworkManager")]),s._v("\nsearch localhost\nnameserver 10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("12\n")])])]),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('确认dns解析效果\n[root@admin ~]# host -a stor02.superopsmsb.com\n[root@admin ~]# host -a stor02.superopsmsb.com 10.0.0.12\n[root@admin ~]# host -a stor02.superopsmsb.com 10.0.0.12\nTrying "stor02.superopsmsb.com"\nUsing domain server:\nName: 10.0.0.12\nAddress: 10.0.0.12#53\nAliases:\n...\n;; QUESTION SECTION:\n;stor02.superopsmsb.com.                IN      ANY\n\n;; ANSWER SECTION:\nstor02.superopsmsb.com. 604800  IN      A       10.0.0.14\n\n;; AUTHORITY SECTION:\nsuperopsmsb.com.        604800  IN      NS      ns.superopsmsb.com.\n\n;; ADDITIONAL SECTION:\nns.superopsmsb.com.     604800  IN      A       10.0.0.12\n\nReceived 89 bytes from 10.0.0.12#53 in 0 ms\n')])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@admin ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# nslookup stor02.superopsmsb.com ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@admin ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# nslookup stor02.superopsmsb.com 10.0.0.12")]),s._v("\nServer:         10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("12\nAddress:        10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("12"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#53")]),s._v("\n\nName:   stor02"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("superopsmsb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com\nAddress: 10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("14\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("确认dns解析效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@admin ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# dig file.stor04.superopsmsb.com")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@admin ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# dig img.stor04.superopsmsb.com @10.0.0.12")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" <<>> DiG 9"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("11"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("4-P2-RedHat-9"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("11"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("4-26"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("P2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("el7_9"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("9 <<>> img"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("stor04"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("superopsmsb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com @10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("12\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" ANSWER SECTION:\nimg"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("stor04"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("superopsmsb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" 604800 IN   A       10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("16\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" AUTHORITY SECTION:\nstor04"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("superopsmsb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" 604800  IN      NS      ns"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("stor04"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("superopsmsb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" ADDITIONAL SECTION:\nns"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("stor04"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("superopsmsb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" 604800 IN    A       10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("12\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" Query time: 0 msec\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" SERVER: 10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("12"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#53(10.0.0.12)")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" WHEN: 一 9月 26 19:46:57 CST 2022\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" MSG SIZE  rcvd: 104\n")])])]),t("p",[s._v("配置rgw存储节点的dns相关配置")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("定制stor04的dns域名配置\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tail -n4 /etc/ceph/ceph.conf")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[client.rgw.stor04]")]),s._v("\nrgw_host = stor04\nrgw_frontends = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"civetweb port=7480+8443s ssl_certificate=/etc/ceph/ssl/civetweb.pem"')]),s._v("\nrgw_dns_name = stor04"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("superopsmsb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com\n属性解析：\n\t通过 rgw_dns_name 属性制定当前节点的域名\n\t\n重启当前节点的服务效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl restart ceph-radosgw@rgw.stor04")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl status ceph-radosgw@rgw.stor04")]),s._v("\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-3-4-s3测试"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-4-s3测试"}},[s._v("#")]),s._v(" 1.3.4 S3测试")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("S3 API接口简介")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\tS3服务的REST API使用用户账号（user）、存储桶（bucket）和对象（object）三个组件来组织存储的数据对象，对象保存于存储桶中，而存储桶则支持授权给特定账号进行读写及创建"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("删除等操作\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\tradosgw-admin是用于管理radowgw服务的命令行接口，它有着众多的分别用于不同管理功能的命令，例如user、subuser、key、bucket和object等\n\t命令格式：\n\t\tradosgw-admin user create "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("uid="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"s3user"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("display-name="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"S3 Testing User"')]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("而后即可通过其API接口进行访问测试，或者使用s3cmd命令进行\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 使用s3cmd命令之前需要事先配置其工作环境，包括指定Access Key和Secret Key，以及S3服务的访问端点和默认的Region（Ceph的新版本中称作zonegroup）等\n\t命令格式：\n\t\ts3cmd "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("configure\n\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 配置的结果将保存于~"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("s3cmd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("cfg配置文件中，用户随后可通过编辑此文件修改配置参数，或者再次运行此配置命令为其指定新的配置信息\n\ts3cmd有众多的子命令\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("参考资料：\n\thttps:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("docs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com/en/latest/radosgw/s3/python/"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#using-s3-api-extensions")]),s._v("\n")])])]),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("S3 API接口专用账号")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建专属账号\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ radosgw-admin user create "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("uid="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s3user'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("display-name="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'S3 Testing user'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user_id"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"s3user"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"display_name"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"S3 Testing user"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"email"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"suspended"')]),s._v(": 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"max_buckets"')]),s._v(": 1000"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"subusers"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"keys"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"s3user"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"access_key"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"BX2IDCO5ADZ8IWZ4AVX7"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"secret_key"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"wKXAiBBspTx9kl1NpcAi4eOCHxvQD7ORHnrmvBlf"')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看认证用户\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ radosgw-admin user list\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"s3user"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n查看详情\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ radosgw-admin user info "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("uid s3user\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user_id"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"s3user"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"keys"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"s3user"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"access_key"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"BX2IDCO5ADZ8IWZ4AVX7"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"secret_key"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"wKXAiBBspTx9kl1NpcAi4eOCHxvQD7ORHnrmvBlf"')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),t("p",[s._v("客户端配置")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("在客户端上安装测试命令 s3cmd\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum install s3cmd -y")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("使用s3之前，需要做一些预设的配置\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# s3cmd --configure")]),s._v("\n\nEnter new values or accept defaults in brackets with Enter"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nRefer to user manual "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" detailed description of all options"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\nAccess key and Secret key are your identifiers "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" Amazon S3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" Leave them empty "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("using")]),s._v(" the env variables"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 下面的两个属性是来自于之前的账号信息")]),s._v("\nAccess Key: BX2IDCO5ADZ8IWZ4AVX7\t\t\nSecret Key: wKXAiBBspTx9kl1NpcAi4eOCHxvQD7ORHnrmvBlf\nDefault Region "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[US]")]),s._v(":\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 此处可以使用默认的")]),s._v("\n\nUse "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"s3.amazonaws.com"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" S3 Endpoint and not modify it to the target Amazon S3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 此处的域名是否用，我们自己定义的内容")]),s._v("\nS3 Endpoint "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[s3.amazonaws.com]")]),s._v(": stor04"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("superopsmsb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com:7480\n\nUse "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"%(bucket)s.s3.amazonaws.com"')]),s._v(" to the target Amazon S3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"%(bucket)s"')]),s._v(" and "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"%(location)s"')]),s._v(" vars can be used\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" the target S3 system supports dns based buckets"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 关于存储桶的定制，需要使用自己的域名，但是格式一样")]),s._v("\nDNS-style bucket+hostname:port template "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" accessing a bucket "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("bucket"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("s3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("amazonaws"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("bucket"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("stor04"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("superopsmsb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com:7480\n\nEncryption password is used to protect your files "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" reading\nby unauthorized persons "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" in transfer to S3\nEncryption password:\t\t\t\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这里不需要密码")]),s._v("\nPath to GPG program "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("usr/bin/gpg"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(":\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 使用默认的gpg命令路径")]),s._v("\n\nWhen "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("using")]),s._v(" secure HTTPS protocol all communication with Amazon S3\nservers is protected "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" 3rd party eavesdropping"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" This method is\nslower than plain HTTP"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" and can only be proxied with Python 2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("7 or newer\nUse HTTPS protocol "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[Yes]")]),s._v(": No\t\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 不使用HTTPs协议")]),s._v("\n\nOn some networks all internet access must go through a HTTP proxy"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("Try")]),s._v(" setting it here "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" you can"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'t connect to S3 directly\nHTTP Proxy server name:\t\t\t\t\t\t# 不使用代理，因为是本地访问\n\nNew settings:\n  Access Key: NOF182FGP8Q38CWLZ8WQ\n  Secret Key: zP2ZWJPXTsZWQXg2hKY4Wv4OpoolKZEOwfheJlx3\n  Default Region: US\n  S3 Endpoint: stor04.superopsmsb.com:7480\n  DNS-style bucket+hostname:port template for accessing a bucket: %(bucket)s.stor04.superopsmsb.com:7480\n  Encryption password:\n  Path to GPG program: /usr/bin/gpg\n  Use HTTPS protocol: False\n  HTTP Proxy server name:\n  HTTP Proxy server port: 0\n\nTest access with supplied credentials? [Y/n] Y\t\t# 确认最后的信息\nPlease wait, attempting to list all buckets...\nSuccess. Your access key and secret key worked fine :-)\n\nNow verifying that encryption works...\nNot configured. Never mind.\n\nSave settings? [y/N] y\t\t\t\t\t\t\t\t# 保存信息\nConfiguration saved to '")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("root/"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("s3cfg'\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看常见的帮助信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# s3cmd")]),s._v("\nUsage: s3cmd "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[options]")]),s._v(" COMMAND "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[parameters]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nCommands:\n  Make bucket\n      s3cmd mb s3:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("BUCKET\n  Remove bucket\n      s3cmd rb s3:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("BUCKET\n  List objects or buckets\n      s3cmd "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[s3://BUCKET[/PREFIX]]")]),s._v("\n  List all object in all buckets\n      s3cmd la\n  Put file into bucket\n      s3cmd put FILE "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[FILE...]")]),s._v(" s3:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("BUCKET"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("PREFIX"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  Get file "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" bucket\n      s3cmd get s3:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("BUCKET/OBJECT LOCAL_FILE\n  Delete file "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" bucket\n      s3cmd "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("del")]),s._v(" s3:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("BUCKET/OBJECT\n  Delete file "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" bucket "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("alias "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("del")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n      s3cmd "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" s3:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("BUCKET/OBJECT\n  Restore file "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" Glacier storage\n      s3cmd restore s3:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("BUCKET/OBJECT\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("p",[s._v("域名解析")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("定制专属的dns域名，让客户端找到 stor04"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("superopsmsb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com 主机名。\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /etc/resolv.conf")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Generated by NetworkManager")]),s._v("\nnameserver 10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("12\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# nslookup file.stor04.superopsmsb.com 10.0.0.12")]),s._v("\nServer:         10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("12\nAddress:        10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("12"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#53")]),s._v("\n\nName:   file"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("stor04"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("superopsmsb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com\nAddress: 10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("16\n")])])]),t("p",[s._v("存储桶创建实践")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建存储桶\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# s3cmd mb s3://images")]),s._v("\nBucket "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s3://images/'")]),s._v(" created\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# s3cmd mb s3://dir")]),s._v("\nBucket "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s3://dir/'")]),s._v(" created\n\n查看存储桶\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# s3cmd ls")]),s._v("\n2062-09-26 14:21  s3:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),s._v("\n2062-09-26 13:57  s3:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("images\n")])])]),t("p",[s._v("文件上传下载实践")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("上传文件到存储桶中，存储同目录可以随意玩耍\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# s3cmd put /etc/issue s3://images/linux/issue")]),s._v("\nupload: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/etc/issue'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("> "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s3://images/linux/issue'")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("1 of 1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n 23 of 23   100% in    1s    12"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("79 B/s  done\n \n查看文件对象效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# s3cmd ls s3://images/linux")]),s._v("\n                          "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("DIR")]),s._v("  s3:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("images/linux/\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# s3cmd ls s3://images/linux/issue")]),s._v("\n2062-09-26 13:58           23  s3:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("images/linux/issue\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("下载文件对象\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# s3cmd get s3://images/linux/issue")]),s._v("\ndownload: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s3://images/linux/issue'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("> "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'./issue'")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("1 of 1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n 23 of 23   100% in    0s     3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("42 KB/s  done\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# s3cmd get s3://images/linux/issue /tmp/issue-bak")]),s._v("\ndownload: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s3://images/linux/issue'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("> "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/tmp/issue-bak'")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("1 of 1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n 23 of 23   100% in    0s     3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("38 KB/s  done\n \n查看效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls")]),s._v("\nanaconda-ks"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("cfg  issue\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls /tmp/issue-bak")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("tmp/issue-bak\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("对于一个大的RGW Object，会被切割成多个独立的RGW Object上传，称为multipart。multipar的优势是断点续传。s3接口默认切割大小为15MB。\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 /data/scripts]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# dd if=/dev/zero of=a.txt bs=1M count=60")]),s._v("\n记录了60+0 的读入\n记录了60+0 的写出\n62914560字节"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("63 MB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("已复制，0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0495739 秒，1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("3 GB/秒\n\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 /data/scripts]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ll a.txt")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("rw-r-"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("r-"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 1 root root 62914560 9月  27 11:06 a"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("txt\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 /data/scripts]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  s3cmd put a.txt s3://images/linux/")]),s._v("\nupload: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'a.txt'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("> "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s3://images/linux/a.txt'")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[part 1 of 4, 15MB]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("1 of 1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n 15728640 of 15728640   100% in    0s    25"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("99 MB/s  done\nupload: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'a.txt'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("> "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s3://images/linux/a.txt'")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[part 2 of 4, 15MB]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("1 of 1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n 15728640 of 15728640   100% in    0s    27"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("90 MB/s  done\nupload: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'a.txt'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("> "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s3://images/linux/a.txt'")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[part 3 of 4, 15MB]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("1 of 1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n 15728640 of 15728640   100% in    0s    28"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("93 MB/s  done\nupload: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'a.txt'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("> "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s3://images/linux/a.txt'")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[part 4 of 4, 15MB]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("1 of 1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n 15728640 of 15728640   100% in    0s    31"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("85 MB/s  done\n")])])]),t("p",[s._v("目录上传下载实践")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("准备目录结构\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mkdir /data/test/{scripts,conf,file} -p")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# touch /data/test/{scripts/{1..4}.sh,conf/{1..3}.conf,file/{1..5}.txt}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# echo scripts-1 > /data/test/scripts/1.sh")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# echo conf-2 > /data/test/conf/2.conf")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# echo file-5 > /data/test/file/5.txt")]),s._v("\n\n上传目录 \n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# s3cmd put /data/test/ s3://dir/etc/ --recursive")]),s._v("\nupload: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/data/test/conf/1.conf'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("> "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s3://dir/etc/conf/1.conf'")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("1 of 12"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n 0 of 0     0% in    0s     0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("00 B/s  done\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nupload: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/data/test/scripts/4.sh'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("> "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s3://dir/etc/scripts/4.sh'")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("12 of 12"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n 0 of 0     0% in    0s     0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("00 B/s  done\n \n查看效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# s3cmd ls s3://dir")]),s._v("\n                          "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("DIR")]),s._v("  s3:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# s3cmd ls s3://dir/etc\t\t\t\t# 查看目录的时候，必须在最后添加/")]),s._v("\n                          "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("DIR")]),s._v("  s3:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# s3cmd ls s3://dir/etc/")]),s._v("\n                          "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("DIR")]),s._v("  s3:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/conf/\n                          "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("DIR")]),s._v("  s3:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/file/\n                          "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("DIR")]),s._v("  s3:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/scripts/\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# s3cmd ls s3://dir/etc/conf/")]),s._v("\n2062-09-26 14:23            0  s3:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/conf/1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf\n2062-09-26 14:23            7  s3:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/conf/2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf\n2062-09-26 14:23            0  s3:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/conf/3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("下载目录对象\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# s3cmd get s3://dir/  --recursive")]),s._v("\ndownload: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s3://dir/etc/conf/1.conf'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("> "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'./etc/conf/1.conf'")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("1 of 12"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n 0 of 0     0% in    0s     0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("00 B/s  done\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n注意：\n\t如果按照上传目录结构方式下载文件的时候，不要加子目录，\n\t\n下载子目录\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# s3cmd get s3://dir/etc/  --recursive")]),s._v("\ndownload: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s3://dir/etc/conf/1.conf'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("> "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'./conf/1.conf'")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("1 of 12"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n 0 of 0     0% in    0s     0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("00 B/s  done\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n结果显示：\n\t它是将子目录下载到当前目录了\n")])])]),t("p",[s._v("文件删除")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("删除文件文件对象\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# s3cmd del s3://images/linux/issue")]),s._v("\ndelete: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s3://images/linux/issue'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# s3cmd ls s3://images/linux/issue")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n\n删除目录对象\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# s3cmd del s3://images/linux/issue")]),s._v("\ndelete: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s3://images/linux/issue'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# s3cmd del s3://dir/etc/  --recursive")]),s._v("\ndelete: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s3://dir/etc/conf/1.conf'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\ndelete: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s3://dir/etc/scripts/4.sh'")]),s._v("\n\n删除存储桶\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# s3cmd rb  s3://images")]),s._v("\nBucket "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s3://images/'")]),s._v(" removed\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# s3cmd rb  s3://dir")]),s._v("\nBucket "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s3://dir/'")]),s._v(" removed\n")])])]),t("p",[s._v("python测试")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("安装测试模块\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum -y install python-boto")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("定制测试脚本\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /data/scripts/tests3.py")]),s._v("\nimport boto"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("s3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("connection\n\naccess_key = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'BX2IDCO5ADZ8IWZ4AVX7'")]),s._v("\nsecret_key = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'wKXAiBBspTx9kl1NpcAi4eOCHxvQD7ORHnrmvBlf'")]),s._v("\nconn = boto"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("connect_s3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n        aws_access_key_id=access_key"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        aws_secret_access_key=secret_key"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        host="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'10.0.0.16'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" port=7480"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        is_secure=False"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" calling_format=boto"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("s3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("connection"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("OrdinaryCallingFormat"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n       "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\nbucket = conn"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("create_bucket"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'ceph-s3-bucket'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" bucket in conn"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("get_all_buckets"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(":\n    print "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"{name} {created}"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("format"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n        name=bucket"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        created=bucket"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("creation_date"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("测试效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# python /data/scripts/tests3.py")]),s._v("\nceph-s3-bucket 2062-09-26T14:41:42"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("505Z\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-3-5-swift测试"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-5-swift测试"}},[s._v("#")]),s._v(" 1.3.5 Swift测试")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("Swift API接口简介")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("Swift的用户账号对应于radosgw中的subuser（子用户），它隶属于某个事先存在的user（用户账号）\n\tradosgw-admin user create "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("uid="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"swiftuser"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("display-name="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Swift Testing User"')]),s._v("\n\tradosgw-admin subuser create "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("uid=swiftuser "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("subuser=swiftuser:swift "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("access=full\n\t\nSwift API的上下文中，存储桶以container表示，而非S3中的bucket，但二者在功用上类同，都是对象数据的容器\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("Python Swiftclient是一个用于与Swift API交互的Python客户端程序，它包含了Python API（swift 模块）和一个命令行工具swift"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\t环境安装如下\n\tpip instal "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("upgrade python-swiftclient\n\nswift命令可以通过Swift API完成容器和对象数据的管理操作，其基础语法格式为“\n\tswift "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("A Auth URL"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("U username"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("K password"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" subcommand\n")])])]),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("用户创建")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("swift的实践用户，我们直接使用上面s3创建的用户来创建\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ radosgw-admin user list\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"s3user"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("基于s3user用户创建swift拥有所有权限的用户\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ radosgw-admin subuser create "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("uid s3user "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("subuser=s3user:swift "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("access=full\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user_id"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"s3user"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"subusers"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"id"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"s3user:swift"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"permissions"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"full-control"')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"keys"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"s3user"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"access_key"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"BX2IDCO5ADZ8IWZ4AVX7"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"secret_key"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"wKXAiBBspTx9kl1NpcAi4eOCHxvQD7ORHnrmvBlf"')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"swift_keys"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"s3user:swift"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"secret_key"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"pZ5DGT3YDBqdAtb10aFiNGeO2AtJKJN4rLKuI4wU"')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("生成 s3user:swift 对应的secret_key\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ radosgw-admin key create "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("subuser=s3user:swift "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("key-"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v("=swift "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("gen-secret\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user_id"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"s3user"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"display_name"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"S3 Testing user"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"email"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"suspended"')]),s._v(": 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"max_buckets"')]),s._v(": 1000"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"subusers"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"id"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"s3user:swift"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"permissions"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"full-control"')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"keys"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"s3user"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"access_key"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"BX2IDCO5ADZ8IWZ4AVX7"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"secret_key"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"wKXAiBBspTx9kl1NpcAi4eOCHxvQD7ORHnrmvBlf"')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"swift_keys"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"s3user:swift"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"secret_key"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"O7On31ApRWE6aZkSPby9bTp4y19srGTfDKl7IA04"')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),t("p",[s._v("客户端环境")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("安装swift命令\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum -y install python-setuptools python-pip")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# pip install python-swiftclient==3.4.0")]),s._v("\n注意：\n\t如果需要安装最新版本的话，需要提前将Python版本提升到3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("6+\n\thttps:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("pypi"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("org/project/python-swiftclient/\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("命令解析：\n\tswift "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("A 认证URL/auth "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("U 用户名称:swift "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("K secret_key 命令\n\n命令测试效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# swift -A http://10.0.0.16:7480/auth -U s3user:swift -K O7On31ApRWE6aZkSPby9bTp4y19srGTfDKl7IA04 list")]),s._v("\nceph-s3-bucket\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("配置环境变量\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" > ~"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("swift << EOF\nexport ST_AUTH=http:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("16:7480/auth\nexport ST_USER=s3user:swift\nexport ST_KEY=O7On31ApRWE6aZkSPby9bTp4y19srGTfDKl7IA04\nEOF\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("加载环境变量\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# source ~/.swift")]),s._v("\n\n确认效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# swift list")]),s._v("\nceph-s3-bucket\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看状态信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# swift stat")]),s._v("\n                                    Account: v1\n                                 Containers: 2\n                                    Objects: 1\n                                      Bytes: 23\nObjects in policy "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"default-placement-bytes"')]),s._v(": 0\n  Bytes in policy "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"default-placement-bytes"')]),s._v(": 0\n   Containers in policy "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"default-placement"')]),s._v(": 2\n      Objects in policy "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"default-placement"')]),s._v(": 1\n        Bytes in policy "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"default-placement"')]),s._v(": 23\n                     X-Openstack-"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Request-Id")]),s._v(": tx00000000000000000012c-0063324b45-63ad-default\n                X-Account-Bytes-Used-Actual: 4096\n                                 X-Trans-Id: tx00000000000000000012c-0063324b45-63ad-default\n                                X-Timestamp: 1664240453"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("17581\n                               Content-"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Type")]),s._v(": text/plain"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" charset=utf-8\n                              Accept-Ranges: bytes\n")])])]),t("p",[s._v("存储桶增删测试")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建存储桶\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# swift post swift-super")]),s._v("\n\n删除存储桶\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# swift delete ceph-s3-bucket")]),s._v("\nceph-s3-bucket\n\n查看存储桶\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# swift list")]),s._v("\nswift-super\n")])])]),t("p",[s._v("文件上传操作")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("上传文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# swift upload swift-super /etc/passwd")]),s._v("\netc/passwd\n\n查看效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# swift list swift-super")]),s._v("\netc/passwd\n")])])]),t("p",[s._v("目录上传操作")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("上传目录操作\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# swift upload swift-super /data/test")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("test/scripts/4"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sh\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("test/file/3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("txt\n\n查看效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# swift list swift-super")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("test/conf/1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\netc/passwd\n")])])]),t("p",[s._v("文件下载操作")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("下载文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# swift download swift-super etc/passwd")]),s._v("\netc/passwd "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[auth 0.014s, headers 0.023s, total 0.024s, 0.120 MB/s]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls etc/passwd")]),s._v("\netc/passwd\n\n下载所有\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# swift download --all")]),s._v("\nswift-super/"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("test/file/4"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("txt "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[auth 0.008s, headers 0.019s, total 0.019s, 0.000 MB/s]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n注意：\n\t它对于目录的递归下载不是太友好\n")])])]),t("p",[s._v("文件删除操作")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("删除文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# swift delete swift-super etc/passwd")]),s._v("\netc/passwd\n注意：\n\t它不支持目录删除，但是可以通过批量删除来实现\n\n批量删除\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# swift delete swift-super --prefix=data")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("test/file/4"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("txt\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("test/scripts/1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sh\n\n批量删除\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# swift delete swift-super --all")]),s._v("\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-3-6-对象访问"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-6-对象访问"}},[s._v("#")]),s._v(" 1.3.6 对象访问")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("简介")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("作为OSS对象存储，我们可以在互联网上以http"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(":"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" 的方式来访问对象文件，基本格式如下：\n\t对于存储在rgw01"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("superopsmsb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com上的S3 API对象存储系统上bucket存储桶中的名为images/1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("jpg 的对象，可通过 http:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("bucket"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw01"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("superopsmsb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com/images/1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("jpg对其进行访问。\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("默认情况下，这种情况是拒绝的\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# s3cmd ls s3://images/linux/issue")]),s._v("\n2062-09-27 00:49           23  s3:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("images/linux/issue\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl http://images.stor04.superopsmsb.com:7480/linux/issue")]),s._v("\n<?xml version="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1.0"')]),s._v(" encoding="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"UTF-8"')]),s._v("?><Error><Code>AccessDenied<"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("Code><BucketName>images<"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("BucketName><RequestId>tx00000000000000000012f-0063324d15-63ad-default<"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("RequestId><HostId>63ad-default-default<"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("HostId><"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("Error>\n结果显示：\n\t这里拒绝的原因就是 AccessDenied，是需要我们通过专用的访问策略方式来进行功能实现。\n")])])]),t("p",[s._v("解析")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("在使用http方式访问对象存储的时候，我们需要注意的是：\n\t1 资源对象的访问方式\n\t\thttp 还是 https，依赖于rgw的基本配置\n\t2 资源对象的访问控制\n\t\t通过定制策略的方式来实现\n\t3 资源对象的跨域问题\n\t\t通过定制cors的方式来实现\n\t4 资源对象在浏览器端的缓存机制\n\t\trgw的基本配置定制\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("参考资料：\n\thttps:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("docs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com/en/latest/radosgw/bucketpolicy/\n\thttps:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("docs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com/en/latest/radosgw/s3/python/\n")])])]),t("p",[s._v("命令解析")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 /data/conf]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# s3cmd --help")]),s._v("\nUsage: s3cmd "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[options]")]),s._v(" COMMAND "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[parameters]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n  Modify Bucket Policy\n      s3cmd setpolicy FILE s3:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("BUCKET\n  Delete Bucket Policy\n      s3cmd delpolicy s3:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("BUCKET\n  Modify Bucket CORS\n      s3cmd setcors FILE s3:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("BUCKET\n  Delete Bucket CORS\n      s3cmd delcors s3:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("BUCKET\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n  Upload a lifecycle policy "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" the bucket\n      s3cmd setlifecycle FILE s3:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("BUCKET\n  Get a lifecycle policy "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" the bucket\n      s3cmd getlifecycle s3:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("BUCKET\n  Remove a lifecycle policy "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" the bucket\n      s3cmd dellifecycle s3:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("BUCKET\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("p",[s._v("查看默认策略")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 /data/conf]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# s3cmd info s3://swift-super")]),s._v("\ns3:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("swift-super/ "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("bucket"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(":\n   Location:  default\n   Payer:     BucketOwner\n   Expiration Rule: none\n   Policy:    none\n   CORS:      none\n   ACL:       S3 Testing user: FULL_CONTROL\n")])])]),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("定制策略")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("定制访问策略文件 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("conf/policy"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("json\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Statement"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Effect"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Allow"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Principal"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"*"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Action"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"s3:GetObject"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Resource"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"*"')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n属性解析：\n\tResource参数匹配某一种文件：Resource:"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"*.jpg"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"*.png"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\tAction可以设置较多参数，\n参考资料：\n\thttps:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("docs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com/docs/master/radosgw/bucketpolicy/\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("应用访问策略\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 /data/conf]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# s3cmd setpolicy policy.json s3://images --acl-public")]),s._v("\ns3:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("images/: Policy updated\n\n确认效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 /data/conf]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# s3cmd info s3://images")]),s._v("\ns3:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("images/ "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("bucket"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(":\n   Location:  default\n   Payer:     BucketOwner\n   Expiration Rule: none\n   Policy:    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Statement"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Effect"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Allow"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Principal"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"*"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Action"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"s3:GetObject"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Resource"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"*"')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n   CORS:      none\n   ACL:       S3 Testing user: FULL_CONTROL\n")])])]),t("p",[s._v("设置访问限制")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("定制cors的策略文件 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("conf/rules"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("xml \n<CORSConfiguration>\n  <CORSRule> \n    <ID>Allow everything<"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("ID>  \n    <AllowedOrigin>"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("<"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("AllowedOrigin>  \n    <AllowedMethod>GET<"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("AllowedMethod>  \n    <AllowedMethod>HEAD<"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("AllowedMethod>  \n    <AllowedMethod>PUT<"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("AllowedMethod>  \n    <AllowedMethod>POST<"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("AllowedMethod>  \n    <AllowedMethod>DELETE<"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("AllowedMethod>  \n    <AllowedHeader>"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("<"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("AllowedHeader>  \n    <MaxAgeSeconds>30<"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("MaxAgeSeconds>\n  <"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("CORSRule>\n<"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("CORSConfiguration>\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("应用浏览器跨域设置文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 /data/conf]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# s3cmd setcors rules.xml s3://images")]),s._v("\n查看效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 /data/conf]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# s3cmd info s3://images")]),s._v("\ns3:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("images/ "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("bucket"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(":\n   Location:  default\n   Payer:     BucketOwner\n   Expiration Rule: none\n   Policy:    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n   CORS:      <CORSConfiguration xmlns="),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("<"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("CORSConfiguration>\n   ACL:       S3 Testing user: FULL_CONTROL\n")])])]),t("p",[s._v("访问效果")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 /data/conf]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl http://images.stor04.superopsmsb.com:7480/linux/issue")]),s._v("\n\\S\nKernel \\r on an \\m\n")])])]),t("p",[s._v("脚本测试")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("定制访问测试脚本 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("scripts/tests4"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("py\nimport boto"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("s3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("connection\n\naccess_key = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'BX2IDCO5ADZ8IWZ4AVX7'")]),s._v("\nsecret_key = "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'wKXAiBBspTx9kl1NpcAi4eOCHxvQD7ORHnrmvBlf'")]),s._v("\nconn = boto"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("connect_s3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n        aws_access_key_id=access_key"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        aws_secret_access_key=secret_key"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        host="),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'10.0.0.16'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" port=7480"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        is_secure=False"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" calling_format=boto"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("s3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("connection"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("OrdinaryCallingFormat"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n       "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ndef get_object_url"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("bucket_name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" object_name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(":\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try")]),s._v(":\n        bucket = conn"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("get_bucket"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("bucket_name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        plans_key = bucket"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("get_key"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("object_name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        plans_url = plans_key"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("generate_url"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" query_auth=False"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                                           force_http=False"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" plans_url\n    except Exception as e:\n        print"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"get {} error:{}"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("format"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("object_name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" e"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" False\nprint"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("get_object_url"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"images"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"linux/issue"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("获取资源对象的url效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 /data/scripts]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# python tests4.py")]),s._v("\nhttp:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("16:7480/images/linux/issue?x-amz-meta-s3cmd-attrs=atime%3A1664200700/ctime%3A1654585109/gid%3A0/gname%3Aroot/md5%3Af078fe086dfc22f64b5dca2e1b95de2c/mode%3A33188/mtime%3A1603464839/uid%3A0/uname%3Aroot\n访问url的效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor04 /data/scripts]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl http://10.0.0.16:7480/images/linux/issue?x-amz-meta-s3cmd-attrs=atime%3A1664200700/ctime%3A1654585109/gid%3A0/gname%3Aroot/md5%3Af078fe086dfc22f64b5dca2e1b95de2c/mode%3A33188/mtime%3A1603464839/uid%3A0/uname%3Aroot")]),s._v("\n\\S\nKernel \\r on an \\m\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-3-7-底层数据"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-7-底层数据"}},[s._v("#")]),s._v(" 1.3.7 底层数据")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("简介")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\tRGW是一个对象处理网关。数据实际存储在ceph集群中。利用librados的接口，与ceph集群通信。RGW主要存储三类数据：元数据"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("metadata"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("、索引数据"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("bucket index"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("、数据"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("。\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 元数据信息：包括user"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("用户信息"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("，bucket"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("存储桶关系"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("，bucket"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("instance"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("存储桶实例"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("。\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 索引数据信息: 主要k/v的结构来维护bucket中rgw对象的索引信息，val是关于rgw对象的元数据信息\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 数据信息: 其实就是rgw object内容，它存放在一个或多个rados object中\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("这三类数据一般存储在不同的pool中，元数据也分多种元数据，存在不同的ceph pool中。\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("默认情况下，RGW安装完毕后，会在rados集群上生成包括如下存储池的一系列存储池\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("root\ndefault"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("control\ndefault"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("meta\ndefault"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("log\n\n当我们开始基于对象存储的方式实现数据访问后，它就会生成另外一些存储池\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ~]")]),s._v("$ ceph osd pool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("root\t\t\t\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 包含的都是zone,zonegroup,realm等信息")]),s._v("\ndefault"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("control\t\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# pool中对象的控制信息")]),s._v("\ndefault"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("meta\t\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 包含的是元数据信息")]),s._v("\ndefault"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("log\t\t\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 包含的是日志处理信息，包括垃圾回收机制")]),s._v("\ndefault"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("buckets"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("index\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 包含的是存储桶和对象的映射信息")]),s._v("\ndefault"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("buckets"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v("\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 包含的是存储桶的对象数据信息")]),s._v("\n注意：\n\t这里的default指的是 ceph的zone区域。\n\tcontrol利用librados提供的对象"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("watch-notify")]),s._v("功能，当有数据更新时，通知其他RGW刷新cache。\n")])])]),t("p",[s._v("元数据")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看元数据\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ~]")]),s._v("$ radosgw-admin metadata list\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"bucket"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"bucket.instance"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"otp"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# One-time password 一次性密码机制")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看用户\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ~]")]),s._v("$ radosgw-admin metadata list user\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"s3user"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n获取用户细节信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ~]")]),s._v("$ radosgw-admin metadata list user:s3user\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看存储桶\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ~]")]),s._v("$ radosgw-admin metadata list bucket\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"images"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"swift-super"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n获取存储桶信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ~]")]),s._v("$ radosgw-admin metadata get bucket:images:\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("获取存储桶实例\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ~]")]),s._v("$ radosgw-admin metadata list bucket"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("instance\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"images:09d0b6f1-fc49-4838-bda1-08cc60553e29.15577.7"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"swift-super:09d0b6f1-fc49-4838-bda1-08cc60553e29.15577.4"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n获取存储桶实例信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ~]")]),s._v("$ radosgw-admin metadata get bucket"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("instance:images:09d0b6f1-fc49-4838-bda1-08cc60553e29"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("15577"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("7\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("元数据存储池")]),s._v(" "),t("div",{staticClass:"language-pow extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("{zone}.rgw.meta 存放的是元数据\n\troot: bucket及bucket-instance\n    users.keys: 用户key\n    users.email:用户Email,object的key值=email\n    users.swift: swift账号\n    users.uid: s3用户及用户的Bucket信息\n    roles：\n    heap：\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看用户的uid信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ~]")]),s._v("$ rados "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p default"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("meta "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("N users"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("uid "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("\ns3user\ns3user"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("buckets\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("获取用户管理的buckets\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ~]")]),s._v("$ rados "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p default"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("meta  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("N users"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("uid listomapkeys s3user"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("buckets\nimages\nswift-super\n\n默认查看bucket信息是二进制，所以我们需要将其保存到一个文件中，通过专用命令进行查看\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ~]")]),s._v("$ rados "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p default"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("meta  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("N users"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("uid getomapval s3user"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("buckets images images_bucket\nWriting to images_bucket\n\n查看加密文件信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ~]")]),s._v("$ ceph-dencoder import images_bucket "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" cls_user_bucket_entry decode dump_json\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"bucket"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"images"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"marker"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"09d0b6f1-fc49-4838-bda1-08cc60553e29.15577.7"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"bucket_id"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"09d0b6f1-fc49-4838-bda1-08cc60553e29.15577.7"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"size"')]),s._v(": 23"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"size_rounded"')]),s._v(": 4096"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"creation_time"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2022-09-27 00:49:53.839482Z"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"count"')]),s._v(": 1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user_stats_sync"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("其他信息获取\n\tbucket信息： rados "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p default"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("meta "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("N root "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("\n\tbucket元数据：rados "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p default"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("meta "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("N root get "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("bucket_id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" meta_file\n\n")])])]),t("p",[s._v("索引数据存储池")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("获取buckets的索引信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ~]")]),s._v("$ rados "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p default"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("buckets"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("index "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("09d0b6f1-fc49-4838-bda1-08cc60553e29"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("15577"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("4\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("09d0b6f1-fc49-4838-bda1-08cc60553e29"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("15577"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("7\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看存储桶的对象信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ~]")]),s._v("$ rados "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p default"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("buckets"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("index listomapkeys "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("09d0b6f1-fc49-4838-bda1-08cc60553e29"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("15577"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("7\nlinux/issue\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看对象元数据信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ~]")]),s._v("$ rados "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p default"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("buckets"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("index getomapval "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("09d0b6f1-fc49-4838-bda1-08cc60553e29"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("15577"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("7 linux/issue object_key\nWriting to object_key\n\n查看文件内容信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ~]")]),s._v("$ ceph-dencoder "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" rgw_bucket_dir_entry import object_key decode dump_json         "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"linux/issue"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"instance"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ver"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"pool"')]),s._v(": 11"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"epoch"')]),s._v(": 1\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"locator"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"exists"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("文件对象的header中记录了一些统计信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ~]")]),s._v("$ rados "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p default"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("buckets"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("index getomapheader "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("09d0b6f1-fc49-4838-bda1-08cc60553e29"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("15577"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("7 index_object_header\nWriting to index_object_header\n\n查看统计信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ~]")]),s._v("$ ceph-dencoder "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" rgw_bucket_dir_header import index_object_header decode dump_json\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ver"')]),s._v(": 2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"master_ver"')]),s._v(": 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"stats"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n        1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"total_size"')]),s._v(": 23"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"total_size_rounded"')]),s._v(": 4096"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"num_entries"')]),s._v(": 1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"actual_size"')]),s._v(": 23\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"new_instance"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"reshard_status"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"not-resharding"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"new_bucket_instance_id"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"num_shards"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("1\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),t("p",[s._v("数据信息存储池")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看数据对象\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ~]")]),s._v("$ rados "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p default"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("buckets"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("\n09d0b6f1-fc49-4838-bda1-08cc60553e29"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("15577"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("7_linux/issue\n\n查看对象数据的属性信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ~]")]),s._v("$ rados "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p default"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("buckets"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(" listxattr 09d0b6f1-fc49-4838-bda1-08cc60553e29"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("15577"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("7_linux/issue\nuser"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("acl\nuser"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("content_type\nuser"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("etag\nuser"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("idtag\nuser"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("manifest\nuser"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pg_ver\nuser"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("source_zone\nuser"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("storage_class\nuser"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("tail_tag\nuser"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("x-amz-content-sha256\nuser"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("x-amz-date\nuser"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("x-amz-meta-s3cmd-attrs\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("获取对象的manifest的信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ~]")]),s._v("$ rados "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p default"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("buckets"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(" getxattr 09d0b6f1-fc49-4838-bda1-08cc60553e29"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("15577"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("7_linux/issue user"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("manifest > manifest\n查看信息详情\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ~]")]),s._v("$ ceph-dencoder "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" RGWObjManifest import manifest decode dump_json\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"objs"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-3-8-进阶方案"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-8-进阶方案"}},[s._v("#")]),s._v(" 1.3.8 进阶方案")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、案例解读、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("简介")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\tceph分布式存储机制，随着大量应用的普及，在生产中的存储地位越来越高了，但是自我搭建存储云的成本太高了，所以我们在实际应用的过程中，往往是混合云"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("公有云"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v("私有云"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("的方式来实现"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("借助于公有云的可扩展、低成本实现大量普通数据的存储，借助于私有云的高度可控实现敏感数据的安全控制。\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("混合云存储的特点：\n\t高性能：敏感活动数据存储在私有云存储中，普通数据存储到公有云存储中。利用公有云的特性，实现负载的分散，从而提供一个较高的综合访问性能；\n\t安全可控：混合云存储中的私有云部分的软硬件资源都是高度控制的，所以可以实现敏感数据的可控制性和安全性；\n\t高度扩展：借助于公有云存储的扩展特性，混合云存储也具备了高度扩展容量的特性；\n\t相对低成本：普通数据存储到公有云存储中，节省了私有云存储的成本，还拥有公有云存储的成本优势，混合云存储具有低成本的优势。\n")])])]),t("p",[s._v("ceph解决方案")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t混合云存储相较于公有云存储和私有云存储会更加全面，更加完善。Ceph 的对象存储针对混合云的场景，也相应的提供了解决方案，即云同步Cloud Sync功能。Ceph RGW 的Cloud Sync 功能是基于RGW Multisite 机制实现的，先看下RGW Multisite 机制。\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\tCeph RGW 的 Multisite 机制用于实现多个Ceph 对象存储集群间数据同步，其涉及到的核心概念包括：\n        zone：对应于一个独立的集群，由一组 RGW 对外提供服务。\n        zonegroup：每个 zonegroup 可以对应多个zone，zone 之间同步数据和元数据。\n        realm：每个realm都是独立的命名空间，可以包含多个 zonegroup，zonegroup 之间同步元数据。\n")])])]),t("p",[t("img",{attrs:{src:"image/image-20220927100024375.png",alt:"image-20220927100024375"}})]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\tMultisite 是一个zone 层面的功能处理机制，所以默认情况下，是 zone 级的数据同步，所以说操作粒度过于粗糙。而基于RGW multisite 实现了 Cloud Sync，支持将Ceph 中的对象数据同步到支持 S3 接口的公有云存储中，作为slave zone不再是一个具体的对象存储集群，而是一个抽象程度更高的概念，可以代表任何一个对象存储集群，从而实现了混合云的基本能力。\n\tCloud Sync 功能正是将支持 S3 接口的存储集群，抽象为 slave zone 的概念，然后通过Multisite 机制，实现将 Ceph 中的对象数据同步到外部对象存储中。\n")])])]),t("p",[s._v("局限性")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t在使用 Ceph 对象存储时， RGW 的 Cloud Sync 功能实际上是基本可以满足混合云存储的应用场景的，当然劣势是不可避免的：\n\t1 支持的同步粒度最细为存储桶级，在某些应用场景下，存储桶级的同步粒度是不太合适的；\n\t2 RGW Multisite 的数据同步因为涉及到多云环境，所以时间控制要求高，一些时间敏感的场景并不适用。\n")])])]),t("p",[t("strong",[s._v("案例解读")])]),s._v(" "),t("p",[s._v("存储分级管理")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("存储介质：\n\t出于对访问性能、成本等因素的考虑，同时引入多种存储介质的分级管理，实现高效数据存储。\n存储策略：\n\t主要针对的是数据级别的副本设定"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("默认3副本"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("和存储厂商的指定。\n存放规则：\n\t针对应用场景的不同，对不同的数据实现各自的数据存放规则。但是因为是zone级别的，所以有些场景不合适。\n")])])]),t("p",[s._v("对象周期管理")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t作为对象存储，它的最大特点就是基于web形式来进行访问，不可避免的涉及到缓存的管理，所以对象生命周期管理是非常重要的事项。\n\t目前来说，对象存储的周期管理主要有两种方式：迁移处理和过期删除处理\n")])])]),t("p",[s._v("自动迁移管理")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t根据存储桶日志中的操作记录等属性参数，我们可以实现对存储桶中的对象数据的热度进行分析，并按照分析结果自动生成迁移策略，从而实现对象数据的自动化管理。\n\t从 target bucket 中读取存储桶日志；\n    对日记记录进行过滤、分析，得到用户配置的规则中所标定的对象数据的访问热度；\n    生成相应的生命周期管理规则；\n    将生成的生命周期管理规则配置到相应的存储桶上。\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h2",{attrs:{id:"_1-4-cephfs接口"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-cephfs接口"}},[s._v("#")]),s._v(" 1.4 CephFS接口")]),s._v(" "),t("h3",{attrs:{id:"_1-4-1-基础知识"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-1-基础知识"}},[s._v("#")]),s._v(" 1.4.1 基础知识")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("场景")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t有了 RBD，远程磁盘挂载的问题就解决了，但 RBD 的问题是不能多个主机共享一个磁盘，如果有一份数据很多客户端都要读写该怎么办呢？这时 CephFS 作为文件系统存储解决方案就派上用场了。\n")])])]),t("p",[s._v("简介")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\tCeph 文件系统（Ceph FS）是个 POSIX 兼容的文件系统，它直接使用 Ceph 存储集群来存储数据。 Ceph 文件系统与 Ceph 块设备、同时提供 S3 和 Swift API 的 Ceph 对象存储、或者原生库（ librados ）的实现机制稍显不同。\n")])])]),t("p",[s._v("要点")]),s._v(" "),t("p",[t("img",{attrs:{src:"image/image-20211117114047214.png",alt:"image-20211117114047214"}})]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\tCephFS需要至少运行一个元数据服务器（MDS）守护进程（ceph-mds），此进程管理与CephFS上存储的文件相关的元数据，并协调对Ceph存储集群的访问。\n\t因此，若要使用CephFS接口，需要在存储集群中至少部署一个MDS实例。\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("注意：\n\tMDS虽然称为元数据服务，但是它却不存储任何元数据信息，它存在的目的仅仅是 让我们rados集群提供的存储接口能够兼容POSIX 的文件系统接口 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v(" 简单来说，它是真正元数据信息的索引服务。\n\t客户端在访问文件接口的时候，首先连接到 MDS上，在MDS的内存里面维持元数据的索引信息，这些信息真正的保存在RADOS集群的metadata pool上面，而对应的数据，保存在对应的 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(" pool上面。\n\t而且以将元数据服务作为一个非状态的效果，便于扩展。\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("相较于NFS来说，它主要有以下特点优势：\n\t1 底层数据冗余的功能，底层的roados 提供了基本的数据冗余功能，因此不存在nfs的单点故障因素。\n\t2 底层的roados系统有n个存储节点组成，所以数据的存储可以分散IO，吞吐量较高。\n\t3 底层的roados系统有n个存储节点组成，所以ceph提供的扩展性要想当的高\n")])])]),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("部署mds主机")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("在admin主机上为stor05上部署mds服务\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph-deploy mds create stor05\n\n在stor05上，并确认是否开启了守护进程\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ssh stor05 "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ps aux | grep ceph-mds | grep -v grep"')]),s._v("\nceph       14471  0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("1  1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("2 384316 22504 ?        Ssl  11:48   0:00 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("usr/bin/ceph-mds "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("cluster ceph "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("id stor05 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("setuser ceph "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("setgroup ceph\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("在admin主机上通过 ceph "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("s 中查看mds的状态\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$  ceph "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("s\n  cluster:\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n  services:\n    mon: 3 daemons"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" quorum mon01"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("mon02"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("mon03 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("age 6m"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    mgr: mon01"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("active"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" since 47h"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" standbys: mon02\n    mds:  1 up:standby\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 一个mds部署成功")]),s._v("\n    osd: 6 osds: 6 up "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("since 6m"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 6 in "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("since 43h"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    rgw: 1 daemon active "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("stor04"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n注意：\n\t在没有为fs准备存储池的前提下，是看不到效果的\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("需要专用的命令来进行查看mds的状态效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph mds stat\n 1 up:standby\n结果显示：\n\t查看MDS的相关状态可以发现，刚添加的MDS处于Standby模式\n")])])]),t("p",[s._v("创建专属存储池")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建元数据存储池\nceph osd pool create cephfs-metadata 32 32\nceph osd pool create cephfs-"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(" 64 64\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("将刚才创建的存储池组合为fs专属存储池\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph fs new cephfs cephfs-metadata cephfs-"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v("\nnew fs with metadata pool 14 and "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(" pool 15\n")])])]),t("p",[s._v("确认效果")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("确认效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("s\n  cluster:\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n  services:\n    mon: 3 daemons"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" quorum mon01"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("mon02"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("mon03 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("age 11m"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    mgr: mon01"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("active"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" since 47h"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" standbys: mon02\n    mds: cephfs:1 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("0=stor05=up:active"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    osd: 6 osds: 6 up "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("since 11m"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 6 in "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("since 43h"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    rgw: 1 daemon active "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("stor04"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看状态\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph fs status cephfs\ncephfs "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 0 clients\n======\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" Rank "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" State  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("  MDS   "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("    Activity   "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("  dns  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("  inos "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("  0   "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" active "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" stor05 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" Reqs:    0 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("s "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("   10  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("   13  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("       Pool      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("  used "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" avail "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" cephfs-metadata "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" metadata "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" 1536k "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" 35"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("8G "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("   cephfs-"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("    0  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" 35"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("8G "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" Standby MDS "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v("\nMDS version: ceph version 14"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("22 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ca74598065096e6fcbd8433c8779a2be0c889351"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" nautilus "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("stable"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-4-2-接口使用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-2-接口使用"}},[s._v("#")]),s._v(" 1.4.2 接口使用")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("客户端使用cephFS方式")]),s._v(" "),t("p",[t("img",{attrs:{src:"image/image-20211210121816739.png",alt:"image-20211210121816739"}})]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("客户端使用cephFS，主要有两种方式：\n\t内核文件系统 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" Ceph、libcephfs\n\t用户空间文件系统 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" FUSE"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Filesystem in USErspace"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n前提：\n\t1 至少一个节点运行ceph-mds守护进程\n\t2 创建存储池 ceph-metadata、ceph-"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v("\n\t3 激活文件系统\n\t4 无论那种客户端使用cephFS的方式，都需要有专门的认证机制。\n")])])]),t("p",[s._v("准备认证文件")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("在admin节点上，准备认证账号\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph auth "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("get-or")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("create client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fsclient mon "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'allow r'")]),s._v(" mds "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'allow rw'")]),s._v(" osd "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'allow rwx pool=cephfs-data'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("o ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fsclient"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring\n\t注意：我们只需要对"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v("的存储池进行操作即可，不需要对metadata存储池进行授权。  \n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看账号信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph auth get client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fsclient\n\n查看认证文件信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("fsclient*\nceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fsclient"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fsclient"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[client.fsclient]")]),s._v("\n        key = AQBgdTJj+LVdFBAAZOjGIsw4t+o1swZlW4CvKQ== \n")])])]),t("p",[s._v("秘钥管理")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t客户端挂载cephFS的时候，需要指定用户名和key，而这两项是有不同的两个选项来指定的，所以我们应该将这两个内容分开存储\n\n获取相关的秘钥信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph-authtool "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("n client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fsclient ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fsclient"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring\nAQBgdTJj+LVdFBAAZOjGIsw4t+o1swZlW4CvKQ==\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph auth print-key client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fsclient\nAQBgdTJj+LVdFBAAZOjGIsw4t+o1swZlW4CvKQ==\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("保存用户账号的密钥信息于secret文件，用于客户端挂载操作认证之用\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph auth print-key client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fsclient > fsclient"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("key\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" fsclient"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("key\nAQBgdTJj+LVdFBAAZOjGIsw4t+o1swZlW4CvKQ==\n")])])]),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("ceph客户端的需求")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("客户端主机环境准备\n\t内核模块ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ko\n\t\tyum install ceph\n\t安装ceph-common程序包\n\t\tyum install ceph-common\n\t提供ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf配置文件\n\t\tceph-deploy "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("overwrite-conf config push stor06\n\t获取到用于认证的密钥文件\n\t\tsudo scp fsclient"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("key stor06:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/ceph/\n")])])]),t("p",[s._v("cephFS客户端准备")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("我们准备将 stor06 作为cephFS的客户端主机，检查stor06的ceph模块加载情况\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# modinfo ceph")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\n保证 stor06上有ceph相关的配置文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls /etc/ceph/")]),s._v("\nceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("kube"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("  ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf  fsclient"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("key  rbdmap\n")])])]),t("p",[s._v("挂载cephFS")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建专属的数据目录\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mkdir /cephfs-data/")]),s._v("\n\n挂载cephFS对象\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mount -t ceph mon01:6789,mon02:6789,mon03:6789:/ /cephfs-data/ -o name=fsclient,secretfile=/etc/ceph/fsclient.key")]),s._v("\n注意：\n\t内核空间挂载ceph文件系统，要求必须指定ceph文件系统的挂载路径\n\t\n确认挂载效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mount | grep cephfs")]),s._v("\n10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("13:6789"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("14:6789"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("15:6789:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" on "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("cephfs-"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" ceph "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("rw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("relatime"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("name=fsclient"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("secret=<hidden>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("acl"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("wsize=16777216"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看挂载点的效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# stat -f /cephfs-data/")]),s._v("\n  文件："),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/cephfs-data/"')]),s._v("\n    ID：c931549bd8ae8624 文件名长度：255     类型：ceph\n块大小：4194304    基本块大小：4194304\n    块：总计：9182       空闲：9182       可用：9182\nInodes: 总计：0          空闲："),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("1\n结果显示：\n\t挂载点的类型是 ceph。\n\t\n确认文件系统使用效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# echo nihao cephfs > /cephfs-data/cephfs.txt")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /cephfs-data/cephfs.txt")]),s._v("\nnihao cephfs\n")])])]),t("p",[s._v("开机自启动挂载cephFS")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("卸载刚才挂载的cephFS\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# umount /cephfs-data")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mount | grep ceph")]),s._v("\n\n设置开机自启动\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# echo 'mon01:6789,mon02:6789,mon03:6789:/  /cephfs-data  ceph name=fsclient,secretfile=/etc/ceph/fsclient.key,_netdev,noatime 0 0' >> /etc/fstab")]),s._v("\n属性解析：\n\t_netdev "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 告诉挂载程序，一旦超时，自动跳过去。\n\tnoatime "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 在读文件时不去更改文件的access time属性，提高性能\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("挂载磁盘\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mount -a")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mount | grep ceph")]),s._v("\n10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("13:6789"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("14:6789"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("15:6789:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" on "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("cephfs-"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" ceph "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("rw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("noatime"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("name=fsclient"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("secret=<hidden>"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("acl"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n查看效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /cephfs-data/cephfs.txt")]),s._v("\nnihao cephfs\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-4-3-fuse实践"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-3-fuse实践"}},[s._v("#")]),s._v(" 1.4.3 FUSE实践")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("简介")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t对于某些操作系统来说，它没有提供对应的ceph内核模块，我们还需要使用cephFS的话，可以通过 FUSE方式来实现，FUSE全称Filesystem in Userspace，用于非特权用户能够无需操作内核而创建文件系统。\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("如果我们在非内核的环境下使用cephFS的话，需要对客户端主机的环境做一些准备工作：\n\t安装ceph-fuse程序包\n\t\tyum install "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("y ceph-fuse ceph-common\n\t获取到客户端账号的keyring文件和ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf配置文件\n\t\tceph-deploy "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("overwrite-conf config push stor06\n\t\tsudo scp ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fsclient"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring root@stor06:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/ceph/\n")])])]),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("客户端环境准备")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("我们准备将 stor06 作为cephFS的客户端主机，安装对应的软件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum install ceph-fuse ceph-common -y")]),s._v("\n\n保证 stor06上有ceph相关的配置文件\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls /etc/ceph/")]),s._v("\nceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("kube"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("  ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf  fsclient"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("key  rbdmap\n")])])]),t("p",[s._v("挂载cephFS")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建专属的数据目录\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mkdir /cephfs-data-user/")]),s._v("\n\n挂载cephFS对象\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph-fuse -n client.fsclient -m mon01:6789,mon02:6789,mon03:6789 /cephfs-data-user/")]),s._v("\nceph-fuse"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("7963"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": starting ceph client2062-09-27 12:23:47"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("905 7f6e97de4f80 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("1 init"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" newargv = 0x5637c9545540 newargc=9\nceph-fuse"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("7963"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": starting fuse\n\n确认挂载效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mount | grep cephfs")]),s._v("\nceph-fuse on "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("cephfs-"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("user "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" fuse"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ceph-fuse "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("rw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("nosuid"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("nodev"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("relatime"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("user_id=0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("group_id=0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("allow_other"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看挂载点的效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# stat -f /cephfs-data-user/")]),s._v("\n  文件："),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/cephfs-data-user/"')]),s._v("\n    ID：0        文件名长度：255     类型：fuseblk\n块大小：4194304    基本块大小：4194304\n    块：总计：9182       空闲：9182       可用：9182\nInodes: 总计：1          空闲：0\n\t\n确认文件系统使用效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# echo nihao cephfs user > /cephfs-data-user/cephfs.txt")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /cephfs-data-user/cephfs.txt")]),s._v("\nnihao cephfs "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("user\n")])])]),t("p",[s._v("开机自启动挂载cephFS")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("卸载刚才挂载的cephFS\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# umount /cephfs-data-user")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mount | grep ceph")]),s._v("\n\n设置开机自启动\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# echo 'none  /cephfs-data-user   fuse.ceph   ceph.id=fsclient,ceph.conf=/etc/ceph/ceph.conf,_netdev,noatime 0 0' >> /etc/fstab")]),s._v("\n属性解析：\n\t_netdev "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 告诉挂载程序，一旦超时，自动跳过去。\n\tnoatime "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 在读文件时不去更改文件的access time属性，提高性能\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("挂载磁盘\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mount -a")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mount | grep ceph")]),s._v("\nceph-fuse on "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("cephfs-"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("user "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),s._v(" fuse"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ceph-fuse "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("rw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("nosuid"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("nodev"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("noatime"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("user_id=0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("group_id=0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("allow_other"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n查看效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /cephfs-data-user/cephfs.txt")]),s._v("\nnihao cephfs user\n\n专用的卸载命令\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# fusermount -u /cephfs-data-user")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@stor06 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mount | grep cephfs")]),s._v("\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h2",{attrs:{id:"_1-5-集群管理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-5-集群管理"}},[s._v("#")]),s._v(" 1.5 集群管理")]),s._v(" "),t("h3",{attrs:{id:"_1-5-1-集群状态"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-5-1-集群状态"}},[s._v("#")]),s._v(" 1.5.1 集群状态")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、集群管理、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("检查集群状态")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("s\n  cluster: 查看集群ID 和 集群运行状况\n    id:     1d4e5773-619a-479d-861a-66ba451ce945\n    health: HEALTH_OK\n\n  services: 各种服务的状态监控\n    mon: 3 daemons"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" quorum mon01"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("mon02"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("mon03 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("age 48m"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    mgr: mon01"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("active"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" since 2d"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" standbys: mon02\n    mds: cephfs:1 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("0=stor05=up:active"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    osd: 6 osds: 6 up "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("since 48m"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 6 in "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("since 44h"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    rgw: 1 daemon active "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("stor04"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n  task status:  任务状态\n\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(": 存储数据相关的监控，包括存储池、存储对象、存储统计数量等\n    pools:   10 pools"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 352 pgs\n    objects: 270 objects"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 60 MiB\n    usage:   6"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("3 GiB used"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 114 GiB "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" 120 GiB avail\n    pgs:     352 active+clean  \n")])])]),t("p",[s._v("检查集群即时状态")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看pg的状态\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph pg stat\n352 pgs: 352 active+clean"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" 60 MiB "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 314 MiB used"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 114 GiB "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" 120 GiB avail"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" 4"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0 KiB/s "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rd")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 0 B/s wr"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 6 op/s\n\n查看pool的状态\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd pool stats\npool "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("root id 6\n  nothing is going on\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看ceph的存储空间状态\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph df "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[detail]")]),s._v("\nRAW STORAGE:\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CLASS")]),s._v("     SIZE        AVAIL       USED        RAW USED     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v("RAW USED\n    hdd       120 GiB     114 GiB     314 MiB      6"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("3 GiB          5"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("26\n    TOTAL     120 GiB     114 GiB     314 MiB      6"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("3 GiB          5"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("26\n\nPOOLS:\n    POOL         ID  PGS  STORED    OBJECTS  USED      "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v("USED    MAX AVAIL\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rgw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("root    6   32   1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("2 KiB   4        768 KiB   0        36 GiB\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("p",[s._v("查看osd状态")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看osd的基本状态\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd stat\n6 osds: 6 up "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("since 52m"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 6 in "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("since 44h"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" epoch: e150\n\n查看osd的属性详情\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd dump\nepoch 150\nfsid 1d4e5773-619a-479d-861a-66ba451ce945\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\n查看osd的归属结构Ceph将列显CRUSH树及主机、它的OSD、OSD是否已启动及其权重\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd tree\nID "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CLASS")]),s._v(" WEIGHT  "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("TYPE")]),s._v(" NAME      STATUS REWEIGHT PRI-AFF\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("1       0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("11691 root default\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("3       0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("03897     host mon01\n 0   hdd 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("01949         osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0      up  1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("00000 1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("00000\n 1   hdd 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("01949         osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("1      up  1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("00000 1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("00000\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("p",[s._v("查看mon状态")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t集群中存在多个Mon主机时，应该在启动集群之后读取或写入数据之前检查Mon的仲裁状态；事实上，管理员也应该定期检查这种仲裁结果\n\t\n显示监视器映射\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph mon stat\ne3: 3 mons at "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("mon01="),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[v2:10.0.0.13:3300/0,v1:10.0.0.13:6789/0]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("mon02="),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[v2:10.0.0.14:3300/0,v1:10.0.0.14:6789/0]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("mon03="),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[v2:10.0.0.15:3300/0,v1:10.0.0.15:6789/0]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" election epoch 36"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" leader 0 mon01"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" quorum 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("2 mon01"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("mon02"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("mon03\n\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph mon dump\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n0: "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[v2:10.0.0.13:3300/0,v1:10.0.0.13:6789/0]")]),s._v(" mon"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("mon01\n1: "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[v2:10.0.0.14:3300/0,v1:10.0.0.14:6789/0]")]),s._v(" mon"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("mon02\n2: "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[v2:10.0.0.15:3300/0,v1:10.0.0.15:6789/0]")]),s._v(" mon"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("mon03\ndumped monmap epoch 3\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("普通方式查看多个mon节点的选举状态\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph quorum_status\n\n以格式化方式查看选举状态\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph quorum_status "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("f json-pretty\n")])])]),t("p",[t("strong",[s._v("集群管理")])]),s._v(" "),t("p",[s._v("集群管理套接字")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("Ceph的管理套接字接口常用于查询守护进程\n\t资源对象文件保存的目录 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("lib/ceph目录\n\t套接字默认保存 于"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("run/ceph目录\n\t此接口的使用不能以远程方式进程\n")])])]),t("p",[s._v("借助于socket文件实现ceph属性的动态管理")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("命令的使用格式：\n\tceph "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("admin-daemon "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("run/ceph/socket-name\n\t获取使用帮助：\n\tceph "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("admin-daemon "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("run/ceph/socket-name help\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("简单示例\n\tceph "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("admin-daemon "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("run/ceph/ceph-mgr"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("mon01"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("asok help\n\tceph "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("admin-daemon "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("run/ceph/ceph-mon"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("mon01"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("asok help\n\tceph "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("admin-daemon "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("run/ceph/ceph-osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("asok help\n\tceph "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("admin-daemon "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("run/ceph/ceph-osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("asok help\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-5-2-配置文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-5-2-配置文件"}},[s._v("#")]),s._v(" 1.5.2 配置文件")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("文件目录")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("ceph软件安装完成后，就会生成专用的家目录\n\nroot@mon01:~"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls /etc/ceph/")]),s._v("\nceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("admin"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("keyring  ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf  rbdmap  tmpzvyyulv9\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("ceph配置文件就是 ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf，该文件遵循 ini文件的语法格式。\n\nroot@mon01:~"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /etc/ceph/ceph.conf")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[global]")]),s._v("\nfsid = 22fc9b8e-6d30-463d-b312-89dc91ee0969\npublic_network = 10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0/24\ncluster_network = 192"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("168"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("8"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0/24\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[mon]")]),s._v("\nmon allow pool delete = true\n")])])]),t("p",[s._v("配置结构")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("对于ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf文件来说，它主要有四部分组成：\n\t"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[global]")]),s._v(" \tceph存储的全局性配置\n\t"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[osd]")]),s._v("\t\t所有影响 Ceph 存储集群中 ceph-osd 守护进程的相关配置，会覆盖global的相同属性\n\t"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[mon]")]),s._v("\t\t所有影响 Ceph 存储集群中 ceph-mon 守护进程的相关配置，会覆盖global的相同属性\n\t"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[client]")]),s._v("\t所有影响 Ceph 客户端管理的相关配置，比如 块设备客户端、fs客户端、oss客户端等\n\t\n注意：ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf主要是针对整体来进行设置的，如果我们需要针对某一个对象来进行修改的话，可以使用\n\t"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"对象.主机名|id"')]),s._v(" 的方式来进行针对性定制。\n\t比如："),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[mon.mon01]")]),s._v("、"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[osd.1]")]),s._v("\n")])])]),t("p",[s._v("配置文件的加载")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("对于ceph来说，它的配置文件，不仅仅有 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/ceph/ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf 一种样式，他还有更多的样式 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v(" 主要是作用的范围不一样\n\n全局范围：\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc/ceph/ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf\n\t"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$CEPH_CONF")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("c path/to/ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf\n局部范围\n\t~"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ceph/config\n\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("ceph/conf\n")])])]),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("元参数")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\t在ceph环境中，它提供了很多可以直接拿过来使用的元数据变量。这些变量可以直接从环境中获取到指定的信息，方便我们进行后续处理。\n\t这些信息，不仅仅可以在运行时使用，还可以在配置文件中进行定制。\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("常见的变量信息有：\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$cluster")]),s._v("：当前Ceph集群的名称\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$type")]),s._v("：当前服务的类型名称，可能会展开为osd或mon；\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$id")]),s._v("：进程的标识符，例如对osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0来说，其标识符为0；\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$host")]),s._v("：守护进程所在主机的主机名；\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$name")]),s._v("：其值为"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$id")]),s._v("\n")])])]),t("p",[s._v("运行时使用")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("我们在ceph运行过程中，可以通过 以下方式来获取不同的属性信息内容\n\t查看配置信息\n\tceph daemon "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("daemon-"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" config show\n\t查看帮助信息\n\tceph daemon "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("daemon-"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" help\n\t查看指定参数信息\n\tceph daemon "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("daemon-"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" config get "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("parameter"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\t修改特定的信息\n\tceph tell "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("daemon-"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("daemon id or "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" injectargs "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("value"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("value"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\t设定特定的属性\n\tceph daemon "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("daemon-"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("value"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("获取所有配置属性\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@mon01 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph daemon osd.0 config show")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"osd.0"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cluster"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ceph"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"admin_socket"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/var/run/ceph/ceph-osd.0.asok"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"admin_socket_mode"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"threadpool_empty_queue_max_wait"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"throttler_perf_counter"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@mon01 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph daemon osd.0 config show | wc -l")]),s._v("\n1644\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("获取帮助信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@mon01 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph daemon mon.mon01 help")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"add_bootstrap_peer_hint"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"add peer address as potential bootstrap peer for cluster bringup"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sessions"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"list existing sessions"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"smart"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Query health metrics for underlying device"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sync_force"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"force sync of and clear monitor store"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"version"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"get ceph version"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("获取制定信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@mon01 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph daemon mon.mon01 config get admin_socket")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"admin_socket"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/var/run/ceph/ceph-mon.mon01.asok"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@mon01 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph daemon osd.0 config get admin_socket")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"admin_socket"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/var/run/ceph/ceph-osd.0.asok"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),t("p",[s._v("更改属性")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("查看当前的属性信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@mon01 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph daemon osd.0 config get debug_osd")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"debug_osd"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1/5"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n修改制定的属性\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@mon01 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph tell osd.0 injectargs '--debug-osd 0/5'")]),s._v("\n\n查看修改后的属性信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@mon01 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph daemon osd.0 config get debug_osd")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"debug_osd"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0/5"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("修改制定的属性\nceph daemon osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0 config "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" debug_osd 1/5\nceph daemon osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0 config get debug_osd\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-5-3-磁盘管理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-5-3-磁盘管理"}},[s._v("#")]),s._v(" 1.5.3 磁盘管理")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 场景需求、简单实践、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("场景需求")])]),s._v(" "),t("p",[s._v("简介")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t在ceph分布式存储集群里，数以千计万计的磁盘数量规模下，磁盘出现故障是不可避免，所以服务器更换故障磁盘就成为大规模机房的日常运维工作之一，而ceph存储集群中就需要在物理磁盘更换的前提下，需要不断重复的完成OSD磁盘的更换的操作。\n")])])]),t("p",[s._v("操作步骤")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t在ceph集群环境中，主要有三套方法来实现磁盘的更换操作，但是这些操作各有优劣，甚至对于某些场景来说，不能够使用xx方式的磁盘更换操作，所以我们需要了解一下这些常见的磁盘管理操作。\n\t注意：\n\t\t这里主要介绍多种磁盘更换的思路和区别，里面的一些数据，仅供参考。\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("更换方式1：\n\t1 到指定节点上，停止指定的osd进程\n    2 将移除OSD节点状态标记为out\n    3 从crush中移除OSD节点，该节点不作为数据的载体\n    4 删除OSD节点和对应的认证信息\n    5 增加一个新的 OSD\n   \t注意：\n   \t\t1、2、3、4、5 这几步都会发生数据迁移的动作\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("更换方式2：\n\t1 修改osd的数据操作权重值，让数据不分布在这个节点上\n\t2 到指定节点上，停止指定的osd进程\n\t3 将移除OSD节点状态标记为out\n\t4 从crush中移除OSD节点，该节点不作为数据的载体\n\t5 删除OSD节点和对应的认证信息\n\t6 增加一个新的 OSD\n\t注意：\n\t\t1、5、6 这几步会发生数据迁移动作\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("更换方式3：\n\t1 对ceph集群的osd设置禁止数据迁移的标记\n\t2 修改osd的数据操作权重值，让数据不分布在这个节点上\n\t3 到指定节点上，停止指定的osd进程\n\t4 从crush中移除OSD节点，该节点不作为数据的载体\n\t5 删除OSD节点和对应的认证信息\n\t6 增加一个新的 OSD\n\t7 移除ceph集群的osd禁止数据迁移标记\n\t注意：\n\t\t因为添加了标记，所以1-6这几步的数据迁移都不会执行，只有7这一步会发生数据迁移动作。\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("注意：\n\t如果想要查看每次数据迁移的状态，可以查看当前pg的状态效果\n\tceph pg dump pgs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("awk "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{print $1,$15}'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("grep "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("v pg > pg_base"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("txt\n\t每次执行数据迁移动作后，可以再次保存，然后对比此次数据迁移的效果\n\t"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("diff")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("y "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("W 100 pg_end"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("txt pg_base"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("txt "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("suppress-common-lines "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" wc "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("l\n")])])]),t("p",[t("strong",[s._v("简单实践")])]),s._v(" "),t("p",[s._v("磁盘更换方式1实践")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("1 到指定节点上，停止指定的osd进程\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@mon01 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl  stop  ceph-osd@1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@mon01 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph osd tree")]),s._v("\nID "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CLASS")]),s._v(" WEIGHT  "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("TYPE")]),s._v(" NAME      STATUS REWEIGHT PRI-AFF\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n 1   hdd 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("01949         osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("1    down  1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("00000 1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("00000\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("2 将移除OSD节点状态标记为out\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@mon01 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph osd out 1")]),s._v("\nmarked out osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@mon01 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph osd tree")]),s._v("\nID "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CLASS")]),s._v(" WEIGHT  "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("TYPE")]),s._v(" NAME      STATUS REWEIGHT PRI-AFF\n "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n 1   hdd 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("01949         osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("1    down        0 1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("00000\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("标记状态的改变，会导致pg的迁移，查看pgs的状态\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@mon01 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph pg dump pgs")]),s._v("\n10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("1d         0     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("   0 active+clean "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n注意：\n\tpg迁移过程中，会有一些异常状态 active+recovering+undersized+remapped \n\t\n我们还有另外一种方式来进行检查数据迁移效果\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("s\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n  services:\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    osd: 7 osds: 6 up "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("since 20s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 6 in "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("since 20s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" 17 remapped pgs\n    rgw: 1 daemon active "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("stor04"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n  task status:\n\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(":\n    pools:   10 pools"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 352 pgs\n    objects: 270 objects"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 60 MiB\n    usage:   6"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("4 GiB used"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 114 GiB "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" 120 GiB avail\n    pgs:     0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("284% pgs not active\n             158/810 objects degraded "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("19"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("506%"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n             14/810 objects misplaced "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("728%"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n             327 active+clean\n             17  active+recovery_wait+undersized+degraded+remapped\n             3   active+recovery_wait+degraded\n             1   active+recovery_wait\n             1   active+recovery_wait+remapped\n             1   active+recovering+degraded\n             1   activating\n             1   active+recovering+undersized+remapped\n\n  io:\n    recovery: 3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("1 MiB/s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 4 objects/s\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("3 从crush中移除OSD节点，该节点不作为数据的载体\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@mon01 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph osd crush remove osd.1")]),s._v("\nremoved item id 1 name "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'osd.1'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" crush map\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("4 移除无效的osd节点"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("并移除认证信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("1\nremoved osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("1\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph auth "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("del")]),s._v(" osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("1\nupdated\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("5-1 清理磁盘\ndmsetup status\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("lib/ceph/osd/ceph-1/fsid\ndmsetup remove ceph-1的id\nmkfs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ext4 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("dev/sdc\n\n5-2 擦除磁盘上的数据\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph-deploy disk zap mon01 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("dev/sdc\n\n5-3 添加磁盘数据\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph-deploy "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("overwrite-conf osd create mon01 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("dev/sdc\n")])])]),t("p",[s._v("磁盘更换方式2实践")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("这次以mon02 主机为例\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@mon02 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph osd tree")]),s._v("\nID "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CLASS")]),s._v(" WEIGHT  "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("TYPE")]),s._v(" NAME      STATUS REWEIGHT PRI-AFF\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("5       0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("03897     host mon02\n 2   hdd 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("01949         osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("2      up  1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("00000 1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("00000\n 3   hdd 0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("01949         osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("3      up  1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("00000 1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("00000\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("1 修改osd的数据操作权重值，让数据不分布在这个节点上\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@mon02 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph osd crush reweight osd.3 0")]),s._v("\nreweighted item id 3 name "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'osd.3'")]),s._v(" to 0 in crush map\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("2 到指定节点上，停止指定的osd进程\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@mon02 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sudo systemctl stop ceph-osd@3")]),s._v("\n\n3 将移除OSD节点状态标记为out\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd out osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("3\nmarked out osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("4 从crush中移除OSD节点，该节点不作为数据的载体\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@mon02 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph osd crush remove osd.3")]),s._v("\nremoved item id 3 name "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'osd.3'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" crush map\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("5 移除无效的osd节点后删除认证信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("3\nremoved osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("3\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph auth "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("del")]),s._v(" osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("3\nupdated\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("6-1 清理磁盘\ndmsetup status\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("lib/ceph/osd/ceph-2/fsid\ndmsetup remove ceph-3的id\nmkfs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ext4 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("dev/sdc\n\n6-2 擦除磁盘上的数据后添加磁盘\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph-deploy disk zap mon02 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("dev/sdc\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph-deploy "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("overwrite-conf osd create mon02 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("dev/sdc\n")])])]),t("p",[s._v("磁盘更换方式3实践")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("1 对ceph集群的osd设置禁止数据迁移的标记\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" norebalance\nnorebalance is "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" nobackfill\nnobackfill is "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" norecover\nnorecover is "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v("\n\n查看状态后，osd会有相应标签\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("s\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n  services:\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    osd: 6 osds: 6 up "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("since 16m"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 6 in "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("since 16m"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n         flags nobackfill"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("norebalance"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("norecover\n    rgw: 1 daemon active "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("stor04"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("2 修改osd的数据操作权重值，让数据不分布在这个节点上\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd crush reweight osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("5 0\nreweighted item id 5 name "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'osd.5'")]),s._v(" to 0 in crush map\n\n因为集群已经禁止数据迁移了，所以这个时候，并不会发生数据迁移动作\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("s\n  cluster:\n    id:     1d4e5773-619a-479d-861a-66ba451ce945\n    health: HEALTH_WARN\n            nobackfill"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("norebalance"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("norecover flag"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v("\n            Reduced "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(" availability: 16 pgs inactive"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 20 pgs peering\n            Degraded "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(" redundancy: 104/810 objects degraded "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("12"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("840%"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 30 pgs degraded"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 1 pg undersized\n\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(":\n    pools:   10 pools"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 352 pgs\n    objects: 270 objects"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 60 MiB\n    usage:   6"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("5 GiB used"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 114 GiB "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" 120 GiB avail\n    pgs:     27"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("273% pgs not active\n             104/810 objects degraded "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("12"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("840%"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n             6/810 objects misplaced "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("741%"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n             226 active+clean\n             95  peering\n             16  active+recovery_wait+degraded\n             14  active+recovery_wait+undersized+degraded+remapped\n             1   remapped+peering\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("3 到指定节点上，停止指定的osd进程\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@mon03 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sudo systemctl stop ceph-osd@5")]),s._v("\n\n4 从crush中移除OSD节点，该节点不作为数据的载体\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@mon02 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph osd crush remove osd.5")]),s._v("\nremoved item id 5 name "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'osd.5'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" crush map\n\n5 移除无效的osd节点后删除认证信息\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("5\nremoved osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("5\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph auth "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("del")]),s._v(" osd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("5\nupdated\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("6-1 清理磁盘\ndmsetup status\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("lib/ceph/osd/ceph-5/fsid\ndmsetup remove ceph-5的id\nmkfs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ext4 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("dev/sdc\n\n6-2 擦除磁盘上的数据后添加磁盘\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph-deploy disk zap mon03 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("dev/sdc\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph-deploy "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("overwrite-conf osd create mon03 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("dev/sdc\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("7 移除ceph集群的osd禁止数据迁移标记\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd unset norebalance\nnorebalance is unset\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd unset nobackfill\nnobackfill is unset\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph osd unset norecover\nnorecover is unset\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("稍等一会查看ceph的状态\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[cephadm@admin ceph-cluster]")]),s._v("$ ceph "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("s\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v(":\n    pools:   10 pools"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 352 pgs\n    objects: 270 objects"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 60 MiB\n    usage:   6"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("5 GiB used"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 113 GiB "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" 120 GiB avail\n    pgs:     352 active+clean\n结果显示：\n\t这个时候，才会发生数据迁移的动作\n")])])]),t("p",[s._v("生产技巧")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t当我们遇到ceph宿主机重启的场景，如果不想发生频繁的数据迁移动作，可以手工临时禁用ceph自带数据恢复平衡功能即可\n\n禁用ceph集群数据迁移：\n    ceph osd "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" noout\n    ceph osd "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" nobackfill\n    ceph osd "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),s._v(" norecover\n启用ceph集群数据迁移：\n    ceph osd unset noout\n    ceph osd unset nobackfill\n    ceph osd unset norecover\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-5-4-性能调优"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-5-4-性能调优"}},[s._v("#")]),s._v(" 1.5.4 性能调优")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基础知识、常见策略、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基础知识")])]),s._v(" "),t("p",[s._v("简介")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t性能优化没有一个标准的定义，如果用大白话来说的话，他就是在现有主机资源的前提下，发挥业务最大的处理能力。也理解为：通过空间"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("资源消耗"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("优化换取时间"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("业务处理"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("效益\n\t它主要体现在几个方面：改善业务逻辑处理的速度、提升业务数据吞吐量、优化主机资源的消耗量。\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\t性能优化没有一个基准值，我们只能通过自我或者普遍的场景工作经验，设定一个阶段性的目标，然后通过物理手段、配置手段、代码手段等方式提高主机资源的业务处理能力。\n")])])]),t("p",[s._v("通用处理措施")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("基础设施\n\t合适设备 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 多云环境、新旧服务器结合、合适网络等\n\t研发环境 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 应用架构、研发平台、代码规范等\n应用软件\n\t多级缓存 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 浏览器缓存、缓存服务器、服务器缓存、应用缓存、代码缓存、数据缓存等。\n\t数据压缩 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 数据构建压缩、数据传输压缩、缓存数据压缩、数据对象压缩、清理无效数据等。\n\t数据预热 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 缓冲数据、预取数据、预置主机、数据同步等。\n业务处理\n\t削峰填谷 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 延时加载、分批发布、限流控制、异步处理、超时降级等\n\t任务批处理 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 数据打包传输、数据批量传输、延迟数据处理等\n")])])]),t("p",[s._v("ceph环境")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\tCeph分布式存储环境是以集群服务器来进行承载存储服务的，所以对于Ceph的性能优化主要体现在基础设施层的合适设备、应用项目的多级缓存和数据压缩、业务处理的任务批处理。\n")])])]),t("p",[t("strong",[s._v("常见策略")])]),s._v(" "),t("p",[s._v("基础设施")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\tCeph集群的各个服务守护进程在 Linux 服务器上运行，所以适当调优操作系统能够对ceph存储集群的性能产生积极的影响。它主要涉及到以下几个方面：\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 选择合适的CPU和内存。\n\t\t不同角色具有不同的 CPU 需求，MDS"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("4"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(">OSD"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(">MON"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("，纠删代码功能需要更多 CPU。\n\t\t不同角色具有不同的 内存 需求，MON>OSD\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 选择合适的磁盘容量\t\n    \t合理评估阶段性业务量，计算节点数量及各个节点的磁盘容量需求。\n    \t选择合适的 SAS、SATA、SSD，实现分级存储的能力。\n    \tOS系统、数据、日志使用独立的SSD硬盘，使整体吞吐量最大化\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 选择合适的网络设备\n    \tCeph集群对于网络数据传输能力要求高，需要支持巨型帧"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("9000字节，默认1500字节"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("功能\n    \tCeph集群数据传输量很大，需要所有设备的 MTU 设置必须一致\n    \t如果可以的话，网络带宽一定要大，最好以3倍需求量的方式采购\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 配置合适的文件系统\n    \t推荐使用vfs文件系统，ceph借助于xfs扩展属性在创建和挂载文件系统场景中提高索引数据缓存\n    \tosd_mkfs_options_xfs、osd_mount_options_xfs\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 搭建内部时间服务器\n    \tceph集群对于时间要求比较高，为了保证数据的通信一致性，最好采用内部时间服务器\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 合理采用多云环境\n    \t将合适的业务负载转移到公有云环境。\n")])])]),t("p",[s._v("应用软件")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\tCeph集群的很多功能都是以各种服务配置的方式来进行实现的，所以我们有必要结合不同的配置属性，实现ceph集群环境级别的性能优化：\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 数据访问\n\t\t采用public网络和cluster网络机制，实现数据操作网络的可靠性，避免外部网络攻击的安全性。\n\t\t配置属性：public_network、cluster_network、max_open_file等\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 数据存储\n\t\t设定合理的存储池的PG 数量，集群PGs总数 = "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("OSD总数 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" 100 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" 最大副本数"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\t更多数据存储规划：https:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("docs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ceph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com/en/latest/rados/operations/placement-groups/"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#choosing-the-number-of-placement-groups")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 多级缓存\n\t\t根据实际情况开启RDBCache"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("rbd_cache_xxx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("、RGWCache"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("rgw_cache_xxx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("、OSDCache、MDSCache\n\t\t建立合理的SSD缓存pool，设定合理的cache age、target size 等参数\n\t\t理清业务场景，根据缓存模式"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("write-back")]),s._v("、readproxy、readonly等"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("，启用cache-tiering机制。\n")])])]),t("p",[s._v("业务处理")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("\tceph集群在大规模数据处理的时候，可以通过数据批处理能力来实现数据的高效传输。\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 数据批处理\n\t\tfilestore_max"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("min_sync_interval 从日志到数据盘最大"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("小同步间隔"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("seconds"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\tfilestore_queue_max_ops"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("bytes 数据盘单次最大接受的操作数"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("字节数\n\t\tfilestore_queue_committing_max_ops"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("bytes 数据盘单次最大处理的操作数"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("字节数\n\t\tjournal_max_write_ops"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("bytes 日志一次性写入的最大操作数"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("字节数"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("bytes"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\tjournal_queue_max_ops"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("bytes 日志一次性查询的最大操作数"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v("字节数"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("bytes"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\tosd_max_write_size\tOSD一次可写入的最大值"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("MB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\tosd_recovery_max_active\t同一时间内活跃的恢复请求数\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])]),t("h3",{attrs:{id:"_1-5-5-性能测试"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-5-5-性能测试"}},[s._v("#")]),s._v(" 1.5.5 性能测试")]),s._v(" "),t("p",[s._v("学习目标")]),s._v(" "),t("p",[s._v("这一节，我们从 基准测试、rados测试、小结 三个方面来学习。")]),s._v(" "),t("p",[t("strong",[s._v("基准测试")])]),s._v(" "),t("p",[s._v("磁盘测试")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("准备工作"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("清理缓存\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@mon03 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# echo 3 > /proc/sys/vm/drop_caches^C")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@mon03 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /proc/sys/vm/drop_caches")]),s._v("\n0\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@mon03 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# echo 3 > /proc/sys/vm/drop_caches")]),s._v("\n\n查看磁盘\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@mon03 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls /var/lib/ceph/osd/")]),s._v("\nceph-4  ceph-5\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("OSD 磁盘写性能\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@mon03 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# dd if=/dev/zero of=/var/lib/ceph/osd/ceph-4/write_test bs=1M count=100")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n104857600字节"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("105 MB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("已复制，0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("4009 秒，262 MB/秒\n\nOSD 磁盘读性能\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@mon03 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# dd if=/var/lib/ceph/osd/ceph-4/write_test of=/dev/null bs=1M count=100")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n104857600字节"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("105 MB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("已复制，0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0233439 秒，4"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("5 GB/秒\n\n清理环境\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@mon03 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rm -f /var/lib/ceph/osd/ceph-4/write_test")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("参考资料：\n\thttps:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("www"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("thomas-krenn"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com/en/wiki/Linux_I/O_Performance_Tests_using_dd\n")])])]),t("p",[s._v("网络测试")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("在多台主机上准备网络基准测试工具\nyum install iperf "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("y\n服务端命令参数\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("s 以server模式启动\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p 指定服务器端使用的端口或客户端所连接的端口\n客户端命令参数\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("d 同时进行双向传输测试\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("n 指定传输的字节数\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("节点1执行命令\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@admin ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iperf -s -p 6900")]),s._v("\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("客户端执行命令\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@mon03 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iperf -c admin -p 6900")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("\nClient connecting to admin"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" TCP port 6900\nTCP window size:  552 KByte "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("default"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("  3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" local 10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("15 port 48376 connected with 10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("12 port 6900\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" ID"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Interval       Transfer     Bandwidth\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("  3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("  0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0-10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0 sec  2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("58 GBytes  2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("21 Gbits/sec\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("注意：\n\t无论是磁盘测试还是网络测试，都需要多次测试后，获取平均值效果\n")])])]),t("p",[t("strong",[s._v("rados测试")])]),s._v(" "),t("p",[s._v("bench性能测试工具")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("它是Ceph 自带的 rados bench 测试工具，命令格式如下：\n\trados bench "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p <存储池> <秒数> <操作模式> "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("b <块大小> "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("t 并行数 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("no-cleanup\n参数解读：\n\t操作模式：包括三种，分别是"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("write")]),s._v("：写，seq：顺序读；rand：随机读\n\t块大小：默认为4M\n\t并行数: 读"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("写并行数，默认为 16\n\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("no-cleanup 表示测试完成后不删除测试用数据。\n\t\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 在做读测试之前，需要使用该参数来运行一遍写测试来产生测试数据，\n\t\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 在测试结束后运行 rados "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p <存储池> cleanup 清理测试数据。\n注意：\n\t曾经的bench-"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("write")]),s._v("已经被整合到bench中了\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("创建测试存储池\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@admin ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph osd pool create pool-test 32 32")]),s._v("\npool "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'pool-test'")]),s._v(" created\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("写测试：\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@admin ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rados bench -p pool-test 10 write --no-cleanup")]),s._v("\nhints = 1\nMaintaining 16 concurrent writes of 4194304 bytes to objects of size 4194304 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" up to 10 seconds or 0 objects\nObject prefix: benchmark_data_admin_5683\n  sec Cur ops   started  finished  avg MB/s  cur MB/s last lat"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  avg lat"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    0       0         0         0         0         0           "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("           0\n\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n   10      16       147       131   52"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("3689        64     1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("18095     1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("16048\nTotal time run:         10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("9577\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nMin latency"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(":         0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("202\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("顺序读测试\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@admin ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rados bench -p pool-test 10 seq")]),s._v("\nhints = 1\n  sec Cur ops   started  finished  avg MB/s  cur MB/s last lat"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  avg lat"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    0       0         0         0         0         0           "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("           0\n   \t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n   10      15       139       124   45"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0608         8     9"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("09797     0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("93913\nTotal time run:       11"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("5093\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nMin latency"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(":       0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0240264\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("随机读测试\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@admin ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rados bench -p pool-test 10 rand")]),s._v("\nhints = 1\n  sec Cur ops   started  finished  avg MB/s  cur MB/s last lat"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  avg lat"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    0       0         0         0         0         0           "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("           0\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n   10      16       589       573   229"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("081       244     0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("20209    0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("272096\nTotal time run:       10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("2428\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\nMin latency"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(":       0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("0225745\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("清理环境\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@admin ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rados -p pool-test cleanup")]),s._v("\nRemoved 148 objects\n")])])]),t("p",[s._v("load-gen性能测试工具")]),s._v(" "),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("Ceph 自带的 rados 性能测试工具，可在集群内产生混合类型的负载，相较于bench，load-gen只做吞吐量测试。命令格式如下：\n\trados "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p 存储池 load-gen \n参数解读：\n\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("num-objects     \t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 初始生成测试用的对象数")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("min-object-size \t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 最小对象大小")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("max-object-size \t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 最大对象大小")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("max-ops         \t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 最大操作数目")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("min-op-len      \t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 最小操作长度，相当于iodepth")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("max-op-len      \t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 最大操作长度")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("read-percent")]),s._v("    \t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 读操作的百分比")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("target-throughput "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 单次提交IO的累计吞吐量上线，单位 MB/s")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("run-length      \t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 运行时长，单位秒")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("percent\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 读写混合中，读操作占用比例")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("max_backlog\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 单次提交IO的吞吐量上限")]),s._v("\n    \n注意：\n\tiodepth就是io队列深度"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("io队列里面允许出现几个命令等待操作"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("，它的作用是\n\t\t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" 控制硬盘操作的过程中的负载情况，避免系统一直发送指令，出现磁盘受不了导致系统崩溃的现象\n")])])]),t("div",{staticClass:"language-powershell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-powershell"}},[t("code",[s._v("在pool-test存储池中，初始对象50个，单次io的最大数量16，顺序写入4M的数据块"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("测试时间10秒。\n"),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("[root@mon03 ~]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rados -p pool-test load-gen --num-objects 50 --min-object-size 4M --max-object-size 4M --max-object-size 4M --max-ops 16 --min-op-len 4M  --max-op-len 4M --percent 5 --target-throughput 40 --run-length 10")]),s._v("\nrun length 10 seconds\npreparing 50 objects\nload-gen will run 10 seconds\n    1: throughput=0MB/sec pending "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v("=0\nREAD : oid=obj-AF5uiLtTtxSNSNR off=0 len=4194304\nop 0 completed"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" throughput=3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("86MB/sec\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    9: throughput=0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("442MB/sec pending "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("data")]),s._v("=0\nwaiting "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" all operations to complete\ncleaning up objects\n")])])]),t("p",[t("strong",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\n")])])])])}),[],!1,null,null,null);t.default=e.exports}}]);